package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.classes;

import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.event.FieldEvents.FocusEvent;
import com.vaadin.event.FieldEvents.FocusListener;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;

public class PatientHistoryPicker extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;
    @AutoGenerated
    private ComboBox patient;
    @AutoGenerated
    private CheckBox enabled;
    
    
    // {section fields}
    // ****************
    org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    private String projectCode;
    
    // {end fields}

    // {section constructors}
    // **********************
    public PatientHistoryPicker() {
        setCompositionRoot(buildMainLayout());
        configureComponents();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public void setProjectCode(String code) {
        projectCode = code;
    }
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void addValueChangeListener(ValueChangeListener vcl) {
        patient.addValueChangeListener(vcl);
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    private void configureComponents() {
        enabled.setImmediate(true);
        enabled.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                if(!enabled.getValue()) {
                    patient.setValue(null);
                }
                
            }
        });
        
        patient.setImmediate(true);
        patient.addFocusListener(new FocusListener() {
            
            @Override
            public void focus(FocusEvent event) {
                
                log.info("focus");
                
            }
        });
        patient.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                enabled.setValue(patient.getValue() != null);
                
            }
        });
    }
    // {end privatemethods}

    // {section database}
    // ******************
    private void dbGetPatients() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSL_ID as id"
         + "\n " + ", CONCAT_WS(' ', PSA_NAME, PSL_VORNAME, PSL_NAME) as patient"
         + "\n " + "from cust_patient_stammdaten_liste"
         + "\n " + "left join cust_patient_stammdaten_anrede on PSL_ANREDE = PSA_ID";
         
        if(projectCode != null) {
        
             sql += "\n " + "where PSL_ID in ("
             + "\n " + "    select VH_PATIENT_ID"
             + "\n " + "    from cust_verk_haupt"
             + "\n " + "    where cust_verk_haupt.VH_PROJEKT_ID in ("
             + "\n " + "        select PSLV_ID"
             + "\n " + "        from cust_projekte_stammdaten_liste"
             + "\n " + "        where PSLV_CODE = 'SA'"
             + "\n " + "    )"
             + "\n " + ")";
         
        }
         
        sql += "\n " + "order by PSL_NAME asc";
        q.setSqlString(sql);
    }
    // {end database}

    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("-1px");
        mainLayout.setHeight("-1px");
        mainLayout.setMargin(false);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("-1px");
        setHeight("-1px");
        
        // enabled
        enabled = new CheckBox();
        enabled.setImmediate(false);
        enabled.setWidth("-1px");
        enabled.setHeight("-1px");
        mainLayout.addComponent(enabled);
        mainLayout.setComponentAlignment(enabled, new Alignment(48));
        
        // patients
        patient = new ComboBox();
        patient.setCaption("Patienten-Historie");
        patient.setImmediate(false);
        patient.setWidth("100%");
        patient.setHeight("-1px");
        mainLayout.addComponent(patient);
        mainLayout.setComponentAlignment(patient, new Alignment(48));
        
        return mainLayout;
    }
}
