package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form.classes;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.tool.comunication.email.Mailer;
import archenoah.lib.tool.comunication.email.Mailer.MAIL_TYPE;
import archenoah.lib.tool.templating.TemplatingRenderer;
import archenoah.lib.vaadin.Components.Validators.RegexValidator;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.Language.i18n.I18nNB;
import archenoah.lib.vaadin.validator.ValidatorManager;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.RichTextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;


public class MailEditor extends CustomComponent{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Button send;
    @AutoGenerated
    private RichTextArea customMessage;
    @AutoGenerated
    private RichTextArea preview;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private TextField recipient;
    @AutoGenerated
    private TextField sender;
    
    
    

    // {section fields}
    // ****************
    
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(MailEditor.class);
    
    private Integer projectId;
    private Integer patientId;
    private Integer nurseId;
    private Integer externalId;
    
    private I18nManager i18n;
    private ValidatorManager val;
    
    private final static class caption extends I18nCB {
        static final I18nCB title = set();
        static final I18nCB new_assignment = set();
    }
    
    private final static class notifier extends I18nNB {
        static final I18nNB error_mail = set(ERROR, MC, 5);
    }
    
    private String height = "700px";
    private String width = "600px";
    private Window win = null;
    private Item patientInfo;
    private Item externalInfo;
    private Item nurseInfo;
    private Item projectInfo;
    
    TemplatingRenderer render;
    
    // {end fields}

    // {section constructors}
    // **********************
    public MailEditor() {
        setCompositionRoot(buildMainLayout());
        
        i18n = new I18nManager(this);
        val = new ValidatorManager(this);
        
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    
    public void setProjecttId(Integer projectId) {
        this.projectId = projectId;
    }
    
    public void setPatientId(Integer patientId) {
        this.patientId = patientId;
    }

    public void setNurseId(Integer nurseId) {
        this.nurseId = nurseId;
    }

    public void setExternalId(Integer externalId) {
        this.externalId = externalId;
    }
    
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    public Window show() {
        
        win = null;
        
        try {
            win = generateWindow();    
        } catch (IllegalArgumentException e) {
            i18n.notifier(notifier.error_mail);
        }
        
        return win;
    }
    
    // {end publicmethods}



    // {section privatemethods}
    // ************************
    
    private Window  generateWindow() {
        
        if(projectId == null) {
            throw new IllegalArgumentException("missing projectId");
        }
        if(patientId == null) {
            throw new IllegalArgumentException("missing patientId");
        }
        if(nurseId == null) {
            throw new IllegalArgumentException("missing nurseId");
        }

        init();
        
        Window win = new Window(i18n.get(caption.title),this);
        win.setModal(true);
        win.setHeight(height);
        win.setWidth(width);
        win.center();
        win.setDraggable(false);
        win.setResizable(false);
        UI.getCurrent().getUI().addWindow(win);
        
        return win;
    }
    
    private void init() {
        
        this.patientInfo = dbGetPatientInfo();
        this.externalInfo = dbGetExternalInfo();
        this.nurseInfo = dbGetNurseInfo();
        this.projectInfo = dbGetProjectInfo();
        
        if(patientInfo == null) {
            throw new IllegalArgumentException("patientInfo not found"); 
        }
        if(nurseInfo == null) {
            throw new IllegalArgumentException("nurseInfo not found"); 
        }
        
        configureComponents();
        
        render = new TemplatingRenderer();
        render.loadTemplate("tpl_new_assignment");
        
        addRenderItem(render, patientInfo);
        addRenderItem(render, nurseInfo);
        addRenderItem(render, projectInfo);
        addRenderItem(render, externalInfo);
        render.with("custom", customMessage.getValue());
        
        preview.setValue(render.render());
        preview.setReadOnly(true);
    }
    
    private void configureComponents() {
        
        new RegexValidator(sender, ".+@.+", null, null, false);
        new RegexValidator(recipient, ".+@.+", null, null, false);
        
        sender.setImmediate(true);
        recipient.setImmediate(true);
        
        sender.setValue(MyUtils.getValueFromItem(projectInfo, "projectMail", String.class));
        recipient.setValue(MyUtils.getValueFromItem(nurseInfo, "nurseMail", String.class));
        
        customMessage.setImmediate(true);
        customMessage.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                render.with("custom", customMessage.getValue());
                preview.setReadOnly(false);
                preview.setValue(render.render());
                preview.setReadOnly(true);
            }
        });
        
        send.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {

                if(!recipient.isValid() || !sender.isValid()) {
                    log.warn("invalid mail addresses");
                    return;
                }
                
                //TASK validator!
                sendMail();
                if(win != null) {
                    win.close();
                }
                
            }
        });
    }
    
    private void sendMail() {
        
        
        Mailer mail = new Mailer(CMS_Config_Std.getInstance());
        mail.setSender(sender.getValue());
        mail.setSubject(i18n.get(caption.new_assignment));
        mail.setType(MAIL_TYPE.HTML);
        mail.addRecipient(recipient.getValue());
        mail.setContent(render.render());
        
        mail.send();
        
    }
    
    @SuppressWarnings("unchecked")
    private void addRenderItem(TemplatingRenderer render, Item item) {
        
        if(item == null) {
            return;
        }
        
        for (Object pid : item.getItemPropertyIds()) {
            render.with(pid.toString(), MyUtils.getValueFromItem(item, pid, item.getItemProperty(pid).getType()));
        }
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    private Item dbGetPatientInfo() {
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select "
         + "\n " + "    CONCAT_WS(' ', ASA_NAME, PSL_VORNAME, PSL_NAME) as patient,"
         + "\n " + "    PSL_STRASSE as street,"
         + "\n " + "    PSL_ZUSATZ as additional,"
         + "\n " + "    PSL_PLZ as plz,"
         + "\n " + "    PSL_ORT as city,"
         + "\n " + "    PSL_COUNTYCODE as country,"
         + "\n " + "    PSL_TEL as phone,"
         + "\n " + "    PSL_HANDY as mobile,"
         + "\n " + "    PSL_EMAIL as mail"
         + "\n " + "from cust_patient_stammdaten_liste"
         + "\n " + "left join cms_auth_stammdaten_anrede on PSL_ANREDE = ASA_ID"
         + "\n " + "where PSL_ID = " + patientId;
        q.setSqlString(sql);
        
        return MyUtils.getFirstItemFromContainer(q.query());
        
    }
    
    private Item dbGetExternalInfo() {
        
        if(externalId == null) {
            return null;
        }
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select "
         + "\n " + "    CONCAT_WS(' ', ASA_NAME, SAD_VORNAME, SAD_NAME) as extName,"
         + "\n " + "    SAD_TEL as extPhone"
         + "\n " + "from cust_stammdaten_aussendienst"
         + "\n " + "left join cms_auth_stammdaten_anrede on SAD_ID_ANREDE = ASA_ID"
         + "\n " + "where SAD_ID = " + externalId;
        q.setSqlString(sql);
        
        return MyUtils.getFirstItemFromContainer(q.query());
        
    }
    
    private Item dbGetNurseInfo() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select "
         + "\n " + "    CONCAT_WS(' ', ASA_NAME, AUL_VORNAME, AUL_NAME) as nurse,"
         + "\n " + "    AUL_EMAIL as nurseMail"
         + "\n " + "from cust_krankenschwester_stammdaten_ks"
         + "\n " + "left join cms_auth_stammdaten_user on AUL_ID = KSK_U_ID"
         + "\n " + "left join cms_auth_stammdaten_anrede on AUL_ANREDE_ID = ASA_ID"
         + "\n " + "where KSK_ID = " + nurseId;
        q.setSqlString(sql);
        
        return MyUtils.getFirstItemFromContainer(q.query());
    }
    
    private Item dbGetProjectInfo() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSLV_NAME as project, PSLV_PROJECT_MAIL as projectMail"
            + "\n " + "from cust_projekte_stammdaten_liste"
            + "\n " + "where PSLV_ID = " + projectId;
        q.setSqlString(sql);
        
        return MyUtils.getFirstItemFromContainer(q.query());
    }
    
    // {end database}

    // {section layout}
    // ****************
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 1.0f);
        mainLayout.setComponentAlignment(horizontalLayout_1, new Alignment(48));
        
        // preview
        preview = new RichTextArea();
        preview.setImmediate(false);
        preview.setWidth("90.0%");
        preview.setHeight("100.0%");
        mainLayout.addComponent(preview);
        mainLayout.setExpandRatio(preview, 6.0f);
        mainLayout.setComponentAlignment(preview, new Alignment(48));
        
        // customMessage
        customMessage = new RichTextArea();
        customMessage.setCaption("customMessage");
        customMessage.setImmediate(false);
        customMessage.setWidth("90.0%");
        customMessage.setHeight("100.0%");
        mainLayout.addComponent(customMessage);
        mainLayout.setExpandRatio(customMessage, 3.0f);
        mainLayout.setComponentAlignment(customMessage, new Alignment(48));
        
        // send
        send = new Button();
        send.setCaption("send");
        send.setImmediate(true);
        send.setWidth("-1px");
        send.setHeight("-1px");
        mainLayout.addComponent(send);
        mainLayout.setExpandRatio(send, 1.0f);
        mainLayout.setComponentAlignment(send, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("90.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(false);
        
        // sender
        sender = new TextField();
        sender.setCaption("sender");
        sender.setImmediate(false);
        sender.setWidth("-1px");
        sender.setHeight("-1px");
        horizontalLayout_1.addComponent(sender);
        horizontalLayout_1.setComponentAlignment(sender, new Alignment(48));
        
        // recipient
        recipient = new TextField();
        recipient.setCaption("recipient");
        recipient.setImmediate(false);
        recipient.setWidth("-1px");
        recipient.setHeight("-1px");
        horizontalLayout_1.addComponent(recipient);
        horizontalLayout_1.setComponentAlignment(recipient, new Alignment(48));
        
        return horizontalLayout_1;
    }
    
    // {end layout}
}
