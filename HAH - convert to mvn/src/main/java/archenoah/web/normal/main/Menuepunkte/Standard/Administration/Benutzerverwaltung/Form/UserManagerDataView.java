package archenoah.web.normal.main.Menuepunkte.Standard.Administration.Benutzerverwaltung.Form;

import org.tepi.filtertable.FilterTable;

import archenoah.UIS.UI_Functions;
import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.CustomConverterFactorys.CustomConverterFactory;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;

import com.github.wolfie.refresher.Refresher;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

import de.steinwedel.messagebox.ButtonId;
// import
// archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Filter.Decorator_Forsteo;
// import
// archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Filter.Generator_Forsteo;
import de.steinwedel.messagebox.MessageBoxListener;

public class UserManagerDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */
    enum Status {
    }

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private VerticalLayout verticalLayout_2;

    @AutoGenerated
    private FilterTable tbl_users;

    @AutoGenerated
    private MenuBar men_frm;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Allgemein
    private UI_Functions me;
    private Refresher refresher;
    private CMS_Config_Std std;
    private String Exportname;
    // Datenbank
    private final Object[][] Filter = null;
    private Container cont_Momentan;
    private FilteringTableUpdater userTableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem Temp_Menü = null;

    private Button Temp_Btn = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_create;

    private MenuBar.MenuItem btn_update;

    private MenuBar.MenuItem btn_read;

    private MenuBar.MenuItem btn_delete;

    private MenuBar.MenuItem btn_filter;

    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PollListener pollListener = null;

    /************ ----->Einstellungen<-- ********************/
//    private final String LNG_FRM_ID = "6";
    private static String formName = "UserManagerDataView";
    private final String BER_MEN_ID = "12";
    private final String Windows_Height = "600px";
    private final String Windows_Width = "900px";
    private final int Datenholen_MS = 5000;
    private final boolean Datenholen_An = true;

    private final String NOT_Del = "37";

    /******************************************************/

    //private final Object[] filtercols = new Object[] { "ID", "Patient", "Arzt", "Krankenschwester", "Tag", "Monat", "Jahr", "Status" };
    private final Object[] defaultcols = new Object[] { "AUL_ID", "AUL_USERNAME", "ASA_NAME", "AUL_NAME", "AUL_VORNAME", "AUL_TEL",
            "AUL_EMAIL", "AUL_PASS_RESET", "AUL_AKTIV" };
    private final Object[] activecols = defaultcols;

    private I18nManager i18n;

    /******************************************************/

    public UserManagerDataView(MenuItem Arg_Menü) {
        Temp_Menü = Arg_Menü;

        // TODO add user code here
    }

    public UserManagerDataView(Button Arg_btn) {

        Temp_Btn = Arg_btn;

        // TODO add user code here
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: Abmessungen");
            return;
        }

        Standard_Init();

        if (Temp_Menü != null) {
            String Recourcename = Temp_Menü.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Exportname = Temp_Menü.getText();
            Build_Window_Button bwb = new Build_Window_Button(Temp_Menü.getText(), mainLayout, Windows_Height, Windows_Width,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Window_Button bwb = new Build_Window_Button(Temp_Btn.getCaption(), mainLayout, Windows_Height, Windows_Width,
                    Temp_Btn.getIcon());
            win = bwb.ReturnWindow();
        }

        win.addDetachListener(onDetach);

    }

    /********* INIT-Tray ************/
    public void Init_Class_Tab(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (Temp_Menü != null) {
            Exportname = Temp_Menü.getText();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Menü.getText(), mainLayout, Temp_Menü.getIcon());
        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Btn.getCaption(), mainLayout, Temp_Btn.getIcon());
        }

        tab.getSelectedTab().addDetachListener(onDetach);
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        std = CMS_Config_Std.getInstance();
        buildMainLayout();
        i18n = new I18nManager(this);

        generateMenu();
        setMenuPermissions();

        me = new UI_Functions();

        setTableUpdater();
        updateTable();
        configureTable();

        setupListenersAndDetachEvent();
        i18n.refresh();
    }

    private void setupListenersAndDetachEvent() {
        pollListener = new PollListener() {

            @Override
            public void poll(PollEvent event) {
                if(tab.isRendered(mainLayout)){
                    updateTable();
                }
            }
        };

        UI.getCurrent().getUI().addPollListener(pollListener);

        onDetach = new DetachListener() {

            @Override
            public void detach(DetachEvent event) {
                UI.getCurrent().getUI().removePollListener(pollListener);
            }
        };
    }

    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (BER_MEN_ID == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(BER_MEN_ID) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_create.setEnabled(c);
        btn_create.setVisible(c);

        btn_read.setEnabled(r);
        btn_read.setVisible(r);

        btn_update.setEnabled(u);
        btn_update.setVisible(u);

        btn_delete.setEnabled(d);
        btn_delete.setVisible(d);
    }


    /************ -><- ******************/

    /***************** Comands *********************/
    public Command cmd_btn_add = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            pop_benutzer_insert_edit pg = new pop_benutzer_insert_edit(selectedItem, "");
            
        }
    };
    
    public Command cmd_btn_read = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if(tbl_users.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String userId = Integer.toString((Integer) tbl_users.getContainerProperty(tbl_users.getValue(), "AUL_ID").getValue());
            pop_benutzer_insert_edit pg = new pop_benutzer_insert_edit(selectedItem, userId, true);

        }
    };
    
    public Command cmd_btn_edit = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            
            if(tbl_users.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String userId = Integer.toString((Integer) tbl_users.getContainerProperty(tbl_users.getValue(), "AUL_ID").getValue());
            pop_benutzer_insert_edit pg = new pop_benutzer_insert_edit(selectedItem, userId);

        }
    };

    public Command cmd_btn_del = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            
            if(tbl_users.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String userId = Integer.toString((Integer) tbl_users.getContainerProperty(tbl_users.getValue(), "AUL_ID").getValue());
            deleteUser(userId);

        }
    };

    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_users.setFilterBarVisible(true);
                tbl_users.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_users.setFilterBarVisible(!tbl_users.isFilterBarVisible());

        }
    };


    /******************************************/

    /*********** Gen Menüs *************/
    private void generateMenu() {

        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);

    }

    /*************************** Config TBL ********************/
    private void setTableUpdater() {

    }

    private void configureTable() {
        tbl_users.setSelectable(true);
        tbl_users.setFilterOnDemand(false);
        tbl_users.setImmediate(true);
        tbl_users.setColumnCollapsingAllowed(false);
        tbl_users.setFooterVisible(true);

        tbl_users.setPageLength(1);

        userTableUpdater = new FilteringTableUpdater(tbl_users);

        CustomConverterFactory ccf = new CustomConverterFactory();

        tbl_users.setConverter("AUL_AKTIV", ccf.createConverter(String.class, Boolean.class));
        tbl_users.setConverter("AUL_PASS_RESET", ccf.createConverter(String.class, Boolean.class));
    }

    /*************************** Database ********************/

    private void updateTable() {

        if (!tbl_users.isFilterBarVisible()) {
            dbGetContainer();
            tbl_users.setVisibleColumns(activecols);
        }

    }
    
    private void deleteUser(final String id){
        
        if (id.equals("1")) {
            I18nManager.global(I18nGlobalNotifiers.admin_user_not_deletable);
            return;
        }
        
        I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
            
            @Override
            public void buttonClicked(ButtonId arg0) {
                if(ButtonId.YES == arg0) {
                    dbDeleteUser(id);
                }
            }
        });
    }
    
    private void dbGetContainer() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_USERNAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("ASA_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_VORNAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_TEL");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_EMAIL");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_AKTIV");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_PASS_RESET");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cms_auth_stammdaten_anrede",
                "AUL_ANREDE_ID", "ASA_ID");

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_USERNAME", "NOT", "LIKE('')", "");

        Container container = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (userTableUpdater != null) {
            userTableUpdater.updateTable(container);
        } else {
            tbl_users.setContainerDataSource(container);
        }

    }
    
    private void dbDeleteUser(String id){
    
        CMS_Config_Std std = CMS_Config_Std.getInstance();
    
        DBClass db = new DBClass();
        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_stammdaten_user");
        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_ID", "=", id , "");
        db.DB_Data_Delete.DB_Delete();
    
    }
    
    /*********************************************************/

    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);

        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");

        // horizontalLayout_2
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("100.0%");
        horizontalLayout_2.setMargin(false);
        mainLayout.addComponent(horizontalLayout_2);
        mainLayout.setExpandRatio(horizontalLayout_2, 1.0f);

        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        mainLayout.addComponent(verticalLayout_2);
        mainLayout.setExpandRatio(verticalLayout_2, 10.0f);
        mainLayout.setComponentAlignment(verticalLayout_2, new Alignment(20));

        // horizontalLayout_1
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(false);
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 1.0f);

        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);

        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        verticalLayout_2.addComponent(men_frm);
        verticalLayout_2.setExpandRatio(men_frm, 1.0f);
        verticalLayout_2.setComponentAlignment(men_frm, new Alignment(48));

        // tbl_frm
        tbl_users = new FilterTable();
        tbl_users.setImmediate(true);
        tbl_users.setWidth("100.0%");
        tbl_users.setHeight("90.0%");
        // tbl_frm.setFilterDecorator(new Decorator_Forsteo());
        // tbl_frm.setFilterGenerator(new Generator_Forsteo());
        // tbl_frm.setContainerDataSource(Get_Data_Container());

        verticalLayout_2.addComponent(tbl_users);
        verticalLayout_2.setExpandRatio(tbl_users, 10.0f);
        verticalLayout_2.setComponentAlignment(tbl_users, new Alignment(20));

        return verticalLayout_2;
    }
}
