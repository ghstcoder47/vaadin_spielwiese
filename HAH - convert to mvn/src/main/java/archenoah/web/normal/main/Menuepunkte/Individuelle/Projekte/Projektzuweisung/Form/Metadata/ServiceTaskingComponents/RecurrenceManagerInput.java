package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form.Metadata.ServiceTaskingComponents;

import java.text.DateFormat;
import java.util.ArrayList;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowDataField;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowDataFieldConverter;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowPopupInput;
import archenoah.lib.vaadin.Components.Recurrence.PART;
import archenoah.lib.vaadin.Components.Recurrence.RecurrenceInput;
import archenoah.lib.vaadin.Components.Recurrence.RruleItem;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

public class RecurrenceManagerInput extends CustomComponent implements MultiRowPopupInput{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Button save;
    @AutoGenerated
    private RecurrenceInput recurrence;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private ComboBox type;
    // {section fields}
    // ****************
    private Window win;
    private I18nConverter typeConverter;
    private SaveAction saveAction; 
    // {end fields}
    private MultiRowDataFieldConverter typeFieldConverter;
    private MultiRowDataFieldConverter dateFieldConverter;

    // {section constructors}
    // **********************
    public RecurrenceManagerInput() {
        buildMainLayout();
        configureConverters();
        configureComponents();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public void setTypeConverter(I18nConverter typeConverter) {
        this.typeConverter = typeConverter;
        this.typeConverter.attachDatasource(type);
    }
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    

    @Override
    public ArrayList<MultiRowDataField> getFields() {
        ArrayList<MultiRowDataField> list = new ArrayList<MultiRowDataField>();
        
        MultiRowDataField typef = new MultiRowDataField(type, "STMD_TYPE", Integer.class);
        typef.setConverter(typeConverter);
        list.add(typef);
        
        MultiRowDataField start = new MultiRowDataField(recurrence.getField(PART.START), "STMD_RRULE_START", java.sql.Date.class);
        start.setFieldConverter(dateFieldConverter);
        StringSqlTimestampConverter date = new StringSqlTimestampConverter();
        date.setDateFormat(DateFormat.SHORT);
        start.setConverter(date);
        list.add(start);
        
        list.add(new MultiRowDataField(recurrence.getField(PART.RRULE), "STMD_RRULE", String.class));
        list.add(new MultiRowDataField(recurrence.getField(PART.CUSTOM), "STMD_RRULE_CUSTOM", Integer.class));
        
        
        return list ;
    }

    @Override
    public void show() {
        if(win == null) {
            Build_Window_Button bwb = new Build_Window_Button("Protokollgenerierung definieren", mainLayout, "500", "540", null);
            win = bwb.ReturnWindow();
            
            win.addCloseListener(new CloseListener() {
                
                @Override
                public void windowClose(CloseEvent e) {
                    
                    //clear fields since reopening does not create a new instance
                    type.setValue(null);
                    recurrence.setValue(null);
                    toggleEnabled(true);
                    
                }
            });
            
        }else {
            UI.getCurrent().getUI().addWindow(win);
        }
    }
    
    @Override
    public void setValue(Item item) {
        type.setValue(MyUtils.getValueFromItem(item, "STMD_TYPE", Integer.class));
        
        RruleItem ri = new RruleItem(item);
        ri.setPropertyFor(PART.START, "STMD_RRULE_START");
        ri.setPropertyFor(PART.RRULE, "STMD_RRULE");
        ri.setPropertyFor(PART.CUSTOM, "STMD_RRULE_CUSTOM");
        recurrence.setValue(ri);
        
        toggleEnabled(false);
    }
    
    @Override
    public void setSaveAction(SaveAction saveAction) {
        
        this.saveAction = saveAction;
        
    }
    
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    private void configureConverters() {
//        activeFieldConverter = new MultiRowDataFieldConverter() {
//            @Override
//            public Object convertForTable(MultiRowDataField field) {
//                return new java.sql.Date(((java.util.Date) field.getField().getValue()).getTime());
//            }
//        };
        
        dateFieldConverter = new MultiRowDataFieldConverter() {
            @Override
            public Object convertForTable(MultiRowDataField field) {
                return new java.sql.Date(((java.util.Date) field.getField().getValue()).getTime());
            }
        };
        
    }
    
    private void configureComponents() {
        save.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(type.getValue() == null
                    || !recurrence.isValid()){
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                    return;
                }
                
                if(saveAction != null) {
                    saveAction.onSave(getFields());
                }
                
                win.close();
                
            }
        });
    }
    
    private void toggleEnabled(Boolean enabled) {
        type.setEnabled(enabled);
        type.setStyleName(enabled ? "" : "nogrey"); 
        recurrence.setEnabled(enabled);
        save.setVisible(enabled);
        save.setEnabled(enabled);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    // {end database}

    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("-1px");
        mainLayout.setMargin(true);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("-1px");
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        mainLayout.addComponent(horizontalLayout_1);
        
        // recurrence
        recurrence = new RecurrenceInput();
        recurrence.setImmediate(false);
        recurrence.setWidth("100.0%");
        recurrence.setHeight("-1px");
        mainLayout.addComponent(recurrence);
        mainLayout.setComponentAlignment(recurrence, new Alignment(48));
        
        // save
        save = new Button();
        save.setCaption("Speichern");
        save.setImmediate(true);
        save.setWidth("-1px");
        save.setHeight("-1px");
        mainLayout.addComponent(save);
        mainLayout.setComponentAlignment(save, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(false);
        
        // type
        type = new ComboBox();
        type.setCaption("Typ");
        type.setImmediate(false);
        type.setWidth("-1px");
        type.setHeight("-1px");
        horizontalLayout_1.addComponent(type);
        horizontalLayout_1.setComponentAlignment(type, new Alignment(48));
        
        return horizontalLayout_1;
    }
}
