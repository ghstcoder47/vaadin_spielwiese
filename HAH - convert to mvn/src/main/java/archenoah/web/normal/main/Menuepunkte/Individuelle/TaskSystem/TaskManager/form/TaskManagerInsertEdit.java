package archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.form;

import java.sql.Timestamp;
import java.text.DateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.LinkedHashSet;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;

import org.vaadin.tokenfield.TokenField;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.ContainerTool;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.Components.Validators.ContextHelper;
import archenoah.lib.vaadin.Components.Validators.RegexValidator;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.valchecker.val_checker4;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskGroups.classes.TaskGroupsData;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.classes.TTYPE;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.classes.TaskManagerMailHandler;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.classes.TaskManagerMailHandler.MTYPE;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.classes.UserContainer;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.form.FieldChangeEntries.ValueContainerCollection;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.data.Property;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.shared.ui.label.ContentMode;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.Panel;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.RichTextArea;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TabSheet.SelectedTabChangeEvent;
import com.vaadin.ui.TabSheet.SelectedTabChangeListener;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

@SuppressWarnings({"serial", "rawtypes", "unchecked"})
public class TaskManagerInsertEdit extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;

    @AutoGenerated
    private HorizontalLayout buttons;

    @AutoGenerated
    private Button btn_save;

    @AutoGenerated
    private VerticalLayout main;

    @AutoGenerated
    private Panel panelMain;

    @AutoGenerated
    private VerticalLayout layoutMain;

    @AutoGenerated
    private TabSheet tabChanges;

    @AutoGenerated
    private Panel panelChanges;

    @AutoGenerated
    private VerticalLayout layoutChanges;

    @AutoGenerated
    private VerticalLayout layoutOptions;

    @AutoGenerated
    private HorizontalLayout layoutOptionsDivider;

    @AutoGenerated
    private VerticalLayout layoutDescription;

    @AutoGenerated
    private TokenField tokenTags;

    @AutoGenerated
    private TabSheet tabTextFields;

    @AutoGenerated
    private VerticalLayout layoutExternalContacts;

    @AutoGenerated
    private TextArea textExternalContact;

    @AutoGenerated
    private VerticalLayout layoutSolutionTab;

    @AutoGenerated
    private RichTextArea textareaSolution;

    @AutoGenerated
    private VerticalLayout layoutDescriptionTab;

    @AutoGenerated
    private RichTextArea textareaDescription;

    @AutoGenerated
    private VerticalLayout layoutHelp;

    @AutoGenerated
    private RichTextArea textareaHelp;

    @AutoGenerated
    private VerticalLayout layoutInfo;

    @AutoGenerated
    private RichTextArea textareaInfo;

    @AutoGenerated
    private Label labelInfo;

    @AutoGenerated
    private VerticalLayout layoutOptionsRight;

    @AutoGenerated
    private PopupDateField dateDue;

    @AutoGenerated
    private ComboBox comboAssignee;

    @AutoGenerated
    private ComboBox comboResponsible;

    @AutoGenerated
    private ComboBox comboDepartment;

    @AutoGenerated
    private ComboBox comboCreator;

    @AutoGenerated
    private VerticalLayout layoutOptionsLeft;

    @AutoGenerated
    private PopupDateField dateReminder;

    @AutoGenerated
    private AbsoluteLayout spacer1;

    @AutoGenerated
    private ComboBox comboStatus;

    @AutoGenerated
    private ComboBox comboConcerns;

    @AutoGenerated
    private ComboBox comboPriority;

    @AutoGenerated
    private ComboBox comboTopic;

    @AutoGenerated
    private ComboBox comboType;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private VerticalLayout layoutDate;

    @AutoGenerated
    private Label labelDate;

    @AutoGenerated
    private VerticalLayout layoutTitle;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;

    @AutoGenerated
    private TextField textTitle;

    @AutoGenerated
    private Label labelTitle;

    

    

    

    

    

    

    

    

    

    

    

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    private org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    // Allgemein
    private CMS_Config_Std std;
    private String exportCaption;
    
    // Datenbank
    private Map<Object, String> componentMap;
    private Map<Object, String> dbMap;
    private Map<Object, String> validateMap;
    private Form_Bind fb;
    private String dataSetId = "";

    private I18nManager i18nParent;
    
    // Berrechtigung
    private int ACC_ID;
	private Integer permRead;
	private Integer permUpdate;
	private Integer permCreate;
	private Integer permDelete;

    private MenuItem tmpMenu = null;
    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;
    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/
    
    private ChangeEntry changeComment;
    private TabSheet.Tab changeCommentTab;
    private TabSheet.Tab newCommentTab;
    private Boolean newComment = false;
    
    
    private UserContainer userContainer;
    
    private  Container formContainer;
    private Container tagContainer;
    private HashMap<String, Object> oldMap;
    private  HashMap<String, Object> newMap;
    
    private ValueContainerCollection valueContainerCollection;
    
    private IntStepper topicFilterIdField = new IntStepper();
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "302";
    private final String formIdPerm = "301";
    private final String Windows_Height = "750px";
    private final String Windows_Width = "900px";
    
    private final String dataIdCol = "TMT_ID";
    private final String dataTableName = "cust_taskmanager_tasks";

    private TTYPE type;

	private TaskManagerMailHandler mailHandler;

    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB titleContextHelp = set();
        
        static final I18nCB capaDescription = set();
        static final I18nCB capaSolution = set();
        static final I18nCB capaFinding = set();
        
        static final I18nCB newComment = set();
    }
    
    /******************************************************/

    public TaskManagerInsertEdit(MenuItem Arg_Menü, String Arg_Form_ID) {
        tmpMenu = Arg_Menü;
        dataSetId = Arg_Form_ID;
    }

    public TaskManagerInsertEdit(Button Arg_btn, String Arg_Form_ID) {
        tmpButton = Arg_btn;
        dataSetId = Arg_Form_ID;
    }

    /********* INIT-Window ************/
    public void init(I18nManager i18nParent) {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }
        
        this.i18nParent = i18nParent;
        
        Standard_Init();

        String fid = dataSetId;
        if (fid != "") {
            fid = " - #" + fid;
        }

        if (tmpMenu != null) {
        	
            String Recourcename = null;
            ThemeResource resource = null;
            if(tmpMenu.getIcon() != null){
            	Recourcename = tmpMenu.getIcon().toString();
            	Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";
            	resource = new ThemeResource(Recourcename);
            }

            exportCaption = tmpMenu.getText();
            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText() + fid, mainLayout, Windows_Height, Windows_Width, resource);
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            exportCaption = tmpButton.getCaption();
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption() + fid, mainLayout, Windows_Height, Windows_Width, tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

    }

    /********* INIT-Tray ************/
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            exportCaption = tmpMenu.getText();
            new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            exportCaption = tmpButton.getCaption();
            new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        
        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        
        registerComponents();
        
        fillFields();
        fillDbMap();

        setCustomValidators();
        

        /***************/

        setMenuPermissions();
        configureComponents();
        
        if (dataSetId != "") {
        	
            dbFillForm();
            dbFillFormTags();
            dbFillFormChanges();
            dbFillInfo();
            configureReadonly();
            initFilledForm();
            
        } else {
            
//        	configureReadonly();
        	initEmptyForm();
        	
        }

        
        toggleExternalContacts();
        setEventListeners();
        componentListeners();
        
        /**********************/
        
        fillValidateMap();
        
        /**********************/
        i18n.ignore(
            labelTitle,
            labelInfo,
            labelDate
            );
        
        i18n.replace(
            tabTextFields.getTab(layoutDescriptionTab),
            tabTextFields.getTab(layoutSolutionTab),
            tabTextFields.getTab(layoutInfo));
        
        i18n.refresh();
    }
    
    public void setType (TTYPE type) {
        this.type = type;
    }
    
    public void setTopicId(Integer tid){
        topicFilterIdField.setValue(tid);
    }
    
    public void setTitle(String title) {
        textTitle.setValue(title);
    }
    
    public void setInfo(String info, String help) {
        
        tabTextFields.getTab(layoutInfo).setVisible(info != null);
        textareaInfo.setReadOnly(false);
        textareaInfo.setValue(info);
        layoutInfo.setMargin(true);
        textareaInfo.setReadOnly(true);
        
        tabTextFields.getTab(layoutHelp).setVisible(help != null);
        textareaHelp.setReadOnly(false);
        textareaHelp.setValue(help);
        layoutHelp.setMargin(true);
        textareaHelp.setReadOnly(true);
    }
    
    public void setInfo(String title, String info, String help) {
        
        log.info("title: {}, info: {}, help: {}", title, info, help);
        
        setInfo(info, help);
        labelInfo.setValue("<b>"+ title + "</b>");
        labelInfo.setVisible(title != null && !"".equals(title));
        
    }
    
 // register components for lng and validation tools
    private void registerComponents(){
    	componentMap = new HashMap<Object, String>();
    	new ComponentIterator(main).createMap(componentMap);
    }
    
    
    private void configureComponents(){ //TASK this needs reworking if there is ever a third type!
    	
    	for (Entry<Object, String> entry : componentMap.entrySet()) {
    		AbstractField field = (AbstractField) entry.getKey();
    		
			field.setImmediate(true);
			
			if(field instanceof ComboBox){
				((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
			}

		}
    	
    	mainLayout.setStyleName("taskmanager-entry");
    	
    	horizontalLayout_1.setStyleName("cust_margin_half_full_none_full");
    	layoutOptions.setStyleName("cust_margin_half_full_none_full");
    	
    	labelTitle.setContentMode(ContentMode.HTML);
    	labelTitle.setStyleName("label-title");
    	textTitle.setVisible(false);
    	
    	labelInfo.setContentMode(ContentMode.HTML);
    	
    	comboTopic.setImmediate(true);
    	comboTopic.setItemCaptionPropertyId("TMMTO_TOPIC");
    	comboTopic.setNullSelectionAllowed(false);
    	
    	comboCreator.setEnabled(false);
    	comboCreator.setStyleName("nogrey");
    	
    	comboType.setNullSelectionAllowed(false);
//    	comboSeverity.setNullSelectionAllowed(false);
    	comboPriority.setVisible(type == TTYPE.TASK);
    	comboPriority.setRequired(type == TTYPE.TASK);
    	comboPriority.setNullSelectionAllowed(false);
    	
//    	comboCapaRating.setVisible(type == TTYPE.CAPA);
//    	comboCapaRating.setRequired(type == TTYPE.CAPA);
//    	comboCapaRating.setNullSelectionAllowed(false);
    	
    	comboStatus.setNullSelectionAllowed(false);
    	
    	dateReminder.setVisible(type == TTYPE.CAPA); //TASK extend on new type
    	spacer1.setVisible(type == TTYPE.CAPA);
    	
    	comboResponsible.setNullSelectionAllowed(false);
    	
    	comboDepartment.setItemCaptionPropertyId("TMG_NAME");
    	
    	textareaDescription.setImmediate(true);
    	textareaDescription.setRequired(type == TTYPE.CAPA);
    	textareaDescription.setNullRepresentation("");
    	textareaDescription.setNullSettingAllowed(true);
    	textareaSolution.setImmediate(true);
    	textExternalContact.setImmediate(true);
    	textExternalContact.setStyleName("cust_textarea_no_margin");
    	
    	tokenTags.setFilteringMode(FilteringMode.CONTAINS);
    	tokenTags.setTokenCaptionPropertyId("caption");
    	
//    	changeEntry_1.setEditable(true);
    	
    	changeComment = new ChangeEntry(i18nParent, valueContainerCollection);
    	changeComment.setEditable(true);
    	changeComment.setHeight("200px");
    	
    	//tabChanges.addComponent(changeComment);
    	changeCommentTab = tabChanges.addTab(changeComment, "Bearbeitungskommentar");
    	changeCommentTab.setVisible(false);
    	
    	tabTextFields.getTab(layoutInfo).setVisible(false);
    	tabTextFields.getTab(layoutHelp).setVisible(false);
    	
    	// migrated from database
    	comboPriority.setRequired(true);
    	comboResponsible.setRequired(true);
    	comboStatus.setRequired(true);
    	textTitle.setRequired(true);
    	dateDue.setRequired(true);
    	comboType.setRequired(true);
    	comboTopic.setRequired(true);
    	
    	//"mindestens 10, maximal 50 Zeichen"
    	new ContextHelper(textTitle, i18n.get(caption.titleContextHelp));
    	new RegexValidator(textTitle, "^.{10,125}$", null, null, false);
    	// migration end
    	
    	//CAPA mode
    	if(type == TTYPE.CAPA) {
    	    
    	    tabTextFields.getTab(layoutDescriptionTab).setCaption(i18n.get(caption.capaDescription));
    	    tabTextFields.getTab(layoutSolutionTab).setCaption(i18n.get(caption.capaSolution));
    	    
    	    comboConcerns.setVisible(false);
	        
	        comboAssignee.setRequired(true);
	        comboAssignee.setNullSelectionAllowed(false);
	        
	        tabTextFields.getTab(layoutInfo).setVisible(true);
	        tabTextFields.getTab(layoutInfo).setCaption(i18n.get(caption.capaFinding));
	        
            tabTextFields.getTab(layoutHelp).setVisible(true);
	        
	        tabTextFields.setSelectedTab(0);
    	    
    	}
    	
    }
    
    private void configureReadonly(){
    	
        Boolean ro = type != TTYPE.CAPA;
        
    	layoutDescriptionTab.setMargin(ro);
//    	layoutSolutionTab.setMargin(true);
    	
    	textareaDescription.setReadOnly(ro);
//    	textareaSolution.setReadOnly(true);
    	
    }
    
    private void initFilledForm(){
    	newCommentTab = tabChanges.addTab(new VerticalLayout(), i18n.get(caption.newComment));
    }
    
    private void componentListeners(){
    	
    	ValueChangeListener vcl = new ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				
				updateDifference();
				
			}
		};
    	
    	dateDue.addValueChangeListener(vcl);
    	dateReminder.addValueChangeListener(vcl);
    	textExternalContact.addValueChangeListener(vcl);
    	for (Entry<Object, String> entry : componentMap.entrySet()) {
    		AbstractField field = (AbstractField) entry.getKey();
			
			if(field instanceof ComboBox){
				((ComboBox)field).addValueChangeListener(vcl);
			}

		}

    	comboType.setImmediate(true);
    	comboType.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                toggleExternalContacts();
                                
            }
        });
    	
    	tabChanges.addSelectedTabChangeListener(new SelectedTabChangeListener() {
			
			@Override
			public void selectedTabChange(SelectedTabChangeEvent event) {
				
				if(newCommentTab.equals(event.getTabSheet().getTab(event.getTabSheet().getSelectedTab()))){
					newComment = true;
					updateDifference();
				}
				
			}
		});
    	
    	comboDepartment.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                if(comboAssignee.getValue() == null) {
                    comboAssignee.setValue(comboDepartment.getContainerDataSource().getItem(comboDepartment.getValue())
                            .getItemProperty("TMG_ID_USER_LEAD").getValue());
                }
                
            }
        });
    	
    	comboAssignee.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                // call sort on first itemId to trigger filterAll()
                IndexedContainer cds = (IndexedContainer) comboStatus.getContainerDataSource();
                cds.sort(cds.getSortableContainerPropertyIds().toArray(), new boolean[] {true});
                if(!comboStatus.containsId(comboStatus.getValue())) {
                    comboStatus.setValue(comboStatus.getItemIds().iterator().next());
                }
            }
        });
    	
    	((IndexedContainer) comboStatus.getContainerDataSource()).addContainerFilter(new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                
                Boolean res = true;
                
                res = !(comboAssignee.getValue() == null
                        && item.getItemProperty("TMMST_TOKEN") != null
                        && !item.getItemProperty("TMMST_TOKEN").getValue().equals("status_new")); 
                
                return res;
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return propertyId.equals("TMMST_TOKEN");
            }
        });
    	
    }
    
    private void toggleExternalContacts() {
        //type_complaint                
        Boolean isComplaint = MyUtils.equalsWithNulls(comboType.getValue(), 2);
        tabTextFields.getTab(layoutExternalContacts).setVisible(isComplaint);
        if(!isComplaint && oldMap != null) {
            
            textExternalContact.setValue((String) oldMap.get("TMT_EXTERNAL_CONTACT"));
            
        }
        
    }
    
    private void fillLngConverters(){
    	I18nConverter typeConverter = new I18nConverter("cust_taskmanager_master_types", "TMMT_ID", "TMMT_TOKEN");
    	I18nConverter statusConverter = new I18nConverter("cust_taskmanager_master_status", "TMMST_ID", "TMMST_TOKEN");
    	I18nConverter priorityConverter = new I18nConverter("cust_taskmanager_master_priorities", "TMMP_ID", "TMMP_TOKEN");
//    	LngConverter capaRatingConverter = new LngConverter(fid, "cust_audit_master_rating", "AMR_TOKEN", "AMR_ID");
    	
    	valueContainerCollection.addContainer("TMT_ID_TYPE", typeConverter.getLocalizedContainer(), "TMMT_ID", "TMMT_TOKEN", typeConverter);
    	valueContainerCollection.addContainer("TMT_ID_STATUS", statusConverter.getLocalizedContainer(), "TMMST_ID", "TMMST_TOKEN", statusConverter);
    	valueContainerCollection.addContainer("TMT_ID_PRIORITY", priorityConverter.getLocalizedContainer(), "TMMP_ID", "TMMP_TOKEN", priorityConverter);
//    	valueContainerCollection.addContainer("TMT_CAPA_RATING", capaRatingConverter.getContainer(), "AMR_ID", "AMR_TOKEN", capaRatingConverter);
    	
    	fillFromConverter(typeConverter, comboType);
    	fillFromConverter(statusConverter, comboStatus);
    	fillFromConverter(priorityConverter, comboPriority);
//    	fillFromConverter(capaRatingConverter, comboCapaRating);
    	
    	((IndexedContainer) comboType.getContainerDataSource()).addContainerFilter(new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                
                return MyUtils.getValueFromItem(item, "TMMT_TYPE", String.class).equals(type.toString());
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return false;
            }
        });

    	
    }
    
    private void fillFromConverter(final I18nConverter converter, final ComboBox combo){
        
        converter.attachDatasource(combo);
        
    }
    
    /*************************** Events *******************************/

    private void setEventListeners() {

        btn_save.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {

                if (validate() == false) {
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                    return;
                }
                
                mailHandler = new TaskManagerMailHandler();
                
                if (dataSetId.equals("") == true) {
                	
                    Integer insertId = dbInsert();
                    
                    dataSetId = Integer.toString(insertId);
                    
                    if(topicFilterIdField.getValue() != 0){
                        dbLinkTopic();
                    }
                    
                    mailHandler.setTaskId(insertId);
                    mailHandler.addNotification(MTYPE.NEW);
                    
                } else {
                	
                    dbUpdate();
                    
                    mailHandler.setTaskId(Integer.parseInt(dataSetId));

                }
                
				dbSaveTags();
				saveDifference();
	            
	            checkMailNotifications();

                //TASK check if save successful
				if(!dataSetId.equals("0")){
					UI.getCurrent().getUI().removeWindow(win);
					
					mailHandler.sendMails();
					
				}else{
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                    return;
				}
                
            }

        });

       
    }

    /******************************************************************/
    
    /************************ --> Berrechtigung <-- **************************/

    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_save.setEnabled((c||u));

    }
    
    /***********************************************/
    
    private void initEmptyForm(){
    	
    	labelTitle.setVisible(false);
    	labelDate.setVisible(false);
    	textTitle.setVisible(true);
    	textTitle.setWidth("100%");
    	
    	comboCreator.setValue(ACC_ID);
    	textareaDescription.setReadOnly(false);
    	textareaSolution.setReadOnly(false);
    	
    	comboStatus.setValue(1);
    	comboPriority.setValue(0);
    	comboResponsible.setValue(ACC_ID);
    	
    }
    
    private void fillFields(){
    	
    	valueContainerCollection = new ValueContainerCollection();
    	
    	fillLngConverters();
    	
    	userContainer = new UserContainer();
    	
    	valueContainerCollection.addContainer("TMT_ID_USER_CREATOR", userContainer.getContainer(), "AUL_ID", "user");
    	valueContainerCollection.addContainer("TMT_ID_USER_RESPONSIBLE", userContainer.getContainer(), "AUL_ID", "user");
    	valueContainerCollection.addContainer("TMT_ID_USER_ASSIGNEE", userContainer.getContainer(), "AUL_ID", "user");
    	valueContainerCollection.addContainer("TMT_ID_USER_CONCERNS", userContainer.getContainer(), "AUL_ID", "user");
    	
    	fillUserCombo(comboCreator, userContainer);
    	fillUserCombo(comboResponsible, userContainer);
    	fillUserCombo(comboAssignee, userContainer);
    	fillUserCombo(comboConcerns, userContainer);
    	
    	dbFillDepartement();
    	dbFillTopics();
    	dbFillTags();
    }

    private void fillUserCombo(ComboBox combobox, UserContainer con){
    	
//    	combo.setOverrideDefaultId(true);
//    	combo.setIdProperty("AUL_ID");
//    	combo.setItemCaptionPropertyId("user");
//    	combo.setContainerDataSource(con.getContainer());
    	
    	new combo(con.getContainer(), combobox, "AUL_ID", "user");
    	
    }
    
    /***********************************************/
    
    private void setFixedFields(Item item){
    	setTitle(item);
    	setCreated(item);
    }
    
    
    private void setTitle(Item item){
    	
    	String title = (String) item.getItemProperty("TMT_TITLE").getValue();
    	labelTitle.setValue(title);
    
    }
    
    private void setCreated(Item item){
    	
    	java.sql.Timestamp ts = (Timestamp) item.getItemProperty("TMT_CREATED").getValue();
    	
		StringSqlTimestampConverter time = new StringSqlTimestampConverter();
		time.setDateFormat(DateFormat.SHORT);
		time.setTimeFormat(DateFormat.SHORT);
		
		String date = time.convertToPresentation(ts, String.class, new Locale("DE"));
    	
    	labelDate.setValue(date);
    	
    }
    
    
    private void checkMailNotifications() {
        
        if(newMap == null) {
            return;
        }
        
        // status change
        if(newMap.containsKey("TMT_ID_STATUS")) {
//            System.out.println("status changed");
//            System.out.println(comboDepartment.getContainerProperty(comboDepartment.getValue(), "TMG_MAIL").getValue());
          
            mailHandler.addNotification(MyUtils.equalsWithNulls(newMap.get("TMT_ID_STATUS"), 0) ? MTYPE.CLOSED : MTYPE.CHANGE_STATUS);
        }
        
        // user assigned
        if(newMap.containsKey("TMT_ID_USER_ASSIGNEE")) {
//            System.out.println("assignee changed");
//            System.out.println(MyUtils.getItemFromContainer(userContainer.getContainer(), "AUL_ID", comboAssignee.getValue()));
            mailHandler.addNotification(MTYPE.CHANGE_ASSIGNEE);
        }
        
    }
    
    /************************************************/
    
    private void updateDifference(){
    	
    	
    	if(!newComment && formContainer == null){
    		return;
    	}
    	
    	oldMap = new HashMap<>();
    	newMap = new HashMap<>();
    	
    	Item formItem = formContainer.getItem(formContainer.getItemIds().iterator().next());
    	
    	for (Entry<Object, String> entry : dbMap.entrySet()) {
			
    		AbstractField field = (AbstractField) entry.getKey();
    		
    		String[] split = entry.getValue().split(":");
    		
    		String col = (split[1]);
    		
    		Property prop = formItem.getItemProperty(col);
    		
    		if(!MyUtils.equalsWithNulls(prop.getValue(), field.getValue())){
    			
    			oldMap.put(col, prop.getValue());
    			newMap.put(col, field.getValue());
    			
    		}
    		
		}
    	
    	
    	if(newComment || newMap.size() > 0){
    		changeCommentTab.setVisible(true);
    		tabChanges.setSelectedTab(changeCommentTab);
			newCommentTab.setVisible(false);
    	}else{
    		changeCommentTab.setVisible(false);
			newCommentTab.setVisible(!newComment);
    		tabChanges.setSelectedTab(0);
    	}
    	
    	
    	
    	changeComment.setFieldChanges(new FieldChangeEntries(i18nParent, valueContainerCollection, oldMap, newMap));
    	

    }
    
    
    
    /******************** Database *****************/
    private void fillDbMap() {
        dbMap = new HashMap<>();
//        dbMap.put(component, "table:COLUMN");
        
        dbMap.put(textTitle, dataTableName + ":TMT_TITLE");
        
        dbMap.put(comboAssignee, dataTableName + ":TMT_ID_USER_ASSIGNEE");
        dbMap.put(comboCreator, dataTableName + ":TMT_ID_USER_CREATOR");
        dbMap.put(comboResponsible, dataTableName + ":TMT_ID_USER_RESPONSIBLE");
        dbMap.put(comboConcerns, dataTableName + ":TMT_ID_USER_CONCERNS");
        
//        dbMap.put(comboDepartment, dataTableName + ":");
//        dbMap.put(comboDepartment, dataTableName + ":");

        dbMap.put(comboTopic, dataTableName + ":TMT_ID_TOPIC");
        dbMap.put(comboType, dataTableName + ":TMT_ID_TYPE");
//        dbMap.put(comboSeverity, dataTableName + ":TMT_ID_SEVERITY");
        dbMap.put(comboPriority, dataTableName + ":TMT_ID_PRIORITY");
//        dbMap.put(comboCapaRating, dataTableName + ":TMT_CAPA_RATING");
        dbMap.put(comboStatus, dataTableName + ":TMT_ID_STATUS");
        
        dbMap.put(comboDepartment, dataTableName + ":TMT_ID_DEPARTMENT");
        
        
        dbMap.put(dateReminder, dataTableName + ":TMT_REMINDER_DATE");
        dbMap.put(dateDue, dataTableName + ":TMT_DUE");
        
        dbMap.put(textareaDescription, dataTableName + ":TMT_DESCRIPTION");
        dbMap.put(textareaSolution, dataTableName + ":TMT_SOLUTION");
        dbMap.put(textExternalContact, dataTableName + ":TMT_EXTERNAL_CONTACT");
        
        

    }

    private void dbFillForm() {
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();

        /******************************** Table ****************************************/
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
        /******************************************************************************/
        /******************************** Filter ****************************************/
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein(dataTableName, dataIdCol, "=", dataSetId, "");
        /******************************************************************************/

        // db.DB_Data_Get.Set_Type("SLF_VON_UHRZEIT", Date.class);
        // db.DB_Data_Get.Set_Type("SLF_BIS_UHRZEIT", Date.class);
        
        db.debugNextQuery(false);
        
        formContainer = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        Item item = formContainer.getItem(formContainer.getItemIds().iterator().next());
        setFixedFields(item);
        fb = new Form_Bind();
        
        if(formContainer.size() > 0){
        	fb.Get_and_Fill(formContainer, dbMap);
        }
        
    }

    private void dbFillFormTags(){
    	
    	String table = "cust_taskmanager_task_labels";
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
    	db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein(table, "TMTL_ID_TASK", "=", dataSetId, "");
    	Container tags = db.DB_Data_Get.DB_SEND_AND_GET_Container();
    	
    	for (Object tagId : tags.getItemIds()) {
			tokenTags.addToken(tags.getContainerProperty(tagId, "TMTL_ID_TAG").getValue());
		}
    	
    }
    
    private void dbFillInfo() {
        
        if(type != TTYPE.CAPA) {
            return;
        }
        
        DBClass db = new DBClass();

        String sql = "select ALF_TITLE, ALF_OBSERVATIONS, ALF_HELP"
                 + "\n " + "from cust_taskmanager_meeting_topic_tasks"
                 + "\n " + "inner join cust_audit_logging_findings on TMETT_ID_TOPIC = ALF_ID and TMETT_TYPE = 'TYPE_CAPA'"
                 + "\n " + "where cust_taskmanager_meeting_topic_tasks.TMETT_ID_TASK = " + dataSetId;
        
        db.CustomQuery.setSqlString(sql);
//        db.debugNextQuery(true);
        
        Item item = MyUtils.getFirstItemFromContainer(db.CustomQuery.query());
            
        setInfo(MyUtils.getValueFromItem(item, "ALF_TITLE", String.class), 
                MyUtils.getValueFromItem(item, "ALF_OBSERVATIONS", String.class),
                MyUtils.getValueFromItem(item, "ALF_HELP", String.class));

        
    }
    
    private void dbFillFormChanges(){
    	
    	String table = "cust_taskmanager_tasks_logs";
    	String hashProperty = "TMT_HASH";
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
    	db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	db.DB_Data_Get.DB_Ordnen.DB_Ordnen("TMT_CREATED", "ASC");
    	
    	Container oldContainer = getChangesByType(db, table, "old");
    	Container newContainer = getChangesByType(db, table, "new");
    	
    	LinkedHashMap<String, TaskManagerInsertEdit.ChangeData> changeMap = new LinkedHashMap<String, TaskManagerInsertEdit.ChangeData>();

		if(!oldContainer.getContainerPropertyIds().contains(hashProperty)
				|| !newContainer.getContainerPropertyIds().contains(hashProperty)){
			return;
		}
		
		// fill changeMap from old values
    	for (Object id : oldContainer.getItemIds()) {
    		
    		String hash = (String) oldContainer.getContainerProperty(id, hashProperty).getValue();
    		
    		if(hash != null){
    			ChangeData data = new ChangeData(hash);
    			data.setOldValues(oldContainer.getItem(id));
    			changeMap.put(hash, data);
    		}
			
		}
    	
    	// set newValues for each hash pair
    	for (Object id : newContainer.getItemIds()) {
    		
    		String hash = (String) newContainer.getContainerProperty(id, hashProperty).getValue();
    		
    		if(hash != null && changeMap.get(hash) != null){
    			changeMap.get(hash).setNewValues(newContainer.getItem(id));
    		}
			
		}
    	
    	// add new ChangeEntries to change log tab content
    	for (Entry<String, ChangeData> entry : changeMap.entrySet()) {
			
    		layoutChanges.addComponent(new ChangeEntry(i18nParent, valueContainerCollection, entry.getValue().oldValues, entry.getValue().newValues));
    		
		}
    	
        layoutChanges.setHeight(null);
        panelChanges.setScrollTop(Integer.MAX_VALUE);
    }
    
    class ChangeData{
    	
    	private String hash;
    	private Item oldValues;
    	private Item newValues;
    	
    	ChangeData(String hash){
    		this.hash = hash;
    	}
    	
		public String getHash() {
			return hash;
		}

		public Item getOldValues() {
			return oldValues;
		}

		public void setOldValues(Item oldValues) {
			this.oldValues = oldValues;
		}

		public Item getNewValues() {
			return newValues;
		}

		public void setNewValues(Item newValues) {
			this.newValues = newValues;
		}
    	
    	
    }
    
    private Container getChangesByType(DBClass db, String table, String type){
    	db.DB_Data_Get.DB_Filter.DB_Data_Leeren();
    	db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein(table, "TMT_ID_REFERENCE", "=", dataSetId, "AND");
    	db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein(table, "TMT_ENTRY_TYPE", "=", "'" + type + "'", "");
    	
    	db.debugNextQuery(false);
    	
    	return db.DB_Data_Get.DB_SEND_AND_GET_Container();
    }
    
    private Integer dbLinkTopic(){
        DBClass db = new DBClass();
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_taskmanager_meeting_topic_tasks");
        db.DB_Data_Insert.DB_Daten.DB_Data("cust_taskmanager_meeting_topic_tasks", "TMETT_ID_TOPIC", topicFilterIdField.getValue().toString());
        db.DB_Data_Insert.DB_Daten.DB_Data("cust_taskmanager_meeting_topic_tasks", "TMETT_ID_TASK", dataSetId);
        db.DB_Data_Insert.DB_Daten.DB_Data("cust_taskmanager_meeting_topic_tasks", "TMETT_TYPE", type.toString());
        return db.DB_Data_Insert.DB_Insert();
    }
    
    private int dbInsert() {
        DBClass db = new DBClass();
        fb = new Form_Bind();
        fb.Insert(db, dbMap);
        db.DB_Data_Insert.DB_Daten.DB_Data(dataTableName, "TMT_SYSTEM_TYPE", type.toString());
        /******************************** Table ****************************************/
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
        /******************************************************************************/
        // dba.DB_Data_Insert.DB_DEBUG_SQL_STRING();
        return db.DB_Data_Insert.DB_Insert();
    }

    private void dbUpdate() {
        DBClass db = new DBClass();
        fb = new Form_Bind();
        fb.Update(db, dbMap);

        /******************************** Table ****************************************/
        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
        /******************************************************************************/
        /******************************** Filter ****************************************/
        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein(dataTableName, dataIdCol, "=", dataSetId, "");
        /******************************************************************************/
        db.debugNextQuery(false);
        db.DB_Data_Update.DB_Update();

    }
    
    private void dbSaveTags(){
    	String table = "cust_taskmanager_task_labels";
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein(table, "TMTL_ID_TASK", "=", dataSetId, "");
    	db.DB_Data_Delete.DB_Delete();
    	
    	
    	
    	
    	db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	
    	
    	LinkedHashSet hs = (LinkedHashSet) tokenTags.getValue();
    	
    	if(hs != null){
    	
	    	for (Object object : hs) {
				
	    		Integer tid;
	    		
				if(!(object instanceof Integer)){
					tid = dbInsertNewTag(object.toString());
				}else{
					tid = (Integer) object;
				}
				
				db.DB_Data_Insert.DB_Daten.DB_Data_Leeren();
				db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMTL_ID_TASK", dataSetId);
				db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMTL_ID_TAG", tid.toString());
				db.DB_Data_Insert.DB_Insert();
			}
	    	
    	}

    	
    }
    
    private int dbInsertNewTag(String name){
    	
    	String table = "cust_taskmanager_labels";
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TML_TEXT", name);
    	
    	return db.DB_Data_Insert.DB_Insert();
    }
    
    private void saveDifference(){
    	
    	Date date = new Date();
    	
    	String hash = Integer.toHexString(date.hashCode());
    	
    	if(oldMap != null && newMap != null
    			&& oldMap.size() > 0 && newMap.size() > 0
    			&& oldMap.size() == newMap.size()){
    		
    		hash = Integer.toHexString(oldMap.keySet().toString().hashCode())
        			+ Integer.toHexString(oldMap.entrySet().toString().hashCode())
        			+ Integer.toHexString(newMap.keySet().toString().hashCode())
        			+ Integer.toHexString(newMap.entrySet().toString().hashCode())
        			+ Integer.toHexString(date.hashCode());
    		
    		dbSaveDifference(oldMap, false, hash);
        	dbSaveDifference(newMap, true, hash);
        	
    	}else if(newComment){
    		dbSaveDifference(null, false, hash);
    		dbSaveDifference(null, true, hash);
    	}
    	
    	
    }
    
    private int dbSaveDifference(HashMap<String, Object> map, Boolean isNewValue, String hash){
    	
    	if(map == null && changeComment.getCommentComponent().getValue().length() == 0){
    		return -1;
    	}
    	
    	String table = "cust_taskmanager_tasks_logs";
    	
    	DBClass db = new DBClass();
    	db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(table);
    	
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMT_ID_USER_CREATOR", Integer.toString(ACC_ID));
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMT_ENTRY_TYPE", isNewValue ? "new" : "old");
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMT_ID_REFERENCE", dataSetId);
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMT_HASH", hash);
    	
    	db.DB_Data_Insert.DB_Daten.DB_Data(table, "TMT_COMMENT", isNewValue ? changeComment.getCommentComponent().getValue() : null);
    	
    	if(map != null){
	    	for (Entry<String, Object> entry : map.entrySet()) {
	    		
	    		String value = "";
	    		
	    		if(entry.getValue() == null){
	    			
	    			value = null;
	    			
	    		}else{
	    		
		    		if(entry.getValue() instanceof java.util.Date){
		    			value = new java.sql.Timestamp(((java.util.Date) entry.getValue()).getTime()).toString();
		    		}else{
		    			value = entry.getValue().toString();
		    		}
		    		
	    		}
	    		
				db.DB_Data_Insert.DB_Daten.DB_Data(table, entry.getKey(), value);
			}
    	}
    	db.debugNextQuery(false);
    	
    	return db.DB_Data_Insert.DB_Insert();
    	
    }
    
    private void dbFillTopics() {
        
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_taskmanager_master_topics");
        
        Container con = db.DB_Data_Get.DB_SEND_AND_GET();
        valueContainerCollection.addContainer("TMT_ID_TOPIC", con, "TMMTO_ID", "TMMTO_TOPIC");
        
        comboTopic.setContainerDataSource(MyUtils.convertIndex(con, "TMMTO_ID"));
        
        ((IndexedContainer) comboTopic.getContainerDataSource()).addContainerFilter(new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                
                return MyUtils.getValueFromItem(item, "TMMTO_TYPE", String.class).equals(type.toString());
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return false;
            }
        });
        
    }
    
    private void dbFillDepartement(){
    	
    	comboDepartment.setContainerDataSource(TaskGroupsData.getGroups());
    	valueContainerCollection.addContainer("TMT_ID_DEPARTMENT", comboDepartment.getContainerDataSource(), "TMG_ID", "TMG_NAME");
    	
    }

    private void dbFillTags(){
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
    	db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_taskmanager_labels");
    	db.DB_Data_Get.DB_Ordnen.DB_Ordnen("LOWER(TML_TEXT)", "ASC");
    	tagContainer = db.DB_Data_Get.DB_SEND_AND_GET_Container();
    	
   	
    	Container tokenContainer = new IndexedContainer();
    	tokenContainer.addContainerProperty("caption", String.class, i18nParent.get(TaskManagerDataView.caption.field_empty));
    	tokenTags.setContainerDataSource(tokenContainer);
    	
    	ContainerTool ct = new ContainerTool(tagContainer);
    	ct.iterateItems(ct.new IterationInstruction() {
			
			@Override
			public void runInstruction(ContainerTool ctt, Object itemId, Item item, Object[] objects) {
				
				tokenTags.getContainerDataSource().addItem(ctt.getContainerValue(itemId, "TML_ID"))
				.getItemProperty("caption").setValue(ctt.getContainerValue(itemId, "TML_TEXT"));

			}
		});
    	
    }
    
    /*********************** -->Validierung<-- ********************/
    private void fillValidateMap() {
        validateMap = new HashMap<>();
        validateMap.putAll(componentMap);
        
        validateMap.put(textareaDescription, tabTextFields.getTab(layoutDescriptionTab).getCaption());

    }

    private void setCustomValidators() {

        // psw_pass_1.addValidator(new Custom_Benutzerform_psw_ändern(psw_pass_1, psw_pass_2));

        /******* manual actions *******/

    }

    private boolean validate() {
        val_checker4 val = new val_checker4(validateMap);
        if (val.Is_Valid() == false) {
            return false;
        } else {
            return true;
        }

    }

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // main
        main = buildMain();
        mainLayout.addComponent(main);
        mainLayout.setExpandRatio(main, 9.0f);
        mainLayout.setComponentAlignment(main, new Alignment(48));
        
        // buttons
        buttons = buildButtons();
        mainLayout.addComponent(buttons);
        mainLayout.setExpandRatio(buttons, 1.0f);
        mainLayout.setComponentAlignment(buttons, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildMain() {
        // common part: create layout
        main = new VerticalLayout();
        main.setImmediate(false);
        main.setWidth("100.0%");
        main.setHeight("100.0%");
        main.setMargin(false);
        main.setSpacing(true);
        
        // panelMain
        panelMain = buildPanelMain();
        main.addComponent(panelMain);
        main.setComponentAlignment(panelMain, new Alignment(48));
        
        return main;
    }

    @AutoGenerated
    private Panel buildPanelMain() {
        // common part: create layout
        panelMain = new Panel();
        panelMain.setImmediate(false);
        panelMain.setWidth("100.0%");
        panelMain.setHeight("100.0%");
        
        // layoutMain
        layoutMain = buildLayoutMain();
        panelMain.setContent(layoutMain);
        
        return panelMain;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutMain() {
        // common part: create layout
        layoutMain = new VerticalLayout();
        layoutMain.setImmediate(false);
        layoutMain.setWidth("100.0%");
        layoutMain.setHeight("100.0%");
        layoutMain.setMargin(false);
        layoutMain.setSpacing(true);
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        layoutMain.addComponent(horizontalLayout_1);
        
        // layoutOptions
        layoutOptions = buildLayoutOptions();
        layoutMain.addComponent(layoutOptions);
        layoutMain.setExpandRatio(layoutOptions, 1.0f);
        
        // tabChanges
        tabChanges = buildTabChanges();
        layoutMain.addComponent(tabChanges);
        
        return layoutMain;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(true);
        
        // layoutTitle
        layoutTitle = buildLayoutTitle();
        horizontalLayout_1.addComponent(layoutTitle);
        horizontalLayout_1.setExpandRatio(layoutTitle, 1.0f);
        
        // layoutDate
        layoutDate = buildLayoutDate();
        horizontalLayout_1.addComponent(layoutDate);
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutTitle() {
        // common part: create layout
        layoutTitle = new VerticalLayout();
        layoutTitle.setImmediate(false);
        layoutTitle.setWidth("100.0%");
        layoutTitle.setHeight("-1px");
        layoutTitle.setMargin(false);
        
        // labelTitle
        labelTitle = new Label();
        labelTitle.setImmediate(false);
        labelTitle.setWidth("-1px");
        labelTitle.setHeight("-1px");
        layoutTitle.addComponent(labelTitle);
        
        // horizontalLayout_2
        horizontalLayout_2 = buildHorizontalLayout_2();
        layoutTitle.addComponent(horizontalLayout_2);
        
        return layoutTitle;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_2() {
        // common part: create layout
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("-1px");
        horizontalLayout_2.setMargin(false);
        horizontalLayout_2.setSpacing(true);
        
        // textTitle
        textTitle = new TextField();
        textTitle.setCaption("Zusammenfassung");
        textTitle.setImmediate(false);
        textTitle.setWidth("-1px");
        textTitle.setHeight("-1px");
        horizontalLayout_2.addComponent(textTitle);
        horizontalLayout_2.setExpandRatio(textTitle, 1.0f);
        
        return horizontalLayout_2;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutDate() {
        // common part: create layout
        layoutDate = new VerticalLayout();
        layoutDate.setImmediate(false);
        layoutDate.setWidth("-1px");
        layoutDate.setHeight("-1px");
        layoutDate.setMargin(false);
        
        // labelDate
        labelDate = new Label();
        labelDate.setImmediate(false);
        labelDate.setWidth("-1px");
        labelDate.setHeight("-1px");
        layoutDate.addComponent(labelDate);
        
        return layoutDate;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutOptions() {
        // common part: create layout
        layoutOptions = new VerticalLayout();
        layoutOptions.setImmediate(false);
        layoutOptions.setWidth("100.0%");
        layoutOptions.setHeight("100.0%");
        layoutOptions.setMargin(true);
        
        // layoutOptionsDivider
        layoutOptionsDivider = buildLayoutOptionsDivider();
        layoutOptions.addComponent(layoutOptionsDivider);
        
        return layoutOptions;
    }

    @AutoGenerated
    private HorizontalLayout buildLayoutOptionsDivider() {
        // common part: create layout
        layoutOptionsDivider = new HorizontalLayout();
        layoutOptionsDivider.setImmediate(false);
        layoutOptionsDivider.setWidth("100.0%");
        layoutOptionsDivider.setHeight("100.0%");
        layoutOptionsDivider.setMargin(false);
        layoutOptionsDivider.setSpacing(true);
        
        // layoutOptionsLeft
        layoutOptionsLeft = buildLayoutOptionsLeft();
        layoutOptionsDivider.addComponent(layoutOptionsLeft);
        
        // layoutOptionsRight
        layoutOptionsRight = buildLayoutOptionsRight();
        layoutOptionsDivider.addComponent(layoutOptionsRight);
        
        // layoutDescription
        layoutDescription = buildLayoutDescription();
        layoutOptionsDivider.addComponent(layoutDescription);
        layoutOptionsDivider.setExpandRatio(layoutDescription, 1.0f);
        
        return layoutOptionsDivider;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutOptionsLeft() {
        // common part: create layout
        layoutOptionsLeft = new VerticalLayout();
        layoutOptionsLeft.setImmediate(false);
        layoutOptionsLeft.setWidth("160px");
        layoutOptionsLeft.setHeight("100.0%");
        layoutOptionsLeft.setMargin(false);
        
        // comboType
        comboType = new ComboBox();
        comboType.setCaption("Typ");
        comboType.setImmediate(false);
        comboType.setWidth("100.0%");
        comboType.setHeight("-1px");
        layoutOptionsLeft.addComponent(comboType);
        
        // comboTopic
        comboTopic = new ComboBox();
        comboTopic.setCaption("Thema");
        comboTopic.setImmediate(false);
        comboTopic.setWidth("100.0%");
        comboTopic.setHeight("-1px");
        layoutOptionsLeft.addComponent(comboTopic);
        
        // comboPriority
        comboPriority = new ComboBox();
        comboPriority.setCaption("Priorität");
        comboPriority.setImmediate(false);
        comboPriority.setWidth("100.0%");
        comboPriority.setHeight("-1px");
        layoutOptionsLeft.addComponent(comboPriority);
        
        // comboConcerns
        comboConcerns = new ComboBox();
        comboConcerns.setCaption("Betrifft");
        comboConcerns.setImmediate(false);
        comboConcerns.setWidth("100.0%");
        comboConcerns.setHeight("-1px");
        layoutOptionsLeft.addComponent(comboConcerns);
        
        // comboStatus
        comboStatus = new ComboBox();
        comboStatus.setCaption("Status");
        comboStatus.setImmediate(false);
        comboStatus.setWidth("100.0%");
        comboStatus.setHeight("-1px");
        layoutOptionsLeft.addComponent(comboStatus);
        
        // spacer1
        spacer1 = new AbsoluteLayout();
        spacer1.setImmediate(false);
        spacer1.setWidth("-1px");
        spacer1.setHeight("-1px");
        layoutOptionsLeft.addComponent(spacer1);
        
        // dateReminder
        dateReminder = new PopupDateField();
        dateReminder.setCaption("Reminder");
        dateReminder.setImmediate(false);
        dateReminder.setWidth("100.0%");
        dateReminder.setHeight("-1px");
        layoutOptionsLeft.addComponent(dateReminder);
        
        return layoutOptionsLeft;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutOptionsRight() {
        // common part: create layout
        layoutOptionsRight = new VerticalLayout();
        layoutOptionsRight.setImmediate(false);
        layoutOptionsRight.setWidth("160px");
        layoutOptionsRight.setHeight("100.0%");
        layoutOptionsRight.setMargin(false);
        
        // comboCreator
        comboCreator = new ComboBox();
        comboCreator.setCaption("Erstellt von");
        comboCreator.setImmediate(false);
        comboCreator.setWidth("100.0%");
        comboCreator.setHeight("-1px");
        layoutOptionsRight.addComponent(comboCreator);
        
        // comboDepartment
        comboDepartment = new ComboBox();
        comboDepartment.setCaption("Abteilung");
        comboDepartment.setImmediate(false);
        comboDepartment.setWidth("100.0%");
        comboDepartment.setHeight("-1px");
        layoutOptionsRight.addComponent(comboDepartment);
        
        // comboResponsible
        comboResponsible = new ComboBox();
        comboResponsible.setCaption("Verantwortlich");
        comboResponsible.setImmediate(false);
        comboResponsible.setWidth("100.0%");
        comboResponsible.setHeight("-1px");
        layoutOptionsRight.addComponent(comboResponsible);
        
        // comboAssignee
        comboAssignee = new ComboBox();
        comboAssignee.setCaption("Zugewiesen an");
        comboAssignee.setImmediate(false);
        comboAssignee.setWidth("100.0%");
        comboAssignee.setHeight("-1px");
        layoutOptionsRight.addComponent(comboAssignee);
        
        // dateDue
        dateDue = new PopupDateField();
        dateDue.setCaption("Fälligkeitsdatum");
        dateDue.setImmediate(false);
        dateDue.setWidth("100.0%");
        dateDue.setHeight("-1px");
        layoutOptionsRight.addComponent(dateDue);
        
        return layoutOptionsRight;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutDescription() {
        // common part: create layout
        layoutDescription = new VerticalLayout();
        layoutDescription.setImmediate(false);
        layoutDescription.setWidth("100.0%");
        layoutDescription.setHeight("100.0%");
        layoutDescription.setMargin(false);
        layoutDescription.setSpacing(true);
        
        // tabTextFields
        tabTextFields = buildTabTextFields();
        layoutDescription.addComponent(tabTextFields);
        layoutDescription.setExpandRatio(tabTextFields, 1.0f);
        
        // tokenTags
        tokenTags = new TokenField();
        tokenTags.setCaption("Stichworte");
        tokenTags.setImmediate(false);
        tokenTags.setWidth("-1px");
        tokenTags.setHeight("-1px");
        layoutDescription.addComponent(tokenTags);
        
        return layoutDescription;
    }

    @AutoGenerated
    private TabSheet buildTabTextFields() {
        // common part: create layout
        tabTextFields = new TabSheet();
        tabTextFields.setImmediate(true);
        tabTextFields.setWidth("100.0%");
        tabTextFields.setHeight("100.0%");
        
        // layoutInfo
        layoutInfo = buildLayoutInfo();
        tabTextFields.addTab(layoutInfo, "Info", null);
        
        // layoutHelp
        layoutHelp = buildLayoutHelp();
        tabTextFields.addTab(layoutHelp, "Hilfestellung", null);
        
        // layoutDescriptionTab
        layoutDescriptionTab = buildLayoutDescriptionTab();
        tabTextFields.addTab(layoutDescriptionTab, "Beschreibung", null);
        
        // layoutSolutionTab
        layoutSolutionTab = buildLayoutSolutionTab();
        tabTextFields.addTab(layoutSolutionTab, "Lösung", null);
        
        // layoutExternalContacts
        layoutExternalContacts = buildLayoutExternalContacts();
        tabTextFields.addTab(layoutExternalContacts, "Externer Kontakt", null);
        
        return tabTextFields;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutInfo() {
        // common part: create layout
        layoutInfo = new VerticalLayout();
        layoutInfo.setImmediate(false);
        layoutInfo.setWidth("100.0%");
        layoutInfo.setHeight("100.0%");
        layoutInfo.setMargin(false);
        layoutInfo.setSpacing(true);
        
        // labelInfo
        labelInfo = new Label();
        labelInfo.setImmediate(false);
        labelInfo.setWidth("100.0%");
        labelInfo.setHeight("-1px");
        layoutInfo.addComponent(labelInfo);
        
        // textareaInfo
        textareaInfo = new RichTextArea();
        textareaInfo.setImmediate(false);
        textareaInfo.setWidth("100.0%");
        textareaInfo.setHeight("100.0%");
        layoutInfo.addComponent(textareaInfo);
        layoutInfo.setExpandRatio(textareaInfo, 1.0f);
        
        return layoutInfo;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutHelp() {
        // common part: create layout
        layoutHelp = new VerticalLayout();
        layoutHelp.setImmediate(false);
        layoutHelp.setWidth("100.0%");
        layoutHelp.setHeight("100.0%");
        layoutHelp.setMargin(false);
        
        // textareaHelp
        textareaHelp = new RichTextArea();
        textareaHelp.setImmediate(false);
        textareaHelp.setWidth("100.0%");
        textareaHelp.setHeight("100.0%");
        layoutHelp.addComponent(textareaHelp);
        
        return layoutHelp;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutDescriptionTab() {
        // common part: create layout
        layoutDescriptionTab = new VerticalLayout();
        layoutDescriptionTab.setImmediate(false);
        layoutDescriptionTab.setWidth("100.0%");
        layoutDescriptionTab.setHeight("100.0%");
        layoutDescriptionTab.setMargin(false);
        
        // textareaDescription
        textareaDescription = new RichTextArea();
        textareaDescription.setImmediate(false);
        textareaDescription.setWidth("100.0%");
        textareaDescription.setHeight("100.0%");
        layoutDescriptionTab.addComponent(textareaDescription);
        
        return layoutDescriptionTab;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutSolutionTab() {
        // common part: create layout
        layoutSolutionTab = new VerticalLayout();
        layoutSolutionTab.setImmediate(false);
        layoutSolutionTab.setWidth("100.0%");
        layoutSolutionTab.setHeight("100.0%");
        layoutSolutionTab.setMargin(false);
        
        // textareaSolution
        textareaSolution = new RichTextArea();
        textareaSolution.setImmediate(false);
        textareaSolution.setWidth("100.0%");
        textareaSolution.setHeight("100.0%");
        layoutSolutionTab.addComponent(textareaSolution);
        
        return layoutSolutionTab;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutExternalContacts() {
        // common part: create layout
        layoutExternalContacts = new VerticalLayout();
        layoutExternalContacts.setImmediate(false);
        layoutExternalContacts.setWidth("100.0%");
        layoutExternalContacts.setHeight("100.0%");
        layoutExternalContacts.setMargin(false);
        
        // textExternalContact
        textExternalContact = new TextArea();
        textExternalContact.setImmediate(false);
        textExternalContact.setWidth("100.0%");
        textExternalContact.setHeight("100.0%");
        layoutExternalContacts.addComponent(textExternalContact);
        
        return layoutExternalContacts;
    }

    @AutoGenerated
    private TabSheet buildTabChanges() {
        // common part: create layout
        tabChanges = new TabSheet();
        tabChanges.setImmediate(true);
        tabChanges.setWidth("100.0%");
        tabChanges.setHeight("-1px");
        
        // panelChanges
        panelChanges = buildPanelChanges();
        tabChanges.addTab(panelChanges, "Änderungshistorie", null);
        
        return tabChanges;
    }

    @AutoGenerated
    private Panel buildPanelChanges() {
        // common part: create layout
        panelChanges = new Panel();
        panelChanges.setImmediate(false);
        panelChanges.setWidth("100.0%");
        panelChanges.setHeight("200px");
        
        // layoutChanges
        layoutChanges = new VerticalLayout();
        layoutChanges.setImmediate(false);
        layoutChanges.setWidth("100.0%");
        layoutChanges.setHeight("100.0%");
        layoutChanges.setMargin(false);
        panelChanges.setContent(layoutChanges);
        
        return panelChanges;
    }

    @AutoGenerated
    private HorizontalLayout buildButtons() {
        // common part: create layout
        buttons = new HorizontalLayout();
        buttons.setImmediate(false);
        buttons.setWidth("100.0%");
        buttons.setHeight("100.0%");
        buttons.setMargin(false);
        
        // btn_save
        btn_save = new Button();
        btn_save.setCaption("Speichern");
        btn_save.setImmediate(true);
        btn_save.setWidth("-1px");
        btn_save.setHeight("-1px");
        buttons.addComponent(btn_save);
        buttons.setComponentAlignment(btn_save, new Alignment(48));
        
        return buttons;
    }

}
