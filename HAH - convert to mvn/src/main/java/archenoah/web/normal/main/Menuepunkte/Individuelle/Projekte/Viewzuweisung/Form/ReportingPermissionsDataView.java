package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Viewzuweisung.Form;

import java.util.HashMap;

import org.tepi.filtertable.FilterTable;

import archenoah.lib.custom.PauseablePollListener;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Viewzuweisung.classes.ReportingGroupPermissions;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Viewzuweisung.classes.ReportingUserPermissions;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.event.ItemClickEvent;
import com.vaadin.event.ItemClickEvent.ItemClickListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;


public class ReportingPermissionsDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private VerticalLayout vl_main;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;

    @AutoGenerated
    private VerticalLayout verticalLayout_3;

    @AutoGenerated
    private Button btnSave;

    @AutoGenerated
    private TabSheet permissionTab;

    @AutoGenerated
    private ReportingUserPermissions userPermissions;

    @AutoGenerated
    private ReportingGroupPermissions groupPermissions;

    @AutoGenerated
    private FilterTable listViews;

    @AutoGenerated
    private VerticalLayout vl_menuSpacer;

    @AutoGenerated
    private MenuBar men_frm;

    

	

	

	

	

	

	

	

	

	

	

	

	

    

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Datenbank
    private FilteringTableUpdater tableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Men端punkte <- ********************/
    private MenuBar.MenuItem btn_create;
    private MenuBar.MenuItem btn_update;
    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_duplicate;
    private MenuBar.MenuItem btn_filter;

    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PauseablePollListener pollListener = null;
    
    enum Status {}
    enum Count {}
    enum Project {}
    enum Patient {}
    enum Nurse {}
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "20";
    private final String formIdPerm = "33";
    private final String winHeight = "600px";
    private final String winWidth = "900px";

    /************************ Filtered Init ******************/

    private HashMap<String, String> filteredInitVars;
    /******************************************************/


    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB bool_true = set();
        static final I18nCB bool_false = set();
    }
    
    /******************************************************/

    public ReportingPermissionsDataView(MenuItem Arg_Men端) {
        tmpMenu = Arg_Men端;
    }

    public ReportingPermissionsDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        pollListener = new PauseablePollListener() {}; // dummy;

        if(onDetach != null) {
            win.addDetachListener(onDetach);
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        setupListenersAndDetachEvent();
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);

        generateMenu();

        
		fillFields();
		
//        setMenuPermissions();
//        updateTable();
//        tbl_data.setSortContainerPropertyId(tableIdCol);
//        tbl_data.setSortAscending(true);
//        tbl_data.sort();
		
        configureTable();
        configueComponents();
        
        setEventListener();
        
        i18n.refresh();
    }

    private void setupListenersAndDetachEvent() {
    }
    
    
    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_create.setEnabled(c);
        btn_create.setVisible(c);

        btn_duplicate.setEnabled(c);
        btn_duplicate.setVisible(c);
        
        btn_read.setEnabled(r);
        btn_read.setVisible(r);

        btn_update.setEnabled(u);
        btn_update.setVisible(u);

        btn_delete.setEnabled(d);
        btn_delete.setVisible(d);
    }

    /************ -><- ******************/
    
   
    /***************** Comands *********************/
    CloseListener closeListener = new CloseListener() {
        
        @Override
        public void windowClose(CloseEvent e) {
            
            pollListener.resume();
            
        }
    };
 

    /******************************************/

    
    

    /*********** Gen Men端s *************/
    private void generateMenu() {

//        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
//        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
//        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
//        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
//        btn_duplicate = men_frm.addItem("FRM_DUPLICATE", Icons.White.projekte_16, cmd_btn_duplicate);
        
        
//        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);

    }
    
    private void configueComponents(){
    	
    	permissionTab.setEnabled(false);
    	
    }

    private void fillFields(){
    	
    	
    }
    
    private void setEventListener(){
    	
    	listViews.addItemClickListener(new ItemClickListener() {
			
			@Override
			public void itemClick(ItemClickEvent event) {
				// FIXME Auto-generated method stub
				
			    permissionTab.setEnabled(true);
				
			    groupPermissions.setParentId((Integer) event.getItem().getItemProperty("id").getValue());
			    userPermissions.setParentId((Integer) event.getItem().getItemProperty("id").getValue());
				
			}
		});
    	
    	btnSave.addClickListener(new ClickListener() {
			
			@Override
			public void buttonClick(ClickEvent event) {
				// FIXME Auto-generated method stub
				
				groupPermissions.save();
				userPermissions.save();
				
			}
		});
    	
    	
    	
    }

    
    /*************************** Config TBL ********************/

    private void configureTable() {

    	dbFillView();
    	
    	listViews.setSelectable(true);
    	listViews.setImmediate(true);

    }

    /*************************** Database ********************/
    
    /********************************/

    private void dbFillView(){
    	
	    CustomQuery q = new DBClass().CustomQuery;
	    
		String sql = "SELECT" 
				+ "\n "	+ "		CRV_ID AS id"  
				+ "\n "	+ "		, CRV_VIEW" 
				+ "\n " + "FROM"
				+ "\n "	+ "		cust_report_views";
    	
		q.setSqlString(sql);
		
		listViews.setContainerDataSource(q.query());
		
    }

    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // vl_main
        vl_main = buildVl_main();
        mainLayout.addComponent(vl_main);
        mainLayout.setExpandRatio(vl_main, 1.0f);
        mainLayout.setComponentAlignment(vl_main, new Alignment(20));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVl_main() {
        // common part: create layout
        vl_main = new VerticalLayout();
        vl_main.setImmediate(false);
        vl_main.setWidth("100.0%");
        vl_main.setHeight("100.0%");
        vl_main.setMargin(true);
        
        // vl_menuSpacer
        vl_menuSpacer = buildVl_menuSpacer();
        vl_main.addComponent(vl_menuSpacer);
        
        // horizontalLayout_2
        horizontalLayout_2 = buildHorizontalLayout_2();
        vl_main.addComponent(horizontalLayout_2);
        vl_main.setExpandRatio(horizontalLayout_2, 1.0f);
        
        return vl_main;
    }

    @AutoGenerated
    private VerticalLayout buildVl_menuSpacer() {
        // common part: create layout
        vl_menuSpacer = new VerticalLayout();
        vl_menuSpacer.setImmediate(false);
        vl_menuSpacer.setWidth("100.0%");
        vl_menuSpacer.setHeight("40px");
        vl_menuSpacer.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        vl_menuSpacer.addComponent(men_frm);
        vl_menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
        
        return vl_menuSpacer;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_2() {
        // common part: create layout
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("100.0%");
        horizontalLayout_2.setMargin(true);
        horizontalLayout_2.setSpacing(true);
        
        // listViews
        listViews = new FilterTable();
        listViews.setImmediate(false);
        listViews.setWidth("100.0%");
        listViews.setHeight("100.0%");
        horizontalLayout_2.addComponent(listViews);
        horizontalLayout_2.setExpandRatio(listViews, 1.0f);
        
        // verticalLayout_3
        verticalLayout_3 = buildVerticalLayout_3();
        horizontalLayout_2.addComponent(verticalLayout_3);
        horizontalLayout_2.setExpandRatio(verticalLayout_3, 1.0f);
        
        return horizontalLayout_2;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_3() {
        // common part: create layout
        verticalLayout_3 = new VerticalLayout();
        verticalLayout_3.setImmediate(false);
        verticalLayout_3.setWidth("100.0%");
        verticalLayout_3.setHeight("100.0%");
        verticalLayout_3.setMargin(false);
        verticalLayout_3.setSpacing(true);
        
        // tabSheet_1
        permissionTab = buildTabSheet_1();
        verticalLayout_3.addComponent(permissionTab);
        verticalLayout_3.setExpandRatio(permissionTab, 1.0f);
        
        // btnSave
        btnSave = new Button();
        btnSave.setCaption("Speichern");
        btnSave.setImmediate(true);
        btnSave.setWidth("-1px");
        btnSave.setHeight("-1px");
        verticalLayout_3.addComponent(btnSave);
        verticalLayout_3.setComponentAlignment(btnSave, new Alignment(48));
        
        return verticalLayout_3;
    }

    @AutoGenerated
    private TabSheet buildTabSheet_1() {
        // common part: create layout
        permissionTab = new TabSheet();
        permissionTab.setImmediate(true);
        permissionTab.setWidth("100.0%");
        permissionTab.setHeight("100.0%");
        
        // userAssignments
        groupPermissions = new ReportingGroupPermissions();
        groupPermissions.setImmediate(false);
        groupPermissions.setWidth("100.0%");
        groupPermissions.setHeight("100.0%");
        permissionTab.addTab(groupPermissions, "group_permissions", null);
        
        // reportingUserPermissions_1
        userPermissions = new ReportingUserPermissions();
        userPermissions.setImmediate(false);
        userPermissions.setWidth("100.0%");
        userPermissions.setHeight("100.0%");
        permissionTab.addTab(userPermissions, "user_permissions", null);
        
        return permissionTab;
    }
}
