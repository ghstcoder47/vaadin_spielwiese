package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form;

import java.util.HashMap;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.RichTextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class form_email_senden extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Button btn_e_send;
    @AutoGenerated
    private RichTextArea rta_email;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private TextField txt_an;
    @AutoGenerated
    private TextField txt_von;
    /**************** --> Allgemein <--- ********************/
    // Allgemein
    private CMS_Config_Std std;

    // Datenbank

    private DBClass db;
    private final String Form_ID = "";
    // Berrechtigung
    private int ACC_ID;
    private int Lesen;
    private int Schreiben;
    private int Erstellen;
    private int Edit;
    private int Löschen;

    private final MenuItem Temp_Menü = null;

    private final Button Temp_Btn = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private final boolean Status_Fill = false;

    /************ ----->Einstellungen<-- ********************/
//    private final String LNG_FRM_ID = "21";
    private final String BER_MEN_ID = "";
    private final String Windows_Height = "650px";
    private final String Windows_Width = "700px";
    /******************************************************/
    
    private HashMap<Integer, String> projectTemplates;
    
    private final Integer projectId;
    private final String Projektname;
    private final String Patient;
    private final String Nurse;
    private String Arzt;
    private final String Krankenschwester_ID;
    private String Emailadresse;
    private String patData;
    private String aussendienst = ""; // leerstring um textmarke zu entfernen
    private I18nManager i18n;


    public form_email_senden(Integer id, String Arg_K_ID, String Arg_Projektname, String Arg_Patient, String Arg_Nurse) {
        
        projectId = id;
        Projektname = Arg_Projektname;
        Patient = Arg_Patient;
        Nurse = Arg_Nurse;
        Krankenschwester_ID = Arg_K_ID;

        Get_Aemailadresse();
        
        projectTemplates = new HashMap<Integer, String>();
        projectTemplates.put(1, "8"); // Forsteo
    }

    public form_email_senden(Integer id, String Arg_K_ID, String Arg_Projektname, String Arg_Patient, String Arg_Nurse, Integer patId) {
        this(id, Arg_K_ID, Arg_Projektname, Arg_Patient, Arg_Nurse);

        getPatData(patId);
    }

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        txt_an.setValue(Emailadresse);
        txt_von.setValue(dbGetProjectMail());

        Build_Window_Button bwb = new Build_Window_Button("Email Senden an " + Nurse, mainLayout, Windows_Height, Windows_Width, null);
        win = bwb.ReturnWindow();

    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        std = CMS_Config_Std.getInstance();

        Email_Fill();

        btn_e_send.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {

                // TODO Automatisch generierter Methodenstub

                if (txt_von.getValue() != null && txt_an.getValue() != null && rta_email.getValue() != null) {
                    Email_Senden();
                    I18nManager.global(I18nGlobalNotifiers.mail_sent);
                    UI.getCurrent().removeWindow(win);
                }
            }
        });

    }
    
    public void fillAdm(String admId){
        getAdm(admId);
    }
    
    private String getTemplateId(Integer id){
        String templateId = "6";
        if(projectTemplates.containsKey(id)){
            templateId = projectTemplates.get(id);
        }
        return templateId;
    }
    
    private void Get_Aemailadresse() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_EMAIL");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "AUL_ID", "KSK_U_ID");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_ID", "=", Krankenschwester_ID, "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        for (Object ItemIda : con.getItemIds()) {

            Emailadresse = (String) con.getContainerProperty(ItemIda, "AUL_EMAIL").getValue();
        }

    }

    private void getPatData(Integer patId) {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_TITEL");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSA_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_VORNAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_STRASSE");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_ORT");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_PLZ");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_TEL");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_EMAIL");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_HANDY");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_patient_stammdaten_liste", "INNER JOIN", "cust_patient_stammdaten_anrede", "PSL_ANREDE", "PSA_ID");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_patient_stammdaten_liste", "PSL_ID", "=", String.valueOf(patId), "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET();

        if (con.size() > 0) {

            patData = "";
            String ls = System.getProperty("line.separator") + "<br />";

            for (Object itemId : con.getItemIds()) {

                patData += con.getItem(itemId).getItemProperty("PSA_NAME").getValue() + " ";
                if (con.getItem(itemId).getItemProperty("PSL_TITEL").getValue() != null) {
                    patData += con.getItem(itemId).getItemProperty("PSL_TITEL").getValue() + " ";
                }
                patData += con.getItem(itemId).getItemProperty("PSL_NAME").getValue() + ", ";
                patData += con.getItem(itemId).getItemProperty("PSL_VORNAME").getValue() + ls;
                patData += con.getItem(itemId).getItemProperty("PSL_PLZ").getValue() + " ";
                patData += con.getItem(itemId).getItemProperty("PSL_ORT").getValue() + ls;
                patData += con.getItem(itemId).getItemProperty("PSL_STRASSE").getValue() + ls;
                if (con.getItem(itemId).getItemProperty("PSL_TEL").getValue().equals("") == false) {
                    patData += con.getItem(itemId).getItemProperty("PSL_TEL").getValue() + ls;
                }
                if (con.getItem(itemId).getItemProperty("PSL_HANDY").getValue().equals("") == false) {
                    patData += con.getItem(itemId).getItemProperty("PSL_HANDY").getValue() + ls;
                }
                if (con.getItem(itemId).getItemProperty("PSL_EMAIL").getValue().equals("") == false) {
                    patData += con.getItem(itemId).getItemProperty("PSL_EMAIL").getValue() + ls;
                }

            }
        }
    }
    
    private void getAdm(String admId){
        
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_stammdaten_aussendienst", "LEFT JOIN", "cms_auth_stammdaten_anrede", "SAD_ID_ANREDE", "ASA_ID");
        

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_stammdaten_aussendienst", "SAD_ID", "=", admId, "");
        
        
//        db.DB_Data_Get.DB_DEBUG_SQL_STRING();
        
        Item item = db.DB_Data_Get.DB_SEND_AND_GET_FIRST_ITEM();
        
        if(item != null){
            aussendienst = "";
            String ls = System.getProperty("line.separator") + "<br />";
            
            String anrede = (String) item.getItemProperty("ASA_NAME").getValue();
            
            if(anrede != null && !anrede.equals("")){
                aussendienst += item.getItemProperty("ASA_NAME").getValue();
                aussendienst += " ";
            }
            
            aussendienst += item.getItemProperty("SAD_NAME").getValue();
            
            String vorname = (String) item.getItemProperty("SAD_VORNAME").getValue();
            
            if(vorname != null && !vorname.equals("")){
                aussendienst += ", ";
                aussendienst += vorname;
            }
            
            String tel =  (String) item.getItemProperty("SAD_TEL").getValue();
            if(tel != null && !tel.equals("")){
                aussendienst += ls + tel;
            }            
            
        }
        
    }
    
    private void Email_Senden() {
//        Email em = new Email(std.SMTP_Adresse, std.SMTP_Port, std.SMTP_Username, std.SMTP_Passwort);
//        em.set_Einstellungen_Email_Typ_HTML();
//        em.set_Einstellungen_Betreff("Neuer Patient");
//        em.set_Einstellungen_EmpfängerAddresse(txt_an.getValue());
//        em.set_Einstellungen_SenderAddresse(txt_von.getValue());
//        em.set_Template_Data_Setzen(rta_email.getValue());
//        em.func_sendMail();
    }

    private void Email_Fill() {
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("ELV_VORLAGE");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_email_liste_vorlage");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_email_liste_vorlage", "ELV_ID", "=", getTemplateId(projectId), "");
        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        String nachricht = "";
        for (Object ItemIda : con.getItemIds()) {
            // UserId = (int) result.getItem(ItemIda).getItemProperty(this.Spalte_ID)
            // .getValue();

            nachricht = (String) con.getItem(ItemIda).getItemProperty("ELV_VORLAGE").getValue();

        }

        nachricht = nachricht.replaceAll("#Nurse#", Nurse);
        nachricht = nachricht.replaceAll("#Patient#", Patient);
        nachricht = nachricht.replaceAll("#Projektname#", Projektname);

        nachricht = nachricht.replaceAll("#PatData#", patData);
        
        nachricht = nachricht.replaceAll("#AussendienstData#", aussendienst);


        rta_email.setValue(nachricht);

    }
    
    private String dbGetProjectMail(){
    	
    	DBClass db = new DBClass();
    	
    	db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
    	db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_projekte_stammdaten_liste");
    	db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_projekte_stammdaten_liste", "PSLV_ID", "=", projectId.toString(), "");
    	
    	Item item = db.DB_Data_Get.DB_SEND_AND_GET_FIRST_ITEM();
    	
    	String mail = (String) item.getItemProperty("PSLV_PROJECT_MAIL").getValue();
    	mail = (mail == null || mail.equals("")) ? std.Email_CS : mail;
    	
    	return mail;
    }
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);

        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");

        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 0.5f);
        mainLayout.setComponentAlignment(horizontalLayout_1, new Alignment(48));

        // rta_email
        rta_email = new RichTextArea();
        rta_email.setImmediate(false);
        rta_email.setWidth("90.0%");
        rta_email.setHeight("90.0%");
        mainLayout.addComponent(rta_email);
        mainLayout.setExpandRatio(rta_email, 4.0f);
        mainLayout.setComponentAlignment(rta_email, new Alignment(48));

        // btn_e_send
        btn_e_send = new Button();
        btn_e_send.setCaption("Email Senden");
        btn_e_send.setImmediate(true);
        btn_e_send.setWidth("-1px");
        btn_e_send.setHeight("-1px");
        mainLayout.addComponent(btn_e_send);
        mainLayout.setExpandRatio(btn_e_send, 0.5f);
        mainLayout.setComponentAlignment(btn_e_send, new Alignment(48));

        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("90.0%");
        horizontalLayout_1.setHeight("40.0%");
        horizontalLayout_1.setMargin(false);

        // txt_von
        txt_von = new TextField();
        txt_von.setCaption("Email von");
        txt_von.setImmediate(false);
        txt_von.setWidth("-1px");
        txt_von.setHeight("-1px");
        horizontalLayout_1.addComponent(txt_von);
        horizontalLayout_1.setComponentAlignment(txt_von, new Alignment(48));

        // txt_an
        txt_an = new TextField();
        txt_an.setCaption("Email an");
        txt_an.setImmediate(false);
        txt_an.setWidth("-1px");
        txt_an.setHeight("-1px");
        horizontalLayout_1.addComponent(txt_an);
        horizontalLayout_1.setComponentAlignment(txt_an, new Alignment(48));

        return horizontalLayout_1;
    }

}
