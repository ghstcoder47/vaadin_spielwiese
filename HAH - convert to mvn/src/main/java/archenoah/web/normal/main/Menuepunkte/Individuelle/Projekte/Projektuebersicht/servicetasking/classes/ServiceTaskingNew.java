package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.servicetasking.classes;


import java.util.ArrayList;

import org.tepi.filtertable.FilterTable;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.UserInfo.UserData;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.shared.ui.datefield.Resolution;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.VerticalLayout;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.Icon;
import de.steinwedel.messagebox.MessageBox;
import de.steinwedel.messagebox.MessageBoxListener;

public class ServiceTaskingNew extends CustomComponent{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;

    @AutoGenerated
    private PopupDateField planned;

    @AutoGenerated
    private FilterTable assignments;

    // {section fields}
    // ****************
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(ServiceTaskingNew.class);
    
    private MessageBox messageBox;
    private SaveListener saveListener;
    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB title = set();
    }
    
    // {end fields}
    

    // {section constructors}
    // **********************
    public ServiceTaskingNew() {
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this);
        
        configureComponents();
        fillForm();
        
        showPopup();
        
        i18n.refresh();
     }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    public void addSaveListener(SaveListener saveListener) {
        this.saveListener = saveListener;;
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    private void configureComponents() {
        
        ValueChangeListener vcl = new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                checkValid();
            }
        };

        
        planned.setResolution(Resolution.DAY);
        planned.setImmediate(true);
        planned.addValueChangeListener(vcl);
        planned.setRequired(true);
        
        assignments.setFilterBarVisible(true);
        assignments.setFilterOnDemand(false);
        assignments.setSelectable(true);
        assignments.setImmediate(true);
        assignments.setRequired(true);
        
        
        assignments.addValueChangeListener(vcl);
        
    }
    
    private void fillForm() {
        dbFillAssignments();
    }
    
    private void checkValid() {
        
        boolean valid = planned.isValid() && assignments.isValid();
        if(messageBox != null) {
            messageBox.getButton(ButtonId.OK).setEnabled(valid);
        }
        
    }
    
    private void showPopup() {
        
        
        MessageBoxListener mbl = new MessageBoxListener() {

            @Override
            public void buttonClicked(ButtonId buttonId) {

                Integer tid = null;
                Boolean close = false;
                
                if (buttonId.equals(ButtonId.OK)) {
                    
                    tid = dbCreate();
                    close = (tid != null);
                    
                }else {
                    close = true;
                }
                
                if(close) {
                    messageBox.close();
                    if(saveListener != null && tid != null) {
                        saveListener.onSave(tid);
                    }
                }else {
                    log.warn("error inserting entry");
                }
                
                
                
            }
        };

        messageBox = MessageBox.showCustomized(Icon.NONE, i18n.get(caption.title), this, mbl, ButtonId.CANCEL, ButtonId.OK);
        messageBox.setWidth("600px");
        messageBox.setHeight("400px");
        messageBox.getButton(ButtonId.OK).setEnabled(false);
        messageBox.setAutoClose(false);
        
    }
    // {end privatemethods}

    // {section database}
    // ******************
    
    private void dbFillAssignments() {
        
        Integer userId = UserData.get().getUserId();
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select VH_ID, PSLV_NAME as project, "
             + "\n " + "       CONCAT(PSA_NAME, ' ', PSL_VORNAME, ' ', PSL_NAME, ' (', PSL_PLZ, ' ', PSL_ORT, ')') as patient,"
             + "\n " + "       CONCAT(na.ASA_NAME, ' ', ns.AUL_VORNAME, ' ', ns.AUL_NAME) as nurse"
             + "\n " + "   from"
             + "\n " + "   cust_verk_haupt"
             + "\n " + "   inner join cust_projekte_stammdaten_liste on VH_PROJEKT_ID = PSLV_ID and PSLV_CODE = 'SA'"
             + "\n " + "   -- patient"
             + "\n " + "   left join cust_patient_stammdaten_liste on VH_PATIENT_ID = PSL_ID"
             + "\n " + "   left join cust_patient_stammdaten_anrede on PSL_ANREDE = PSA_ID"
             + "\n " + "   -- nurse"
             + "\n " + "   left join cust_verk_subs on VH_PATIENT_ID = CVS_PATIENT_ID and VH_PROJEKT_ID = CVS_PROJECT_ID"
             + "\n " + "   left join cust_krankenschwester_stammdaten_ks as ksm on VH_NURSE_ID = ksm.KSK_ID"
             + "\n " + "   left join cms_auth_stammdaten_user as ns on ksm.KSK_U_ID = ns.AUL_ID"
             + "\n " + "   left join cms_auth_stammdaten_anrede as na on na.ASA_ID = ns.AUL_ANREDE_ID"
             + "\n " + "   -- subs"
             + "\n " + "   left join cust_krankenschwester_stammdaten_ks as kss on CVS_NURSE_ID = kss.KSK_ID"
             + "\n " + "   where VH_AKTIV = 1"
             + "\n " + "       and ("
             + "\n " + "           (PSLV_ID in (select ID_PROJECT from cms_auth_liste_gu"
             + "\n " + "               left join cust_protokoll_servicetasking_config on (`KEY` = 'create_own') and `VALUE` = AL_G_ID"
             + "\n " + "               where AL_U_ID = " + userId + " and VALUE IS NOT NULL) and (ns.AUL_ID = " + userId + " or kss.KSK_U_ID = " + userId + "))"
             + "\n " + "           or"
             + "\n " + "           PSLV_ID in (select ID_PROJECT from cms_auth_liste_gu"
             + "\n " + "               left join cust_protokoll_servicetasking_config on (`KEY` = 'create_all') and `VALUE` = AL_G_ID"
             + "\n " + "               where AL_U_ID = " + userId + " and VALUE IS NOT NULL)"
             + "\n " + "       )"
             + "\n " + "    group by VH_ID";
        q.setSqlString(sql);
        
        assignments.setContainerDataSource(MyUtils.convertIndex(q.query(), "VH_ID"));
        assignments.setVisibleColumns(new Object[] {"project", "patient", "nurse"});
        
    }
    
    private Integer dbCreate() {
        
        String dt = "'" + MyUtils.formatSqlDate(planned.getValue()) + "'";
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "insert into cust_protokoll_servicetasking (ST_VH_ID, ST_ID_PATIENT, ST_ID_NURSE, ST_DATE, ST_ORIGINAL_DATE)"
         + "\n " + "select VH_ID, VH_PATIENT_ID, VH_NURSE_ID, " + dt + ", " + dt
         + "\n " + "from cust_verk_haupt"
         + "\n " + "where VH_ID = " + assignments.getValue();
        q.setSqlString(sql);
        
        ArrayList<Integer> keys = new ArrayList<Integer>();
        q.update(false, keys);
        
        if(keys.size() > 0) {
            return keys.iterator().next();
        }else {
            return null;
        }
    }
    
    // {end database}

    public static abstract class SaveListener{
        public abstract void onSave(Integer newId);
    }
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // assignments
        assignments = new FilterTable();
        assignments.setImmediate(false);
        assignments.setWidth("100.0%");
        assignments.setHeight("100.0%");
        mainLayout.addComponent(assignments);
        mainLayout.setExpandRatio(assignments, 1.0f);
        
        // planned
        planned = new PopupDateField();
        planned.setCaption("Plandatum");
        planned.setImmediate(false);
        planned.setWidth("-1px");
        planned.setHeight("-1px");
        mainLayout.addComponent(planned);
        mainLayout.setComponentAlignment(planned, new Alignment(48));
        
        return mainLayout;
    }
}
