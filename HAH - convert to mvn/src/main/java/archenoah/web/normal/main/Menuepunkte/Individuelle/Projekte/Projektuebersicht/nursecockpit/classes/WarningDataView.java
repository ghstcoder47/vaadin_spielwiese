package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.nursecockpit.classes;

import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Map.Entry;

import org.tepi.filtertable.FilterTable;

import archenoah.global.warningmodule.Warning;
import archenoah.global.warningmodule.WarningList;
import archenoah.global.warningmodule.WarningType;
import archenoah.global.warningmodule.WarningTypeConverter;
import archenoah.lib.custom.TableFilterGenerator;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.table.RowGenerators.HtmlLabelColumnGenerator;
import archenoah.lib.vaadin.CustomConverterFactorys.MapConverter;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.ItemSetChangeEvent;
import com.vaadin.data.Container.ItemSetChangeListener;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.converter.Converter;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.VerticalLayout;

public class WarningDataView extends CustomComponent{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private FilterTable table;
    

    // {section fields}
    // ****************
    
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(WarningDataView.class);
    
    private WarningList warnings;
    private I18nManager i18n;
    
    private StringSqlTimestampConverter dateConverter;
    private WarningTypeConverter typeConverter;
    private Converter<String, Integer> userConverter;
    private Converter<String, Integer> patientConverter;
    
    // {end fields}

    // {section constructors}
    // **********************
    public WarningDataView() {
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this);
        
        warnings = new WarningList();
        configureComponents();
        setUser(null);
        setUser(null); // dirty hack to fix issues with inital empty filterGenerator
        
        i18n.refresh();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void setUser(Integer userId) {
        warnings.setUserId(userId);
        refresh();
    }
    
    public void refresh() {
        fillTable();
    }
    
    public int getCount() {
        return table.size();
    }
    
    public void setFilterBarVisible(boolean visible) {
        table.setFilterBarVisible(visible);
    }
    
    public void clearFilters() {
        table.clearFilters();
    }
    
    public boolean isFilterBarVisible() {
        return table.isFilterBarVisible();
    }
    
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    @SuppressWarnings("serial")
    private void configureComponents() {
        
        dbGetUsers();
        dbGetPatients();
        
        table.addGeneratedColumn("message", new HtmlLabelColumnGenerator("message", "contents"));
        
        table.addItemSetChangeListener(new ItemSetChangeListener() {
            
            @Override
            public void containerItemSetChange(ItemSetChangeEvent event) {
                
                table.setColumnFooter("message", Integer.toString(table.size()));
                
            }
        });
        
        table.setFilterGenerator(new TableFilterGenerator(table));
        
    }
    
    
    @SuppressWarnings("serial")
    private void fillTable() {
        BeanItemContainer<Warning> warningContainer = new BeanItemContainer<Warning>(Warning.class);
        
        for (Entry<WarningType, ArrayList<Warning>> bytype : warnings.getWarnings().entrySet()) {
            
            for (Warning warning : bytype.getValue()) {
                
                warningContainer.addBean(warning);
                
            }
            
        }
        table.setSortEnabled(true);
        table.setSelectable(true);
        table.setFilterOnDemand(false);
        table.setImmediate(true);
        table.setColumnCollapsingAllowed(false);
        table.setFooterVisible(true);
        table.setPageLength(1);
        
        table.setContainerDataSource(warningContainer);
        table.setVisibleColumns(new Object[] {"type", "date", "userId", "patientId", "message"});
        table.sort(new Object[] {"date"}, new boolean[] {true});
        
        table.setColumnFooter("message", Integer.toString(warningContainer.size()));
        
        if(dateConverter == null) {
            StringSqlTimestampConverter dateConverter = new StringSqlTimestampConverter();
            dateConverter.setDateFormat(DateFormat.SHORT);
            table.setConverter("date", dateConverter);
        }
        
        if(typeConverter == null) {
            typeConverter = new WarningTypeConverter();
            table.setConverter("type", typeConverter);
        }
        
        if(userConverter == null) {
            userConverter = new MapConverter<Integer>(dbGetUsers(), "id", "user", Integer.class);
            table.setConverter("userId", userConverter);
        }
        
        if(patientConverter == null) {
            patientConverter = new MapConverter<Integer>(dbGetPatients(), "id", "patient", Integer.class);
            table.setConverter("patientId", patientConverter);
        }
        

        
        
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    
    private Container dbGetUsers() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select AUL_ID as id, CONCAT(ASA_NAME, ' ', AUL_VORNAME, ' ', AUL_NAME) as `user`"
            + "\n " + "from cms_auth_stammdaten_user left join cms_auth_stammdaten_anrede on AUL_ANREDE_ID = ASA_ID";
        q.setSqlString(sql);
        return q.query();
    }
    
    private Container dbGetPatients() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSL_ID as id, CONCAT(PSA_NAME, ' ', PSL_VORNAME, ' ', PSL_NAME) as patient from"
            + "\n " + "view_patient_stammdaten_liste left join cust_patient_stammdaten_anrede on PSL_ANREDE = PSA_ID";
        q.setSqlString(sql);
        return q.query();
    }
    
    // {end database}

    // {section layout}
    // ****************
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // table
        table = new FilterTable();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        mainLayout.addComponent(table);
        
        return mainLayout;
    }
    
    // {end layout}
}
