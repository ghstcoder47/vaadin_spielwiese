package archenoah.web.normal.main.Menuepunkte.Unsichtbar.UserAttributes.form;

import java.util.Collection;
import java.util.HashMap;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.validator.ValidatorManager;
import archenoah.web.normal.main.Menuepunkte.Unsichtbar.UserAttributes.form.UserAttributesDataView.UserConverter;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.Panel;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

@SuppressWarnings({"serial", "rawtypes", "unchecked"})
public class UserAttributesInsertEdit extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;

    @AutoGenerated
    private HorizontalLayout buttons;

    @AutoGenerated
    private Button btn_save;

    @AutoGenerated
    private VerticalLayout main;

    @AutoGenerated
    private Panel panel_1;

    @AutoGenerated
    private VerticalLayout verticalLayout_4;

    @AutoGenerated
    private TextField value;

    @AutoGenerated
    private ComboBox property;

    @AutoGenerated
    private ComboBox user;

    

    


	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Allgemein
    org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    private Form_Bind fb;
    private Integer dataSetId;
    
    // Berrechtigung
	private Integer permRead;
	private Integer permUpdate;
	private Integer permCreate;
	private Integer permDelete;

    private MenuItem tmpMenu = null;
    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;
    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/
    
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdPerm = "711";
    private final String Windows_Height = "300px";
    private final String Windows_Width = "300px";
    
//    private final String dataIdCol = "SRL_ID";
    private final String dataTableName = "cms_user_attributes";

    private HashMap<Object, String> dbMap;
    
    private I18nManager i18n;
    private ValidatorManager val;

    private UserConverter userConverter;

    /******************************************************/

    public UserAttributesInsertEdit(MenuItem Arg_Menü, Integer dataSetId) {
        tmpMenu = Arg_Menü;
        this.dataSetId = dataSetId;
    }

    public UserAttributesInsertEdit(Button Arg_btn, Integer dataSetId) {
        tmpButton = Arg_btn;
        this.dataSetId = dataSetId;
    }

    /********* INIT-Window ************/
    public void init() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        String fid = "";
        if (dataSetId != null) {
            fid = " - #" + dataSetId;
        }

        if (tmpMenu != null) {
        	
            String Recourcename = null;
            ThemeResource resource = null;
            if(tmpMenu.getIcon() != null){
            	Recourcename = tmpMenu.getIcon().toString();
            	Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";
            	resource = new ThemeResource(Recourcename);
            }

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText() + fid, mainLayout, Windows_Height, Windows_Width, resource);
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption() + fid, mainLayout, Windows_Height, Windows_Width, tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

    }

    /********* INIT-Tray ************/
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        val = new ValidatorManager(this);
        
        fillFields();
        fillDbMap();

//        if (dataSetId != null) {
//        	
//            dbFillForm();
//             
//        } else {
//            
//        	//TASK "create init"
//        	
//        }
        
//        setMenuPermissions();
        configureComponents();

    }
    
    
    
    
    private void configureComponents(){
    	
        user.setRequired(true);
        property.setRequired(true);
        
        value.setMaxLength(50);
        value.setNullRepresentation("");
        value.setNullSettingAllowed(true);
        value.setValue(null);
        
    	componentListeners();

    	
    }
    
    private void componentListeners(){
        
        btn_save.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {

                if (!val.isValid()) {
                    return;
                }
                
//                if (dataSetId == null) {
                    
                    dataSetId = dbInsert();
                    
//                } else {
//                    
//                    dbUpdate();
//
//                }
                

                //TASK check if save successful
                UI.getCurrent().getUI().removeWindow(win);
            }

        });
        
        
    }
    
    
    /******************************************************************/
    
    /************************ --> Berrechtigung <-- **************************/

//    @SuppressWarnings("unused")
//    public void setPermissionsFromDatabase() {
//        if (formIdPerm == "") {
//            System.out.println("Form Einstellung Fehlt: Berechtigung");
//            return;
//        }
//
//        
//        Rechteholen r = new Rechteholen(UserData.get().getUserId() + "");
//        String[][] perms = r.Datenholen();
//        
//        System.out.println(perms);
//        
//        for (int i = 0; i < perms.length; i++) {
//            if (perms[i][0].equals(formIdPerm) == true) {
//
//                permRead = Integer.valueOf(perms[i][3]);
//                permUpdate = Integer.valueOf(perms[i][4]);
//                permCreate = Integer.valueOf(perms[i][6]);
//                permDelete = Integer.valueOf(perms[i][5]);
//                
//            }
//        }
//    }
//
//    public void setPermissions(int create, int read, int update, int delete) {
//
//        permCreate = create;
//        permRead = read;
//        permUpdate = update;
//        permDelete = delete;
//
//    }
//
//    private void setMenuPermissions() {
//        Boolean c = (permCreate == 1);
//        Boolean r = (permRead == 1);
//        Boolean u = (permUpdate == 1);
//        Boolean d = (permDelete == 1);
//        
//        btn_save.setEnabled((c||u));
//
//    }
    
    
    /***********************************************/
    
    public void setUsers(UserConverter userConverter) {
        this.userConverter = userConverter;
    }
    
    private void fillFields(){
       
        if(userConverter == null) {
            throw new IllegalArgumentException("userConverter is missing!");
        }


        user.setContainerDataSource(handleClone(userConverter.getContainer()));
        user.setItemCaptionPropertyId(userConverter.getItemCaptionProperty());
        
        property.setContainerDataSource(dbGetAttributes());
        property.setItemCaptionPropertyId("UA_KEY");
        
//        property.addItem("ordermanager_country");
//        property.addItem("developer_options");
//        property.addItem("pop_change_planned_date");
        
    }
    
    private IndexedContainer handleClone(IndexedContainer con) {
        
        Collection<Filter> filters = con.getContainerFilters();
        con.removeAllContainerFilters();
        IndexedContainer clone = MyUtils.cloneContainer(con);
        for (Filter filter : filters) {
            con.addContainerFilter(filter);
        }
        
        return clone;
        
    }
    
    /******************** Database *****************/
    private void fillDbMap() {
        
        String table = dataTableName + ":";
        
        dbMap = new HashMap<>();
        dbMap.put(user, table + "UA_ID_USER");
        dbMap.put(property, table + "UA_KEY");
        dbMap.put(value, table + "UA_VALUE");

    }

//    private void dbFillForm() {
//       
//        CustomQuery q = new DBClass().CustomQuery;
//        String sql = "select"
//         + "\n " + "    UA_ID_USER"
//         + "\n " + "    , UA_KEY"
//         + "\n " + "    , UA_VALUE"
//         + "\n " + "from cms_user_attributes"
//         + "\n " + "where SRL_ID = " + dataSetId;
//             
////        q.db.debugNextQuery(true);
//        q.setSqlString(sql);
//        
//        Container con = q.query();
//        
//        if(con.size() > 0) {
//            
//            fb = new Form_Bind();
//            fb.Get_and_Fill(con, dbMap);
//           
//        }
//        
//    }

    private int dbInsert() {
        DBClass db = new DBClass();
        
        fb = new Form_Bind();
        fb.Insert(db, dbMap);
        
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
        
//        db.DB_Data_Insert.DB_DEBUG_SQL_STRING();
        return db.DB_Data_Insert.DB_Insert();
    }

//    private void dbUpdate() {
//        DBClass db = new DBClass();
//        fb = new Form_Bind();
//        fb.Update(db, dbMap);
//        
//        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
//        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein(dataTableName, dataIdCol, "=", dataSetId.toString(), "");
//        
//        db.DB_Data_Update.DB_Update();
//
//    }
    
    private Container dbGetAttributes() {
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select distinct UA_KEY from cms_user_attributes";
        q.setSqlString(sql);
        
        return MyUtils.convertIndex(q.query(), "UA_KEY");
        
    }

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // main
        main = buildMain();
        mainLayout.addComponent(main);
        mainLayout.setExpandRatio(main, 9.0f);
        mainLayout.setComponentAlignment(main, new Alignment(48));
        
        // buttons
        buttons = buildButtons();
        mainLayout.addComponent(buttons);
        mainLayout.setComponentAlignment(buttons, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildMain() {
        // common part: create layout
        main = new VerticalLayout();
        main.setImmediate(false);
        main.setWidth("100.0%");
        main.setHeight("100.0%");
        main.setMargin(false);
        main.setSpacing(true);
        
        // panel_1
        panel_1 = buildPanel_1();
        main.addComponent(panel_1);
        main.setComponentAlignment(panel_1, new Alignment(48));
        
        return main;
    }

    @AutoGenerated
    private Panel buildPanel_1() {
        // common part: create layout
        panel_1 = new Panel();
        panel_1.setImmediate(false);
        panel_1.setWidth("100.0%");
        panel_1.setHeight("100.0%");
        
        // verticalLayout_4
        verticalLayout_4 = buildVerticalLayout_4();
        panel_1.setContent(verticalLayout_4);
        
        return panel_1;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_4() {
        // common part: create layout
        verticalLayout_4 = new VerticalLayout();
        verticalLayout_4.setImmediate(false);
        verticalLayout_4.setWidth("100.0%");
        verticalLayout_4.setHeight("100.0%");
        verticalLayout_4.setMargin(true);
        verticalLayout_4.setSpacing(true);
        
        // user
        user = new ComboBox();
        user.setCaption("Benutzer");
        user.setImmediate(false);
        user.setWidth("-1px");
        user.setHeight("-1px");
        verticalLayout_4.addComponent(user);
        verticalLayout_4.setComponentAlignment(user, new Alignment(48));
        
        // property
        property = new ComboBox();
        property.setCaption("Property");
        property.setImmediate(false);
        property.setWidth("-1px");
        property.setHeight("-1px");
        verticalLayout_4.addComponent(property);
        verticalLayout_4.setComponentAlignment(property, new Alignment(48));
        
        // value
        value = new TextField();
        value.setCaption("Wert");
        value.setImmediate(false);
        value.setWidth("-1px");
        value.setHeight("-1px");
        verticalLayout_4.addComponent(value);
        verticalLayout_4.setComponentAlignment(value, new Alignment(48));
        
        return verticalLayout_4;
    }

    @AutoGenerated
    private HorizontalLayout buildButtons() {
        // common part: create layout
        buttons = new HorizontalLayout();
        buttons.setImmediate(false);
        buttons.setWidth("100.0%");
        buttons.setHeight("-1px");
        buttons.setMargin(true);
        
        // btn_save
        btn_save = new Button();
        btn_save.setCaption("Speichern");
        btn_save.setImmediate(true);
        btn_save.setWidth("-1px");
        btn_save.setHeight("-1px");
        buttons.addComponent(btn_save);
        buttons.setComponentAlignment(btn_save, new Alignment(48));
        
        return buttons;
    }

}
