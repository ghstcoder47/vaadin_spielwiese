package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Reporting.Form;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Objects;

import org.tepi.filtertable.FilterTable;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.data.util.filter.Compare;
import com.vaadin.data.util.filter.Or;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.shared.ui.label.ContentMode;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.custom.PauseablePollListener;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nMB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.web.normal.UserInfo.UserData;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Reporting.classes.ReportingFooterUpdater;
import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.Icon;


public class ReportingDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
	private HorizontalLayout mainLayout;

	@AutoGenerated
	private VerticalLayout vl_main;

	@AutoGenerated
	private FilterTable tbl_data;

	@AutoGenerated
	private HorizontalLayout layoutFilter;

	@AutoGenerated
	private Button info;

	@AutoGenerated
	private ComboBox viewSelector;

	@AutoGenerated
	private VerticalLayout vl_menuSpacer;

	@AutoGenerated
	private MenuBar men_frm;

	

	

	

	

    

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(ReportingDataView.class);
    
    // Datenbank
    private FilteringTableUpdater tableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_create;
    private MenuBar.MenuItem btn_update;
    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_duplicate;
    private MenuBar.MenuItem btn_filter;

    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PauseablePollListener pollListener = null;
    
    ReportingFooterUpdater tableFooterUpdater;
    
    enum Status {}
    enum Count {}
    enum Project {}
    enum Patient {}
    enum Nurse {}

    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "20";
    private final String formIdPerm = "33";
    private final String winHeight = "600px";
    private final String winWidth = "900px";

    /************************ Filtered Init ******************/

    private HashMap<String, String> filteredInitVars;
    /******************************************************/

//    private final String tableIdCol = "VH_ID";
    
//    private final Object[] tableColsAll = new Object[] { "VH_ID", "VH_CREATED", "PSLV_NAME", "PATIENT", "PSL_COUNTYCODE", "NURSE", "rlead", "pdf_type", "pdf_freq", "COUNT", "COUNT_CUR", "VH_AKTIV" };
    //use custom Cols when needed
//    private final Object[] tableColsDefault = tableColsAll;
    //use custom Cols when needed
//    private final Object[] tableColsFilter = tableColsDefault;
//    private Object[] tableColsActive = tableColsDefault;

    private I18nConverter pdfTypeConverter;
    private I18nConverter pdfFreqConverter;

    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB bool_true = set();
        static final I18nCB bool_false = set();
    }
    
    /******************************************************/

    public ReportingDataView(MenuItem Arg_Menü) {
        tmpMenu = Arg_Menü;
    }

    public ReportingDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        pollListener = new PauseablePollListener() {}; // dummy;

        if(onDetach != null) {
            win.addDetachListener(onDetach);
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        setupListenersAndDetachEvent();
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);

        generateMenu();

        
		fillFields();
		
		
//        setMenuPermissions();

//        
        updateTable();
//        tbl_data.setSortContainerPropertyId(tableIdCol);
//        tbl_data.setSortAscending(true);
//        tbl_data.sort();
        configureTable();
        configueComponents();
        
        i18n.refresh();
    }

    private void setupListenersAndDetachEvent() {
        pollListener = PauseablePollListener.getListener(tab, mainLayout, new PollListener() {
            @Override
            public void poll(PollEvent event) {
//                updateTable();
            }
        });
    }
    
    
    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_create.setEnabled(c);
        btn_create.setVisible(c);

        btn_duplicate.setEnabled(c);
        btn_duplicate.setVisible(c);
        
        btn_read.setEnabled(r);
        btn_read.setVisible(r);

        btn_update.setEnabled(u);
        btn_update.setVisible(u);

        btn_delete.setEnabled(d);
        btn_delete.setVisible(d);
    }

    /************ -><- ******************/
    
   
    /***************** Comands *********************/
    CloseListener closeListener = new CloseListener() {
        
        @Override
        public void windowClose(CloseEvent e) {
            
            pollListener.resume();
            updateTable(true);
            
        }
    };
 

    /******************************************/

    
    

    /*********** Gen Menüs *************/
    private void generateMenu() {

//        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
//        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
//        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
//        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
//        btn_duplicate = men_frm.addItem("FRM_DUPLICATE", Icons.White.projekte_16, cmd_btn_duplicate);
        
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);

    }
    
    private void configueComponents(){
        tableFooterUpdater = new ReportingFooterUpdater(tbl_data);
    	
        viewSelector.setFilteringMode(FilteringMode.CONTAINS);
        viewSelector.setImmediate(true);
        viewSelector.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
            	info.setEnabled(!Objects.isNull(event.getProperty().getValue()));
            	
                dbFillTable();
                
                tableFooterUpdater.setViewName(event.getProperty().getValue().toString());
                tableFooterUpdater.updateTableFooter();
            }
        });
        
        info.setEnabled(false);
        info.setImmediate(true);
        info.setIcon(Icons.White.info_16);
        
        info.addClickListener(new ClickListener() {
			
			@Override
			public void buttonClick(ClickEvent event) {
				
				
				Label label = new Label();
				label.setContentMode(ContentMode.HTML);
				Item selectedItem = viewSelector.getContainerDataSource().getItem(viewSelector.getValue());
				String description = MyUtils.getValueFromItem(selectedItem, "CRV_DESC", String.class);
				
				label.setValue(description);
				
				i18n.messageBox(msg.info, null, label);
				
				log.info("PID: {}", viewSelector.getContainerDataSource().getContainerPropertyIds());
				
			}
		});
        
    }

    private static class msg extends I18nMB{
    	
    	static final I18nMB info = set(Icon.INFO, ButtonId.CLOSE);
    	
    }
    
    private void fillFields(){
    	
    	dbFillView();
    	
    }
    
    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_data.setFilterBarVisible(true);
                tbl_data.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_data.setFilterBarVisible(!tbl_data.isFilterBarVisible());
            
            if(!tbl_data.isFilterBarVisible()){
                tbl_data.clearFilters();
            }
            
//            tableColsActive = tbl_data.isFilterBarVisible() ? tableColsFilter : tableColsDefault;
//            if(tableColsActive.length > 0){
//            	tbl_data.setVisibleColumns(tableColsActive);
//            }

        }
    };
    
    /*************************** Config TBL ********************/

    private void configureTable() {
        tbl_data.setSelectable(true);
        tbl_data.setFilterOnDemand(false);
        tbl_data.setImmediate(true);
        tbl_data.setColumnCollapsingAllowed(false);
        tbl_data.setFooterVisible(true);
        tbl_data.setPageLength(1);
        tbl_data.setColumnCollapsingAllowed(true);

    }

    /*************************** Database ********************/
    
    /********************************/
    
    
    private void updateTable(){
        updateTable(false);
    }
    
    private void updateTable(Boolean ignoreFilter) {
    	
        if ((ignoreFilter || !tbl_data.isFilterBarVisible()) && viewSelector.getValue() != null) {
            dbGetContainer();
            try{
//                tbl_data.setVisibleColumns(tableColsActive);
            }catch(Exception e){
                
            }
        }
        
//        tbl_data.setColumnFooter("VH_AKTIV", "Σ " + tbl_data.size());
        
    }
    
    private void dbGetContainer(){
    	
    }

    private void dbFillTable() {

        tbl_data.setContainerDataSource(null);
        if(viewSelector.getValue() == null) {
            return;
        }

		CustomQuery q = new DBClass().CustomQuery;
		
		String sql = "SELECT" 
			+ "\n " + "	*"
			+ "\n " + "FROM" 
			+ "\n " + viewSelector.getValue() + ";";

		q.setSqlString(sql);

//		q.db.debugNextQuery(true);
		
    	tbl_data.setContainerDataSource(q.query());
    	
    
    }
    
    
    

	private void dbFillView() {
	    
	    
	    // set datasource from i18n
	    I18nConverter views = new I18nConverter("cust_report_views", "CRV_VIEW");
	    views.attachDatasource(viewSelector);
	    
	    // admin sees all
	    if(UserData.get().hasGroup(1)) {
	        return;
	    }
	    
	    // find authorized view ids
	    CustomQuery q = new DBClass().CustomQuery;
        String sql ="SELECT "
           + "\n " + "   CRA_ID_VIEW as id"
           + "\n " + "FROM"
           + "\n " + "   cust_report_assignments"
           + "\n " + "WHERE"
           + "\n " + "   CRA_ID_GROUP IN( "+ Joiner.on(",").join(UserData.get().getGroupIds()) +" ) OR "
           + "\n " + "   CRA_ID_USER = " + UserData.get().getUserId();
        
        q.setSqlString(sql);

        // build filter
        final Container ids = MyUtils.convertIndex(q.query(), "id");
        ArrayList<Filter> filters = new ArrayList<>();
        for (Object iid : ids.getItemIds()) {
            filters.add(new Compare.Equal("CRV_ID", iid));
        }

        IndexedContainer con = (IndexedContainer) viewSelector.getContainerDataSource();
        con.addContainerFilter(new Or(filters.toArray(new Filter[0])));

		
	}
	    
    @AutoGenerated
	private HorizontalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new HorizontalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// vl_main
		vl_main = buildVl_main();
		mainLayout.addComponent(vl_main);
		mainLayout.setExpandRatio(vl_main, 1.0f);
		mainLayout.setComponentAlignment(vl_main, new Alignment(20));
		
		return mainLayout;
	}

	@AutoGenerated
	private VerticalLayout buildVl_main() {
		// common part: create layout
		vl_main = new VerticalLayout();
		vl_main.setImmediate(false);
		vl_main.setWidth("100.0%");
		vl_main.setHeight("100.0%");
		vl_main.setMargin(true);
		
		// vl_menuSpacer
		vl_menuSpacer = buildVl_menuSpacer();
		vl_main.addComponent(vl_menuSpacer);
		
		// layoutFilter
		layoutFilter = buildLayoutFilter();
		vl_main.addComponent(layoutFilter);
		
		// tbl_data
		tbl_data = new FilterTable();
		tbl_data.setImmediate(true);
		tbl_data.setWidth("100.0%");
		tbl_data.setHeight("100.0%");
		vl_main.addComponent(tbl_data);
		vl_main.setExpandRatio(tbl_data, 1.0f);
		vl_main.setComponentAlignment(tbl_data, new Alignment(20));
		
		return vl_main;
	}

	@AutoGenerated
	private VerticalLayout buildVl_menuSpacer() {
		// common part: create layout
		vl_menuSpacer = new VerticalLayout();
		vl_menuSpacer.setImmediate(false);
		vl_menuSpacer.setWidth("100.0%");
		vl_menuSpacer.setHeight("40px");
		vl_menuSpacer.setMargin(false);
		
		// men_frm
		men_frm = new MenuBar();
		men_frm.setImmediate(false);
		men_frm.setWidth("100.0%");
		men_frm.setHeight("-1px");
		vl_menuSpacer.addComponent(men_frm);
		vl_menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
		
		return vl_menuSpacer;
	}

	@AutoGenerated
	private HorizontalLayout buildLayoutFilter() {
		// common part: create layout
		layoutFilter = new HorizontalLayout();
		layoutFilter.setImmediate(false);
		layoutFilter.setWidth("100.0%");
		layoutFilter.setHeight("-1px");
		layoutFilter.setMargin(true);
		layoutFilter.setSpacing(true);
		
		// viewSelector
		viewSelector = new ComboBox();
		viewSelector.setCaption("View");
		viewSelector.setImmediate(false);
		viewSelector.setWidth("-1px");
		viewSelector.setHeight("-1px");
		layoutFilter.addComponent(viewSelector);
		layoutFilter.setExpandRatio(viewSelector, 1.0f);
		layoutFilter.setComponentAlignment(viewSelector, new Alignment(10));
		
		// info
		info = new Button();
		info.setCaption("Erläuterung");
		info.setImmediate(true);
		info.setWidth("-1px");
		info.setHeight("-1px");
		layoutFilter.addComponent(info);
		layoutFilter.setExpandRatio(info, 1.0f);
		layoutFilter.setComponentAlignment(info, new Alignment(9));
		
		return layoutFilter;
	}
}
