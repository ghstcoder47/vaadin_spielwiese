package archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.Patientenverwaltung.classes;

import java.sql.Timestamp;
import java.util.ArrayList;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowDataField;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowPopupInput;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.DateField;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

public class PatientCommentInput extends CustomComponent implements MultiRowPopupInput{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Button save;
    @AutoGenerated
    private TextArea comment;
    // {section fields}
    // ****************
    
    org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    private DateField created;
    private DateField updated;
    private ComboBox author;
    private ComboBox type;
    private IntStepper data;
    
    private Filter typeFilter;
    private I18nConverter typeConverter;
    
    private ArrayList<MultiRowDataField> fields;
    
    private Window win;
    private SaveAction saveAction; 
    // {end fields}

    // {section constructors}
    // **********************
    public PatientCommentInput() {
        buildMainLayout();
        configureConverters();
        configureComponents();
        getFields();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public void setTypeConverter(I18nConverter typeConverter) {
        this.typeConverter = typeConverter;
        this.typeConverter.attachDatasource(type);
    }
    
    public I18nConverter getTypeConverter() {
        return typeConverter;
    }
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    public void setType(String typeString) {
        if(!type.getContainerDataSource().getItemIds().contains(typeString)) {
            dbSaveType(typeString);
            type.getContainerDataSource().addItem(typeString).getItemProperty("PCT_TYPE").setValue(typeString);
        }
        type.setValue(typeString);
    }
    
    public void setData(Integer dataId) {
        data.setValue(dataId);
    }

    public void setAuthor(Integer userId) {
        author.setValue(userId);
    }
    
    @Override
    public ArrayList<MultiRowDataField> getFields() {
        
        if(fields != null) {
            return fields;
        }
        
        fields = new ArrayList<MultiRowDataField>();
        
        MultiRowDataField commentField = new MultiRowDataField(comment, "PC_COMMENT", TextArea.class);
        commentField.setDefaultValue("");
        fields.add(commentField);
        

        MultiRowDataField createdField = new MultiRowDataField(created, "PC_CREATED", Timestamp.class);
        fields.add(createdField);
        

        MultiRowDataField updatedField = new MultiRowDataField(updated, "PC_UPDATED", Timestamp.class);
        fields.add(updatedField);
        

        MultiRowDataField authorField = new MultiRowDataField(author, "PC_ID_AUTHOR", Integer.class);
        authorField.setDataSource(dbGetAuthors(), "AUL_ID", "author");
        fields.add(authorField);
        
        MultiRowDataField typeField = new MultiRowDataField(type, "PC_TYPE", String.class);
        typeField.setDataSource(dbGetTypes(), "PCT_TYPE", "PCT_TYPE");
        typeField.setConverter(typeConverter);
        fields.add(typeField);
        
        MultiRowDataField dataField = new MultiRowDataField(data, "PC_DATA", Integer.class);
        fields.add(dataField);

        return fields;
    }

    @Override
    public void show() {
        if(win == null) {
            Build_Window_Button bwb = new Build_Window_Button("Kommentar schreiben", mainLayout, "250", "500", null);
            win = bwb.ReturnWindow();
            win.setStyleName("scrollfix");
            
            win.addCloseListener(new CloseListener() {
                
                @Override
                public void windowClose(CloseEvent e) {
                    
                    //clear fields since reopening does not create a new instance
                    comment.setValue("");
                    toggleEnabled(true);
                    
                }
            });
            
        }else {
            UI.getCurrent().getUI().addWindow(win);
        }
    }
    
    @Override
    public void setValue(Item item) {
        comment.setValue(MyUtils.getValueFromItem(item, "PC_COMMENT", String.class));
        toggleEnabled(false);
    }
    
    @Override
    public void setSaveAction(SaveAction saveAction) {
        
        this.saveAction = saveAction;
        
    }
    
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    private void configureConverters() {
        typeConverter = new I18nConverter("cust_patient_comment_types", "PCT_TYPE"); 
    }
    
    private void configureComponents() {
        
        created = new DateField();
        updated = new DateField();
        author = new ComboBox();
        type = new ComboBox();
        data = new IntStepper();
        
        comment.setRequired(true);
        
        save.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                log.info("author value {}", author.getValue());
                
                if(saveAction != null) {
                    saveAction.onSave(getFields());
                }
                
                win.close();
                
            }
        });
    }
    
    private void toggleEnabled(Boolean enabled) {
        comment.setEnabled(enabled);
        comment.setStyleName(enabled ? "" : "nogrey"); 
        save.setVisible(enabled);
        save.setEnabled(enabled);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    private Container dbGetAuthors() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select AUL_ID, CONCAT_WS('', AUL_VORNAME, ' ', AUL_NAME) as author"
                    + "\n " + "from cms_auth_stammdaten_user where AUL_USERNAME != ''";
        q.setSqlString(sql);
        return q.query();
    }
    
    private Container dbGetTypes() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PCT_TYPE from cust_patient_comment_types";
        q.setSqlString(sql);
        
        return q.query();
    }
    
    private void dbSaveType(String type) {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "INSERT INTO cust_patient_comment_types (`PCT_TYPE`) VALUES ('"+type+"');";
        q.setSqlString(sql);
        q.update();
    }
    // {end database}

    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100%");
        
        // comment
        comment = new TextArea();
        comment.setCaption("Kommentar");
        comment.setImmediate(false);
        comment.setWidth("100.0%");
        comment.setHeight("100.0%");
        mainLayout.addComponent(comment);
        mainLayout.setExpandRatio(comment, 1);
        
        // save
        save = new Button();
        save.setCaption("Speichern");
        save.setImmediate(true);
        save.setWidth("-1px");
        save.setHeight("-1px");
        mainLayout.addComponent(save);
        mainLayout.setComponentAlignment(save, new Alignment(48));
        
        return mainLayout;
    }
}
