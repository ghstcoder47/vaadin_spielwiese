package archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.form;

import java.math.BigDecimal;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.apache.commons.lang3.tuple.Pair;
import org.joda.time.Days;
import org.joda.time.LocalDate;
import org.joda.time.LocalDateTime;
import org.joda.time.LocalTime;
import org.joda.time.format.DateTimeFormat;
import org.joda.time.format.DateTimeFormatter;
import org.vaadin.jonatan.contexthelp.ContextHelp;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.web.normal.UserInfo.Country;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.OpenTickets.classes.SetQueryStatusLng;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.OpenTickets.classes.TITYPE;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.OpenTickets.form.OpenTicketsInsertEdit;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.AutoPackager;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.SumsComponent;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.TicketDbActions;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.TicketDbActions.CreateParams;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.TicketEvent;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.TicketEvent.TicketType;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes.TicketEventContentEdit;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.classes.ProductConverter;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.classes.UserAttributesCountry;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.classes.ProjectNurseCombos;

import com.google.common.base.Joiner;
import com.google.ical.iter.RecurrenceIterator;
import com.google.ical.iter.RecurrenceIteratorFactory;
import com.google.ical.values.DateValueImpl;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.event.FieldEvents.FocusEvent;
import com.vaadin.event.FieldEvents.FocusListener;
import com.vaadin.server.Page;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.Position;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.shared.ui.datefield.Resolution;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.Calendar;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.Notification;
import com.vaadin.ui.Notification.Type;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;
import com.vaadin.ui.components.calendar.CalendarComponentEvents;
import com.vaadin.ui.components.calendar.CalendarComponentEvents.DateClickEvent;
import com.vaadin.ui.components.calendar.CalendarComponentEvents.EventClick;
import com.vaadin.ui.components.calendar.CalendarComponentEvents.MoveEvent;
import com.vaadin.ui.components.calendar.CalendarComponentEvents.RangeSelectEvent;
import com.vaadin.ui.components.calendar.CalendarComponentEvents.WeekClick;
import com.vaadin.ui.components.calendar.event.CalendarEvent;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.Icon;
import de.steinwedel.messagebox.MessageBox;
import de.steinwedel.messagebox.MessageBoxListener;

@SuppressWarnings({"serial", "rawtypes", "unchecked"})
public class PackageCreatorDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private VerticalLayout mainContainer;

    @AutoGenerated
    private VerticalLayout verticalLayout_1;

    @AutoGenerated
    private Calendar calendarData;

    @AutoGenerated
    private HorizontalLayout globalFilterContainer;

    @AutoGenerated
    private VerticalLayout sumsLayout;

    @AutoGenerated
    private Button ticketSums;

    @AutoGenerated
    private Label legend;

    @AutoGenerated
    private HorizontalLayout filterComboLayout;

    @AutoGenerated
    private VerticalLayout verticalLayout_3;

    @AutoGenerated
    private ComboBox filterPatient;

    @AutoGenerated
    private ComboBox filterNurse;

    @AutoGenerated
    private VerticalLayout verticalLayout_2;

    @AutoGenerated
    private ComboBox filterProject;

    @AutoGenerated
    private ComboBox filterType;

    @AutoGenerated
    private ComboBox filterCountry;

    @AutoGenerated
    private HorizontalLayout filterMonthLayout;

    @AutoGenerated
    private Button filterMonthReturn;

    @AutoGenerated
    private PopupDateField filterMonth;

    @AutoGenerated
    private VerticalLayout menuSpacer;

    @AutoGenerated
    private MenuBar men_frm;

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

	

	

	

	

	

	

	

	

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    private org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());

    // Datenbank
    private Map<Object, String> componentMap;
//    private FilteringTableUpdater tableUpdater = null;
    private FilteringTableUpdater warningUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    ContextHelp contextHelp;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_create;
    private MenuBar.MenuItem btn_update;
    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_filter;
    private MenuBar.MenuItem btn_details;
    private MenuBar.MenuItem btn_refresh;

    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/
    
    public static Integer warningDays = 1;
    private BeanItemContainer<TicketEvent> calendarContainer;
    private Filter patientFilter;
    private Filter tempFilter;
    private Filter projectFilter;
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "106";
    private final String formIdPerm = "106";
    private final String winHeight = "600px";
    private final String winWidth = "900px";

    private I18nManager i18n;

    private I18nConverter statusConverter;

    private final static class caption extends I18nCB {
        static final I18nCB NURSE = set();
        static final I18nCB PATIENT = set();
        static final I18nCB GENERIC = set();
        
        static final I18nCB ticket_generic = set();
        static final I18nCB status_unknown = set();
    }
    
    /******************************************************/

    /******************************************************/

    public PackageCreatorDataView(MenuItem Arg_Menü) {
        tmpMenu = Arg_Menü;
    }

    public PackageCreatorDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        
        registerComponents();
        
        generateMenu();

        setMenuPermissions();
        
        fillNurseCombo();
        fillCountryCombo();
        fillTypes();
        fillPatients();
        fillProjects();
        
        setNurseUID();
        setCountryKey(); //TASK
        
        updateCalendar();
        configureComponents();

        
        //setupListenersAndDetachEvent();
        i18n.refresh();
    }
    
    // register components for lng and validation tools
    private void registerComponents(){
    	componentMap = new HashMap<Object, String>();
    	new ComponentIterator(mainContainer).createMap(componentMap);
    }

    
    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        
//        btn_details.setEnabled(r);
//        btn_details.setVisible(r);
        
        btn_create.setEnabled(c);
        btn_create.setVisible(c);
//
//        btn_read.setEnabled(r);
//        btn_read.setVisible(r);
//
//        btn_update.setEnabled(u);
//        btn_update.setVisible(u);
//
//        btn_delete.setEnabled(d);
//        btn_delete.setVisible(d);
    }

    /************ -><- ******************/

    /***************** Comands *********************/
    
    CloseListener closeListener = new CloseListener() {
		
		@Override
		public void windowClose(CloseEvent e) {
			updateCalendar();
		}
	};
    
	
    public Command cmd_btn_refresh = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            updateCalendar();

        }
    };
    
    public Command cmd_btn_add = new Command() {
        
        @Override
        public void menuSelected(MenuItem selectedItem) {
            
            CreateParams params = new CreateParams();
            params.selectedItem = selectedItem;
            params.closeListener = closeListener;
            params.parent = men_frm;
            params.userId = getNurseUserId();
            params.country = (String) filterCountry.getValue();
            
            Date date = null;
            if(ticketSums.getData() != null) {
                try {
                   Pair<Date, Date> data = (Pair<Date, Date>) ticketSums.getData();
                   date = data.getLeft();
                } catch (Exception e) {
                }
            }
            params.shippingDate = date; 
            params.date = new Date();
            
            TicketDbActions dba = new TicketDbActions(); 
            dba.createAndOpen(params);
            
        }
    };
        
    

    /******************************************/

    
    

    /*********** Gen Menüs *************/
    private void generateMenu() {

        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
//        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.add_16, cmd_btn_edit);
//        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
//        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        
//    	btn_details = men_frm.addItem("FRM_DETAILS", null, cmd_btn_details);
//    	btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);
    	btn_refresh = men_frm.addItem("FRM_REFRESH", Icons.White.refresh_16, cmd_btn_refresh);
        

    }
    
    private Date generateOrderDate(){
    	
        return new Date();
    	
    }
    
    private void configureComponents(){
    	
        filterMonth.setDateFormat("MMM yyyy");
        
        filterMonth.setImmediate(true);
        filterMonth.setResolution(Resolution.MONTH);
        filterMonth.setValue(generateOrderDate());
        filterMonth.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateCalendar();
                
            }
        });
        
        configureCalendar();
        
        filterMonthReturn.setImmediate(true);
        filterMonthReturn.setVisible(false);
        filterMonthReturn.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                returnToMonthlyView();
                
            }
        });
        
        filterNurse.setImmediate(true);
        filterNurse.setFilteringMode(FilteringMode.CONTAINS);
        filterNurse.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateCalendar(false);
                
            }
        });
        
        filterCountry.setImmediate(true);
        filterCountry.setFilteringMode(FilteringMode.CONTAINS);
        filterCountry.setItemCaptionPropertyId("CC_TEXT");
        filterCountry.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateCalendar(false);
                
            }
        });
        
        filterType.setImmediate(true);
        filterType.setFilteringMode(FilteringMode.CONTAINS);
        filterType.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateCalendar(false);
                
            }
        });
        
        setLegendTooltip();
        
        // this is to fix the unresponsive click listener after calculating sums 
        tempFilter = new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                return false;
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return false;
            }
        };
        
        ticketSums.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                VerticalLayout vl = new VerticalLayout();
                
                Pair<Date, Date> dates = (Pair<Date, Date>) ticketSums.getData();
                
                List<CalendarEvent> selectedEvents = calendarData.getEvents(dates.getLeft(), new LocalDate(dates.getRight()).plusDays(1).toDate());
                
                MessageBoxListener mbl = new MessageBoxListener() {
                    
                    @Override
                    public void buttonClicked(ButtonId arg0) {
                        //fix for calcSums disabling clicklistener
                        calendarContainer.addContainerFilter(tempFilter);
                        calendarContainer.removeContainerFilter(tempFilter);
                        
                    }
                };

                
                DateTimeFormatter fmt = DateTimeFormat.forPattern("dd.MM");
                MessageBox box = MessageBox.showCustomized(Icon.NONE, String.format("Paketinhalte von %s bis %s",
                        fmt.print(dates.getLeft().getTime()), fmt.print(dates.getRight().getTime())),
                        calculateProductMap(selectedEvents), mbl, ButtonId.OK);
                
                box.setWidth("550px");
                box.setHeight("600px");
                
            }
        });
        
        filterPatient.setWidth("178px");
        filterPatient.setImmediate(true);
        filterPatient.setFilteringMode(FilteringMode.CONTAINS);
        filterPatient.setItemCaptionPropertyId("patient");
        filterPatient.setInvalidAllowed(true);
        filterPatient.addFocusListener(new FocusListener() {
            
            @Override
            public void focus(FocusEvent event) {
                
                Object prev = filterPatient.getValue();
                
                filterPatient.setEnabled(false);
                if(prev != null) {
                    filterPatient.setValue(null);
                    updateCalendar(true);
                }
                filterPatient.setEnabled(true);
                
            }
        });
        filterPatient.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                triggerPatientFilter();
            }
        });
        
        filterProject.setImmediate(true);
        filterProject.setFilteringMode(FilteringMode.CONTAINS);
        filterProject.setItemCaptionPropertyId("PSLV_NAME");
        filterProject.setInvalidAllowed(true);
        filterProject.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                triggerProjectFilter();
            }
        });
        
    }
    
    private void addToProductMap(HashMap<Integer, Integer> productMap, Integer product, Integer quantity) {
        if(productMap.get(product) == null) {
            productMap.put(product, quantity);
        }else {
            productMap.put(product, productMap.get(product) + quantity);
        }
    }
    
    private HashMap<String, Integer> translateProductMap(HashMap<Integer, Integer> map){
        HashMap<String, Integer> res = new HashMap<String, Integer>();
        
        ProductConverter conv = new ProductConverter();
        
        for (Entry<Integer, Integer> entry : map.entrySet()) {
            res.put(conv.convertToPresentation(entry.getKey(), String.class, getLocale()), entry.getValue());
        }
        
        return res;
    }
    
    private SumsComponent calculateProductMap(List<CalendarEvent> selectedEvents) {
        
        HashMap<Integer, Integer> productMap = new HashMap<Integer, Integer>();
        ArrayList<Integer> queryList = new ArrayList<Integer>();
        
        
        Packs packs = new Packs();
        AutoPackager packager = new AutoPackager();
        
        
        for (CalendarEvent sev : selectedEvents) {
            
            TicketEvent ticketEvent = (TicketEvent) sev;
            
            Totals totals = new Totals(packager);
            
            if(ticketEvent.getType() == TicketType.STANDALONE) { // add standalone contents
                
                Item item = ticketEvent.getItem();
                
                totals.add(MyUtils.getValueFromItem(item, "OMS_KEY_COUNTRY", String.class),
                    MyUtils.getValueFromItem(item, "OMS_ID_PATIENT", Integer.class),
                    MyUtils.getValueFromItem(item, "OMS_ID_PRODUCT", Integer.class),
                    MyUtils.getValueFromItem(item, "OMS_QUANTITY", Integer.class));
                
                addToProductMap(productMap, MyUtils.getValueFromItem(item, "OMS_ID_PRODUCT", Integer.class),
                    MyUtils.getValueFromItem(item, "OMS_QUANTITY", Integer.class));
                
            }
            
            if(ticketEvent.getType() == TicketType.PLANNED) { // add planned contents to product map
                
                for (Item eventContent : ticketEvent.getContents()) {
                    
                    totals.add(MyUtils.getValueFromItem(eventContent, "country", String.class),
                        MyUtils.getValueFromItem(eventContent, "patient_id", Integer.class),
                        MyUtils.getValueFromItem(eventContent, "product", Integer.class),
                        MyUtils.getValueFromItem(eventContent, "project_quantity", BigDecimal.class).intValue());
                    
                    addToProductMap(productMap, MyUtils.getValueFromItem(eventContent, "product", Integer.class),
                        MyUtils.getValueFromItem(eventContent, "project_quantity_static", Number.class).intValue());
                    
                }
                
            }
            
            if(ticketEvent.getType() == TicketType.CREATED) { // keep ids for db query later
                queryList.add(ticketEvent.getId());
            }
            
            totals.addToPacks(packs);
            
        }
        
        Container queryContainer = getCreatedContents(queryList);
        
        if(queryContainer != null) {
            
            HashMap<Integer, ArrayList<Item>> contentsByTicket = new HashMap<Integer, ArrayList<Item>>();
            
            for (Object cid : queryContainer.getItemIds()) { // count CREATED contents
                
                Integer product = MyUtils.getValueFromItem(queryContainer.getItem(cid), "OMTC_ID_PRODUCT", Integer.class);
                Integer quantity = MyUtils.getValueFromItem(queryContainer.getItem(cid), "OMTC_QTY", Integer.class);
                
                //new totals map, but save to existing sizesmap!
                
                if(product == null) {
                    System.out.println("warning: package#" + MyUtils.getValueFromItem(queryContainer.getItem(cid), "OMTC_ID_TICKET", Integer.class));
                    
                    Notification notif = new Notification("Hinweis", "Produkt-Fehler in Paket #" + MyUtils.getValueFromItem(queryContainer.getItem(cid), "OMTC_ID_TICKET", Integer.class), Type.WARNING_MESSAGE);
                    notif.setDelayMsec(10000);
                    notif.setPosition(Position.MIDDLE_CENTER);
                    notif.setHtmlContentAllowed(true);
                    notif.show(Page.getCurrent());
                    continue;
                    
                }
                
                Integer tid = MyUtils.getValueFromItem(queryContainer.getItem(cid), "OMTC_ID_TICKET", Integer.class);
                
                if(contentsByTicket.get(tid) == null) {
                    contentsByTicket.put(tid, new ArrayList<Item>());
                }
                contentsByTicket.get(tid).add(queryContainer.getItem(cid));
                
                if(productMap.get(product) == null) {
                    productMap.put(product, quantity);
                }else {
                    productMap.put(product, productMap.get(product) + quantity);
                }
            }
            
            for (ArrayList<Item> itemList : contentsByTicket.values()) {
                Totals totals = new Totals(packager);
                
                for (Item item : itemList) {
                    totals.add(MyUtils.getValueFromItem(item, "OMT_KEY_COUNTRY", String.class),
                        MyUtils.getValueFromItem(item, "OMTC_ID_PATIENT", Integer.class),
                        MyUtils.getValueFromItem(item, "OMTC_ID_PRODUCT", Integer.class),
                        MyUtils.getValueFromItem(item, "OMTC_QTY", Integer.class));
                }
                
                totals.addToPacks(packs);
            }
        }
        
        SumsComponent sc = new SumsComponent();
        sc.setPackager(packager);
        sc.setSums(productMap);
        sc.setSizes(packs);
        
        return sc;
    }
    
    private void setLegendTooltip() {
        
        StringBuilder tooltip = new StringBuilder();
        
        LinkedHashMap<String, String> styles = new LinkedHashMap<String, String>();
//        styles.put("empty", "empty");
        styles.put("unaccepted", "Nicht angenommener Auftrag");
        styles.put("warning", "Planlieferung im Verzug");
        styles.put("full", "Planlieferung lt. Auftragsbestand");
        styles.put("nurse_edit", "<b>[Planung]</b> - Paket in Nurse-Planung");
        styles.put("order_placed", "<b>[Bestellt]</b> - Paket von Nurse angefordert");
        styles.put("order_prepared", "<b>[Vorbereitung]</b> - Paket in Vorbereitung durch Apotheke");
        styles.put("nurse_sent", "<b>[Versendet]</b> - Paket versendet");
        
        tooltip.append("<div class=\"v-calendar package-legend\">");
        
        for (Entry entry : styles.entrySet()) {
            
            tooltip.append("<div class=\"legend-entry v-calendar-event-all-day v-calendar-event-" + entry.getKey() +"-all-day\">" + entry.getValue() +"</div>");
            
        }
        
        tooltip.append("<div class=\"legend-entry v-calendar-event-all-day\"><b>[Empfangen]</b> - Paketempfang bestätigt</div>");
        
        tooltip.append("<div>Besondere Tage:</div>");
        tooltip.append("<div class=\"legend-entry v-calendar-event-all-day v-calendar-event-date-type_no_orders-all-day\">Bestellverbot</div>");
        
        
        tooltip.append("</div>");
        
        legend.setDescription(tooltip.toString());
        
    }
    
    private void configureCalendar(){
        
        calendarData.setImmediate(true);
        
        calendarData.setHandler(new CalendarComponentEvents.EventClickHandler() {
            
            @Override
            public void eventClick(EventClick event) {
                
                TicketEvent tev = (TicketEvent) event.getCalendarEvent();
                
                if(tev == null || tev.getType() == null) {
                    return;
                }
                
                switch (tev.getType()) {
                case STANDALONE:
                    calendarData.setEnabled(false); // explicit to avoid issues with UNACCEPTED_GROUPED
                    clickPlanned(tev);
                    break;
                
                case PLANNED:
                    calendarData.setEnabled(false); // explicit to avoid issues with UNACCEPTED_GROUPED
                    clickPlanned(tev);
                    break;
                    
                case CREATED:
                    calendarData.setEnabled(false);
                    clickCreated(tev);
                    break;
                    
                case UNACCEPTED_SINGLE:
                    // calendarData.setEnabled(false); // TASK requires TicketEventContentEdit work for VPRIV / REP
                    clickUnacceptedSingle(tev);
                    break;

                default:
                    break;
                }
                
            }
        });
        
        calendarData.setHandler(new CalendarComponentEvents.DateClickHandler() {
            
            @Override
            public void dateClick(DateClickEvent event) {
                
                if(returnToMonthlyView()){
                    return;
                }
                
                filterMonth.setVisible(false);
                filterMonthReturn.setVisible(true);
                
                Date clickedDate = event.getDate();

                LocalDate start = MyUtils.getWeekMonday(clickedDate, 0);
                LocalDate end = start.plusWeeks(1).minusDays(1);

                setDates(event, start.toDate(), end.toDate());
                
                calendarData.setStyleName("no-arrows");
            }
            
            protected void setDates(DateClickEvent event, Date start, Date end) {
                event.getComponent().setStartDate(start);
                event.getComponent().setEndDate(end);
            }
            
        });
        
        calendarData.setHandler(new CalendarComponentEvents.WeekClickHandler() {
            
            @Override
            public void weekClick(WeekClick event) {
                
                if(returnToMonthlyView()){
                    return;
                }
                
                filterMonth.setVisible(false);
                filterMonthReturn.setVisible(true);
                
                Date clickedDate = new LocalDate(calendarData.getStartDate()).withWeekOfWeekyear(event.getWeek()).toDate();

                LocalDate start = MyUtils.getWeekMonday(clickedDate, 0);
                LocalDate end = start.plusWeeks(1).minusDays(1);

                setDates(event, start.toDate(), end.toDate());
                
                calendarData.setStyleName("no-arrows");
            }
            
            protected void setDates(WeekClick event, Date start, Date end) {
                event.getComponent().setStartDate(start);
                event.getComponent().setEndDate(end);
            }
                
        });
        
        calendarData.setHandler(new CalendarComponentEvents.RangeSelectHandler() {
            
            @Override
            public void rangeSelect(RangeSelectEvent event) {
                
                ticketSums.setData(Pair.of(event.getStart(), event.getEnd()));
                ticketSums.setEnabled(true);
                
            }
        });
        
        calendarData.setHandler(new CalendarComponentEvents.EventMoveHandler() {
            
            @Override
            public void eventMove(MoveEvent event) {
                
                updateCalendar(false);
                
            }
        });

    }
    
    private Boolean returnToMonthlyView(){
        if(!calendarData.isMonthlyMode()){
            calendarData.setStyleName(null);
            filterMonth.setVisible(true);
            filterMonthReturn.setVisible(false);
            setCalendarRange();
            return true;
        }
        return false;
    }
    
    private void clickPlanned(TicketEvent tev){
        if(!(permRead == 1)){
            return;
        }
        
        final PackageCreatorInsertEdit pcie = new PackageCreatorInsertEdit(tev);
        pcie.setPermissions(permCreate, permRead, permUpdate, permDelete);
        pcie.init();
        
        pcie.getWindow().addCloseListener(new CloseListener() {
            
            @Override
            public void windowClose(CloseEvent e) {
                
                calendarData.setEnabled(true);
                
                if(pcie.wasSaved()){
                    updateCalendar(false);
                    
                    final OpenTicketsInsertEdit tiw = pcie.getOpenTicketWindow();
                    tiw.getWindow().addCloseListener(new CloseListener() {
                        
                        @Override
                        public void windowClose(CloseEvent e) {
                            
                            calendarData.setEnabled(true);
                            
                            if (tiw.wasSaved()) {
                                updateCalendar(false);
                            }
                            
                        }
                    });
                    
                }
                
            }
        });
    }
    
    private void clickCreated(TicketEvent tev){
        final OpenTicketsInsertEdit tie = new OpenTicketsInsertEdit(tev.getId().toString());
        tie.setPermissionsFromDatabase();
        tie.init();
        
        tie.getWindow().addCloseListener(new CloseListener() {
            
            @Override
            public void windowClose(CloseEvent e) {
                
                calendarData.setEnabled(true);
                
                if(tie.wasSaved()){
                    updateCalendar(true);
                }
                    
            }
        });
    }
    
    private void clickUnacceptedSingle(TicketEvent tev){
        new TicketEventContentEdit(tev) {
            
            @Override
            public void onUpdate() {
                
                updateCalendar(false);
                
            }

            @Override
            public void onClose() {
                calendarData.setEnabled(true);
            }
        }.open();
    }
    
    private LocalDate getSelectedMonthStart(){
        
        LocalDate selectedDate = new LocalDate(filterMonth.getValue());
        LocalDate date = new LocalDate(selectedDate.getYear(), selectedDate.getMonthOfYear(), 1);
        return date;
    }
    
    private LocalDate getSelectedMonthEnd(){
        LocalDate date = getSelectedMonthStart().plusMonths(1).minusDays(1);
        return date;
    }
    
    private void setCalendarRange(){
        
        
        LocalDate startDate = getSelectedMonthStart();
        LocalDate endDate = getSelectedMonthEnd();
        
        calendarData.setStartDate(startDate.toDate());
        calendarData.setEndDate(endDate.toDate());
        
    }
    
    
    /*****************************************************************/
    

    /*************************** Config TBL ********************/


    
    /*************************** Database ********************/
    
    /********************************/
    
	private void updateCalendar() {
	    updateCalendar(true);
	}
	
    private void updateCalendar(Boolean setRange) {
        
        if(setRange){
            setCalendarRange();
        }
        
//        calendarData.setEnabled(false);
        
        BeanItemContainer<TicketEvent> container;
        container = generateCalendarEntries();
        updateCalendarEntries(container);
        
        ticketSums.setData(null);
        ticketSums.setEnabled(false);
        
        triggerPatientFilter();
        triggerProjectFilter();
        
//        calendarData.setEnabled(true);
        
        
//        new AsyncJob() {
//            
//            BeanItemContainer<TicketEvent> container;
//            
//            @Override
//            public void startJob() {
//                container = generateCalendarEntries();
//            }
//            
//            @Override
//            public void stopJob() {
//                updateCalendarEntries(container);
//                calendarData.setEnabled(true);
//            }
//            
//        }.run();
        
        
    }
    
    private Integer getNurseUserId(){
        return (Integer) filterNurse.getValue();
    }
    
    private static Container getNursePreferences(Integer nurseUserId){
        
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("*");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(AUL_VORNAME, ' ', AUL_NAME)", "nurse");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_ordermanager_preferences", "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "OMPR_ID_USER", "KSK_U_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "AUL_ID", "KSK_U_ID");
        
        if(nurseUserId != null){
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_ID", "=", nurseUserId.toString(), "");
        }
        
//        db.debugNextQuery(true);
        
        return db.DB_Data_Get.DB_SEND_AND_GET_Container();
        
    }
    
    private Container getStandaloneSettings() {
        
        CustomQuery q = new DBClass().CustomQuery;
        q.setSqlString("SELECT "
             + "\n " + "    cust_ordermanager_standalone.*"
             + "\n " + "    , PP_PRODUCT"
             + "\n " + "    , PP_ID_PROJECT" // used by projectfilter
             + "\n " + "    , OMS_ID_PRODUCT"
             + "\n " + "    , OMS_QUANTITY"
             + "\n " + "    , CONCAT(PSL_VORNAME, ' ', PSL_NAME) AS name"
             + "\n " + "FROM cust_ordermanager_standalone"
             + "\n " + "LEFT JOIN cust_prescriptions_products ON OMS_ID_PRODUCT = PP_ID"
             + "\n " + "LEFT JOIN cust_patient_stammdaten_liste ON OMS_ID_PATIENT = PSL_ID"
             + "\n" + ((filterCountry.getValue() != null) ? ("WHERE OMS_KEY_COUNTRY = '" + filterCountry.getValue() + "'") : "")
             );
//        q.db.debugNextQuery(true);
        
        return q.query();
    }
    
    private void sortContainer(BeanItemContainer<TicketEvent> container){
        container.sort(new Object[]{"start", "importance", "nurse", "address"}, new boolean[]{true});
    }
    
    private void updateCalendarEntries(BeanItemContainer<TicketEvent> container){
        sortContainer(container);
        this.calendarContainer = container;
        calendarData.setContainerDataSource(container,
                "caption", "description", "start", "end", "styleName");
        calendarData.setSizeFull();
    }
    
    private BeanItemContainer<TicketEvent> generateCalendarEntries(){
        
        // Use a container of built-in BasicEvents
        final BeanItemContainer<TicketEvent> container =
            new BeanItemContainer<TicketEvent>(TicketEvent.class);

        TITYPE pt = TITYPE.get((String) filterType.getValue()); 
        Boolean pat = filterPatient.getValue() != null;
        Boolean pro = filterProject.getValue() != null;
        
        addCalendarDates(container);
        
        if((pt == null || pt == TITYPE.NURSE)) {                        addAllPlannedEvents(container);};
        addAllCreatedEvents(container);
        if((pt == null || pt == TITYPE.NURSE) && !(pat || pro)) {       addAllUnacceptedEvents(container);};
        if((pt == null || pt == TITYPE.PATIENT)) {                      addAllStandaloneEvents(container);}
        if((pt == null ) && !(pat || pro)) {                            addAllManufacturerOrderEvents(container);};
        
        return container;
        
    }
    
    private void addCalendarDates(BeanItemContainer<TicketEvent> container) {
        
        I18nConverter typeConverter = new I18nConverter("cust_calendar_dates_types", "CDT_KEY", "CDT_KEY");
        Container dates = getCalendarDates();
        
        for (Object iid : dates.getItemIds()) {
            Item item = dates.getItem(iid);
            
            Date start = MyUtils.getValueFromItem(item, "CD_DATE_START", Date.class);
            Date end = MyUtils.getValueFromItem(item, "CD_DATE_END", Date.class);
            String title = MyUtils.getValueFromItem(item, "CD_TITLE", String.class);
            String country = MyUtils.getValueFromItem(item, "CD_COUNTRY", String.class);
            String type = MyUtils.getValueFromItem(item, "CD_TYPE", String.class);
            String comment = MyUtils.getValueFromItem(item, "CD_COMMENT", String.class); 
            
            String caption = (country != null ? "[" + country + "] " : "") + title;
            String description = "<b>" + typeConverter.getLngText(type) + "</b><br />" + comment;
            
            TicketEvent event = new TicketEvent(caption, description, start, end != null ? end : start);
//            TicketEvent event = new TicketEvent(caption, comment, start);
            event.setImportance(1000);
            event.setAllDay(true);
            event.setStyleName("date-" + type);
            event.setCountryKey(country);
            container.addBean(event);
            
        }
        
    }
    
    /**
     * This needs to be called AFTER addAllCreatedEvents() to handle duplicates
     * @param container
     */
    private void addAllStandaloneEvents(BeanItemContainer<TicketEvent> container) {
        
        if(getNurseUserId() != null){
            return;
        }
        
        Container settings = getStandaloneSettings();
        
        LocalDate calendarStart = getVisibleStart().minusDays(1);
        LocalDate calendarEnd = getVisibleEnd().plusDays(1);
        
        ArrayList<StandaloneBean> standaloneBeanList = new ArrayList<StandaloneBean>();
        
//        LocalDate earliest = new LocalDate();
//        LocalDate latest = new LocalDate();
        
        for(Object id : settings.getItemIds()){
            
            Item setting = settings.getItem(id);
            
            java.sql.Date start = MyUtils.getValueFromItem(setting, "OMS_RRULE_START", java.sql.Date.class);  
            String rrule = MyUtils.getValueFromItem(setting, "OMS_RRULE", String.class);
            
            
            if(start != null && rrule != null){
                    
                LocalDate lStart = new LocalDate(start);
                
                try {
                    
                    RecurrenceIterator iter = RecurrenceIteratorFactory.createRecurrenceIterator(rrule, new DateValueImpl(
                            lStart.getYear(), lStart.getMonthOfYear(), lStart.getDayOfMonth()
                            ), java.util.TimeZone.getDefault(), false);
                    
                    DateValueImpl dv = new DateValueImpl(calendarStart.getYear(), calendarStart.getMonthOfYear(), calendarStart.getDayOfMonth());
                    
                    iter.advanceTo(dv);
                    
                    while(iter.hasNext()){
                        
                        DateValueImpl dvi = (DateValueImpl) iter.next();
                        LocalDate next = new LocalDate(dvi.year(), dvi.month(), dvi.day());
                        
                        StandaloneBean pbean = new StandaloneBean(next, setting);
                        
                          
                        standaloneBeanList.add(pbean);
                        
                        if(next.isAfter(calendarEnd)) {
                            break;
                        }
                        
                    }

                    
                } catch (ParseException e) {
                    e.printStackTrace();
                }
                
                
            }

        }
        
        // grab a list of created hashes
        ArrayList<Integer> hashes = new ArrayList<Integer>();
        for (TicketEvent evt : container.getItemIds()) {
            hashes.add(evt.getDuplicationHash());
        }
        
        // add StandaloneEvents to calendar;
        Iterator<StandaloneBean> biter = standaloneBeanList.iterator();
        while(biter.hasNext()) {
            
            TicketEvent planned = biter.next().getEvent();
            //only add planned event if no hash is found
            if(hashes.contains(planned.getDuplicationHash())){
                log.info("skipping item because of existing duplicate: {}", planned.getItem());
                continue;
            }
            container.addBean(planned);
            
            
        }
        
    }
    
    private void addAllPlannedEvents(BeanItemContainer<TicketEvent> container) {
        addAllPlannedEvents(container, getVisibleStart().minusMonths(1).minusDays(1), getVisibleEnd().plusDays(1),
            getNurseUserId(), (String) filterCountry.getValue());
    }
    
    public static void addAllPlannedEvents(BeanItemContainer<TicketEvent> container, LocalDate calendarStart, LocalDate calendarEnd) {
        addAllPlannedEvents(container, calendarStart, calendarEnd, null, null);
    }
    
    public static void addAllPlannedEvents(BeanItemContainer<TicketEvent> container, LocalDate calendarStart, LocalDate calendarEnd,
        Integer nurseUserId, String country){
        
        Container nursePrefs = getNursePreferences(nurseUserId);
        
        ArrayList<PlannedBean> plannedBeanList = new ArrayList<PlannedBean>();
        
        LocalDate earliest = new LocalDate();
        LocalDate latest = new LocalDate();
        
        for(Object id : nursePrefs.getItemIds()){
            
            Item pref = nursePrefs.getItem(id);
            
            java.sql.Date start = (java.sql.Date) pref.getItemProperty("OMPR_DATE_START").getValue();
            Integer interval = (Integer) pref.getItemProperty("OMPR_TICKET_LENGTH").getValue();
            
            
            if(start != null && interval != null){
                    
                LocalDate lStart = new LocalDate(start);
                
                String rrule = "RRULE:FREQ=WEEKLY;UNTIL=";
                rrule += calendarEnd.toString("YYYYMMdd") + ";";
                rrule += "INTERVAL=" + interval.toString();
                
                try {
                    
                    RecurrenceIterator iter = RecurrenceIteratorFactory.createRecurrenceIterator(rrule, new DateValueImpl(
                            lStart.getYear(), lStart.getMonthOfYear(), lStart.getDayOfMonth()
                            ), java.util.TimeZone.getDefault(), false);
                    
                    DateValueImpl dv = new DateValueImpl(calendarStart.getYear(), calendarStart.getMonthOfYear(), calendarStart.getDayOfMonth());
                    
                    iter.advanceTo(dv);
                    
                    while(iter.hasNext()){
                        
                        DateValueImpl dvi = (DateValueImpl) iter.next();
                        LocalDate next = new LocalDate(dvi.year(), dvi.month(), dvi.day());
                        
//                        addCalendarPlannedEvent(container, next, interval, pref);
                        PlannedBean pbean = new PlannedBean(next, interval, pref);
                        
                        if(pbean.ticketStart.isBefore(earliest)) {
                            earliest = new LocalDate(pbean.ticketStart);
                        }
                        
                        if(pbean.ticketEnd.isAfter(latest)) {
                            latest = new LocalDate(pbean.ticketEnd);
                        }
                        
                        plannedBeanList.add(pbean);
                        
                    }

                    
                } catch (ParseException e) {
                    e.printStackTrace();
                }
                
                
            }
            
            
            
        }
        
        
        // add PlannedEvents to calendar;
        Container contentsContainer = getPlannedContents(earliest, latest, nurseUserId, country);
        
        for (Object iid : contentsContainer.getItemIds()) {
            for (PlannedBean plannedBean : plannedBeanList) {
                plannedBean.addContent(contentsContainer.getItem(iid));
            }
        }
        
        Iterator<PlannedBean> biter = plannedBeanList.iterator();
        while(biter.hasNext()) {
            PlannedBean bean = biter.next();
            
            if(bean.contentsMap.size() > 0) {
                
                for (Entry<String, TicketEvent> eventEntry : bean.getEvents().entrySet()) {
                    container.addBean(eventEntry.getValue());
                }
                
            }
            
        }

        
        // color, count, remove emtpy events
        // checkEventContents(container);
        
    }
    
    private LocalDate getVisibleStart(){
        return MyUtils.getWeekMonday(new LocalDate(calendarData.getStartDate()), 0);
    }
    
    private LocalDate getVisibleEnd(){
        return MyUtils.getWeekMonday(new LocalDate(calendarData.getEndDate()), 1).minusDays(1);
    }
    
    private String generateBetweenCondition(){
       
        String between = " BETWEEN '"+ MyUtils.formatSqlDate(getVisibleStart())
        +"' and '"+MyUtils.formatSqlDate(getVisibleEnd().plusDays(1))+"'";
        return between;
    }
    
    private String generateWeekBetweenCondition(LocalDate monday){
        
        LocalDateTime stop = monday.plusWeeks(1).toLocalDateTime(LocalTime.MIDNIGHT).minusSeconds(1);
        
        String between = " BETWEEN '"+ MyUtils.formatSqlDate(monday)
                +"' and '"+MyUtils.formatSqlDate(stop)+"'";
        return between;

    }
    
    private void addAllCreatedEvents(BeanItemContainer<TicketEvent> container){
        
        DBClass db = new DBClass();
        
        String sql = "SELECT"
            + " \n" + " OMT_ID"
                + " \n" + ", OMT_TYPE"
                + " \n" + ", OMT_DELIVERY_DATE"
                + " \n" + ", OMMS_VALUE"
                + " \n" + ", OMT_KEY_COUNTRY"
                
//                + " \n" + ", CONCAT(IF(AUL_NAME IS NOT NULL and AUL_VORNAME IS NOT NULL," 
//                + " \n CONCAT(AUL_VORNAME, ' ', AUL_NAME, ' '), ''), '(#', OMT_ID, ')') as nurse"

                //+ " \n" + ", CONCAT(AUL_VORNAME, ' ', AUL_NAME) as nurse"
                + " \n" + ", IF(OMT_ID_USER IS NOT NULL, CONCAT(AUL_VORNAME, ' ', AUL_NAME), CONCAT(PSL_VORNAME, ' ', PSL_NAME)) as name"
                + " \n" + ", CONCAT('[', SL_NAME , ']') as address"
                + " \n" + ", CONCAT('(#', OMT_ID, ')') as ticketId"
                
                + " \n" + ", OMT_DATE_FROM" // used to compare planned standalones
                + " \n" + ", OMT_DATE_UNTIL" // ^
                
                + " \n" + "from cust_ordermanager_tickets"
                + " \n" + "left join cms_auth_stammdaten_user on OMT_ID_USER = AUL_ID"  
                + " \n" + "left join cust_patient_stammdaten_liste on OMT_ID_PATIENT = PSL_ID"  
                + " \n" + "left join cust_ordermanager_master_status on OMT_ID_STATUS = OMMS_ID"
                + " \n" + "left join cust_shipping_locations on OMT_ID_LOCATION = SL_ID"
                + " \n" + "WHERE"
                + " \n" + ((filterType.getValue() != null) ? ("OMT_TYPE = '" + filterType.getValue() + "' and ") : "")
                + " \n" + ((getNurseUserId() != null) ? ("OMT_ID_USER = " + getNurseUserId() + " and ") : "")
                + " \n" + ((filterCountry.getValue() != null) ? ("(OMT_KEY_COUNTRY = '" + filterCountry.getValue() + "'"
                        + " or " + "OMT_KEY_COUNTRY IS NULL" + ") and ") : "")
                + " \n" + "( OMT_DELIVERY_DATE " + generateBetweenCondition() + " OR "
                + " \n" + " OMT_DATE_FROM " + generateBetweenCondition() + ")"; // catch if delivery date is empty
        
       
        db.CustomQuery.setSqlString(sql);
        
//        db.debugNextQuery(true);
        
        Container con = db.CustomQuery.query();
        
        for (Object itemId : con.getItemIds()) {
            Item item = con.getItem(itemId);
            
            addCalendarCreatedEvent(container, item);
        }
        
        
    }
    
    private void triggerPatientFilter() {
        
        if(patientFilter != null) {
            calendarContainer.removeContainerFilter(patientFilter);
        }
        if(filterPatient.getValue() == null) {
            return;
        }
        
        final Integer patientId = (Integer) filterPatient.getValue();
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select OMTC_ID_TICKET from cust_ordermanager_ticket_contents" 
                + " \n" +  " where OMTC_ID_PATIENT = "+ patientId +" group by OMTC_ID_TICKET";
        q.setSqlString(sql);
        
        Container con = q.query();
        final ArrayList<Integer> idList = new ArrayList<Integer>();
        for (Object iid : con.getItemIds()) {
            idList.add(MyUtils.getValueFromItem(con.getItem(iid), "OMTC_ID_TICKET", Integer.class));
        }
        
        patientFilter = new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                
                if(itemId instanceof TicketEvent) {
                    TicketEvent tev = (TicketEvent) itemId;
                    
                    if(tev.getType() == TicketType.STANDALONE) {
                        return patientId.equals(MyUtils.getValueFromItem(tev.getItem(), "OMS_ID_PATIENT", Integer.class));
                        
                    }
                    
                    if(tev.getType() == TicketType.PLANNED) {
                        for (Item eventContent : tev.getContents()) {
                            if(patientId.equals(MyUtils.getValueFromItem(eventContent, "patient_id", Integer.class))) {
                                return true;
                            }
                        }
                    }
                    
                }
                
                
                return idList.contains(MyUtils.getValueFromItem(item, "id", Integer.class));
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return MyUtils.equalsWithNulls(propertyId, "id");
            }
        };
        
        calendarContainer.addContainerFilter(patientFilter);
        
    }
    
    private void triggerProjectFilter() {
        
        if(projectFilter != null) {
            calendarContainer.removeContainerFilter(projectFilter);
        }
        if(filterProject.getValue() == null) {
            return;
        }
        
        final Integer projectId = (Integer) filterProject.getValue();
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select OMTC_ID_TICKET from cust_ordermanager_ticket_contents"
            + "\n " + "left join cust_prescriptions_products on PP_ID = OMTC_ID_PRODUCT"
            + "\n " + "where PP_ID_PROJECT = " + projectId + " group by OMTC_ID_TICKET";
        q.setSqlString(sql);
        
        Container con = q.query();
        final ArrayList<Integer> idList = new ArrayList<Integer>();
        for (Object iid : con.getItemIds()) {
            idList.add(MyUtils.getValueFromItem(con.getItem(iid), "OMTC_ID_TICKET", Integer.class));
        }
        
        projectFilter = new Filter() {
            
            @Override
            public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
                
                if(itemId instanceof TicketEvent) {
                    TicketEvent tev = (TicketEvent) itemId;
                    
                    if(tev.getType() == TicketType.STANDALONE) {
                        return projectId.equals(MyUtils.getValueFromItem(tev.getItem(), "PP_ID_PROJECT", Integer.class));
                        
                    }
                    
                    if(tev.getType() == TicketType.PLANNED) {
                        for (Item eventContent : tev.getContents()) {
                            if(projectId.equals(MyUtils.getValueFromItem(eventContent, "project", Integer.class))) {
                                return true;
                            }
                        }
                    }
                    
                }
                
                return idList.contains(MyUtils.getValueFromItem(item, "id", Integer.class));
            }
            
            @Override
            public boolean appliesToProperty(Object propertyId) {
                return MyUtils.equalsWithNulls(propertyId, "id");
            }
        };
        
        calendarContainer.addContainerFilter(projectFilter);
        
    }
    
    private void addAllUnacceptedEvents(BeanItemContainer<TicketEvent> container){
        
        DBClass db = new DBClass();
        
        String sql = "SELECT"
                + " \n" + "project_data_id"
                + " \n" + ", project"
                + " \n" + ", date"
                + " \n" + ", nurse"
                + " \n" + ", PSLV_CODE as code"
                + " \n" + ", COUNT(distinct patient) as total"
                + " \n" + ", GROUP_CONCAT(distinct patient separator ', <br />') as patients"
                + " \n" + "FROM view_packagemanager_union_complete"
                + " \n" + "LEFT JOIN cust_projekte_stammdaten_liste on PSLV_ID = project"
                + " \n" + "WHERE"
                + " \n" + ((getNurseUserId() != null) ? "nurse_user_id = " + getNurseUserId() + " AND " : "")
                + " \n" + ((filterCountry.getValue() != null) ? ("country = '" + filterCountry.getValue() + "' AND ") : "")
                + " \n" + "accepted != 1 AND date" + generateBetweenCondition() 
                + " \n" + ((getNurseUserId() != null) ? "GROUP BY project_data_id" : "GROUP BY date, nurse_id");
        
        db.CustomQuery.setSqlString(sql);
        Container con = db.CustomQuery.query();
        
        for (Object itemId : con.getItemIds()) {
            Item item = con.getItem(itemId);
            
            if(getNurseUserId() != null){
                addCalendarUnacceptedSingleEvent(container, item);
            }else{
                addCalendarUnacceptedGroupedEvent(container, item);
            }
            
        }
    }
    private void addAllManufacturerOrderEvents(BeanItemContainer<TicketEvent> container){
        
        if(getNurseUserId() != null){
            return;
        }
        
        LocalDate calStart = new LocalDate(calendarData.getStartDate());
        LocalDate calEnd = new LocalDate(calendarData.getEndDate());
        
        LocalDate weekStart = MyUtils.getWeekMonday(calStart, 0);
        
        while(weekStart == null || weekStart.isBefore(calEnd)){
            
            try {
                addManufacturerOrderEvent(container, weekStart, getManufacturerOrder(weekStart));
            } catch (Exception e) {
            }
            
            
            weekStart = weekStart.plusWeeks(1);
        }

    }
    
    private Container getManufacturerOrder(LocalDate monday){
        DBClass db = new DBClass();
        
        String sql = "SELECT"
                + " \n" + "sum(project_quantity_static) as order_quantity"
                + " \n" + ", PP_PRODUCT"
                + " \n" + ", country"
                + " \n" + "FROM view_packagemanager_union_complete"
                + " \n" + "INNER JOIN cust_prescriptions_products on product = PP_ID"
                + " \n" + "WHERE"
                + " \n" + ((filterCountry.getValue() != null) ? ("country = '" + filterCountry.getValue() + "' AND ") : "")
                + " \n" + "date" + generateWeekBetweenCondition(monday)
                + " \n" + "GROUP BY country, product"
                + " \n" + "ORDER BY country, product";
        
//        db.debugNextQuery(true);
        
        db.CustomQuery.setSqlString(sql);
        return db.CustomQuery.query();

        
    }
    
    private void addManufacturerOrderEvent(BeanItemContainer<TicketEvent> container, LocalDate date, Container con){
        
        HashMap<String, ArrayList<Pair<String, Integer>>> orderList = new HashMap<String, ArrayList<Pair<String,Integer>>>();
        
        for (Object id : con.getItemIds()) {
            
            BigDecimal order_quantity_bd = MyUtils.getValueFromItem(con.getItem(id), "order_quantity", java.math.BigDecimal.class);
            Integer order_quantity = order_quantity_bd != null ? order_quantity_bd.intValueExact() : 0;
            String PP_PRODUCT = MyUtils.getValueFromItem(con.getItem(id), "PP_PRODUCT", String.class);
            String country = MyUtils.getValueFromItem(con.getItem(id), "country", String.class);
            
            if(orderList.get(country) == null) {
                orderList.put(country, new ArrayList<Pair<String,Integer>>());
            }
            
            orderList.get(country).add(Pair.<String, Integer>of(PP_PRODUCT, order_quantity));
            
        }
        
        String table = "<table style='border-collapse:collapse'>";
        
        for (Entry<String, ArrayList<Pair<String, Integer>>> entry : orderList.entrySet()) {
            
            table += "<tr><th colspan='2'>" + entry.getKey() + "</th></tr>";
            
            for (Pair<String, Integer> pair : entry.getValue()) {
                table += "<tr><td>"+pair.getKey()+"</td><td>"+pair.getValue()+"</td></tr>";
            }
            
        }
        
        table += "</table>";
        
        TicketEvent event = new TicketEvent("[Planungsmengen]", null, date.toDate());
        event.setDescription(table);
        event.setType(TicketType.MANUFACTURER_ORDER);
        event.setImportance(100);
        event.setAllDay(true);
        container.addBean(event);
    }
    
    public static class PlannedBean{
        
        public LocalDate date;
        public Integer interval;
        public Item item;
        public LocalDate ticketStart;
        public LocalDate ticketEnd;
        public Integer userId;
        
        public LocalDate earliestDate = null;
        
        public HashMap<String, ArrayList<Item>> contentsMap;
        
        public PlannedBean(LocalDate date, Integer interval, Item item) {
            this.date = date;
            this.interval = interval;
            this.item = item;
            
            ticketStart = MyUtils.getWeekMonday(date, 1);
            ticketEnd = MyUtils.getWeekMonday(date, 1+interval).minusDays(1);
            userId = MyUtils.getValueFromItem(item, "OMPR_ID_USER", Integer.class);
            contentsMap = new HashMap<String, ArrayList<Item>>();
        }
        
        public void addContent(Item contentItem) {

            Integer uid = Integer.parseInt(MyUtils.getValueFromItem(contentItem, "nurse_user_id", String.class));
            LocalDate date = new LocalDate(MyUtils.getValueFromItem(contentItem, "date", java.sql.Timestamp.class).getTime());
            
            if (MyUtils.equalsWithNulls(userId, uid)) {
                
                if (!date.isBefore(ticketStart) && !date.isAfter(ticketEnd)) {
                    
                    String countryKey = MyUtils.getValueFromItem(contentItem, "country", String.class);
                    
                    if (contentsMap.get(countryKey) == null) {
                        contentsMap.put(countryKey, new ArrayList<Item>());
                    }
                    contentsMap.get(countryKey).add(contentItem);
                    
                    if(earliestDate == null || earliestDate.isAfter(date)) {
                        earliestDate = date;
                    }
                    
                }

            }

        }
        
        public HashMap<String, TicketEvent> getEvents(){
            
            HashMap<String, TicketEvent> eventMap = new HashMap<String, TicketEvent>();
            
            for (Entry<String, ArrayList<Item>> entry : contentsMap.entrySet()) {
                
                String title = MyUtils.getValueFromItem(item, "nurse", String.class);
                String countryKey = "[" + entry.getKey() + "] ";
                
                Date displayDate = date.toDate();
                if(date != null && date.isBefore(new LocalDate())) {
                    
                    LocalDate tempDate = earliestDate.minusDays(warningDays);
                    // move planned delivery to saturday when needed
                    if(tempDate.getDayOfWeek() == 7) {
                        tempDate = tempDate.minusDays(1);
                    }
                    
                    displayDate = tempDate.toDate();
                    title += " (" + date.toString(DateTimeFormat.shortDate()) + ")";
                }
                
                TicketEvent event = new TicketEvent(countryKey + title, null, displayDate);
                event.setType(TicketType.PLANNED);
                event.setPackageType(TITYPE.NURSE);
                event.setImportance(10);
                event.setAllDay(true);
                event.setItem(item);
                event.setTicketStart(ticketStart);
                event.setTicketEnd(ticketEnd);
                event.setCountryKey(entry.getKey());
                event.setTicketContents(entry.getValue());
                
                event.setDescription(entry.getValue().size() + " Protokoll" + ((entry.getValue().size() > 1) ? "e" : "")
                    + "<br />Frühester Inhalt: " + earliestDate.toString(DateTimeFormat.shortDate()));

//              if(Days.daysBetween(new LocalDate(), new LocalDate(event.getStart())).getDays() < warningDays){
                if(Days.daysBetween(new LocalDate(), date).getDays() < warningDays){
                    event.setStyleName("warning");
                }else {
                    event.setStyleName("full");
                }
                
                eventMap.put(entry.getKey(), event);
                
            }
            
            return eventMap;
        }
    }
    
    private class StandaloneBean{
        
        private LocalDate date;
        private Item item;

        public StandaloneBean(LocalDate date, Item item) {
            this.date = date;
            this.item = item;
        }
        
        public TicketEvent getEvent() {
            
            String title = MyUtils.getValueFromItem(item, "name", String.class);
            String countryKey = MyUtils.getValueFromItem(item, "OMS_KEY_COUNTRY", String.class);
            
            if(countryKey != null) {
                title = "[" + countryKey + "] " + "[P] " + title;
            }
            
            TicketEvent event = new TicketEvent(title, null, date.toDate());
            event.setType(TicketType.STANDALONE);
            event.setPackageType(TITYPE.PATIENT);
            event.setImportance(10);
            event.setAllDay(true);
            event.setItem(item);
            event.setTicketStart(date);
            event.setTicketEnd(date);
            event.setCountryKey(countryKey); 
            
            ArrayList<Item> contents = new ArrayList<Item>();
            
            event.setTicketContents(contents);
            
            event.setDescription("Versandmedikament " + MyUtils.getValueFromItem(item, "PP_PRODUCT", String.class));
            
            if(Days.daysBetween(new LocalDate(), new LocalDate(event.getStart())).getDays() < warningDays){
                event.setStyleName("warning");
            }else {
                event.setStyleName("full");
            }
            return event;
        }
        
    }
    
    private void addCalendarCreatedEvent(BeanItemContainer<TicketEvent> container, Item item){
        
        I18nManager lng = new SetQueryStatusLng().getLC();
        
        Integer id = (Integer) item.getItemProperty("OMT_ID").getValue();
        String name = (String) item.getItemProperty("name").getValue();
        String ticketId = (String) item.getItemProperty("ticketId").getValue();
        String countryKey = (String) item.getItemProperty("OMT_KEY_COUNTRY").getValue();

        String type = MyUtils.getValueFromItem(item, "OMT_TYPE", String.class);
        String title = "";
        
        if(MyUtils.equalsWithNulls(type, "NURSE")){
            title = name;
        }else if(MyUtils.equalsWithNulls(type, "PATIENT")) {
            title = "[P] " + name + "";
        }else {
            title = MyUtils.getValueFromItem(item, "address", String.class);
        }
        
        if (title == null) { // fallback
            title = lng.get("ticket_generic");
        }
        
        if(countryKey != null) {
            title = "[" + countryKey + "] " + title;
        }
        
        String status = (String) item.getItemProperty("OMMS_VALUE").getValue();
        
        String warning = "";
        
        Object deldate = item.getItemProperty("OMT_DELIVERY_DATE").getValue(); // java.sql.Date, no casting needed for now
        
        if(deldate == null) {
            title = "[!] " + title;
            warning = "<br/> ACHTUNG: Kein Lieferdatum angegeben!";
        }
        
        LocalDateTime date = new LocalDateTime(deldate);
        
        Integer importance = 0;
        switch (status) {
        
        case "nurse_edit":
            importance = 6;
            break;
        
        case "order_placed":
            importance = 5;
            break;
            
        case "order_prepared":
            importance = 4;
            break;
            
        case "nurse_sent":
            importance = 3;
            break;

        default:
            importance = 5;
            break;
        }
        
        TicketEvent event = new TicketEvent(title + " " + ticketId, lng.get(status) + warning, date.toDate());
        event.setType(TicketType.CREATED);
        event.setPackageType(TITYPE.get(MyUtils.getValueFromItem(item, "OMT_TYPE", String.class)));
        event.setImportance(importance);
        event.setAllDay(true);
        event.setItem(item);
        event.setTicketStart(new LocalDate(MyUtils.getValueFromItem(item, "OMT_DATE_FROM", Date.class)));
        event.setTicketEnd(new LocalDate(MyUtils.getValueFromItem(item, "OMT_DATE_UNTIL", Date.class)));
        event.setId(id);
        event.setCountryKey(countryKey);
        event.setStyleName(status);
        container.addBean(event);
        
    }
    
    private void addCalendarUnacceptedGroupedEvent(BeanItemContainer<TicketEvent> container, Item item){
        

        String title = (String) item.getItemProperty("nurse").getValue();
        Long total = (Long) item.getItemProperty("total").getValue();
        String description  = (String) item.getItemProperty("patients").getValue();
        LocalDateTime date = new LocalDateTime(item.getItemProperty("date").getValue());
        
        String totalString = (total != null) ? " (" + total.intValue() +")" : "";
        
        TicketEvent event = new TicketEvent(title + totalString, description, date.toDate());
        event.setType(TicketType.UNACCEPTED_GROUPED);
        event.setImportance(0);
        event.setAllDay(true);
        event.setItem(item);
        event.setStyleName("unaccepted");
        container.addBean(event);
    }
    
    private void addCalendarUnacceptedSingleEvent(BeanItemContainer<TicketEvent> container, Item item){
        

        String title = (String) item.getItemProperty("patients").getValue();
        LocalDateTime date = new LocalDateTime(item.getItemProperty("date").getValue());
        
        TicketEvent event = new TicketEvent(title, null, date.toDate());
        event.setType(TicketType.UNACCEPTED_SINGLE);
        event.setImportance(0);
        event.setAllDay(true);
        event.setItem(item);
        event.setStyleName("unaccepted");
        container.addBean(event);
    }

    private static Container getPlannedContents(LocalDate earliest, LocalDate latest, Integer nurseUserId, String country) {
        
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("*");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("view_packagemanager_union_complete");
        
        String start = "";
        String end = "";
        
        start = "'" + MyUtils.formatSqlDate(new LocalDateTime(earliest.toDate()).minusSeconds(1)) + "'";
        end =  "'" + MyUtils.formatSqlDate(new LocalDateTime(latest.toDate()).plusDays(1)) + "'";
        
        if(nurseUserId != null) {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("view_packagemanager_union_complete", "nurse_user_id", "=", nurseUserId.toString(), "AND");
        }
        
        if(country != null) {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("view_packagemanager_union_complete", "country", "=", "'"+country+"'", "AND");
        }
        
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("view_packagemanager_union_complete", "status", "IS", "NULL", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("view_packagemanager_union_complete", "accepted", "=", "1", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_BETWEEN("view_packagemanager_union_complete", "date", start, end, "");
        
//        db.debugNextQuery(true);
        
        return db.DB_Data_Get.DB_SEND_AND_GET();
    }
    
    private Container getCreatedContents(ArrayList<Integer> ticketIds) {
        
        if(ticketIds.size() == 0)
            return null;
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select"
         + "\n " + "  OMTC_ID_TICKET"
         + "\n " + "  , OMTC_ID_PATIENT"
         + "\n " + "  , OMTC_ID_PRODUCT"
         + "\n " + "  , OMTC_QTY"
         + "\n " + "  , OMT_KEY_COUNTRY"
//         + "\n " + "  , PP_ID_PROJECT"
         + "\n " + "from cust_ordermanager_ticket_contents"
         + "\n " + "left join cust_ordermanager_tickets on OMTC_ID_TICKET = OMT_ID"
//         + "\n " + "left join cust_prescriptions_products on PP_ID = OMTC_ID_PRODUCT"
         + "\n " + "where OMTC_ID_TICKET in ("+Joiner.on(",").join(ticketIds)+")";
        q.setSqlString(sql);
        
        return q.query();
        
    }
    
    private Container getCalendarDates() {
        
        Country countries = MyUtils.getUserData().getCountry();
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select * from cust_calendar_dates"
             + "\n " + "where"
             + "\n " + "    CD_TYPE in ('type_no_orders')"
             + "\n " + "    and (CD_DATE_START "+generateBetweenCondition()+" or CD_DATE_END "+generateBetweenCondition()+")";
             
        if(filterCountry.getValue() != null) {
            sql += "\n " + "    and (CD_COUNTRY IS NULL or CD_COUNTRY = '" +filterCountry.getValue()+ "')";
        }else if(countries.getCountries().size() > 0) {
            sql += "\n " + "    and (CD_COUNTRY IS NULL or CD_COUNTRY in (" +countries.getFilterString()+ "))";
        }
             
        q.setSqlString(sql);
        
        return q.query();
    }
    
    private void fillNurseCombo(){
        
        ProjectNurseCombos nc = new ProjectNurseCombos();
        nc.setGetAllFields(true);
        Container con = nc.getNurseComboAll();
//        filterNurse.addItem(-1);
//        filterNurse.setItemCaption(-1, "[Generisches Paket]");
        new combo(con, filterNurse, "AUL_ID", "nurse");
        
    }
    
    private void fillCountryCombo() {
        
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("*");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_countrycodes");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_countrycodes", "CC_LNG", "=", "1", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_In("cust_countrycodes", "CC_CODE", "'DE', 'AT'", "");
        
        filterCountry.setContainerDataSource(MyUtils.convertIndex(db.DB_Data_Get.DB_SEND_AND_GET(), "CC_CODE"));
        
    }
    
    private void fillTypes() {
        for (TITYPE type : TITYPE.values()) {
            filterType.addItem(type.name());
            filterType.setItemCaption(type.name(), i18n.get(type.name()));
        }
    }
    
    private void fillPatients() {
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select"
             + "\n " + "    PSL_ID"
             + "\n " + "    , CONCAT_WS(' ', PSA_NAME, PSL_VORNAME, PSL_NAME, CONCAT_WS('', '(', PSL_PLZ, ' ', PSL_ORT, ')')) as patient"
             + "\n " + "from view_patient_stammdaten_liste"
             + "\n " + "left join cust_patient_stammdaten_anrede on PSL_ANREDE = PSA_ID"
             + "\n " + "ORDER BY PSL_NAME ASC";
        q.setSqlString(sql);
        
        filterPatient.setContainerDataSource(MyUtils.convertIndex(q.query(), "PSL_ID"));
        
    }
    
    private void fillProjects() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSLV_ID, PSLV_NAME from cust_projekte_stammdaten_liste order by PSLV_NAME ASC";
        q.setSqlString(sql);
        
        filterProject.setContainerDataSource(MyUtils.convertIndex(q.query(), "PSLV_ID"));
        
    }
    
    private void setNurseUID() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        // db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_liste_gu",
        // "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "AL_U_ID",
        // "KSK_U_ID");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'12'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
            filterNurse.setValue(UID);
            filterNurse.setReadOnly(true);
            filterNurse.setVisible(false);
            
            filterType.setValue(null);
            filterType.setReadOnly(true);
            filterType.setVisible(false);
            
        }

    }
    
    private void setCountryKey() { //TASK rework to use UserData instead!
        
        UserAttributesCountry uac = new UserAttributesCountry();
        uac.setCurrentUserId();
        
        HashMap<String, ArrayList<String>> map = uac.getUserAttributeMap();
        
        if(map == null || map.get("ordermanager_country") == null) {
            return;
        }
        
        ArrayList<String> list = map.get("ordermanager_country");
        
        if(list.size() == 1) {
            String setValue = list.get(0);
            filterCountry.setValue(setValue);
            filterCountry.setVisible(setValue == null);
            filterCountry.setEnabled(setValue == null);
        }
        if(list.size() > 1) {
            ArrayList<Object> idList = new ArrayList<Object>(filterCountry.getItemIds());
            for (Object iid : idList) {
                if(!list.contains(iid)) {
                    filterCountry.removeItem(iid);
                }
            }
            Boolean nsa = filterCountry.getItemIds().size() == idList.size();
            filterCountry.setNullSelectionAllowed(nsa);
            filterCountry.setValue(nsa ? null : filterCountry.getItemIds().iterator().next());
        }
        
        
    }
    /**
     * 
     * {@literal <country, <<product, sizeId>, count>>}
     */

    public class Packs extends HashMap<String, HashMap<Pair<Integer, Integer>, Integer>>{
        
        public void add(String country, Integer product, Integer sizeId, Integer count) {
            
            if(country == null) {
                country = "?";
            }
            
            if(get(country) == null) {
                put(country, new HashMap<Pair<Integer,Integer>, Integer>());
            }
            
            Pair<Integer, Integer> pk = Pair.of(product, sizeId);
            
            if(get(country).get(pk) == null) {
                get(country).put(pk, count);
            }else {
                get(country).put(pk, get(country).get(pk) + count);
            }
        }
    }
    
    /**
     * {@literal <country, <<patient, product>, total>}
     */
    private class Totals extends HashMap<String, HashMap<Pair<Integer, Integer>, Integer>> {
        
        private AutoPackager packager;
        
        public Totals(AutoPackager packager) {
            super();
            this.packager = packager;
        }
        
        public void add(String country, Integer patient, Integer product, Integer sum) {
            
            if(country == null) {
                country = "?";
            }
            
            if(get(country) == null) {
                put(country, new HashMap<Pair<Integer,Integer>, Integer>());
            }
            
            Pair<Integer, Integer> pk = Pair.of(patient, product);
            
            if(get(country).get(pk) == null) {
                get(country).put(pk, sum);
            }else {
                get(country).put(pk, get(country).get(pk) + sum);
            }
        }
        
        public void addToPacks(Packs packs) {
            
            if(size() == 0) {
                return;
            }
            
            for (Entry<String, HashMap<Pair<Integer, Integer>, Integer>> entry : entrySet()) {
                String country = entry.getKey();
                
                for (Entry<Pair<Integer, Integer>, Integer> pentry : entry.getValue().entrySet()) {
                   
                    for (Entry<Pair<Integer, Integer>, Integer> sentry : packager.calculateSizes(country, pentry.getKey().getRight(), pentry.getValue()).entrySet()) {
                        packs.add(country, sentry.getKey().getLeft(), sentry.getKey().getRight(), sentry.getValue());
                    }
                    
                }
            }
        }
    }
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // mainContainer
        mainContainer = buildMainContainer();
        mainLayout.addComponent(mainContainer);
        mainLayout.setExpandRatio(mainContainer, 1.0f);
        mainLayout.setComponentAlignment(mainContainer, new Alignment(20));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildMainContainer() {
        // common part: create layout
        mainContainer = new VerticalLayout();
        mainContainer.setImmediate(false);
        mainContainer.setWidth("100.0%");
        mainContainer.setHeight("100.0%");
        mainContainer.setMargin(true);
        
        // menuSpacer
        menuSpacer = buildMenuSpacer();
        mainContainer.addComponent(menuSpacer);
        
        // globalFilterContainer
        globalFilterContainer = buildGlobalFilterContainer();
        mainContainer.addComponent(globalFilterContainer);
        mainContainer.setComponentAlignment(globalFilterContainer, new Alignment(48));
        
        // verticalLayout_1
        verticalLayout_1 = buildVerticalLayout_1();
        mainContainer.addComponent(verticalLayout_1);
        mainContainer.setExpandRatio(verticalLayout_1, 12.0f);
        
        return mainContainer;
    }

    @AutoGenerated
    private VerticalLayout buildMenuSpacer() {
        // common part: create layout
        menuSpacer = new VerticalLayout();
        menuSpacer.setImmediate(false);
        menuSpacer.setWidth("100.0%");
        menuSpacer.setHeight("40px");
        menuSpacer.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        menuSpacer.addComponent(men_frm);
        menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
        
        return menuSpacer;
    }

    @AutoGenerated
    private HorizontalLayout buildGlobalFilterContainer() {
        // common part: create layout
        globalFilterContainer = new HorizontalLayout();
        globalFilterContainer.setImmediate(false);
        globalFilterContainer.setWidth("100.0%");
        globalFilterContainer.setHeight("90px");
        globalFilterContainer.setMargin(false);
        
        // filterMonthLayout
        filterMonthLayout = buildFilterMonthLayout();
        globalFilterContainer.addComponent(filterMonthLayout);
        globalFilterContainer.setExpandRatio(filterMonthLayout, 1.0f);
        globalFilterContainer.setComponentAlignment(filterMonthLayout, new Alignment(48));
        
        // filterComboLayout
        filterComboLayout = buildFilterComboLayout();
        globalFilterContainer.addComponent(filterComboLayout);
        globalFilterContainer.setExpandRatio(filterComboLayout, 4.0f);
        globalFilterContainer.setComponentAlignment(filterComboLayout, new Alignment(48));
        
        // sumsLayout
        sumsLayout = buildSumsLayout();
        globalFilterContainer.addComponent(sumsLayout);
        globalFilterContainer.setComponentAlignment(sumsLayout, new Alignment(48));
        
        return globalFilterContainer;
    }

    @AutoGenerated
    private HorizontalLayout buildFilterMonthLayout() {
        // common part: create layout
        filterMonthLayout = new HorizontalLayout();
        filterMonthLayout.setImmediate(false);
        filterMonthLayout.setWidth("-1px");
        filterMonthLayout.setHeight("-1px");
        filterMonthLayout.setMargin(false);
        
        // filterMonth
        filterMonth = new PopupDateField();
        filterMonth.setImmediate(false);
        filterMonth.setWidth("-1px");
        filterMonth.setHeight("-1px");
        filterMonthLayout.addComponent(filterMonth);
        filterMonthLayout.setComponentAlignment(filterMonth, new Alignment(48));
        
        // filterMonthReturn
        filterMonthReturn = new Button();
        filterMonthReturn.setCaption("zurück");
        filterMonthReturn.setImmediate(true);
        filterMonthReturn.setWidth("-1px");
        filterMonthReturn.setHeight("-1px");
        filterMonthLayout.addComponent(filterMonthReturn);
        
        return filterMonthLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildFilterComboLayout() {
        // common part: create layout
        filterComboLayout = new HorizontalLayout();
        filterComboLayout.setImmediate(false);
        filterComboLayout.setWidth("-1px");
        filterComboLayout.setHeight("-1px");
        filterComboLayout.setMargin(false);
        filterComboLayout.setSpacing(true);
        
        // filterCountry
        filterCountry = new ComboBox();
        filterCountry.setCaption("Apotheke");
        filterCountry.setImmediate(false);
        filterCountry.setWidth("-1px");
        filterCountry.setHeight("-1px");
        filterComboLayout.addComponent(filterCountry);
        filterComboLayout.setComponentAlignment(filterCountry, new Alignment(33));
        
        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        filterComboLayout.addComponent(verticalLayout_2);
        
        // verticalLayout_3
        verticalLayout_3 = buildVerticalLayout_3();
        filterComboLayout.addComponent(verticalLayout_3);
        
        return filterComboLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("-1px");
        verticalLayout_2.setHeight("-1px");
        verticalLayout_2.setMargin(false);
        
        // filterType
        filterType = new ComboBox();
        filterType.setCaption("Typ");
        filterType.setImmediate(false);
        filterType.setWidth("-1px");
        filterType.setHeight("-1px");
        verticalLayout_2.addComponent(filterType);
        
        // filterProject
        filterProject = new ComboBox();
        filterProject.setCaption("Projekt");
        filterProject.setImmediate(false);
        filterProject.setWidth("-1px");
        filterProject.setHeight("-1px");
        verticalLayout_2.addComponent(filterProject);
        
        return verticalLayout_2;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_3() {
        // common part: create layout
        verticalLayout_3 = new VerticalLayout();
        verticalLayout_3.setImmediate(false);
        verticalLayout_3.setWidth("-1px");
        verticalLayout_3.setHeight("-1px");
        verticalLayout_3.setMargin(false);
        
        // filterNurse
        filterNurse = new ComboBox();
        filterNurse.setCaption("Nurse");
        filterNurse.setImmediate(false);
        filterNurse.setWidth("-1px");
        filterNurse.setHeight("-1px");
        verticalLayout_3.addComponent(filterNurse);
        
        // filterPatient
        filterPatient = new ComboBox();
        filterPatient.setCaption("Patient");
        filterPatient.setImmediate(false);
        filterPatient.setWidth("-1px");
        filterPatient.setHeight("-1px");
        verticalLayout_3.addComponent(filterPatient);
        
        return verticalLayout_3;
    }

    @AutoGenerated
    private VerticalLayout buildSumsLayout() {
        // common part: create layout
        sumsLayout = new VerticalLayout();
        sumsLayout.setImmediate(false);
        sumsLayout.setWidth("-1px");
        sumsLayout.setHeight("-1px");
        sumsLayout.setMargin(false);
        
        // legend
        legend = new Label();
        legend.setImmediate(false);
        legend.setWidth("-1px");
        legend.setHeight("-1px");
        legend.setValue("Legende");
        sumsLayout.addComponent(legend);
        sumsLayout.setComponentAlignment(legend, new Alignment(48));
        
        // ticketSums
        ticketSums = new Button();
        ticketSums.setCaption("Mengen");
        ticketSums.setImmediate(true);
        ticketSums.setWidth("-1px");
        ticketSums.setHeight("-1px");
        sumsLayout.addComponent(ticketSums);
        
        return sumsLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_1() {
        // common part: create layout
        verticalLayout_1 = new VerticalLayout();
        verticalLayout_1.setImmediate(false);
        verticalLayout_1.setWidth("100.0%");
        verticalLayout_1.setHeight("100.0%");
        verticalLayout_1.setMargin(false);
        verticalLayout_1.setSpacing(true);
        
        // calendarData
        calendarData = new Calendar();
        calendarData.setImmediate(true);
        calendarData.setWidth("100.0%");
        calendarData.setHeight("100.0%");
        verticalLayout_1.addComponent(calendarData);
        verticalLayout_1.setExpandRatio(calendarData, 2.0f);
        
        return verticalLayout_1;
    }
}
