package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.pop.classes;

import java.sql.Time;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map.Entry;

import org.slf4j.Logger;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Fields.CustomTimePicker;
import archenoah.lib.vaadin.Components.Steppers.FloatStepper;
import archenoah.lib.vaadin.CustomConverterFactorys.BooleanToTextConverter;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Table;
import com.vaadin.ui.VerticalLayout;

public class PanelInfusionTimes extends CustomComponent{
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout layoutTable;
    @AutoGenerated
    private Table table;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private HorizontalLayout layoutFields;
    @AutoGenerated
    private Button medRemove;
    @AutoGenerated
    private Button medAdd;
    @AutoGenerated
    private CheckBox medFree;
    @AutoGenerated
    private FloatStepper medRate;
    @AutoGenerated
    private CustomTimePicker medStop;
    @AutoGenerated
    private CustomTimePicker medStart;
    // {section fields}
    // ****************
    
    private HashMap<Object, String> componentMap;
    private Integer dataId;

    private ArrayList<Integer> dataOriginal;
    private Logger log;
    
    private Object[] columns  = new Object[] {"START", "STOP", "RATE", "FREE"};
    private I18nManager i18n;
    
    // {end fields}
    

    

    // {section constructors}
    // **********************
    public PanelInfusionTimes() {
        
        log = org.slf4j.LoggerFactory.getLogger(this.getClass());
        
        
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this);
        registerComponents();
        
        fillFields();
        configureComponents();
        configureListeners();
        
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void getEntries(Integer dataId) {
        this.dataId = dataId;
        checkIncompleteInput();
        dbGetEntries();
    }
    
    public void save(Integer dataId) {
        this.dataId = dataId;
        dbSaveEntries();
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    
    private void checkIncompleteInput() {
        boolean hasUnsaved = false;
        
        if( medStart.isValid()
            || medStop.isValid()) {
            hasUnsaved = true;
        }
        
        if(hasUnsaved && table.size() == 0) {
            I18nManager.global(I18nGlobalNotifiers.incomplete_save);
        }
    }
    
    private void registerComponents(){
        componentMap = new HashMap<Object, String>();
        new ComponentIterator(mainLayout).createMap(componentMap);
    }
    
    private void configureComponents() {
        
        for (Entry<Object, String> entry : componentMap.entrySet()) {
            AbstractComponent field = (AbstractComponent) entry.getKey();

                    
            if(field instanceof AbstractField){
                field.setImmediate(true);
            }
            
            if(field instanceof ComboBox){
                ((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
            }
            
        }
        
        medRemove.setEnabled(false);
        
        medStart.setRequired(true);
        medStop.setRequired(true);
        
        medRate.setMinValue(0F);
        medRate.setNumberOfDecimals(2);
        
        
    }
    
    private void configureListeners() {

        
        table.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
               toggleFields((table.getValue() == null)); // edit mode if null
                
            }
        });
        
        medAdd.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(medStart.isValid() && medStop.isValid()) {
                    addEntry();
                }
                
            }
        });
        
        medRemove.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                removeEntry();
                
            }
        });
        
    }
    
    private void configureTable() {
        table.setImmediate(true);
        table.setSelectable(true);
        
        table.setVisibleColumns(columns);
        
        StringSqlTimestampConverter time = new StringSqlTimestampConverter();
        time.setDateFormat(0);
        time.setTimeFormat(DateFormat.SHORT);
        
        table.setConverter("START", time);
        table.setConverter("STOP", time);
        table.setConverter("FREE", new BooleanToTextConverter());
        
        i18n.refresh();
    }
    
    private void fillFields() {

    }
    
    private void toggleFields(Boolean editMode) {
        medStart.setEnabled(editMode);
        medStop.setEnabled(editMode);
        medRate.setEnabled(editMode);
        medFree.setEnabled(editMode);
        medAdd.setEnabled(editMode);
        medRemove.setEnabled(!editMode);
    }
    
    
    private void addEntry() {
        
        Container con = table.getContainerDataSource();
        
        Time start = new Time(medStart.getTime().toDateTimeToday().getMillis());
        Time stop = new Time(medStop.getTime().toDateTimeToday().getMillis());
        Float rate = medRate.getValue();
        Boolean free = medFree.getValue();
        
        
        Object iid = con.addItem();
        
        Collection propIds = con.getContainerPropertyIds();
        
        if(!propIds.contains("START")) {
            con.addContainerProperty("START", java.sql.Time.class, null);
            con.addContainerProperty("STOP", java.sql.Time.class, null);
            con.addContainerProperty("RATE", Float.class, null);
            con.addContainerProperty("FREE", Boolean.class, null);
        }
        
        if(dataId == null) {
            configureTable();
        }
        
        con.getItem(iid).getItemProperty("START").setValue(start);
        con.getItem(iid).getItemProperty("STOP").setValue(stop);
        con.getItem(iid).getItemProperty("RATE").setValue(rate);
        con.getItem(iid).getItemProperty("FREE").setValue(free);
        
        table.setValue(null);
    }
    
    private void removeEntry() {
        
        if(table.getValue() != null) {
            table.getContainerDataSource().removeItem(table.getValue());
        }
        
        table.setValue(null);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    
    private void dbGetEntries() {
        
        DBClass db = new DBClass();
        
        String sql = "SELECT ID, START, STOP, RATE, FREE"
             + "\n " + "FROM cust_protokoll_pop_multi_infusion_times"
             + "\n " + "WHERE ID_DATA = "+dataId
             + "\n " + "ORDER BY ID ASC";
        
        db.CustomQuery.setSqlString(sql);
//        db.debugNextQuery(true);
        Container con  = MyUtils.convertIndex(db.CustomQuery.query(), "ID");
        
        dataOriginal = new ArrayList<Integer>();
        dataOriginal.addAll((Collection<Integer>) con.getItemIds());
        
        table.setContainerDataSource(con);
        
        configureTable();
    }
    
    private ArrayList<Integer> getInsertEntries() {
        
        ArrayList<Integer> insert = new ArrayList<Integer>();
        insert.addAll((Collection<Integer>) table.getContainerDataSource().getItemIds());
        if(dataOriginal != null) {
            insert.removeAll(dataOriginal);
        }
        
        return insert;
    }
    
    private ArrayList<Integer> getDeleteEntries() {
        
        ArrayList<Integer> delete = new ArrayList<Integer>();
        if(dataOriginal != null) {
            delete.addAll(dataOriginal);
        }
        delete.removeAll(table.getContainerDataSource().getItemIds());
        
        return delete;
    }
    
    private void dbSaveEntries() {

        DBClass db = new DBClass();
        
        ArrayList<Integer> insertEntries = getInsertEntries();
        ArrayList<Integer> deleteEntries = getDeleteEntries();
        
        if(deleteEntries.size() > 0 ) {
            String deleteString = "DELETE FROM cust_protokoll_pop_multi_infusion_times WHERE ID_DATA = " + dataId + " AND ID IN("+Joiner.on(",").join(getDeleteEntries())+")";
            db.CustomQuery.setSqlString(deleteString);
            db.CustomQuery.update();
        }
        
        if(insertEntries.size() > 0 ) {
            
            ArrayList<String> insertList = new ArrayList<String>();
            
            for (Integer id : getInsertEntries()) {
                Item item = table.getContainerDataSource().getItem(id);
                
                Integer freeInt = (Boolean) item.getItemProperty("FREE").getValue() ? 1 : 0;
                
                insertList.add("("+dataId+
                        ", '"+item.getItemProperty("START").getValue()+
                        "', '"+item.getItemProperty("STOP").getValue()+
                        "', '"+item.getItemProperty("RATE").getValue()+
                        "', "+ freeInt +")");
            }
            
            String insertString = "INSERT INTO `cust_protokoll_pop_multi_infusion_times` (`ID_DATA`, `START`, `STOP`, `RATE`, `FREE`)"
                    + "\n " + "VALUES " + Joiner.on(",\n").join(insertList) + ";";

            db.CustomQuery.setSqlString(insertString);
            db.CustomQuery.update();
        }

        
    }
    
    
    // {end database}

    // {section layout}
    // ****************
    // {end layout}
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // layoutTable
        layoutTable = buildLayoutTable();
        mainLayout.addComponent(layoutTable);
        mainLayout.setExpandRatio(layoutTable, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutTable() {
        // common part: create layout
        layoutTable = new VerticalLayout();
        layoutTable.setImmediate(false);
        layoutTable.setWidth("100.0%");
        layoutTable.setHeight("100.0%");
        layoutTable.setMargin(false);
        layoutTable.setSpacing(true);
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        layoutTable.addComponent(horizontalLayout_1);
        
        // table
        table = new Table();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        layoutTable.addComponent(table);
        layoutTable.setExpandRatio(table, 1.0f);
        
        return layoutTable;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(false);
        horizontalLayout_1.setSpacing(true);
        
        // layoutFields
        layoutFields = buildLayoutFields();
        horizontalLayout_1.addComponent(layoutFields);
        horizontalLayout_1.setExpandRatio(layoutFields, 1.0f);
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private HorizontalLayout buildLayoutFields() {
        // common part: create layout
        layoutFields = new HorizontalLayout();
        layoutFields.setImmediate(false);
        layoutFields.setWidth("100.0%");
        layoutFields.setHeight("-1px");
        layoutFields.setMargin(false);
        
        // medStart
        medStart = new CustomTimePicker();
        medStart.setCaption("Start");
        medStart.setImmediate(false);
        medStart.setWidth("80px");
        medStart.setHeight("-1px");
        layoutFields.addComponent(medStart);
        layoutFields.setExpandRatio(medStart, 1.0f);
        layoutFields.setComponentAlignment(medStart, new Alignment(24));
        
        // medStop
        medStop = new CustomTimePicker();
        medStop.setCaption("Stop");
        medStop.setImmediate(false);
        medStop.setWidth("80px");
        medStop.setHeight("-1px");
        layoutFields.addComponent(medStop);
        layoutFields.setExpandRatio(medStop, 1.0f);
        layoutFields.setComponentAlignment(medStop, new Alignment(24));
        
        // medRate
        medRate = new FloatStepper();
        medRate.setCaption("ml / h");
        medRate.setImmediate(false);
        medRate.setWidth("80px");
        medRate.setHeight("-1px");
        layoutFields.addComponent(medRate);
        layoutFields.setExpandRatio(medRate, 1.0f);
        layoutFields.setComponentAlignment(medRate, new Alignment(24));
        
        // medFree
        medFree = new CheckBox();
        medFree.setCaption("Frei laufend");
        medFree.setImmediate(false);
        medFree.setWidth("-1px");
        medFree.setHeight("-1px");
        layoutFields.addComponent(medFree);
        layoutFields.setExpandRatio(medFree, 1.0f);
        layoutFields.setComponentAlignment(medFree, new Alignment(48));
        
        // medAdd
        medAdd = new Button();
        medAdd.setCaption("Hinzuf√ºgen");
        medAdd.setImmediate(true);
        medAdd.setWidth("-1px");
        medAdd.setHeight("-1px");
        layoutFields.addComponent(medAdd);
        layoutFields.setExpandRatio(medAdd, 1.0f);
        layoutFields.setComponentAlignment(medAdd, new Alignment(24));
        
        // medRemove
        medRemove = new Button();
        medRemove.setCaption("Entfernen");
        medRemove.setEnabled(false);
        medRemove.setImmediate(true);
        medRemove.setWidth("-1px");
        medRemove.setHeight("-1px");
        layoutFields.addComponent(medRemove);
        layoutFields.setExpandRatio(medRemove, 1.0f);
        layoutFields.setComponentAlignment(medRemove, new Alignment(24));
        
        return layoutFields;
    }
}
