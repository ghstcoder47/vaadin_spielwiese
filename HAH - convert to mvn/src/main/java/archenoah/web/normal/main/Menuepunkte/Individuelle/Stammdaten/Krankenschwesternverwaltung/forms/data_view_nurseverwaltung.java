package archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.Krankenschwesternverwaltung.forms;

import java.util.ArrayList;
import java.util.Collection;

import org.tepi.filtertable.FilterTable;

import archenoah.UIS.UI_Functions;
import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.java_plugin.array_builder.classes.ArrayBuilder_Mehrfach;
import archenoah.lib.vaadin.Components.ClickMenuBar.ClickCommand;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.web.normal.UserInfo.Country;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.Ärztverwaltung.Form.Filter.Decorator_Aerzteverwaltung;

import com.github.wolfie.refresher.Refresher;
import com.github.wolfie.refresher.Refresher.RefreshListener;
import com.google.common.base.Joiner;
import com.vaadin.addon.tableexport.ExcelExport;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.Table;
import com.vaadin.ui.TwinColSelect;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.MessageBoxListener;

public class data_view_nurseverwaltung extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private VerticalLayout verticalLayout_2;

    @AutoGenerated
    private FilterTable tbl_frm;

    @AutoGenerated
    private HorizontalLayout layoutFilters;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_4;

    @AutoGenerated
    private TwinColSelect filterNurseGroup;

    @AutoGenerated
    private CheckBox filterNurseGroupEnabled;

    @AutoGenerated
    private MenuBar men_frm;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;

    

    

    

    /**
     * The constructor should first build the main layout, set the composition root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Allgemein
    private UI_Functions me;
    private Refresher refresher;
    private CMS_Config_Std std;
    private String Exportname;
    // Datenbank
    private Object[][] Filter = null;
    private Container cont_Momentan;

    // Berrechtigung
    private int ACC_ID;
    private int Lesen;
    private int Schreiben;
    private int Erstellen;
    private int Edit;
    private int Löschen;

    private MenuItem Temp_Menü = null;

    private Button Temp_Btn = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem Btn_Add;

    private MenuBar.MenuItem Btn_EDIT;

    private MenuBar.MenuItem Btn_READ;

    private MenuBar.MenuItem Btn_DEL;

    private MenuBar.MenuItem Btn_EXP;

    private MenuBar.MenuItem Btn_EXP_excel;

    private MenuBar.MenuItem Btn_EXP_csv;

    private MenuBar.MenuItem Btn_FT;

    private boolean nurse;
    private boolean arzt;
    private boolean pharma;
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    /************ ----->Einstellungen<-- ********************/
//    private String LNG_FRM_ID = "10";
    private String BER_MEN_ID = "25";
    private String Windows_Height = "600px";
    private String Windows_Width = "900px";
    private int Datenholen_MS = 5000;
    private boolean Datenholen_An = true;

    private String TBL_ID = "KSK_ID";

    private String NOT_Del = "20";

    private String Exporttitel = "Krankenschwester Uebersicht";
    private String Export_Filename = "Krankenschwester_Uebersicht.xls";

    private I18nManager i18n;

    /******************************************************/

    public data_view_nurseverwaltung(MenuItem Arg_Menü) {
        Temp_Menü = Arg_Menü;

        // TODO add user code here
    }

    public data_view_nurseverwaltung(Button Arg_btn) {

        Temp_Btn = Arg_btn;

        // TODO add user code here
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        if (Temp_Menü != null) {
            String Recourcename = Temp_Menü.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Exportname = Temp_Menü.getText();
            Build_Window_Button bwb = new Build_Window_Button(Temp_Menü.getText(), mainLayout, Windows_Height, Windows_Width, new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Window_Button bwb = new Build_Window_Button(Temp_Btn.getCaption(), mainLayout, Windows_Height, Windows_Width, Temp_Btn.getIcon());
            win = bwb.ReturnWindow();
        }

    }

    /********* INIT-Tray ************/
    public void Init_Class_Tab(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (Temp_Menü != null) {
            Exportname = Temp_Menü.getText();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Menü.getText(), mainLayout, Temp_Menü.getIcon());
        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Btn.getCaption(), mainLayout, Temp_Btn.getIcon());
        }

    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        
        /**** Setsstylename **/
        men_frm.setStyleName("Menue_dataview");

        /*********************/
        Generate_Menüs();
        me = new UI_Functions();
        std = CMS_Config_Std.getInstance();
        Config_TBL();

        Prüfung_Ist_Grp_Krankenschwestern();
        Prüfung_Ist_Grp_Ärzte();
        Prüfung_Ist_Pharma();
        
        configureComponents();
        
        if (Schreiben == 0) {
            Btn_EDIT.setEnabled(false);
        }
        if (Erstellen == 0) {
            Btn_Add.setEnabled(false);
        }
        if (Löschen == 0) {
            Btn_DEL.setEnabled(false);
        }

        if (Datenholen_An == true) {
            Datenholen();
            set_refresher();
        }
        i18n.refresh();
    }

    public void Set_Berrechtigung_Database() {
        if (BER_MEN_ID == "") {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] Asan = r.Datenholen();

        for (int i = 0; i < Asan.length; i++) {
            if (Asan[i][0].equals(BER_MEN_ID) == true) {

                Lesen = Integer.valueOf(Asan[i][3]);

                Schreiben = Integer.valueOf(Asan[i][4]);
                Erstellen = Integer.valueOf(Asan[i][6]);
                Löschen = Integer.valueOf(Asan[i][5]);
            }
        }
    }

    public void Set_Berrechtigung_Custom(int Arg_Lesen, int Arg_Erstellen, int Arg_Bearbeiten, int Arg_Loeschen) {
        Lesen = Arg_Lesen;
        Schreiben = Arg_Erstellen;
        Erstellen = Arg_Erstellen;
        Edit = Arg_Bearbeiten;
        Löschen = Arg_Loeschen;
    }

    private void Datenlöschen(final int ID) {

        if (ID == 1) {

            I18nManager.global(I18nGlobalNotifiers.admin_user_not_deletable);

            return;

        } else {

            I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
                
                @Override
                public void buttonClicked(ButtonId arg0) {
                    if(ButtonId.YES == arg0) {
                        Del(ID);
                    }
                }
            });
        }
    }


    /***************** Comands *********************/
    public ClickCommand cmd_btn_add = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            // TODO Auto-generated method stub

            form_nurse_insert_edit pie = new form_nurse_insert_edit(selectedItem, "");
            pie.Init_Class_Window();
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());

        }
    };
    public ClickCommand cmd_btn_edit = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            // TODO Auto-generated method stub

            Object rowId = tbl_frm.getValue(); // get the selected rows id

            if (rowId == null) {

                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            final int ID = (int) tbl_frm.getContainerProperty(rowId, TBL_ID).getValue();
            form_nurse_insert_edit pie = new form_nurse_insert_edit(selectedItem, "" + ID);
            pie.Init_Class_Window();
            pie.Set_Berrechtigung_Custom(1, 1, 1, 1);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());
        }
    };

    public ClickCommand cmd_btn_read = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            // TODO Auto-generated method stub

            Object rowId = tbl_frm.getValue(); // get the selected rows id

            if (rowId == null) {

                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            final int ID = (int) tbl_frm.getContainerProperty(rowId, TBL_ID).getValue();
            form_nurse_insert_edit pie = new form_nurse_insert_edit(selectedItem, "" + ID);
            pie.Init_Class_Window();
            pie.Set_Berrechtigung_Custom(1, 0, 0, 0);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());

        }
    };
    public Command cmd_btn_del = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            // TODO Auto-generated method stub

            Object rowId = tbl_frm.getValue(); // get the selected rows id

            if (rowId == null) {

                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            final int ID = (int) tbl_frm.getContainerProperty(rowId, TBL_ID).getValue();

            Datenlöschen(ID);

        }
    };
    public Command cmd_btn_export_excel = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            // TODO Auto-generated method stub
            Table tbl = new Table();
            tbl.setVisible(false);
            tbl.setContainerDataSource(tbl_frm.getContainerDataSource());

            mainLayout.addComponent(tbl);

            System.out.println(tbl.size());
            ExcelExport excelExport = new ExcelExport(tbl);

            excelExport.excludeCollapsedColumns();
            excelExport.setReportTitle(Exporttitel);
            excelExport.setExportFileName(Export_Filename);

            excelExport.export();
            mainLayout.removeComponent(tbl);

        }
    };

    public Command cmd_btn_export_csv = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            // TODO Auto-generated method stub

        }
    };

    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            // TODO Auto-generated method stub

            if (tbl_frm.isFilterBarVisible() == false) {
                tbl_frm.setFilterBarVisible(true);
                // selectedItem.addStyleName("Filter");
                me.remEx(refresher);
            } else {
                tbl_frm.setFilterBarVisible(false);
                // tbl_frm.removeStyleName("Filter");

                Container gmp = tbl_frm.getContainerDataSource();

                for (Object propid : gmp.getContainerPropertyIds()) {

                    tbl_frm.setFilterFieldValue(propid, "");
                }
                set_refresher();
            }

        }
    };

    /***********************************************/
    /**** Refresher ****/

    private void set_refresher() {
        refresher = new Refresher();

        refresher.setRefreshInterval(Datenholen_MS);

        refresher.addListener(new Datenholenlistener());

        me.addEx(refresher);
    }


    public class Datenholenlistener implements RefreshListener {

        @Override
        public void refresh(Refresher source) {

            Object rowId = tbl_frm.getValue(); // get the selected rows id
            Object Sort = tbl_frm.getSortContainerPropertyId();

            Integer originalIndex = tbl_frm.getCurrentPageFirstItemIndex();
            Datenholen();
            tbl_frm.setCurrentPageFirstItemIndex(originalIndex);

            if (rowId != null) {
                tbl_frm.setValue(rowId);
            }

            if (Sort != null) {
                // tbl_arzt.setSortContainerPropertyId(Sort);

            }

            if (Temp_Menü != null) {

                if (tab != null) {
                    if (Prüfungtab(Temp_Menü.getText()) == false) {
                        me.remEx(source);
                    }
                } else {
                    if (Prüfungwin() == false) {
                        me.remEx(source);
                    }
                }

            }

            if (Temp_Btn != null) {

                if (tab != null) {
                    if (Prüfungtab(Temp_Btn.getCaption()) == false) {
                        me.remEx(source);
                    }
                } else {
                    if (Prüfungwin() == false) {
                        me.remEx(source);
                    }
                }

            }

        }

        private boolean Prüfungtab(String Name) {
            int Count = tab.getComponentCount();

            for (int i = 0; i < Count; i++) {
                if (tab.getTab(i).getCaption() == Name) {

                    // tab.setSelectedTab(i);

                    return true;
                }

            }

            return false;
        }

        private boolean Prüfungwin() {
            boolean pr = false;

            for (Window ItemIda : UI.getCurrent().getWindows()) {
                // UserId = (int) result.getItem(ItemIda).getItemProperty(this.Spalte_ID).getValue;

                if (ItemIda.equals(win) == true) {
                    pr = true;
                }

                //
            }

            return pr;

        }

    }

    /******************************************/
    
    private void configureComponents(){

        // migrated from database
        Btn_DEL.setIcon(Icons.White.delete_16);
        Btn_FT.setIcon(Icons.White.filter_16);
        Btn_READ.setIcon(Icons.White.perm_lesen_16);
        Btn_EXP.setIcon(Icons.White.excel_export_16);
        Btn_Add.setIcon(Icons.White.benutzer_16);
        Btn_EXP_csv.setIcon(Icons.Black.excel_16);
        Btn_EXP_excel.setIcon(Icons.White.excel_16);
        Btn_EDIT.setIcon(Icons.White.edit_16);
        // migration end
        
        filterNurseGroupEnabled.setValue(true);
        filterNurseGroupEnabled.setImmediate(true);
        filterNurseGroup.setContainerDataSource(dbGetNurseGroupValues());
        filterNurseGroup.setItemCaptionPropertyId("PSLV_NAME");

        filterNurseGroup.setValue(filterNurseGroup.getContainerDataSource().getItemIds());
        
        filterNurseGroupEnabled.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Boolean enabled = (Boolean)event.getProperty().getValue();
                filterNurseGroup.setEnabled(enabled);
                Datenholen();
                
            }
        });
        
        filterNurseGroup.setImmediate(true);
        filterNurseGroup.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Datenholen();
                
            }
        });
        
        

    }
    
    /******************************************************************************************/
    /***************************** ---> Configuration Funktionen<--- **************************************/

    /*********** Gen Menüs *************/
    private void Generate_Menüs() {
        Btn_Add = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
        Btn_EDIT = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
        Btn_READ = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
        Btn_DEL = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        Btn_EXP = men_frm.addItem("FRM_EXPORT", Icons.White.log_16, null);
        Btn_EXP_excel = Btn_EXP.addItem("FRM_EXPORT_EXCEL", Icons.White.excel_export_16, cmd_btn_export_excel);
        Btn_EXP_csv = Btn_EXP.addItem("FRM_EXPORT_CSV", Icons.White.excel_16, cmd_btn_export_csv);
        Btn_FT = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);

        if (Schreiben == 0) {
            Btn_EDIT.setEnabled(false);
        }
        if (Erstellen == 0) {
            Btn_Add.setEnabled(false);
        }
        if (Löschen == 0) {
            Btn_DEL.setEnabled(false);
        }
    }

    /********************************/
    /*********** Tabelle Datenholen *************/

    private Container Get_Data_Container() {
        try {
            DBClass db = new DBClass();

            /************ Set Spalten *************/
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_ID");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(KSK_TITEL,' ',KSA_NAME,' ',AUL_NAME,' ',AUL_VORNAME)", "'Krankenschwester'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_STRASSE", "'Strasse'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_ORT", "'Ort'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_PLZ", "'PLZ'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_COUNTRYCODE", "'Land'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_HANDY", "'Handy'");
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_TEL", "'Telefon'");

            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_EMAIL", "'Email'");
            
            db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("fcount", "'Firmen'");
            /**************************************/
            /************ Set Tabelle *************/
            db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_krankenschwester_stammdaten_anrede", "AUL_ANREDE_ID", "KSA_ID");
            db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_krankenschwester_stammdaten_ks", "INNER JOIN", "cms_auth_stammdaten_user", "KSK_U_ID", "AUL_ID");
            
            db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_liste_gu", "INNER JOIN", "cms_auth_stammdaten_user", "AL_U_ID", "AUL_ID");
            
            db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("left join", "(select KSF_ID_NURSE, COUNT(KSF_ID) as fcount"
                                                                         + "\n " + "from  cust_krankenschwester_stammdaten_firmen"
                                                                         + "\n " + "GROUP BY KSF_ID_NURSE) as firms", "cust_krankenschwester_stammdaten_ks",
                                                                         "firms", "KSK_ID", "KSF_ID_NURSE");
            
            /**************************************/
            /************ Set Filter *************/
            
            Country uc = MyUtils.getUserData().getCountry();
            if(uc.hasPermissions()) {
                db.DB_Data_Get.DB_Filter.DB_WHERE_In("cust_krankenschwester_stammdaten_ks", "KSK_COUNTRYCODE", uc.getFilterString(),
                        (nurse || filterNurseGroupEnabled.getValue()) ? "AND" : "");
            }
            
            if(!nurse && filterNurseGroupEnabled.getValue()){
                
                ArrayList<Integer> values = new ArrayList<Integer>();
                
               for (Object id : (Collection) filterNurseGroup.getValue()) {
                   
                   values.add((Integer) filterNurseGroup.getContainerDataSource().getContainerProperty(id, "PSLV_GROUP").getValue());
                
               }
               values.remove(null);
                String filterString = Joiner.on(",").join(values);
                
                if(filterString.length() > 0){
                    db.DB_Data_Get.DB_Filter.DB_WHERE_In("cms_auth_liste_gu", "AL_G_ID", filterString, "");
                }
                
                
            }
            
            Filter_Krankenschwester(db);
//            Filter_Arzt(db);

            
            /**************************************/
            /************ Set Custom *************/
            
            db.DB_Data_Get.DB_Gruppieren.DB_Gruppieren("KSK_ID");
            
            /**************************************/

//            db.debugNextQuery(true);
                        
           
            
            return db.DB_Data_Get.DB_SEND_AND_GET_Container();
        } catch (Exception e) {
            System.out.println("Fehler Beim Datenholen");
            return null;
        }

    }
    
    private Container dbGetNurseGroupValues(){
        
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_projekte_stammdaten_liste");
        
        return db.DB_Data_Get.DB_SEND_AND_GET_Container();
    }
    
    /********************************* Filter Für Berrechtigung ****************************/

    private void Filter_Krankenschwester(DBClass db) {
        if (nurse == false) {
            return;
        }
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_ID", "=", "'" + UID + "'", "");

    }

    private void Filter_Arzt(DBClass db) {
        if (arzt == false) {
            return;
        }
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");

        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass dba = new DBClass();

        dba.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("VH_NURSE_ID");
        dba.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_arzt_stammdaten_arzt", "INNER JOIN", "cms_auth_stammdaten_user", "ASA_U_ID", "AUL_ID");
        dba.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_arzt_stammdaten_arzt", "INNER JOIN", "cust_verk_haupt", "ASA_ID", "VH_ARZT_ID");
        dba.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_ID", "=", "'" + UID + "'", "");

        Container con = dba.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {

            int menge = con.size();

            int anz = 0;

            for (Object ItemIda : con.getItemIds()) {
                // UserId = (int) result.getItem(ItemIda).getItemProperty(this.Spalte_ID).getValue;
                //
                anz = anz + 1;

                if (anz == menge) {
                    db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_ID", "=", "'" + con.getItem(ItemIda).getItemProperty("VH_NURSE_ID").getValue().toString() + "'", "");
                } else {
                    db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_ID", "=", "'" + con.getItem(ItemIda).getItemProperty("VH_NURSE_ID").getValue().toString() + "'", "OR");
                }
            }

        } else {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_ID", "=", "'" + "" + "'", "");
        }

    }

    private void Prüfung_Ist_Grp_Krankenschwestern() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'12'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
            nurse = true;
        } else {
            nurse = false;
        }

    }

    private void Prüfung_Ist_Grp_Ärzte() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'11'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
            arzt = true;
        } else {
            arzt = false;
        }

    }

    private void Prüfung_Ist_Pharma() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'13'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
            pharma = true;
        } else {
            pharma = false;
        }

    }

    /****************************************************************************************/

    private void Datenholen_force() {
        Container con = Get_Data_Container();

        if (con.size() > 0) {
            tbl_frm.setContainerDataSource(con);
            tbl_frm.setVisibleColumns(new Object[] { "Krankenschwester", "Strasse", "Ort", "PLZ", "Land", "Telefon", "Handy", "Email", "Firmen" });
        } else {
            tbl_frm.removeAllItems();

        }
    }

    private void Datenholen() {
        Container con = Get_Data_Container();

        if (con.size() > 0) {

            if (cont_Momentan != null) {
                if (Prüfengleichheit(con) == true) {

                    return;
                } else {
                    if (tbl_frm.isFilterBarVisible() == true) {

                        ArrayBuilder_Mehrfach arb;
                        for (Object propid : con.getContainerPropertyIds()) {

                            arb = new ArrayBuilder_Mehrfach(Filter, 2);
                            Filter = arb.Array_Holen_Object();

                            Filter[Filter.length - 1][0] = propid;
                            Filter[Filter.length - 1][1] = tbl_frm.getFilterFieldValue(propid);
                        }
                    }

                }
            }

            tbl_frm.setContainerDataSource(con);

            cont_Momentan = Get_Data_Container();
            tbl_frm.setColumnFooter("Email", "Insgesamt : " + tbl_frm.size() + " Krankenschwester/Krankenschwestern");

            tbl_frm.setVisibleColumns(new Object[] { "Krankenschwester", "Strasse", "Ort", "PLZ", "Land", "Telefon", "Handy", "Email", "Firmen" });

            if (Filter != null) {
                for (int i = 0; i < Filter.length; i++) {
                    tbl_frm.setFilterFieldValue(Filter[i][0], Filter[i][1]);

                }

                Filter = null;

            }

        } else {
            tbl_frm.removeAllItems();

        }
    }

    private boolean Prüfengleichheit(Container con) {

        boolean gl = true;

        for (Object ItemIda : con.getItemIds()) {
            // UserId = (int) result.getItem(ItemIda).getItemProperty(this.Spalte_ID).getValue;
            //

            for (Object propid : con.getContainerPropertyIds()) {

                try {
                    if (con.getItem(ItemIda).getItemProperty(propid).getValue().equals(cont_Momentan.getItem(ItemIda).getItemProperty(propid).getValue()) == false) {
                        gl = false;
                    }
                } catch (Exception e) {
                    // TODO Automatisch generierter Erfassungsblock
                    gl = false;
                }

            }

        }

        return gl;

    }

    /*************************** Datenlöschen ********************/

    private void Del(int ID) {

        DBClass db = new DBClass();
        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "AUL_ID", "KSK_U_ID");
        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_ID", "=", ID + "", "");
        db.DB_Data_Delete.DB_Delete();

        I18nManager.global(I18nGlobalNotifiers.entry_deleted);

        Datenholen_force();
    }

    private void Edit(int ID) {

    }

    private void Insert() {

    }

    /*************************** Config TBL ********************/
    private void Config_TBL() {
        tbl_frm.setSelectable(true);
        tbl_frm.setFilterOnDemand(false);
        tbl_frm.setImmediate(true);
        tbl_frm.setFilterDecorator(new Decorator_Aerzteverwaltung());
        // tbl_arzt.setFilterDecorator(new FilterDecorator_Krankenschwesterverwaltung());
        tbl_frm.setColumnCollapsingAllowed(true);
        // tbl_arzt.setFilterBarVisible(true);
        tbl_frm.setFooterVisible(true);
    }


    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // horizontalLayout_2
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("100.0%");
        horizontalLayout_2.setMargin(false);
        mainLayout.addComponent(horizontalLayout_2);
        mainLayout.setExpandRatio(horizontalLayout_2, 1.0f);
        
        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        mainLayout.addComponent(verticalLayout_2);
        mainLayout.setExpandRatio(verticalLayout_2, 10.0f);
        mainLayout.setComponentAlignment(verticalLayout_2, new Alignment(20));
        
        // horizontalLayout_1
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(false);
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        verticalLayout_2.addComponent(men_frm);
        verticalLayout_2.setExpandRatio(men_frm, 0.8f);
        verticalLayout_2.setComponentAlignment(men_frm, new Alignment(24));
        
        // layoutFilters
        layoutFilters = buildLayoutFilters();
        verticalLayout_2.addComponent(layoutFilters);
        
        // tbl_frm
        tbl_frm = new FilterTable();
        tbl_frm.setImmediate(false);
        tbl_frm.setWidth("100.0%");
        tbl_frm.setHeight("90.0%");
        verticalLayout_2.addComponent(tbl_frm);
        verticalLayout_2.setExpandRatio(tbl_frm, 10.0f);
        verticalLayout_2.setComponentAlignment(tbl_frm, new Alignment(20));
        
        return verticalLayout_2;
    }

    @AutoGenerated
    private HorizontalLayout buildLayoutFilters() {
        // common part: create layout
        layoutFilters = new HorizontalLayout();
        layoutFilters.setImmediate(false);
        layoutFilters.setWidth("100.0%");
        layoutFilters.setHeight("-1px");
        layoutFilters.setMargin(true);
        
        // horizontalLayout_4
        horizontalLayout_4 = buildHorizontalLayout_4();
        layoutFilters.addComponent(horizontalLayout_4);
        layoutFilters.setComponentAlignment(horizontalLayout_4, new Alignment(10));
        
        return layoutFilters;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_4() {
        // common part: create layout
        horizontalLayout_4 = new HorizontalLayout();
        horizontalLayout_4.setImmediate(false);
        horizontalLayout_4.setWidth("-1px");
        horizontalLayout_4.setHeight("-1px");
        horizontalLayout_4.setMargin(false);
        horizontalLayout_4.setSpacing(true);
        
        // filterNurseGroupEnabled
        filterNurseGroupEnabled = new CheckBox();
        filterNurseGroupEnabled.setCaption("Projektfilter");
        filterNurseGroupEnabled.setImmediate(false);
        filterNurseGroupEnabled.setWidth("-1px");
        filterNurseGroupEnabled.setHeight("-1px");
        horizontalLayout_4.addComponent(filterNurseGroupEnabled);
        horizontalLayout_4.setComponentAlignment(filterNurseGroupEnabled, new Alignment(48));
        
        // filterNurseGroup
        filterNurseGroup = new TwinColSelect();
        filterNurseGroup.setImmediate(false);
        filterNurseGroup.setWidth("-1px");
        filterNurseGroup.setHeight("60px");
        horizontalLayout_4.addComponent(filterNurseGroup);
        horizontalLayout_4.setComponentAlignment(filterNurseGroup, new Alignment(48));
        
        return horizontalLayout_4;
    }
}
