package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Form;

import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashSet;

import org.joda.time.LocalDate;
import org.tepi.filtertable.FilterTable;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.ClickMenuBar.ClickCommand;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.DataviewGenerator;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Form.classes.I18nFORStatusConverter;

import com.mysql.jdbc.StringUtils;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.datefield.Resolution;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TwinColSelect;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

import de.steinwedel.messagebox.ButtonId;
// import
// archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Filter.Decorator_Forsteo;
// import
// archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.forsteo.Filter.Generator_Forsteo;
import de.steinwedel.messagebox.MessageBoxListener;

public class ForsteoDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private VerticalLayout verticalLayout_2;

    @AutoGenerated
    private FilterTable tbl_data;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_4;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_6;

    @AutoGenerated
    private TwinColSelect tcol_filterStatus;

    @AutoGenerated
    private CheckBox cb_filterStatus;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_5;

    @AutoGenerated
    private PopupDateField pop_month;

    @AutoGenerated
    private CheckBox cb_filterMonth;

    @AutoGenerated
    private MenuBar men_frm;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;

    

    

    

    

    

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/

    // Datenbank
    private FilteringTableUpdater userTableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_create;
    private MenuBar.MenuItem btn_update;
    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_filter;
    private MenuBar.MenuItem btn_ln;

    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PollListener pollListener = null;
    
    private Boolean leadNurseView = false;
    
    enum Status {}
    enum LeadNurse {}
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "23";
    private final String formIdPerm = "37";
    private final String winHeight = "600px";
    private final String winWidth = "900px";


    /******************************************************/

    private final String tableIdCol = "ID";
    
    private final Object[] tableColsDefault = new Object[] { "ID", "Erstellungsdatum", "Patient", "Arzt", "Krankenschwester", "cs_name", "Datum", "leadNurseOk", "Status" };
    private final Object[] tableColsFilter = tableColsDefault;
    
    private Object[] tableColsActive = tableColsDefault;

    
    private I18nManager i18n;
    

    
    private final static class caption extends I18nCB {
        static final I18nCB leadNurseOkStatustrue = set();
        static final I18nCB leadNurseOkStatusfalse = set();
    }
    
    /******************************************************/

    public ForsteoDataView(MenuItem Arg_Menü) {
        tmpMenu = Arg_Menü;
    }

    public ForsteoDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void initForsteoDataView() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        win.addDetachListener(onDetach);

    }

    public void initForsteoDataView(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        tab.getSelectedTab().addDetachListener(onDetach);
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);

        generateMenu();
        
        setMenuPermissions();

        updateTable();
        tbl_data.setSortContainerPropertyId(tableIdCol);
        tbl_data.setSortAscending(true);
        tbl_data.sort();
        configureTable();
        configueComponents();
        
        setGlobalFilterMonth();
        
        updateTable();
        
        setupListenersAndDetachEvent();
        
        i18n.refresh();
    }

    private void setupListenersAndDetachEvent() {
        pollListener = new PollListener() {

            @Override
            public void poll(PollEvent event) {
                if(tab.isRendered(mainLayout)){
                    updateTable();
                }
            }
        };

        UI.getCurrent().getUI().addPollListener(pollListener);

        onDetach = new DetachListener() {

            @Override
            public void detach(DetachEvent event) {
                UI.getCurrent().getUI().removePollListener(pollListener);
            }
        };
    }

    public void setGlobalFilterMonth(Date date){
        LocalDate ld = new LocalDate(date);
        cb_filterMonth.setValue(true);
        pop_month.setValue(new LocalDate(ld.getYear(), ld.getMonthOfYear(), 1).toDate());
    }
    
    public void setGlobalFilterMonth(){
        setGlobalFilterMonth(new Date());
    }
    
    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_create.setEnabled(c);
        btn_create.setVisible(c);

        btn_read.setEnabled(r);
        btn_read.setVisible(r);

        btn_update.setEnabled(u);
        btn_update.setVisible(u);

        btn_delete.setEnabled(d);
        btn_delete.setVisible(d);
    }

    /************ -><- ******************/

    /***************** Comands *********************/
    
    CloseListener closeListener = new CloseListener() {
		
		@Override
		public void windowClose(CloseEvent e) {
			
			updateTable(true);
			
		}
	};
    
    //TASK Commands are here
    public ClickCommand cmd_btn_add = new ClickCommand() {
        
        @Override
        public void menuClicked(MenuItem selectedItem) {

            form_forsteo_insert_edit pie = new form_forsteo_insert_edit(selectedItem, "");
            pie.setLeadNurseModeEnabled(leadNurseView);
            pie.Init_Class_Window();
            pie.getWindow().addCloseListener(closeListener);
            this.setWindow(pie.getWindow());
            this.setParent(men_frm);
        }
        
    };
    
    public ClickCommand cmd_btn_read = new ClickCommand() {
        
        @Override
        public void menuClicked(MenuItem selectedItem) {

            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String id = Integer.toString((Integer) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue());
            form_forsteo_insert_edit pie = new form_forsteo_insert_edit(selectedItem, id + "");
            pie.Init_Class_Window();
            pie.Set_Berrechtigung_Custom(1, 0, 0, 0);
            this.setWindow(pie.getWindow());
            this.setParent(men_frm);

        }
        
    };
    
    public ClickCommand cmd_btn_edit = new ClickCommand() {
        
        @Override
        public void menuClicked(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String id = Integer.toString((Integer) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue());
            form_forsteo_insert_edit pie = new form_forsteo_insert_edit(selectedItem, id + "");
            pie.setLeadNurseModeEnabled(leadNurseView);
            pie.Init_Class_Window();
            pie.getWindow().addCloseListener(closeListener);

            this.setWindow(pie.getWindow());
            this.setParent(men_frm);
            
        }
        
    };

    public Command cmd_btn_del = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            String id = Integer.toString((Integer) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue());
            deleteData(id);

        }
    };

    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_data.setFilterBarVisible(true);
                tbl_data.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_data.setFilterBarVisible(!tbl_data.isFilterBarVisible());

            if(!tbl_data.isFilterBarVisible()){
                tbl_data.clearFilters();
            }
            
            tableColsActive = tbl_data.isFilterBarVisible() ? tableColsFilter : tableColsDefault;
            try {
                tbl_data.setVisibleColumns(tableColsActive);
            } catch (Exception e) {
                // TASK: handle exception
            }

        }
    };
    
    public Command cmd_btn_leadnurseview = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            leadNurseView = !leadNurseView;
            updateTable();
            
        }
        
    };
    
    /******************************************/

    /*********** Gen Menüs *************/
    private void generateMenu() {

        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);
        
        btn_ln = men_frm.addItem("FRM_LEADNURSEVIEW", Icons.White.krankenschwester_16, cmd_btn_leadnurseview);

    }

    private void configueComponents(){
        btn_ln.setVisible(isLeadNurse());
        
        
        // MONTHPICKER
        cb_filterMonth.setValue(false);
        cb_filterMonth.setImmediate(true);
        pop_month.setResolution(Resolution.MONTH);
        pop_month.setDateFormat("MMM yyyy");
        pop_month.setEnabled(false);
        
        cb_filterMonth.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Boolean enabled = (Boolean)event.getProperty().getValue();
                pop_month.setEnabled(enabled);
                if(enabled && pop_month.getValue() == null){
                    LocalDate ld = new LocalDate();
                    pop_month.setValue(new LocalDate(ld.getYear(), ld.getMonthOfYear(), 1).toDate());
                }else if(!enabled){
                    pop_month.setValue(null);
                }
                
            }
        });
        
        pop_month.setImmediate(true);
        pop_month.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateTable(true);
                
            }
        });
        
        // STATUSPICKER
        cb_filterStatus.setValue(true);
        cb_filterStatus.setImmediate(true);
        new I18nFORStatusConverter().attachDatasource(tcol_filterStatus);
        
       
        preselectStatusFilter();
        
        cb_filterStatus.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Boolean enabled = (Boolean)event.getProperty().getValue();
                tcol_filterStatus.setEnabled(enabled);
                updateTable(true);
                
            }
        });
        
        tcol_filterStatus.setImmediate(true);
        tcol_filterStatus.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Collection val = (Collection) tcol_filterStatus.getValue();
                cb_filterStatus.setValue(val.size() != 0);
                updateTable(true);
                
            }
        });
        
        
    }
    
    private void preselectStatusFilter(){
        // Preselect a few items
        HashSet<Integer> preselected = new HashSet<Integer>();
        Collections.addAll(preselected, 1, 2, 3);
        tcol_filterStatus.setValue(preselected);
    }
    
    private ArrayList<AbstractField> getActiveGlobalFilters(){
        ArrayList<AbstractField> al = new ArrayList<AbstractField>();
        
        if(pop_month.getValue() != null){
            al.add(pop_month);
        }
        
        if(cb_filterStatus.getValue()){
            al.add(tcol_filterStatus);
        }
        
        return al;
    }
    
    private Boolean hasGlobalFilters(ArrayList a){
        
        return (a.size() > 0);
        
    }
    
    private Boolean hasGlobalFilters(){
        
        return hasGlobalFilters(getActiveGlobalFilters());
        
    }
    
    /*************************** Config TBL ********************/

    private void configureTable() {
        tbl_data.setSelectable(true);
        tbl_data.setFilterOnDemand(false);
        tbl_data.setImmediate(true);
        tbl_data.setColumnCollapsingAllowed(true);
        tbl_data.setFooterVisible(true);

        tbl_data.setColumnWidth("Status", 110);
        tbl_data.setColumnWidth("Datum", 110);
        tbl_data.setColumnWidth("Erstellungsdatum", 110);
        tbl_data.setColumnWidth("leadNurseOk", 85);
        
        
        tbl_data.setPageLength(1);
        
        
        if(tbl_data.size() > 0){
            
        	StringSqlTimestampConverter date = new StringSqlTimestampConverter();
            date.setDateFormat(DateFormat.SHORT);
        	
        	StringSqlTimestampConverter time = new StringSqlTimestampConverter();
            time.setDateFormat(DateFormat.SHORT);
            time.setTimeFormat(DateFormat.SHORT);
            
            tbl_data.setConverter("Datum", time);
            tbl_data.setConverter("Erstellungsdatum", date);

        }
        
        DataviewGenerator gen = new DataviewGenerator();
        gen.addConverter("Status", new I18nFORStatusConverter());
        gen.attach(tbl_data);
        
        userTableUpdater = new FilteringTableUpdater(tbl_data);

    }


    /*************************** Database ********************/
    
    /********************************/
    
    private Boolean isLeadNurse() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'19'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
           return true;
        } else {
            return false;
        }

    }
    
    
    private void updateTable(){
        updateTable(false);
    }
    
    private void updateTable(Boolean ignoreFilter) {

        if (ignoreFilter || !tbl_data.isFilterBarVisible()) {
            
            int ps = tbl_data.size();

            dbGetContainer();
            if(ps == 0) {
                configureTable();
            }
            try{
                tbl_data.setVisibleColumns(tableColsActive);
            }catch(Exception e){
                
            }
        }

        tbl_data.setColumnFooter("Status", "Σ " + tbl_data.size());
        
    }
    
    private void deleteData(final String id){
        
        I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
            
            @Override
            public void buttonClicked(ButtonId arg0) {
                if(ButtonId.YES == arg0) {
                    dbDeleteData(id);
                }
            }
        });
    }
    
    private void dbGetContainer() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        int NUID = getNurseUID();

        DBClass db = new DBClass();

        /************ Set Spalten *************/
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("SLF_ID", "ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(Arzt.AUL_NAME,', ',Arzt.AUL_VORNAME,', ', ASAN_NAME,' ',ASA_TITEL)", "Arzt");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(PSL_NAME,', ',PSL_VORNAME, ', ', PSA_NAME,' ',PSL_TITEL)", "Patient");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(KSK_TITEL,' ',KSA_NAME,' ',Krankenschwester.AUL_NAME,' ',Krankenschwester.AUL_VORNAME)", "Krankenschwester");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(ASA_NAME, ' ', SAD_NAME,' ',SAD_VORNAME)", "Außendienst");

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE WHEN SLF_DATE > '1900-01-01 00:00:00' THEN DATE_ADD(SLF_DATE, INTERVAL IF(SLF_VON != '', SLF_VON, '') HOUR_MINUTE) END", "'Datum'");
//        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE WHEN SLF_DATE > '1900-01-01 00:00:00' THEN DATE_FORMAT(SLF_DATE,'%d') END", "'Tag'");
//        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE WHEN SLF_DATE > '1900-01-01 00:00:00' THEN DATE_FORMAT(SLF_DATE,'%m') END", "'Monat'");
//        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE WHEN SLF_DATE > '1900-01-01 00:00:00' THEN DATE_FORMAT(SLF_DATE,'%Y') END", "'Jahr'");

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE WHEN SLF_CREATED > '1900-01-01 00:00:00' THEN SLF_CREATED END", "'Erstellungsdatum'");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CASE when SLF_LEAD_NURSE_OK = 0 then '" + i18n.get(caption.leadNurseOkStatusfalse) + "' else '" + i18n.get(caption.leadNurseOkStatustrue) + "' end", "'leadNurseOk'");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("SLF_Status", "'Status'");
        /**************************************/
        /************ Set Tabelle *************/
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_schulung_liste_forsteopen", "INNER JOIN", "cust_patient_stammdaten_liste", "SLF_P_ID", "PSL_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_patient_stammdaten_liste", "INNER JOIN", "cust_patient_stammdaten_anrede", "PSL_ANREDE", "PSA_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_schulung_liste_forsteopen", "/*1*/RIGHT JOIN", "cust_verk_haupt", "SLF_P_ID", "VH_PATIENT_ID and VH_NURSE_ID = SLF_K_ID and VH_PROJEKT_ID = 1 and VH_AKTIV = 1");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_verk_haupt", "/*2*/ RIGHT JOIN", "cust_protokoll_forsteo_meta_static", "VH_ID", "PFORMS_VH_ID");

        /* Krankenschwester */
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_schulung_liste_forsteopen", "RIGHT JOIN", "cust_krankenschwester_stammdaten_ks", "SLF_K_ID", "KSK_ID");

        /* Arzt */
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_schulung_liste_forsteopen", "RIGHT JOIN", "cust_arzt_stammdaten_arzt", "SLF_ARZT_ID", "ASA_ID");
        
        /* Außendienst */
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_protokoll_forsteo_meta_static", "RIGHT JOIN", "cust_stammdaten_aussendienst", "PFORMS_ID_ADM", "SAD_ID");
        
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("LEFT JOIN", "cms_auth_stammdaten_user AS Arzt", "Arzt", "cust_arzt_stammdaten_arzt", "AUL_ID", "ASA_U_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("LEFT JOIN", "cms_auth_stammdaten_user AS Krankenschwester", "Krankenschwester", "cust_krankenschwester_stammdaten_ks", "AUL_ID", "KSK_U_ID");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("LEFT JOIN", "cust_krankenschwester_stammdaten_anrede", "cust_krankenschwester_stammdaten_anrede", "Krankenschwester", "KSA_ID", "AUL_ANREDE_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("LEFT JOIN", "cust_arzt_stammdaten_anrede", "cust_arzt_stammdaten_anrede", "Arzt", "ASAN_ID", "AUL_ANREDE_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung_Graph("LEFT JOIN", "cms_auth_stammdaten_anrede", "cms_auth_stammdaten_anrede", "cust_stammdaten_aussendienst", "ASA_ID", "SAD_ID_ANREDE");
//        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_schulung_liste_forsteopen", "INNER JOIN", "cust_schulung_status", "SLF_STATUS", "SS_PROZESS AND SS_PROJEKT = 1");

        /**************************************/
        /************ Set Filter *************/
        String glue = "";
        
        if (NUID != 0 && !leadNurseView) {
            
            if(hasGlobalFilters()){
                glue = "AND";
            }
            
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_krankenschwester_stammdaten_ks", "KSK_U_ID", "=", Integer.toString(NUID), glue);
        }
        
        ArrayList<AbstractField> filterList = getActiveGlobalFilters(); 
        
        if(pop_month.getValue() != null){
            
            java.sql.Timestamp sqlDateFrom = new java.sql.Timestamp(pop_month.getValue().getTime());
            java.sql.Timestamp sqlDateUntil = new java.sql.Timestamp(new LocalDate(pop_month.getValue()).plusMonths(1).toDate().getTime());
            
            filterList.remove(pop_month);
            glue = hasGlobalFilters(filterList) ? "AND" : "";
            
            db.DB_Data_Get.DB_Filter.DB_WHERE_BETWEEN("(cust_schulung_liste_forsteopen", "SLF_DATE", "'" + sqlDateFrom.toString() + "'",  "'" + sqlDateUntil.toString() + "'", "OR");
            db.DB_Data_Get.DB_Filter.DB_WHERE_BETWEEN("cust_schulung_liste_forsteopen", "SLF_CREATED", "'" + sqlDateFrom.toString() + "'",  "'" + sqlDateUntil.toString() + "')", glue);
        }
        
        if(cb_filterStatus.getValue() && ((Collection) tcol_filterStatus.getValue()).size() > 0){
            
            filterList.remove(tcol_filterStatus);
            glue = hasGlobalFilters(filterList) ? "AND" : "";
            
            Collection<Integer> coll = ((Collection<Integer>) tcol_filterStatus.getValue());
            
            String comma = "";
            String in = "";
            
            for (Integer i : coll) {
                in += comma + i;
                if(StringUtils.isNullOrEmpty(comma)){
                    comma = ", ";
                }
            }
            
            db.DB_Data_Get.DB_Filter.DB_WHERE_In("cust_schulung_liste_forsteopen", "SLF_STATUS", in, glue);
        }
        
        /**************************************/
        /************ Set Custom *************/

        // db.DB_Data_Custom.set_SQL_String("CASE WHEN SLF_VON_UHRZEIT > '1900-01-01 00:00:00' THEN SLF_VON_UHRZEIT END AS 'Datum rep'");

        

        /**************************************/
        
        
        // db.DB_Data_Get.Set_Type("Datum von", Date.class);
        // db.DB_Data_Get.Set_Type("Datum bis", Date.class);
//        db.DB_Data_Get.Set_Type("Status", Status.class);
        db.DB_Data_Get.Set_Type("leadNurseOk", LeadNurse.class);

//        db.DB_Data_Get.DB_DEBUG_SQL_STRING();
        
//        db.debugNextQuery(true);
        
        /* **************************/
        
        Container container = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (userTableUpdater != null) {
            userTableUpdater.updateTable(container);
        } else {
            tbl_data.setContainerDataSource(container);
        }

    }
    
    private void dbDeleteData(String id){
    
        CMS_Config_Std std = CMS_Config_Std.getInstance();
    
        DBClass db = new DBClass();
        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_schulung_liste_forsteopen");
        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein("cust_schulung_liste_forsteopen", "SLF_ID", "=", id + "", "");
        db.DB_Data_Delete.DB_Delete();
    
        I18nManager.global(I18nGlobalNotifiers.entry_deleted);
        
        updateTable(true);
    }
    
    /*********************************************************/
    
    private int getNurseUID() {
        int UID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_liste_gu");
        // db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_liste_gu",
        // "INNER JOIN", "cust_krankenschwester_stammdaten_ks", "AL_U_ID",
        // "KSK_U_ID");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_U_ID", "=", "'" + UID + "'", "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "'12'", "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (con.size() > 0) {
            return UID;
        } else {
            return 0;
        }

    }
    
    private Container dbGetStatusValues() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("SS_PROZESS");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("SS_NAME");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_schulung_status");
        
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_schulung_status", "SS_PROJEKT", "=", "1", "");
        
        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        db.DB_Data_Get.connclose();
        
        return con;

    }
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // horizontalLayout_2
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("100.0%");
        horizontalLayout_2.setMargin(false);
        mainLayout.addComponent(horizontalLayout_2);
        mainLayout.setExpandRatio(horizontalLayout_2, 1.0f);
        
        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        mainLayout.addComponent(verticalLayout_2);
        mainLayout.setExpandRatio(verticalLayout_2, 10.0f);
        mainLayout.setComponentAlignment(verticalLayout_2, new Alignment(20));
        
        // horizontalLayout_1
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(false);
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        verticalLayout_2.addComponent(men_frm);
        verticalLayout_2.setExpandRatio(men_frm, 1.2f);
        verticalLayout_2.setComponentAlignment(men_frm, new Alignment(24));
        
        // horizontalLayout_4
        horizontalLayout_4 = buildHorizontalLayout_4();
        verticalLayout_2.addComponent(horizontalLayout_4);
        verticalLayout_2.setComponentAlignment(horizontalLayout_4, new Alignment(48));
        
        // tbl_data
        tbl_data = new FilterTable();
        tbl_data.setImmediate(true);
        tbl_data.setWidth("100.0%");
        tbl_data.setHeight("90.0%");
        verticalLayout_2.addComponent(tbl_data);
        verticalLayout_2.setExpandRatio(tbl_data, 20.0f);
        verticalLayout_2.setComponentAlignment(tbl_data, new Alignment(20));
        
        return verticalLayout_2;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_4() {
        // common part: create layout
        horizontalLayout_4 = new HorizontalLayout();
        horizontalLayout_4.setImmediate(false);
        horizontalLayout_4.setWidth("100.0%");
        horizontalLayout_4.setHeight("70px");
        horizontalLayout_4.setMargin(false);
        
        // horizontalLayout_5
        horizontalLayout_5 = buildHorizontalLayout_5();
        horizontalLayout_4.addComponent(horizontalLayout_5);
        horizontalLayout_4.setComponentAlignment(horizontalLayout_5, new Alignment(48));
        
        // horizontalLayout_6
        horizontalLayout_6 = buildHorizontalLayout_6();
        horizontalLayout_4.addComponent(horizontalLayout_6);
        horizontalLayout_4.setComponentAlignment(horizontalLayout_6, new Alignment(48));
        
        return horizontalLayout_4;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_5() {
        // common part: create layout
        horizontalLayout_5 = new HorizontalLayout();
        horizontalLayout_5.setImmediate(false);
        horizontalLayout_5.setWidth("-1px");
        horizontalLayout_5.setHeight("-1px");
        horizontalLayout_5.setMargin(false);
        horizontalLayout_5.setSpacing(true);
        
        // cb_filterMonth
        cb_filterMonth = new CheckBox();
        cb_filterMonth.setCaption("Monatsfilter");
        cb_filterMonth.setImmediate(false);
        cb_filterMonth.setWidth("-1px");
        cb_filterMonth.setHeight("-1px");
        horizontalLayout_5.addComponent(cb_filterMonth);
        horizontalLayout_5.setComponentAlignment(cb_filterMonth, new Alignment(33));
        
        // pop_month
        pop_month = new PopupDateField();
        pop_month.setImmediate(false);
        pop_month.setWidth("-1px");
        pop_month.setHeight("-1px");
        horizontalLayout_5.addComponent(pop_month);
        horizontalLayout_5.setComponentAlignment(pop_month, new Alignment(34));
        
        return horizontalLayout_5;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_6() {
        // common part: create layout
        horizontalLayout_6 = new HorizontalLayout();
        horizontalLayout_6.setImmediate(false);
        horizontalLayout_6.setWidth("-1px");
        horizontalLayout_6.setHeight("-1px");
        horizontalLayout_6.setMargin(false);
        horizontalLayout_6.setSpacing(true);
        
        // cb_filterStatus
        cb_filterStatus = new CheckBox();
        cb_filterStatus.setCaption("Statusfilter");
        cb_filterStatus.setImmediate(false);
        cb_filterStatus.setWidth("-1px");
        cb_filterStatus.setHeight("-1px");
        horizontalLayout_6.addComponent(cb_filterStatus);
        horizontalLayout_6.setComponentAlignment(cb_filterStatus, new Alignment(33));
        
        // tcol_filterStatus
        tcol_filterStatus = new TwinColSelect();
        tcol_filterStatus.setImmediate(false);
        tcol_filterStatus.setWidth("-1px");
        tcol_filterStatus.setHeight("52px");
        horizontalLayout_6.addComponent(tcol_filterStatus);
        horizontalLayout_6.setComponentAlignment(tcol_filterStatus, new Alignment(34));
        
        return horizontalLayout_6;
    }
}
