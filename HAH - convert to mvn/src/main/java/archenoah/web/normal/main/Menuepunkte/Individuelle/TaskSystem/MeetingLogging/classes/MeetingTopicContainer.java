package archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.MeetingLogging.classes;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.form.TaskManagerDataView;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.RichTextArea;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TabSheet.SelectedTabChangeEvent;
import com.vaadin.ui.TabSheet.SelectedTabChangeListener;
import com.vaadin.ui.TabSheet.Tab;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.Icon;
import de.steinwedel.messagebox.MessageBox;
import de.steinwedel.messagebox.MessageBoxListener;

public class MeetingTopicContainer extends CustomComponent {
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */


    @AutoGenerated
    private HorizontalLayout mainLayout;
    @AutoGenerated
    private TabSheet tabTopic;
    @AutoGenerated
    private VerticalLayout layoutActions;
    @AutoGenerated
    private Button buttonDelete;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;
    @AutoGenerated
    private Button buttonRename;
    @AutoGenerated
    private TextField fieldRename;
    @AutoGenerated
    private VerticalLayout layoutTasks;
    @AutoGenerated
    private VerticalLayout layoutDescription;
    @AutoGenerated
    private RichTextArea fieldDescription;
    
    
    
    
    
    
    
    
    
    /*
     * Fields
     */
    
//    private TaskManagerDataView tasks;
    private TaskManagerDataView taskManagerDataView;
    private final String tbl = "cust_taskmanager_meeting_topics";

    private Integer logId;
    private Integer topId;
    private Integer topType;
    private TabSheet topSheet;
    private Tab topTab;
    private String topTitle;
    private String topResult;
    
    private Boolean hasLoaded = false;
    private OnSave onSave;
    private I18nManager i18n;
    
    /*
     * Constructors
     */
    
    public MeetingTopicContainer(TaskManagerDataView taskView, Integer topId) {
        
        this(taskView);
        
        this.topId = topId;

        if(dbReadTopic()){
            init();
        }
        
    }
    
    
    public MeetingTopicContainer(TaskManagerDataView taskView, Integer logId, Integer topType, String topTitle) {
        
        this(taskView);
        setFields(logId, topType, topTitle);
        init();
    }
    
    private MeetingTopicContainer(TaskManagerDataView taskView){
        this.taskManagerDataView = taskView;
    }
    
    private void setFields(Integer logId, Integer topType, String topTitle){
        
        this.logId = logId;
        this.topType = topType;
        this.topTitle = topTitle;
    }
    
    private void setFields(Integer logId, Integer topType, String topTitle, String topResult){
        
        setFields(logId, topType, topTitle);
        this.topResult = topResult;
        
    }
    
    private void init(){
        buildMainLayout();
        i18n = new I18nManager(this);
        setListeners();
        configureComponents();
        setCompositionRoot(mainLayout);
        
        if(topId == null){
            topId = dbCreateTopic();
        }
        
//        updateTaskList();
        
        if(topResult != null){
            fieldDescription.setValue(topResult);
        }
        
        hasLoaded = true;
    }

    /*
     * Public
     */
    
    public void updateTaskList(){
        
        setDataview();
        taskManagerDataView.setTopicId(topId);

    }
    
    public void saveTopic(){
        dbSaveTopic();
    }
    
    /*
     * Getters and Setters
     */
    
    public Integer getLogId() {
        return logId;
    }


    public void setLogId(Integer logId) {
        this.logId = logId;
    }


    public Integer getTopType() {
        return topType;
    }


    public void setTopType(Integer topType) {
        this.topType = topType;
    }


    public String getTopTitle() {
        return topTitle;
    }


    public void setTopTitle(String topTitle) {
        this.topTitle = topTitle;
    }
    
    public void setTab(TabSheet sheet, Tab tab) {
        this.topSheet = sheet;
        this.topTab = tab;
    }
    
    public void setSaveAction(OnSave onSave) {
        this.onSave = onSave;
    }
    
    /*
     * Private
     */

    
    private void configureComponents() {
        tabTopic.setImmediate(true);
        fieldDescription.setImmediate(true);
    }
    
    private void setListeners(){
        
        tabTopic.addSelectedTabChangeListener(new SelectedTabChangeListener() {
            
            @Override
            public void selectedTabChange(SelectedTabChangeEvent event) {
                
                if(MyUtils.isSelectedTab(1, event)){
                    
                    updateTaskList();
                    
                }
                
            }
        });
        
        fieldDescription.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                if(hasLoaded) {
                    dbSaveTopic();
                }
                
            }
        });
        
        buttonRename.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(fieldRename.getValue() == null || fieldRename.getValue().equals("")) {
                    return;
                }
                
                topTitle = fieldRename.getValue();
                topTab.setCaption(topTitle);
                dbSaveTopic();
                fieldRename.setValue("");
                
            }
        });
        
        buttonDelete.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                MessageBoxListener mbl = new MessageBoxListener() {
                    
                    @Override
                    public void buttonClicked(ButtonId btn) {
                        
                        if(btn == ButtonId.YES){
                            
                            if(dbDeleteTopic() != null){
                                topSheet.removeTab(topTab);
                            }
                            
                        }
                        
                    }
                };
                
                MessageBox mb = MessageBox.showHTML(Icon.WARN, "Thema löschen?", "Möchten sie das Thema '" + topTitle + "' wirklich löschen? <br />"
                        + "Eventuell bestehende Aufgaben bleiben erhalten.", mbl, ButtonId.YES, ButtonId.ABORT); 
                
                
            }
        });

    }
    
    private void setDataview(){
        if(layoutTasks.getComponentCount() == 0){

            layoutTasks.addComponent(taskManagerDataView);
            layoutTasks.setHeight("100%");
        }
    }
    
    private Boolean dbReadTopic(){
        
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        /******************************** Table ****************************************/
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln(tbl);
        /******************************************************************************/
        
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein(tbl, "TMET_ID", "=", topId.toString(), "");
        
//        db.debugNextQuery(true);
        
        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        
        if(con.size() > 0){
            
            Object itemId = con.getItemIds().iterator().next();
            
            Integer logId = (Integer) con.getContainerProperty(itemId, "TMET_ID_LOG").getValue();
            Integer topType = (Integer) con.getContainerProperty(itemId, "TMET_ID_TYPE").getValue();
            String topTitle = (String) con.getContainerProperty(itemId, "TMET_TITLE").getValue();
            String topResult = (String) con.getContainerProperty(itemId, "TMET_RESULT").getValue();
            
            
            setFields(logId, topType, topTitle, topResult);
            
            return true;
        }else{
            return false;
        }
        
        
        
    }
    
    private Integer dbCreateTopic() {
        Integer res = 0;
        
        
        DBClass db = new DBClass();
        /******************************** Table ****************************************/
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(tbl);
        /******************************************************************************/
        
        db.DB_Data_Insert.DB_Daten.DB_Data(tbl, "TMET_ID_LOG", logId.toString());
        db.DB_Data_Insert.DB_Daten.DB_Data(tbl, "TMET_ID_TYPE",  topType.toString());
        db.DB_Data_Insert.DB_Daten.DB_Data(tbl, "TMET_TITLE",  topTitle);
        
//        db.debugNextQuery(true);
        
        res = db.DB_Data_Insert.DB_Insert();
        
        if(onSave != null) {
            onSave.saveAction();
        }
        
        return res;
    }
    
    private void dbSaveTopic(){
        
        if(topId == null){
            System.out.println("topId is null!");
            return;
        }
        
        DBClass db = new DBClass();
        /******************************** Table ****************************************/
        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln(tbl);
        /******************************************************************************/
        
        db.DB_Data_Update.DB_Daten.DB_Data(tbl, "TMET_ID_LOG", logId.toString());
        db.DB_Data_Update.DB_Daten.DB_Data(tbl, "TMET_ID_TYPE",  topType.toString());
        db.DB_Data_Update.DB_Daten.DB_Data(tbl, "TMET_TITLE",  topTitle);
        db.DB_Data_Update.DB_Daten.DB_Data(tbl, "TMET_RESULT",  fieldDescription.getValue());
        
        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein(tbl, "TMET_ID", "=", topId.toString(), "");
        
//        db.debugNextQuery(true);
        
        if(onSave != null) {
            onSave.saveAction();
        }
        
        db.DB_Data_Update.DB_Update();

    }
    
    private Long dbDeleteTopic(){
        
        if(topId == null){
            System.out.println("topId is null!");
            return null;
        }
        
        DBClass db = new DBClass();
        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln(tbl);
        
        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein(tbl, "TMET_ID", "=", topId.toString(), "");
        
//        db.debugNextQuery(true);
        
        if(onSave != null) {
            onSave.saveAction();
        }
        
        return db.DB_Data_Delete.DB_Delete();

    }
    
    
    public abstract class OnSave{
        abstract public void saveAction();
    }
    
    /*
     * AutoGenerated
     */
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // tabTopic
        tabTopic = buildTabTopic();
        mainLayout.addComponent(tabTopic);
        
        return mainLayout;
    }


    @AutoGenerated
    private TabSheet buildTabTopic() {
        // common part: create layout
        tabTopic = new TabSheet();
        tabTopic.setImmediate(true);
        tabTopic.setWidth("100.0%");
        tabTopic.setHeight("300px");
        
        // layoutDescription
        layoutDescription = buildLayoutDescription();
        tabTopic.addTab(layoutDescription, "Thema", null);
        
        // layoutTasks
        layoutTasks = new VerticalLayout();
        layoutTasks.setImmediate(false);
        layoutTasks.setWidth("100.0%");
        layoutTasks.setHeight("100.0%");
        layoutTasks.setMargin(false);
        tabTopic.addTab(layoutTasks, "Aufgaben", null);
        
        // layoutActions
        layoutActions = buildLayoutActions();
        tabTopic.addTab(layoutActions, "Optionen", null);
        
        return tabTopic;
    }


    @AutoGenerated
    private VerticalLayout buildLayoutDescription() {
        // common part: create layout
        layoutDescription = new VerticalLayout();
        layoutDescription.setImmediate(false);
        layoutDescription.setWidth("100.0%");
        layoutDescription.setHeight("100.0%");
        layoutDescription.setMargin(false);
        
        // fieldDescription
        fieldDescription = new RichTextArea();
        fieldDescription.setImmediate(false);
        fieldDescription.setWidth("100.0%");
        fieldDescription.setHeight("100.0%");
        layoutDescription.addComponent(fieldDescription);
        
        return layoutDescription;
    }


    @AutoGenerated
    private VerticalLayout buildLayoutActions() {
        // common part: create layout
        layoutActions = new VerticalLayout();
        layoutActions.setImmediate(false);
        layoutActions.setWidth("100.0%");
        layoutActions.setHeight("100.0%");
        layoutActions.setMargin(true);
        
        // horizontalLayout_2
        horizontalLayout_2 = buildHorizontalLayout_2();
        layoutActions.addComponent(horizontalLayout_2);
        layoutActions.setComponentAlignment(horizontalLayout_2, new Alignment(33));
        
        // buttonDelete
        buttonDelete = new Button();
        buttonDelete.setCaption("Thema Löschen");
        buttonDelete.setImmediate(false);
        buttonDelete.setWidth("-1px");
        buttonDelete.setHeight("-1px");
        layoutActions.addComponent(buttonDelete);
        layoutActions.setComponentAlignment(buttonDelete, new Alignment(33));
        
        return layoutActions;
    }


    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_2() {
        // common part: create layout
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("-1px");
        horizontalLayout_2.setMargin(false);
        horizontalLayout_2.setSpacing(true);
        
        // fieldRename
        fieldRename = new TextField();
        fieldRename.setImmediate(false);
        fieldRename.setWidth("100.0%");
        fieldRename.setHeight("-1px");
        horizontalLayout_2.addComponent(fieldRename);
        horizontalLayout_2.setExpandRatio(fieldRename, 1.0f);
        
        // buttonRename
        buttonRename = new Button();
        buttonRename.setCaption("Thema Umbenennen");
        buttonRename.setImmediate(false);
        buttonRename.setWidth("-1px");
        buttonRename.setHeight("-1px");
        horizontalLayout_2.addComponent(buttonRename);
        
        return horizontalLayout_2;
    }
    
}
