package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.pop.classes;

import java.sql.Time;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map.Entry;

import org.slf4j.Logger;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Fields.CustomTimePicker;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Table;
import com.vaadin.ui.VerticalLayout;

public class PanelMedications extends CustomComponent{
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout layoutTable;
    @AutoGenerated
    private Table table;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private HorizontalLayout layoutFields;
    @AutoGenerated
    private Button medRemove;
    @AutoGenerated
    private Button medAdd;
    @AutoGenerated
    private ComboBox medApplied;
    @AutoGenerated
    private CustomTimePicker medTime;
    @AutoGenerated
    private ComboBox medName;
    @AutoGenerated
    private CheckBox medAdministered;
    // {section fields}
    // ****************
    
    private HashMap<Object, String> componentMap;

    private String type = "unspecified";
    private Integer dataId;

    private I18nConverter medAppliedConverter;
    private ArrayList<Integer> dataOriginal;
    private Logger log;
    
    private Object[] columns  = new Object[] {"NAME", "TIME", "ADM_TYPE"};
    private I18nManager i18n;

    
    // {end fields}
    

    

    // {section constructors}
    // **********************
    public PanelMedications(String type) {
        this.type = type;
        
        log = org.slf4j.LoggerFactory.getLogger(this.getClass());
        
        
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this, PanelMedications.class);
        registerComponents();
        
        fillFields();
        configureComponents();
        configureListeners();
        
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void getEntries(Integer dataId) {
        this.dataId = dataId;
        dbGetEntries();
    }
    
    public void save(Integer dataId) {
        this.dataId = dataId;
        checkIncompleteInput();
        dbSaveEntries();
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    private void checkIncompleteInput() {
        boolean hasUnsaved = false;
        
        if(medName.isValid()
            && medTime.isValid()
            && medApplied.isValid()) {
            hasUnsaved = true;
        }
        
        if(hasUnsaved && table.size() == 0) {
            I18nManager.global(I18nGlobalNotifiers.incomplete_save);
        }
    }
    
    private void registerComponents(){
        componentMap = new HashMap<Object, String>();
        new ComponentIterator(mainLayout).createMap(componentMap);
    }
    
    private void configureComponents() {
        
        for (Entry<Object, String> entry : componentMap.entrySet()) {
            AbstractComponent field = (AbstractComponent) entry.getKey();

                    
            if(field instanceof AbstractField){
                field.setImmediate(true);
            }
            
            if(field instanceof ComboBox){
                ((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
            }
            
        }
        
        medRemove.setEnabled(false);
        
        medName.setRequired(true);
        medName.setNewItemsAllowed(true);
        
        medTime.setRequired(true);
        
        medApplied.setRequired(true);
        medApplied.setNullSelectionAllowed(false);
        
        layoutFields.setEnabled(false);
        table.setEnabled(false);
        
    }
    
    private void configureListeners() {
        
        medAdministered.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                layoutFields.setEnabled(medAdministered.getValue());
                table.setEnabled(medAdministered.getValue());
                
            }
        });
        
        table.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
               toggleFields((table.getValue() == null)); // edit mode if null
                
            }
        });
        
        medAdd.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(medName.isValid()
                        && medTime.isValid()
                        && medApplied.isValid()) {
                    addEntry();
                }
                
            }
        });
        
        medRemove.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                removeEntry();
                
            }
        });
        
    }
    
    private void configureTable() {
        table.setImmediate(true);
        table.setSelectable(true);
        
        table.setVisibleColumns(columns);
        
        StringSqlTimestampConverter time = new StringSqlTimestampConverter();
        time.setDateFormat(0);
        time.setTimeFormat(DateFormat.SHORT);
        
        table.setConverter("TIME", time);
        
        table.setConverter("ADM_TYPE", medAppliedConverter);
        
        i18n.refresh();
    }
    
    private void fillFields() {
        fillMedName();
        fillMedApplied();
    }
    
    
    private void toggleFields(Boolean editMode) {
        medName.setEnabled(editMode);
        medTime.setEnabled(editMode);
        medApplied.setEnabled(editMode);
        medAdd.setEnabled(editMode);
        medRemove.setEnabled(!editMode);
    }
    
    
    private void addEntry() {
        
        Container con = table.getContainerDataSource();
        
        String name = medName.getItemCaption(medName.getValue());
        Time time = new Time(medTime.getTime().toDateTimeToday().getMillis());
        Integer applied = (Integer) medApplied.getValue();
        
        Object iid = con.addItem();
        
        ///TASK if empty
        
        Collection propIds = con.getContainerPropertyIds();
        
        if(!propIds.contains("NAME")) {
            con.addContainerProperty("NAME", String.class, null);
            con.addContainerProperty("TIME", java.sql.Time.class, null);
            con.addContainerProperty("ADM_TYPE", Integer.class, null);
        }
        
        if(dataId == null) {
            configureTable();
        }
        
        con.getItem(iid).getItemProperty("NAME").setValue(name);
        con.getItem(iid).getItemProperty("TIME").setValue(time);
        con.getItem(iid).getItemProperty("ADM_TYPE").setValue(applied);
        
        table.setValue(null);
    }
    
    private void removeEntry() {
        
        if(table.getValue() != null) {
            table.getContainerDataSource().removeItem(table.getValue());
        }
     
        table.setValue(null);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    private void fillMedName() {
        DBClass db = new DBClass();
        
        db.CustomQuery.setSqlString("select DISTINCT NAME from cust_protokoll_pop_multi_meds");
        
        medName.setItemCaptionPropertyId("NAME");
        medName.setContainerDataSource(db.CustomQuery.query());
        
    }
    
    private void fillMedApplied() {
        
        medAppliedConverter = new I18nConverter("cust_protokoll_pop_multi_meds_applications", "ID", "TYPE");
        medAppliedConverter.attachDatasource(medApplied);
        
    }
    
    private void dbGetEntries() {
        
        DBClass db = new DBClass();
        
        String sql = "SELECT ID, NAME, TIME, ADM_TYPE"
             + "\n " + "FROM cust_protokoll_pop_multi_meds"
             + "\n " + "WHERE ID_DATA = "+dataId+" AND FLAG_TYPE = '"+type+"'";
        
        db.CustomQuery.setSqlString(sql);
//        db.debugNextQuery(true);
        Container con  = MyUtils.convertIndex(db.CustomQuery.query(), "ID");
        
        dataOriginal = new ArrayList<Integer>();
        dataOriginal.addAll((Collection<Integer>) con.getItemIds());
        
        table.setContainerDataSource(con);
        
        if(con.size() > 0) {
            medAdministered.setValue(true);
            medAdministered.setEnabled(false);
        }else {
            medAdministered.setValue(false);
            medAdministered.setEnabled(true);
        }
        configureTable();
    }
    
    private ArrayList<Integer> getInsertEntries() {
        
        ArrayList<Integer> insert = new ArrayList<Integer>();
        insert.addAll((Collection<Integer>) table.getContainerDataSource().getItemIds());
        if(dataOriginal != null) {
            insert.removeAll(dataOriginal);
        }
        
        return insert;
    }
    
    private ArrayList<Integer> getDeleteEntries() {
        
        ArrayList<Integer> delete = new ArrayList<Integer>();
        if(dataOriginal != null) {
            delete.addAll(dataOriginal);
        }
        delete.removeAll(table.getContainerDataSource().getItemIds());
        
        return delete;
    }
    
    private void dbSaveEntries() {
        // INSERT INTO `hah_feature_pop`.`cust_protokoll_pop_multi_meds` (`ID_DATA`, `FLAG_TYPE`, `NAME`, `TIME`, `ADM_TYPE`)
        // VALUES ('0', 'type_pre', 'Test 1', '17:26:23', '1');
        DBClass db = new DBClass();
        
        ArrayList<Integer> insertEntries = getInsertEntries();
        ArrayList<Integer> deleteEntries = getDeleteEntries();
        
        if(deleteEntries.size() > 0 ) {
            String deleteString = "DELETE FROM cust_protokoll_pop_multi_meds WHERE ID_DATA = " + dataId + " AND ID IN("+Joiner.on(",").join(getDeleteEntries())+")";
            db.CustomQuery.setSqlString(deleteString);
            db.CustomQuery.update();
        }
        
        if(insertEntries.size() > 0 ) {
            
            ArrayList<String> insertList = new ArrayList<String>();
            
            for (Integer id : getInsertEntries()) {
                Item item = table.getContainerDataSource().getItem(id);
                insertList.add("("+dataId+", '"+type+"', '"+item.getItemProperty("NAME").getValue()+"', '"+item.getItemProperty("TIME").getValue()+"', '"+item.getItemProperty("ADM_TYPE").getValue()+"')");
            }
            
            String insertString = "INSERT INTO `cust_protokoll_pop_multi_meds` (`ID_DATA`, `FLAG_TYPE`, `NAME`, `TIME`, `ADM_TYPE`)"
                    + "\n " + "VALUES " + Joiner.on(",\n").join(insertList) + ";";

            db.CustomQuery.setSqlString(insertString);
            db.CustomQuery.update();
        }

        
    }
    
    
    // {end database}

    // {section layout}
    // ****************
    // {end layout}
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // layoutTable
        layoutTable = buildLayoutTable();
        mainLayout.addComponent(layoutTable);
        mainLayout.setExpandRatio(layoutTable, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutTable() {
        // common part: create layout
        layoutTable = new VerticalLayout();
        layoutTable.setImmediate(false);
        layoutTable.setWidth("100.0%");
        layoutTable.setHeight("100.0%");
        layoutTable.setMargin(false);
        layoutTable.setSpacing(true);
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        layoutTable.addComponent(horizontalLayout_1);
        
        // table
        table = new Table();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        layoutTable.addComponent(table);
        layoutTable.setExpandRatio(table, 1.0f);
        
        return layoutTable;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(false);
        horizontalLayout_1.setSpacing(true);
        
        // medAdministered
        medAdministered = new CheckBox();
        medAdministered.setCaption("verabreicht");
        medAdministered.setImmediate(false);
        medAdministered.setWidth("-1px");
        medAdministered.setHeight("-1px");
        horizontalLayout_1.addComponent(medAdministered);
        horizontalLayout_1.setComponentAlignment(medAdministered, new Alignment(48));
        
        // layoutFields
        layoutFields = buildLayoutFields();
        horizontalLayout_1.addComponent(layoutFields);
        horizontalLayout_1.setExpandRatio(layoutFields, 1.0f);
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private HorizontalLayout buildLayoutFields() {
        // common part: create layout
        layoutFields = new HorizontalLayout();
        layoutFields.setImmediate(false);
        layoutFields.setWidth("100.0%");
        layoutFields.setHeight("-1px");
        layoutFields.setMargin(false);
        
        // medName
        medName = new ComboBox();
        medName.setCaption("Medikament");
        medName.setImmediate(false);
        medName.setWidth("200px");
        medName.setHeight("-1px");
        layoutFields.addComponent(medName);
        layoutFields.setExpandRatio(medName, 2.0f);
        layoutFields.setComponentAlignment(medName, new Alignment(24));
        
        // medTime
        medTime = new CustomTimePicker();
        medTime.setCaption("Uhrzeit");
        medTime.setImmediate(false);
        medTime.setWidth("80px");
        medTime.setHeight("-1px");
        layoutFields.addComponent(medTime);
        layoutFields.setExpandRatio(medTime, 1.0f);
        layoutFields.setComponentAlignment(medTime, new Alignment(24));
        
        // medApplied
        medApplied = new ComboBox();
        medApplied.setCaption("Applikation");
        medApplied.setImmediate(false);
        medApplied.setWidth("100px");
        medApplied.setHeight("-1px");
        layoutFields.addComponent(medApplied);
        layoutFields.setExpandRatio(medApplied, 1.0f);
        layoutFields.setComponentAlignment(medApplied, new Alignment(24));
        
        // medAdd
        medAdd = new Button();
        medAdd.setCaption("Hinzuf√ºgen");
        medAdd.setImmediate(true);
        medAdd.setWidth("-1px");
        medAdd.setHeight("-1px");
        layoutFields.addComponent(medAdd);
        layoutFields.setExpandRatio(medAdd, 1.0f);
        layoutFields.setComponentAlignment(medAdd, new Alignment(24));
        
        // medRemove
        medRemove = new Button();
        medRemove.setCaption("Entfernen");
        medRemove.setEnabled(false);
        medRemove.setImmediate(true);
        medRemove.setWidth("-1px");
        medRemove.setHeight("-1px");
        layoutFields.addComponent(medRemove);
        layoutFields.setExpandRatio(medRemove, 1.0f);
        layoutFields.setComponentAlignment(medRemove, new Alignment(24));
        
        return layoutFields;
    }
}
