package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.pop.classes;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map.Entry;

import org.joda.time.LocalDate;
import org.slf4j.Logger;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

public class PanelCharges extends CustomComponent{
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout layoutTable;
    @AutoGenerated
    private Table table;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;
    @AutoGenerated
    private VerticalLayout layoutFields2;
    @AutoGenerated
    private VerticalLayout verticalLayout_3;
    @AutoGenerated
    private HorizontalLayout fieldsBot;
    @AutoGenerated
    private Button chargesRemove;
    @AutoGenerated
    private Button chargesAdd;
    @AutoGenerated
    private HorizontalLayout fieldsTop;
    @AutoGenerated
    private PopupDateField chargesExpires;
    @AutoGenerated
    private TextField chargesNr;
    @AutoGenerated
    private IntStepper chargesCount;
    // {section fields}
    // ****************
    
    private HashMap<Object, String> componentMap;

    private Integer dataId;

    private ArrayList<Integer> dataOriginal;
    private Logger log;
    
    private Object[] columns  = new Object[] {"COUNT", "NR", "EXPIRES"};
    private I18nManager i18n;
    
    // {end fields}
    

    

    // {section constructors}
    // **********************
    public PanelCharges() {
        
        log = org.slf4j.LoggerFactory.getLogger(this.getClass());
        
        
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this);
        registerComponents();
        
        fillFields();
        configureComponents();
        configureListeners();
        
//        i18n.refresh();
        
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void getEntries(Integer dataId) {
        this.dataId = dataId;
        dbGetEntries();
    }
    
    public void save(Integer dataId) {
        this.dataId = dataId;
        checkIncompleteInput();
        dbSaveEntries();
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    private void checkIncompleteInput() {
        boolean hasUnsaved = false;
        
        if( chargesCount.isValid()
            && chargesNr.isValid()
            && chargesExpires.isValid()) {
            hasUnsaved = true;
        }
        
        if(hasUnsaved && table.size() == 0) {
            I18nManager.global(I18nGlobalNotifiers.incomplete_save);
        }
    }
    
    private void registerComponents(){
        componentMap = new HashMap<Object, String>();
        new ComponentIterator(mainLayout).createMap(componentMap);
    }
    
    private void configureComponents() {
        
        for (Entry<Object, String> entry : componentMap.entrySet()) {
            AbstractComponent field = (AbstractComponent) entry.getKey();

                    
            if(field instanceof AbstractField){
                field.setImmediate(true);
            }
            
            if(field instanceof ComboBox){
                ((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
            }
            
        }
        
        chargesRemove.setEnabled(false);
        
        chargesCount.setRequired(true);
        chargesCount.setMinValue(0);

        chargesNr.setRequired(true);
        
        chargesExpires.setRangeStart(new LocalDate().minusYears(10).toDate());
    }
    
    private void configureListeners() {

        
        table.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
               toggleFields((table.getValue() == null)); // edit mode if null
                
            }
        });
        
        chargesAdd.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if( chargesCount.isValid()
                        && chargesNr.isValid()
                        && chargesExpires.isValid()) {
                    addEntry();
                }
                
            }
        });
        
        chargesRemove.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                removeEntry();
                
            }
        });
        
    }
    
    private void configureTable() {
        table.setImmediate(true);
        table.setSelectable(true);
        
        table.setVisibleColumns(columns);
        
        StringSqlTimestampConverter time = new StringSqlTimestampConverter();
        
        table.setConverter("EXPIRES", time);
        
        table.setColumnExpandRatio("NR", 1);
        
        i18n.refresh();
    }

    
    private void fillFields() {

    }
    
    
    private void toggleFields(Boolean editMode) {
        chargesCount.setEnabled(editMode);
        chargesNr.setEnabled(editMode);
        chargesExpires.setEnabled(editMode);
        
        chargesAdd.setEnabled(editMode);
        chargesRemove.setEnabled(!editMode);
    }
    
    
    private void addEntry() {
        
        Container con = table.getContainerDataSource();
        
        Integer count = chargesCount.getValue();
        String nr = chargesNr.getValue();
        java.sql.Date expires = (chargesExpires.getValue() != null) ? new java.sql.Date(chargesExpires.getValue().getTime()) : null;
        
        
        Object iid = con.addItem();
        
        Collection propIds = con.getContainerPropertyIds();
        
        if(!propIds.contains("COUNT")) {
            
            con.addContainerProperty("COUNT", Integer.class, null);
            con.addContainerProperty("NR", String.class, null);
            con.addContainerProperty("EXPIRES", java.sql.Date.class, null);
        }
        
        if(dataId == null) {
            configureTable();
        }
        
        con.getItem(iid).getItemProperty("COUNT").setValue(count);
        con.getItem(iid).getItemProperty("NR").setValue(nr);
        con.getItem(iid).getItemProperty("EXPIRES").setValue(expires);
        
        table.setValue(null);
        
    }
    
    private void removeEntry() {
        
        if(table.getValue() != null) {
            table.getContainerDataSource().removeItem(table.getValue());
        }
        
        table.setValue(null);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    
    private void dbGetEntries() {
        
        DBClass db = new DBClass();
        
        String sql = "SELECT ID, COUNT, NR, EXPIRES"
             + "\n " + "FROM cust_protokoll_pop_chargen"
             + "\n " + "WHERE ID_DATA = "+dataId
             + "\n " + "ORDER BY ID ASC";
        
        db.CustomQuery.setSqlString(sql);
//        db.debugNextQuery(true);
        Container con  = MyUtils.convertIndex(db.CustomQuery.query(), "ID");
        
        dataOriginal = new ArrayList<Integer>();
        dataOriginal.addAll((Collection<Integer>) con.getItemIds());
        
        table.setContainerDataSource(con);
        
        configureTable();
    }
    
    private ArrayList<Integer> getInsertEntries() {
        
        ArrayList<Integer> insert = new ArrayList<Integer>();
        insert.addAll((Collection<Integer>) table.getContainerDataSource().getItemIds());
        if(dataOriginal != null) {
            insert.removeAll(dataOriginal);
        }
        
        return insert;
    }
    
    private ArrayList<Integer> getDeleteEntries() {
        
        ArrayList<Integer> delete = new ArrayList<Integer>();
        if(dataOriginal != null) {
            delete.addAll(dataOriginal);
        }
        delete.removeAll(table.getContainerDataSource().getItemIds());
        
        return delete;
    }
    
    private void dbSaveEntries() {

        DBClass db = new DBClass();
        
        ArrayList<Integer> insertEntries = getInsertEntries();
        ArrayList<Integer> deleteEntries = getDeleteEntries();
        
        if(deleteEntries.size() > 0 ) {
            String deleteString = "DELETE FROM cust_protokoll_pop_chargen WHERE ID_DATA = " + dataId + " AND ID IN("+Joiner.on(",").join(getDeleteEntries())+")";
            db.CustomQuery.setSqlString(deleteString);
            db.CustomQuery.update();
        }
        
        if(insertEntries.size() > 0 ) {
            
            ArrayList<String> insertList = new ArrayList<String>();
            
            for (Integer id : getInsertEntries()) {
                Item item = table.getContainerDataSource().getItem(id);
                
                insertList.add("("+dataId+
                        ", "+formatPropertyString(item, "COUNT")+
                        ", "+formatPropertyString(item, "NR")+
                        ", "+formatPropertyString(item, "EXPIRES")+
                        ")");
            }
            
            String insertString = "INSERT INTO `cust_protokoll_pop_chargen` (`ID_DATA`, `COUNT`, `NR`, `EXPIRES`)"
                    + "\n " + "VALUES " + Joiner.on(",\n").join(insertList) + ";";

            db.CustomQuery.setSqlString(insertString);
            db.CustomQuery.update();
        }

        
    }
    
    private String formatPropertyString(Item item, String propertyId) {
        
        String result = null;
        
        if(item.getItemProperty(propertyId) != null && item.getItemProperty(propertyId).getValue() != null) {
            result = "'" + item.getItemProperty(propertyId).getValue() + "'";
        }else {
            result = "NULL";
        }
        
        return result;
        
    }
    
    // {end database}

    // {section layout}
    // ****************
    // {end layout}
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // layoutTable
        layoutTable = buildLayoutTable();
        mainLayout.addComponent(layoutTable);
        mainLayout.setExpandRatio(layoutTable, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutTable() {
        // common part: create layout
        layoutTable = new VerticalLayout();
        layoutTable.setImmediate(false);
        layoutTable.setWidth("100.0%");
        layoutTable.setHeight("100.0%");
        layoutTable.setMargin(false);
        layoutTable.setSpacing(true);
        
        // horizontalLayout_2
        horizontalLayout_2 = buildHorizontalLayout_2();
        layoutTable.addComponent(horizontalLayout_2);
        
        // table
        table = new Table();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        layoutTable.addComponent(table);
        layoutTable.setExpandRatio(table, 1.0f);
        
        return layoutTable;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_2() {
        // common part: create layout
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("100.0%");
        horizontalLayout_2.setHeight("-1px");
        horizontalLayout_2.setMargin(false);
        
        // layoutFields2
        layoutFields2 = buildLayoutFields2();
        horizontalLayout_2.addComponent(layoutFields2);
        
        return horizontalLayout_2;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutFields2() {
        // common part: create layout
        layoutFields2 = new VerticalLayout();
        layoutFields2.setImmediate(false);
        layoutFields2.setWidth("100.0%");
        layoutFields2.setHeight("-1px");
        layoutFields2.setMargin(false);
        
        // verticalLayout_3
        verticalLayout_3 = buildVerticalLayout_3();
        layoutFields2.addComponent(verticalLayout_3);
        
        return layoutFields2;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_3() {
        // common part: create layout
        verticalLayout_3 = new VerticalLayout();
        verticalLayout_3.setImmediate(false);
        verticalLayout_3.setWidth("100.0%");
        verticalLayout_3.setHeight("-1px");
        verticalLayout_3.setMargin(false);
        verticalLayout_3.setSpacing(true);
        
        // fieldsTop
        fieldsTop = buildFieldsTop();
        verticalLayout_3.addComponent(fieldsTop);
        
        // fieldsBot
        fieldsBot = buildFieldsBot();
        verticalLayout_3.addComponent(fieldsBot);
        
        return verticalLayout_3;
    }

    @AutoGenerated
    private HorizontalLayout buildFieldsTop() {
        // common part: create layout
        fieldsTop = new HorizontalLayout();
        fieldsTop.setImmediate(false);
        fieldsTop.setWidth("100.0%");
        fieldsTop.setHeight("-1px");
        fieldsTop.setMargin(false);
        fieldsTop.setSpacing(true);
        
        // chargesCount
        chargesCount = new IntStepper();
        chargesCount.setCaption("Anzahl");
        chargesCount.setImmediate(false);
        chargesCount.setWidth("60px");
        chargesCount.setHeight("-1px");
        fieldsTop.addComponent(chargesCount);
        fieldsTop.setComponentAlignment(chargesCount, new Alignment(24));
        
        // chargesNr
        chargesNr = new TextField();
        chargesNr.setCaption("Chargen-Nummer");
        chargesNr.setImmediate(false);
        chargesNr.setWidth("100.0%");
        chargesNr.setHeight("-1px");
        fieldsTop.addComponent(chargesNr);
        fieldsTop.setExpandRatio(chargesNr, 1.0f);
        fieldsTop.setComponentAlignment(chargesNr, new Alignment(24));
        
        // chargesExpires
        chargesExpires = new PopupDateField();
        chargesExpires.setCaption("Verwendbar bis");
        chargesExpires.setImmediate(false);
        chargesExpires.setWidth("80px");
        chargesExpires.setHeight("-1px");
        fieldsTop.addComponent(chargesExpires);
        fieldsTop.setComponentAlignment(chargesExpires, new Alignment(24));
        
        return fieldsTop;
    }

    @AutoGenerated
    private HorizontalLayout buildFieldsBot() {
        // common part: create layout
        fieldsBot = new HorizontalLayout();
        fieldsBot.setImmediate(false);
        fieldsBot.setWidth("100.0%");
        fieldsBot.setHeight("-1px");
        fieldsBot.setMargin(false);
        
        // chargesAdd
        chargesAdd = new Button();
        chargesAdd.setCaption("Hinzuf√ºgen");
        chargesAdd.setImmediate(true);
        chargesAdd.setWidth("-1px");
        chargesAdd.setHeight("-1px");
        fieldsBot.addComponent(chargesAdd);
        fieldsBot.setComponentAlignment(chargesAdd, new Alignment(24));
        
        // chargesRemove
        chargesRemove = new Button();
        chargesRemove.setCaption("Entfernen");
        chargesRemove.setEnabled(false);
        chargesRemove.setImmediate(true);
        chargesRemove.setWidth("-1px");
        chargesRemove.setHeight("-1px");
        fieldsBot.addComponent(chargesRemove);
        fieldsBot.setComponentAlignment(chargesRemove, new Alignment(24));
        
        return fieldsBot;
    }
}
