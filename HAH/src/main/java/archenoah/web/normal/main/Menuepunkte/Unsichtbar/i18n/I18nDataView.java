package archenoah.web.normal.main.Menuepunkte.Unsichtbar.i18n;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.concurrent.CopyOnWriteArrayList;

import org.tepi.filtertable.FilterTable;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.DataviewGenerator;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.CustomConverterFactorys.DataviewConverter;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.resources.Icons;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.ItemSetChangeEvent;
import com.vaadin.data.Container.ItemSetChangeListener;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.event.ItemClickEvent;
import com.vaadin.event.ShortcutAction.KeyCode;
import com.vaadin.event.ShortcutListener;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.DefaultFieldFactory;
import com.vaadin.ui.Field;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;


@SuppressWarnings({"serial", "rawtypes", "unchecked"})
public class I18nDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private VerticalLayout mainContainer;

    @AutoGenerated
    private FilterTable tbl_data;

    @AutoGenerated
    private HorizontalLayout globalFilterContainer;

    @AutoGenerated
    private ComboBox parent;

    @AutoGenerated
    private ComboBox locale;

    @AutoGenerated
    private CheckBox showOpenOnly;

    @AutoGenerated
    private VerticalLayout menuSpacer;

    @AutoGenerated
    private MenuBar men_frm;

    

    

	

	

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    I18nManager i18n;
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(I18nDataView.class);
    
    // Datenbank
    private Map<Object, String> componentMap;

    private MenuItem tmpMenu = null;
    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_filter;
    private MenuBar.MenuItem btn_update_locales;
    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private FilteringTableUpdater tableUpdater = null;
    private Boolean firstFilter = true;
    private PollListener pollListener = null;
    private boolean deferTableUpdates;

    
    /************ ----->Einstellungen<-- ********************/
    private final String winHeight = "600px";
    private final String winWidth = "900px";

    /******************************************************/

    private final String tableIdCol = "ID";
    private final String tableName = "cust_protokoll_pop_daten";
    
    //TASK cols
    private final Object[] tableColsAll = new Object[] { "PARENT", "name", "IDENTIFIER", "LOCALE", "CAPTION" };
    //use custom Cols when needed
    private Object[] tableColsDefault = tableColsAll;
    //use custom Cols when needed
    private final Object[] tableColsFilter = tableColsDefault;
    private Object[] tableColsActive = tableColsDefault;
    
    private List<Object> tableFields = java.util.Arrays.asList(new Object[] {"CAPTION"});
    protected List<Field> fields = new ArrayList<Field>();
    
    /******************************************************/

    public I18nDataView(MenuItem Arg_Menü) {
        tmpMenu = Arg_Menü;
    }

    public I18nDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        win.addDetachListener(onDetach);

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        tab.getSelectedTab().addDetachListener(onDetach);
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        
        i18n = new I18nManager(this);
        
        registerComponents();
        
        generateMenu();

        tbl_data.setSortContainerPropertyId(tableIdCol);
        tbl_data.setSortAscending(true);
        tbl_data.sort();
        
        deferTableUpdates(true);
        
        configureTable();
        configureComponents();
        
        deferTableUpdates(false);
        
        updateTable();
        
        setupListenersAndDetachEvent();
        
        i18n.refresh();
        
    }
    
    // register components for lng and validation tools
    private void registerComponents(){
    	componentMap = new HashMap<Object, String>();
    	new ComponentIterator(mainContainer).createMap(componentMap);
    }

    
    private void setupListenersAndDetachEvent() {
        pollListener = new PollListener() {

            @Override
            public void poll(PollEvent event) {
                if(tab.isRendered(mainLayout)){
                    updateTable();
                }
            }
        };

        UI.getCurrent().getUI().addPollListener(pollListener);

        onDetach = new DetachListener() {

            @Override
            public void detach(DetachEvent event) {
                UI.getCurrent().getUI().removePollListener(pollListener);
            }
        };
    }

    /***************** Comands *********************/
    
    CloseListener closeListener = new CloseListener() {
		
		@Override
		public void windowClose(CloseEvent e) {
			updateTable(true);
		}
	};

    //TASK Commands are here
    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_data.setFilterBarVisible(true);
                tbl_data.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_data.setFilterBarVisible(!tbl_data.isFilterBarVisible());
            
            if(!tbl_data.isFilterBarVisible()){
                tbl_data.clearFilters();
            }
            
            tableColsActive = tbl_data.isFilterBarVisible() ? tableColsFilter : tableColsDefault;
            if(tbl_data.getContainerDataSource().size() > 0 && tableColsActive.length > 0){
            	tbl_data.setVisibleColumns(tableColsActive);
            }

        }
    };
    
      
    /******************************************/

    
    

    /*********** Gen Menüs *************/
    private void generateMenu() {
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);
        btn_update_locales = men_frm.addItem("FRM_UPDATE_LOCALES", Icons.White.refresh_16, new Command() {
            
            @Override
            public void menuSelected(MenuItem selectedItem) {
                
                I18nManager.updateAllLocales();
                updateTable(true);
                
            }
        });

    }
    
    private void configureComponents(){
       
    	for (Entry<Object, String> entry : componentMap.entrySet()) {
    		AbstractComponent field = (AbstractComponent) entry.getKey();
    		
			field.setImmediate(true);
			
			
			if(field instanceof ComboBox){
				((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
			}
			
		}
        
    	showOpenOnly.setValue(true);
    	showOpenOnly.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                cancelEdit();
                updateTable(true);
            }
        });
    	
    	locale.setContainerDataSource(dbGetLocales());
    	locale.setValue(UI.getCurrent().getLocale().getLanguage());
    	locale.setItemCaptionPropertyId("CAPTION");
    	locale.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                cancelEdit();
                updateTable(true);
            }
        });
    	
    	parent.setContainerDataSource(dbGetParentValues());
    	parent.setItemCaptionPropertyId("name");
    	parent.addValueChangeListener(new ValueChangeListener() {

            @Override
            public void valueChange(ValueChangeEvent event) {

                updateTable(true);
                cancelEdit();

            }
        });
    	
    	
    }
    
    private void deferTableUpdates(boolean defer) {
        this.deferTableUpdates = defer;
    }

    
    private ArrayList<AbstractField> getActiveGlobalFilters(){
        ArrayList<AbstractField> al = new ArrayList<AbstractField>();
        
        if(showOpenOnly.getValue()){
            al.add(showOpenOnly);
        }
        
        if(locale.getValue() != null){
            al.add(locale);
        }
        
        if(parent.getValue() != null){
            al.add(parent);
        }
        
        return al;
    }
    
    private Boolean hasGlobalFilters(ArrayList a){
        
        return (a.size() > 0);
        
    }
    
    private Boolean hasGlobalFilters(){
        
        return hasGlobalFilters(getActiveGlobalFilters());
        
    }
    
    /*************************** Config TBL ********************/

    private void configureEditable(boolean editable) {
        
        deferTableUpdates(editable);
        
        tbl_data.setEditable(editable);
        tbl_data.setSelectable(!editable);
        if (editable && !fields.isEmpty()) {
            fields.get(0).focus();
        }

    }
    
    private void configureTable() {
        tbl_data.setSelectable(true);
        tbl_data.setFilterOnDemand(false);
        tbl_data.setImmediate(true);
        tbl_data.setColumnCollapsingAllowed(false);
        tbl_data.setFooterVisible(true);
        tbl_data.setPageLength(1);
        try {
            if (tableColsDefault.length > 0) {
                tbl_data.setVisibleColumns(tableColsDefault);
            }
        } catch (Exception e) {

        }

        if (tbl_data.size() > 0) {

            HashMap<String, DataviewConverter> converterMap = new HashMap<String, DataviewConverter>();
            tbl_data.setFilterGenerator(new DataviewGenerator(converterMap));

        }

        tableUpdater = new FilteringTableUpdater(tbl_data);

        tbl_data.addItemSetChangeListener(new ItemSetChangeListener() {
            @Override
            public void containerItemSetChange(ItemSetChangeEvent event) {
                tbl_data.setValue(null);
            }
        });

        for (Object col : tableColsAll) {

            try {
                tbl_data.setColumnExpandRatio(col, 1);
            } catch (Exception e) {

            }

        }

        tbl_data.setColumnExpandRatio("PARENT", 0);
        tbl_data.setColumnExpandRatio("LOCALE", 0);
        tbl_data.setColumnExpandRatio("CAPTION", 2);
        
        tbl_data.addItemClickListener(new ItemClickEvent.ItemClickListener() {
            @Override
            public void itemClick(ItemClickEvent itemClickEvent) {

                if (itemClickEvent.isDoubleClick() && !tbl_data.isEditable()) {
                    tbl_data.setValue(itemClickEvent.getItemId());
                    configureEditable(true);
                }
            }
        });
        
        tbl_data.addShortcutListener(new ShortcutListener("tbl_data_f2", KeyCode.F2, new int[] {}) {

            @Override
            public void handleAction(Object sender, Object target) {
               startEdit();
            }
        });
        
        tbl_data.addShortcutListener(new ShortcutListener("tbl_data_enter", KeyCode.ENTER, new int[] {}) {

            @Override
            public void handleAction(Object sender, Object target) {
               startEdit();
            }
        });
        
        tbl_data.addShortcutListener(new ShortcutListener("tbl_data_esc", KeyCode.ESCAPE, new int[] {}) {

            @Override
            public void handleAction(Object sender, Object target) {
                cancelEdit();
            }
        });
        
        
        tbl_data.setTableFieldFactory(new DefaultFieldFactory() {
            @Override
            public Field<?> createField(Container container, Object itemId, Object propertyId, com.vaadin.ui.Component uiContext) {
                // If the itemId isn't the currently selected item in the table,
                // don't generate a field
                // i.e. it's not editable
                if (!itemId.equals(tbl_data.getValue())) {
                    return null;
                }

                // create only fields for specified properties
                if (!tableFields.contains(propertyId)) {
                    return null;
                }

                // Let the default factory build the field : you can and
                // probably should do far more
                // Logic here
                TextField field = new TextField();

                // Make the field buffered - this lets us discard the value
                field.setBuffered(true);

                // Let's keep track of all of the attached fields
                field.addAttachListener(new AttachListener() {
                    @Override
                    public void attach(AttachEvent attachEvent) {
                        fields.add((Field) attachEvent.getConnector());
                    }
                });
                field.addDetachListener(new DetachListener() {
                    @Override
                    public void detach(DetachEvent event) {
                        fields.remove(event.getConnector());
                    }
                });
                
                field.setInvalidAllowed(false);
                field.setInvalidCommitted(false);

                return field;
            }
        });

    }
    
    /*************************** Database ********************/
    
    /********************************/
    
    private void startEdit() {
        if (tbl_data.getValue() != null && !tbl_data.isEditable()) {
            configureEditable(true);
        } else if (tbl_data.isEditable()) {
            for (Field field : new CopyOnWriteArrayList<Field>(fields)) {

                if (field instanceof TextField) {
                    TextField text = (TextField) field;
                    if (text.isValid()) {
                        text.commit();
                        dbUpdate(tbl_data.getItem(tbl_data.getValue()));
                    } else {
                        text.discard();
                    }
                    
                    tbl_data.select(tbl_data.getValue());
                    tbl_data.focus();
                }
                configureEditable(false);

            }
        }
    }
    
    private void cancelEdit() {
        if (tbl_data.isEditable()) {
            for (Field field : new CopyOnWriteArrayList<Field>(fields)) {

                if (field instanceof TextField) {
                    TextField text = (TextField) field;
                    text.discard();
                    
                    tbl_data.select(tbl_data.getValue());
                    tbl_data.focus();
                }

            }
            configureEditable(false);
        }
    }
    
    private void updateTable(){
        updateTable(false);
    }
    
    private void updateTable(Boolean ignoreFilter) {
        
        if(deferTableUpdates) {
            return;
        }
        
        if (ignoreFilter || !tbl_data.isFilterBarVisible()) {
            dbGetContainer();
            try{
            	if(tableColsDefault.length > 0){
            		tbl_data.setVisibleColumns(tableColsActive);
            	}
            }catch(Exception e){
                
            }
        }
        
        tbl_data.setColumnFooter("Status", "Σ " + tbl_data.size());
        
    }
    
    private Container dbGetLocales() {
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select LOCALE, CAPTION from cms_i18n_languages WHERE LOCALE != '--'";
        q.setSqlString(sql);
        
        return MyUtils.convertIndex(q.query(), "LOCALE");
    }
    
    private Container dbGetParentValues() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select ID, SUBSTRING_INDEX(NAME, '.', -1) as name from cms_i18n_components order by NAME";
        q.setSqlString(sql);
        
        return MyUtils.convertIndex(q.query(), "ID");

    }
    
    //TASK dbget
	private void dbGetContainer() {
        
	    CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PARENT, SUBSTRING_INDEX(NAME, '.', -1) as name, IDENTIFIER, LOCALE, CAPTION from cms_i18n"
            + "\n " + "left join cms_i18n_components on PARENT = ID"
            + "\n " + "where LOCALE != '--'";
        
        for (AbstractField filter : getActiveGlobalFilters()) {
            
            if(filter == showOpenOnly && I18nManager.getManagers().size() > 0) {
                sql += " and PARENT IN ("
                    + "\n " + "    select ID from cms_i18n_components"
                    + "\n " + "    where NAME IN ('" + Joiner.on("', '").join(I18nManager.getManagers()) + "')"
                    + "\n " + ")";
            }
            
            if(filter == locale) {
                sql += " and LOCALE = '" + locale.getValue() + "'";
            }
            
            if(filter == parent) {
                sql += " and PARENT = " + parent.getValue();
            }
            
        }
        
        sql += "  order by LOCALE, name, IDENTIFIER";
        
//        q.db.debugNextQuery(true);
        q.setSqlString(sql);
        
        try {
        	Container container = q.query();
            
        	if (tableUpdater != null) {
                tableUpdater.updateTable(container);
            } else {
                tbl_data.setContainerDataSource(container);
            }
        	
		} catch (Exception e) {
			// TASK: handle exception
			System.out.println("exception!");
			UI.getCurrent().getUI().removePollListener(pollListener);
		}
        
    }
    
	private int dbUpdate(Item item) {
	    
	    if(item == null) {
	        return 0;
	    }
	    
	    String caption = MyUtils.getValueFromItem(item, "CAPTION", String.class);
	    Integer prnt = MyUtils.getValueFromItem(item, "PARENT", Integer.class);
	    String ident = MyUtils.getValueFromItem(item, "IDENTIFIER", String.class);
	    String loc = MyUtils.getValueFromItem(item, "LOCALE", String.class);
	    
	    if(prnt == null
	        || ident == null
	        || loc == null) {
	        log.warn("missing key values: {}", MyUtils.formatItem(item));
	        return 0;
	    }
	    
	    CustomQuery q = new DBClass().CustomQuery;
        String sql = "UPDATE cms_i18n SET CAPTION='"+caption+"'"
            + "\n " + "WHERE PARENT=" + prnt
            + "\n " + "  AND IDENTIFIER='"+ident+"'"
            + "\n " + "  AND LOCALE='"+loc+"'";
        q.setSqlString(sql);
        
        return q.update();
	    
	}
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // mainContainer
        mainContainer = buildMainContainer();
        mainLayout.addComponent(mainContainer);
        mainLayout.setExpandRatio(mainContainer, 1.0f);
        mainLayout.setComponentAlignment(mainContainer, new Alignment(20));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildMainContainer() {
        // common part: create layout
        mainContainer = new VerticalLayout();
        mainContainer.setImmediate(false);
        mainContainer.setWidth("100.0%");
        mainContainer.setHeight("100.0%");
        mainContainer.setMargin(true);
        
        // menuSpacer
        menuSpacer = buildMenuSpacer();
        mainContainer.addComponent(menuSpacer);
        
        // globalFilterContainer
        globalFilterContainer = buildGlobalFilterContainer();
        mainContainer.addComponent(globalFilterContainer);
        mainContainer.setComponentAlignment(globalFilterContainer, new Alignment(48));
        
        // tbl_data
        tbl_data = new FilterTable();
        tbl_data.setImmediate(true);
        tbl_data.setWidth("100.0%");
        tbl_data.setHeight("100.0%");
        mainContainer.addComponent(tbl_data);
        mainContainer.setExpandRatio(tbl_data, 1.0f);
        mainContainer.setComponentAlignment(tbl_data, new Alignment(20));
        
        return mainContainer;
    }

    @AutoGenerated
    private VerticalLayout buildMenuSpacer() {
        // common part: create layout
        menuSpacer = new VerticalLayout();
        menuSpacer.setImmediate(false);
        menuSpacer.setWidth("100.0%");
        menuSpacer.setHeight("40px");
        menuSpacer.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        menuSpacer.addComponent(men_frm);
        menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
        
        return menuSpacer;
    }

    @AutoGenerated
    private HorizontalLayout buildGlobalFilterContainer() {
        // common part: create layout
        globalFilterContainer = new HorizontalLayout();
        globalFilterContainer.setImmediate(false);
        globalFilterContainer.setWidth("100.0%");
        globalFilterContainer.setHeight("80px");
        globalFilterContainer.setMargin(false);
        
        // showOpenOnly
        showOpenOnly = new CheckBox();
        showOpenOnly.setCaption("showOpenOnly");
        showOpenOnly.setImmediate(false);
        showOpenOnly.setWidth("-1px");
        showOpenOnly.setHeight("-1px");
        globalFilterContainer.addComponent(showOpenOnly);
        globalFilterContainer.setComponentAlignment(showOpenOnly, new Alignment(48));
        
        // locale
        locale = new ComboBox();
        locale.setCaption("locale");
        locale.setImmediate(false);
        locale.setWidth("-1px");
        locale.setHeight("-1px");
        globalFilterContainer.addComponent(locale);
        globalFilterContainer.setComponentAlignment(locale, new Alignment(48));
        
        // parent
        parent = new ComboBox();
        parent.setCaption("parent");
        parent.setImmediate(false);
        parent.setWidth("-1px");
        parent.setHeight("-1px");
        globalFilterContainer.addComponent(parent);
        globalFilterContainer.setComponentAlignment(parent, new Alignment(48));
        
        return globalFilterContainer;
    }

}
