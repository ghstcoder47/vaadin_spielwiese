package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form.Metadata;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Map.Entry;

import org.apache.commons.lang3.tuple.Pair;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Metadata.MetadataPanel;
import archenoah.lib.vaadin.Components.Metadata.RecurrenceDateInformation;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form.form_projektzuweisung_rrule;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Panel;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class MetadataForsteoMain extends MetadataPanel {
    //        public class MetadataForsteoMain extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Panel pan_project;
    @AutoGenerated
    private VerticalLayout verticalLayout_2;
    @AutoGenerated
    private ComboBox cbx_csUser;
    @AutoGenerated
    private ComboBox cbx_adm;

    /**************** --> Allgemein <--- ********************/
    // Berrechtigung

    private final Button Temp_Btn = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private final Window win = null;
    private Panel pan = null;
    private final form_projektzuweisung_rrule rrule = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/
    private String staticId = null;
    private HashMap<Object, String> DBMapStatic;

    private ArrayList<AbstractField> validateListStatic;


    // 	Datenbank
    private final String projectId = "1";

    /************ ----->Einstellungen<-- ********************/
    private final String LNG_FRM_ID = "2101";
 
    private final String Windows_Height = "600px";
    private final String Windows_Width = "720px";

    /******************************************************/

    //public ComboBox cb_nurse;
    public MetadataForsteoMain() {
        buildMainLayout();
        new I18nManager(this);
        pan = new Panel(mainLayout);
        pan.setSizeFull();

    }

    /********* INIT-Window ************/

    @Override
    public Panel getPanel() {
        defaultInit();
        return pan;
    }

    //        /*************************************/
    //        //TASK placeholder stuff for Editor
    //        private Boolean hasMainId(){
    //            return true;
    //        }
    //        
    //        private String getMainId(){
    //            return null;
    //        }
    //        
    //        private String getPatientId(){
    //            return null;
    //        }
    //        /*************************************/

    /********* Inherited Methods ************/
    
    @Override
    public Boolean validate(){

        if (!validateStatic()) {
            I18nManager.global(I18nGlobalNotifiers.fields_empty);
            return false;
        }
        
        return true;
    }
    
    @Override
    public Boolean save() {
        
        if (!hasMainId()) {
            I18nManager.global(I18nGlobalNotifiers.no_main_id);
            return false;
        }
        
        if(!validate()){
            return false;
        }

        if (staticId != null && staticId.equals("") == false) {
            updateStatic();
        } else {
            saveStatic();
        }

        return true;
    }

    @Override
    public void update() {
        fillFields();
    }

    @Override
    public HashMap<String, Object> getFieldValues(){
        
        HashMap<String, Object> map = new HashMap<String, Object>();
        
        for (Entry<Object, String> entry: DBMapStatic.entrySet()) {

            map.put(entry.getValue(), ((AbstractField) entry.getKey()).getValue());
            
        }
        
        return map;
    }
    
    @Override
    public Boolean hasRecurrence() {
        // TASK Auto-generated method stub
        return false;
    }

    @Override
    public void setRecurrenceSettings(String Form_ID) {
        // TASK Auto-generated method stub
        
    }

    @Override
    public String getRecurrenceString() {
        // TASK Auto-generated method stub
        return null;
    }

    @Override
    public Date getRecurrenceStart() {
        // TASK Auto-generated method stub
        return null;
    }

    @Override
    public Integer getRecurrenceRepetitions() {
        // TASK Auto-generated method stub
        return null;
    }

    @Override
    public Date getRecurrenceLatestDate() {
        // TASK Auto-generated method stub
        return null;
    }

    @Override
    public Integer getRecurrenceMetaId() {
        // TASK Auto-generated method stub
        return null;
    }
    
    @Override
    public Boolean isNurseRequired() {
        return true;
    }
    
    @Override
    public Boolean hasMultiRecurrence() {
        return false;
    }
    
    @Override
    public HashMap<Integer, RecurrenceDateInformation> getRecurrenceDates(Boolean all) {
        return null;
    }
    
    @Override
    public Pair<Date, Date> getBoundaryDates(Integer delegationId, Date originalDate){
        return null;
    }
    
    @Override
    public void deleteUnaccepted() {
        // TASK Auto-generated method stub
        
    }

    /********* Init-Standard ************/
    private void defaultInit() {
        setDBMaps();
        setupFields();
        fillFields();

        setValidateMaps();

        /**********************/


    }

    /******************* Config TBL *******************/

    private void setupFields() {

        cbx_adm.setFilteringMode(FilteringMode.CONTAINS);
        cbx_csUser.setReadOnly(true);
        cbx_csUser.setEnabled(false);

    }

    private void fillFields() {
        getAdm();
        getCS();
        
        cbx_csUser.setReadOnly(false);
        
        getStatic();
        
        if(cbx_csUser.getValue() == null){
            setAuthedUser();
        }
        
        cbx_csUser.setReadOnly(true);
    }
    
    /************************* --> Main <-- ***********************/
    
    private Integer getAuthedUser(){
        return (Integer) UI.getCurrent().getUI().getSession().getSession().getAttribute("Userid");
    }
    
    private void setAuthedUser(){
        cbx_csUser.setValue(getAuthedUser());
    }
    

    private void SetTableHeaders() {
        //	tbl_analyse.setColumnHeader("Krankenschwesternname", LC.getCaption("Krankenschwesternname"));

    }

    /************************************************/

    private Boolean validateStatic() {

        for (AbstractField field : validateListStatic) {
            if (field.isValid() == false) {
                I18nManager.global(I18nGlobalNotifiers.fields_empty);
                return false;
            }
        }

        return true;
    }

    /********** -> DB Map <- ******************/
    private void setDBMaps() {

        DBMapStatic = new HashMap<Object, String>();
        DBMapStatic.put(cbx_adm, "cust_protokoll_forsteo_meta_static:PFORMS_ID_ADM");
        DBMapStatic.put(cbx_csUser, "cust_protokoll_forsteo_meta_static:PFORMS_ID_CS");

    }

    private void setValidateMaps() {

        validateListStatic = new ArrayList<AbstractField>();
        validateListStatic.add(cbx_adm);

    }

    /********** -> Datenholen <- ******************/
    private void getStatic() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_protokoll_forsteo_meta_static");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();

        String wid = getMainId();
        if (wid == null || wid == "") {
            wid = "0";
        }

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_protokoll_forsteo_meta_static", "PFORMS_VH_ID", "=", wid, "");

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        Form_Bind fb = new Form_Bind();

        if (con.size() > 0) {
            staticId = Integer.toString((Integer) con.getItem(1).getItemProperty("PFORMS_ID").getValue());
            fb.Get_and_Fill(con, DBMapStatic);
        }

    }

    private void getAdm() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("SAD_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(IFNULL(CONCAT(ASA_NAME, ' '),''),SAD_NAME,' ',SAD_VORNAME)", "name");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_stammdaten_aussendienst", "LEFT JOIN", "cms_auth_stammdaten_anrede", "SAD_ID_ANREDE",
                "ASA_ID");

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_stammdaten_aussendienst", "SAD_ID_PROJEKT", "=", projectId, "");

        try {
            combo nc = new combo(db.DB_Data_Get.DB_SEND_AND_GET_Container(), cbx_adm, "SAD_ID", "name");
        } catch (Exception e) {
            cbx_adm.removeAllItems();
        }
    }

    private void getCS() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("DISTINCT(AUL_ID)");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(ASA_NAME,' ',AUL_NAME,' ',AUL_VORNAME)",
                "name");
        
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_liste_gu", "INNER JOIN", "cms_auth_stammdaten_user", "AL_U_ID", "AUL_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cms_auth_stammdaten_anrede", "AUL_ANREDE_ID", "ASA_ID");
        
//        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_liste_gu", "AL_G_ID", "=", "14", "");
        // don't filter to be compatible with non-14 users (admin)
        
//        db.DB_Data_Get.DB_DEBUG_SQL_STRING();
        
        try {
            combo nc = new combo(db.DB_Data_Get.DB_SEND_AND_GET_Container(), cbx_csUser, "AUL_ID", "name");
        } catch (Exception e) {
            cbx_csUser.removeAllItems();
        }
        
    }

    /* *********************************** */

    private Integer saveStatic() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_protokoll_forsteo_meta_static");

        Form_Bind fb = new Form_Bind();
        fb.Insert(db, DBMapStatic);

        db.DB_Data_Insert.DB_Daten.DB_Data("cust_protokoll_forsteo_meta_static", "PFORMS_VH_ID", getMainId());

        //db.DB_Data_Insert.DB_DEBUG_SQL_STRING();
        return db.DB_Data_Insert.DB_Insert();

    }

    private void updateStatic() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();
        DBClass db = new DBClass();
        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_protokoll_forsteo_meta_static");

        Form_Bind fb = new Form_Bind();
        fb.Update(db, DBMapStatic);

        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein("cust_protokoll_forsteo_meta_static", "PFORMS_ID", "=", staticId, "");

        db.DB_Data_Update.DB_Update();

    }

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("-1px");
        mainLayout.setMargin(false);
        mainLayout.setSpacing(true);

        // top-level component properties
        setWidth("100.0%");
        setHeight("-1px");

        // pan_project
        pan_project = buildPan_project();
        mainLayout.addComponent(pan_project);

        return mainLayout;
    }

    @AutoGenerated
    private Panel buildPan_project() {
        // common part: create layout
        pan_project = new Panel();
        pan_project.setCaption("Projektinformationen");
        pan_project.setImmediate(false);
        pan_project.setWidth("100.0%");
        pan_project.setHeight("200px");

        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        pan_project.setContent(verticalLayout_2);

        return pan_project;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);

                // cbx_adm
        cbx_adm = new ComboBox();
        cbx_adm.setCaption("Außendienstmitarbeiter");
        cbx_adm.setImmediate(false);
        cbx_adm.setWidth("200px");
        cbx_adm.setHeight("-1px");
        verticalLayout_2.addComponent(cbx_adm);
        verticalLayout_2.setComponentAlignment(cbx_adm, new Alignment(48));

        // cbx_cs_user
        cbx_csUser = new ComboBox();
        cbx_csUser.setCaption("CS Kontakt");
        cbx_csUser.setImmediate(false);
        cbx_csUser.setWidth("200px");
        cbx_csUser.setHeight("-1px");
        verticalLayout_2.addComponent(cbx_csUser);
        verticalLayout_2.setComponentAlignment(cbx_csUser, new Alignment(48));

        return verticalLayout_2;
    }

}
