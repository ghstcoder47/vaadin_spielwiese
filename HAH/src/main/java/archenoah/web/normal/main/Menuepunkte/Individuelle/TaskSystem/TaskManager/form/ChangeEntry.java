package archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.form;

import java.sql.Timestamp;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Locale;

import org.joda.time.Days;
import org.joda.time.Hours;
import org.joda.time.LocalDateTime;
import org.joda.time.Minutes;

import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.main.Menuepunkte.Individuelle.TaskSystem.TaskManager.form.FieldChangeEntries.ValueContainerCollection;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.RichTextArea;
import com.vaadin.ui.VerticalLayout;

public class ChangeEntry extends CustomComponent {
	
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */



	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private VerticalLayout layoutContent;
	@AutoGenerated
	private HorizontalLayout layoutButtons;
	@AutoGenerated
	private Button buttonCommentCancel;
	@AutoGenerated
	private Button buttonCommentSave;
	@AutoGenerated
	private HorizontalLayout layoutCommentDivider;
	@AutoGenerated
	private VerticalLayout commentBoxWrapper;
	@AutoGenerated
	private RichTextArea textareaComment;
	@AutoGenerated
	private VerticalLayout layoutChangeSetWrapper;
	@AutoGenerated
	private HorizontalLayout layoutTopBar;
	@AutoGenerated
	private Button buttonEditComment;
	@AutoGenerated
	private HorizontalLayout layoutChangedInfo;
	@AutoGenerated
	private Label labelName;
	@AutoGenerated
	private Label labelBy;
	@AutoGenerated
	private Label labelDate;
	@AutoGenerated
	private Label labelChanged;
	private I18nManager LC;
	private ValueContainerCollection collection;
	private Boolean isEditable = false;
	
	private HashMap<String, Object> oldMap;
	private HashMap<String, Object> newMap;
	
	/*
	 * Constructor
	 */
	
	public ChangeEntry(I18nManager LC, ValueContainerCollection collection) {
		
		this.LC = LC;
		this.collection = collection;

		
		buildMainLayout();
//		addFieldChange();
		
		configureComponents();
		configureEditable();
		setCompositionRoot(mainLayout);
		
	}
	
	public ChangeEntry(I18nManager LC, ValueContainerCollection collection, Item oldValues, Item newValues){
		this(LC, collection);
		generateFieldChanges(oldValues, newValues);
		setGeneralValues(oldValues, newValues);
	}
	
	/*
	 * Public
	 */
	
	public void setEditable(Boolean editable){
		isEditable = editable;
		layoutChangedInfo.setVisible(!editable);
		textareaComment.setReadOnly(!editable);
		configureEditable();
	}
	
	public void setFieldChanges(FieldChangeEntries fieldChangeEntry){
		layoutChangeSetWrapper.removeAllComponents();
		layoutChangeSetWrapper.addComponent(fieldChangeEntry);
		mainLayout.setHeight(null);
	}
	
	public RichTextArea getCommentComponent(){
		return textareaComment;
	}
	
	/*
	 * Logik 
	 */
	
	private void setGeneralValues(Item oldValues, Item newValues){
		
		// User
		if(newValues.getItemPropertyIds().contains("TMT_ID_USER_CREATOR")){
			labelName.setValue((String) collection.getValueFromContainer("TMT_ID_USER_CREATOR", newValues.getItemProperty("TMT_ID_USER_CREATOR").getValue()));
		}
		
		
		// Date
		if(newValues.getItemPropertyIds().contains("TMT_CREATED")){
			java.sql.Timestamp ts = (Timestamp) newValues.getItemProperty("TMT_CREATED").getValue();
	    	
			StringSqlTimestampConverter time = new StringSqlTimestampConverter();
			time.setDateFormat(DateFormat.SHORT);
			time.setTimeFormat(DateFormat.SHORT);
			
			String date = time.convertToPresentation(ts, String.class, new Locale("DE"));
	    	
			LocalDateTime then = new LocalDateTime(ts.getTime());
			LocalDateTime now = new LocalDateTime();
			
			ArrayList<Integer> durations = new ArrayList<Integer>();
			ArrayList<String> tokens = new ArrayList<String>(
				    Arrays.asList("date_day", "date_hour", "date_minute"));
			
			
			durations.add(Days.daysBetween(then, now).getDays());
			durations.add(Hours.hoursBetween(then, now).getHours());
			durations.add(Minutes.minutesBetween(then, now).getMinutes());
			
			

			Integer res = null;
			Integer i = 1;
			String app = "";
			
			for (Integer dur : durations) {
				if(dur > 0){
					res = dur;
					break;
				}
				i++;
			}
					
			if(res != null && (i == 1 ? (res <= 3) : true)){
				String t = tokens.get(i-1);
				t += res > 1 ? "_mult" : "";
				app += " ("+ LC.get("token_before") + " " + res + " " + LC.get(t) + ")";
			}
			
			
	    	labelDate.setValue(date + app + " ");
		}
		// Comment
		if(newValues.getItemPropertyIds().contains("TMT_COMMENT")){
		
			String comment = (String) newValues.getItemProperty("TMT_COMMENT").getValue();
			
			if(comment != null){
				configureEditable(true);
				textareaComment.setValue(comment);
				configureEditable(isEditable);
			}
		
		}
		
	}
	
	private void generateFieldChanges(Item oldValues, Item newValues){
		
		oldMap = new HashMap<>();
    	newMap = new HashMap<>();
    	
    	oldMap = generateMap(oldValues);
    	newMap = generateMap(newValues);
		
		FieldChangeEntries fce = new FieldChangeEntries(LC, collection, oldMap, newMap);
		setFieldChanges(fce);
		
	}
	private HashMap<String, Object> generateMap(Item item){
		
		HashMap<String, Object> map = new HashMap<>();
		
    	for (Object id : item.getItemPropertyIds()) {
			
//    		if(item.getItemProperty(id).getValue() != null){
    			map.put((String) id, item.getItemProperty(id).getValue()); 
//    		}
    		
		}
    	
    	return map;
	}
	
	
	private void configureComponents(){
		
		layoutTopBar.setStyleName("cust_margin_half_full_none_full top-bar");
		layoutContent.setStyleName("cust_margin_half_full_none_full");
		
		textareaComment.setHeight(null);
		textareaComment.setReadOnly(true);
		
		buttonEditComment.setEnabled(false);
		buttonEditComment.setVisible(false);
		
		buttonCommentSave.setEnabled(false);
		buttonCommentSave.setVisible(false);
		
		buttonCommentCancel.setEnabled(false);
		buttonCommentCancel.setVisible(false);
		
		layoutButtons.setVisible(false);
	}
	
	private void configureEditable(){
		configureEditable(isEditable);
	}
	
	private void configureEditable(Boolean editable){
		textareaComment.setReadOnly(!editable);
		textareaComment.setHeight(editable ? "170px" : null);
		
		Float changeRatio = editable ? 2.0f : 3.0f;
		Float commentRatio = editable ? 3.0f : 2.0f;
		
		layoutCommentDivider.setExpandRatio(layoutChangeSetWrapper, changeRatio);
		layoutCommentDivider.setExpandRatio(commentBoxWrapper, commentRatio);
		
		
		
	}
	
	/*
	 * AutoGenerated Layout
	 */
	
    @AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// layoutTopBar
		layoutTopBar = buildLayoutTopBar();
		mainLayout.addComponent(layoutTopBar);
		
		// layoutContent
		layoutContent = buildLayoutContent();
		mainLayout.addComponent(layoutContent);
		mainLayout.setExpandRatio(layoutContent, 1.0f);
		
		return mainLayout;
	}

	@AutoGenerated
	private HorizontalLayout buildLayoutTopBar() {
		// common part: create layout
		layoutTopBar = new HorizontalLayout();
		layoutTopBar.setImmediate(false);
		layoutTopBar.setWidth("100.0%");
		layoutTopBar.setHeight("-1px");
		layoutTopBar.setMargin(true);
		
		// layoutChangedInfo
		layoutChangedInfo = buildLayoutChangedInfo();
		layoutTopBar.addComponent(layoutChangedInfo);
		
		// buttonEditComment
		buttonEditComment = new Button();
		buttonEditComment.setCaption("Bearbeiten");
		buttonEditComment.setImmediate(true);
		buttonEditComment.setWidth("-1px");
		buttonEditComment.setHeight("-1px");
		layoutTopBar.addComponent(buttonEditComment);
		layoutTopBar.setComponentAlignment(buttonEditComment, new Alignment(6));
		
		return layoutTopBar;
	}

	@AutoGenerated
	private HorizontalLayout buildLayoutChangedInfo() {
		// common part: create layout
		layoutChangedInfo = new HorizontalLayout();
		layoutChangedInfo.setImmediate(false);
		layoutChangedInfo.setWidth("-1px");
		layoutChangedInfo.setHeight("-1px");
		layoutChangedInfo.setMargin(false);
		layoutChangedInfo.setSpacing(true);
		
		// labelChanged
		labelChanged = new Label();
		labelChanged.setImmediate(false);
		labelChanged.setWidth("100.0%");
		labelChanged.setHeight("-1px");
		labelChanged.setValue("Ge√§ndert am");
		layoutChangedInfo.addComponent(labelChanged);
		
		// labelDate
		labelDate = new Label();
		labelDate.setImmediate(false);
		labelDate.setWidth("-1px");
		labelDate.setHeight("-1px");
		labelDate.setValue("vor N Tagen");
		layoutChangedInfo.addComponent(labelDate);
		
		// labelBy
		labelBy = new Label();
		labelBy.setImmediate(false);
		labelBy.setWidth("-1px");
		labelBy.setHeight("-1px");
		labelBy.setValue("durch");
		layoutChangedInfo.addComponent(labelBy);
		
		// labelName
		labelName = new Label();
		labelName.setImmediate(false);
		labelName.setWidth("-1px");
		labelName.setHeight("-1px");
		labelName.setValue("USERNAME");
		layoutChangedInfo.addComponent(labelName);
		
		return layoutChangedInfo;
	}

	@AutoGenerated
	private VerticalLayout buildLayoutContent() {
		// common part: create layout
		layoutContent = new VerticalLayout();
		layoutContent.setImmediate(false);
		layoutContent.setWidth("100.0%");
		layoutContent.setHeight("100.0%");
		layoutContent.setMargin(true);
		layoutContent.setSpacing(true);
		
		// layoutCommentDivider
		layoutCommentDivider = buildLayoutCommentDivider();
		layoutContent.addComponent(layoutCommentDivider);
		
		// layoutButtons
		layoutButtons = buildLayoutButtons();
		layoutContent.addComponent(layoutButtons);
		
		return layoutContent;
	}

	@AutoGenerated
	private HorizontalLayout buildLayoutCommentDivider() {
		// common part: create layout
		layoutCommentDivider = new HorizontalLayout();
		layoutCommentDivider.setImmediate(false);
		layoutCommentDivider.setWidth("100.0%");
		layoutCommentDivider.setHeight("100.0%");
		layoutCommentDivider.setMargin(false);
		
		// layoutChangeSetWrapper
		layoutChangeSetWrapper = new VerticalLayout();
		layoutChangeSetWrapper.setImmediate(false);
		layoutChangeSetWrapper.setWidth("100.0%");
		layoutChangeSetWrapper.setHeight("-1px");
		layoutChangeSetWrapper.setMargin(false);
		layoutCommentDivider.addComponent(layoutChangeSetWrapper);
		layoutCommentDivider.setExpandRatio(layoutChangeSetWrapper, 2.0f);
		
		// commentBoxWrapper
		commentBoxWrapper = buildCommentBoxWrapper();
		layoutCommentDivider.addComponent(commentBoxWrapper);
		layoutCommentDivider.setExpandRatio(commentBoxWrapper, 3.0f);
		
		return layoutCommentDivider;
	}

	@AutoGenerated
	private VerticalLayout buildCommentBoxWrapper() {
		// common part: create layout
		commentBoxWrapper = new VerticalLayout();
		commentBoxWrapper.setImmediate(false);
		commentBoxWrapper.setWidth("100.0%");
		commentBoxWrapper.setHeight("100.0%");
		commentBoxWrapper.setMargin(false);
		
		// textareaComment
		textareaComment = new RichTextArea();
		textareaComment.setImmediate(false);
		textareaComment.setWidth("100.0%");
		textareaComment.setHeight("100.0%");
		commentBoxWrapper.addComponent(textareaComment);
		
		return commentBoxWrapper;
	}

	@AutoGenerated
	private HorizontalLayout buildLayoutButtons() {
		// common part: create layout
		layoutButtons = new HorizontalLayout();
		layoutButtons.setImmediate(false);
		layoutButtons.setWidth("-1px");
		layoutButtons.setHeight("-1px");
		layoutButtons.setMargin(false);
		layoutButtons.setSpacing(true);
		
		// buttonCommentSave
		buttonCommentSave = new Button();
		buttonCommentSave.setCaption("Speichern");
		buttonCommentSave.setImmediate(true);
		buttonCommentSave.setWidth("-1px");
		buttonCommentSave.setHeight("-1px");
		layoutButtons.addComponent(buttonCommentSave);
		
		// buttonCommentCancel
		buttonCommentCancel = new Button();
		buttonCommentCancel.setCaption("Abbrechen");
		buttonCommentCancel.setImmediate(true);
		buttonCommentCancel.setWidth("-1px");
		buttonCommentCancel.setHeight("-1px");
		layoutButtons.addComponent(buttonCommentCancel);
		
		return layoutButtons;
	}

}
