package archenoah.web.normal.main.Menuepunkte.Standard.Benutzereinstellungen.Passwortänderung;

import java.io.UnsupportedEncodingException;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;
import java.util.Map;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.encryption.sha1.Crypt_SHA1;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.valchecker.val_checker;
import archenoah.web.normal.Login.Validate.Custom_Benutzerform_psw_ändern;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.event.ShortcutAction.KeyCode;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.Button.ClickShortcut;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.PasswordField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class frm_passwortedit extends CustomComponent {

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private Button btn_save;
	@AutoGenerated
	private PasswordField txt_pass2;
	@AutoGenerated
	private PasswordField txt_pass1;
	
	private Window Passwort_Ändern;
	
	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	

	

	

	

	

	
	private MenuItem selectedItem;
	
	public Map<Object, String> Val_Map;
    private I18nManager i18n;
	

	/**
	 * The constructor should first build the main layout, set the
	 * composition root and then do any custom initialization.
	 *
	 * The constructor will not be automatically regenerated by the
	 * visual editor.
	 */
	public frm_passwortedit(MenuItem Arg_selectedItem) {
		buildMainLayout();
		i18n = new I18nManager(this);
		selectedItem = Arg_selectedItem;

		Aufbau_Window();
		VAL_Map_Fill();
		Event_Forms();
		
		// migrated from database
		txt_pass1.setRequired(true);
		txt_pass2.setRequired(true);
		// migration end
		
		// TODO add user code here
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("320px");
		mainLayout.setHeight("220px");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("320px");
		setHeight("220px");
		
		// txt_pass1
		txt_pass1 = new PasswordField();
		txt_pass1.setCaption("Geben Sie ein Paaswort ein:");
		txt_pass1.setImmediate(false);
		txt_pass1.setWidth("50.0%");
		txt_pass1.setHeight("-1px");
		txt_pass1.setTabIndex(20);
		mainLayout.addComponent(txt_pass1);
		mainLayout.setComponentAlignment(txt_pass1, new Alignment(48));
		
		// txt_pass2
		txt_pass2 = new PasswordField();
		txt_pass2.setCaption("Passwort Wiederholen");
		txt_pass2.setImmediate(false);
		txt_pass2.setWidth("50.0%");
		txt_pass2.setHeight("-1px");
		txt_pass2.setTabIndex(21);
		mainLayout.addComponent(txt_pass2);
		mainLayout.setComponentAlignment(txt_pass2, new Alignment(48));
		
		// btn_save
		btn_save = new Button();
		btn_save.setCaption("Passwort Ändern");
		btn_save.setImmediate(true);
		btn_save.setWidth("50.0%");
		btn_save.setHeight("-1px");
		btn_save.setTabIndex(22);
		mainLayout.addComponent(btn_save);
		mainLayout.setComponentAlignment(btn_save, new Alignment(48));
		
		return mainLayout;
	}
	
	
	
	//************Window******************/
	private void Aufbau_Window()
	{
		Passwort_Ändern = new Window(selectedItem.getText());
		Passwort_Ändern.setIcon(selectedItem.getIcon());
		Passwort_Ändern.setModal(true);
		Passwort_Ändern.setResizable(false);
		Passwort_Ändern.setContent(mainLayout);
		Passwort_Ändern.center();
		Passwort_Ändern.setDraggable(false);
		Passwort_Ändern.setClosable(true);
		Passwort_Ändern.setHeight("300px");
		Passwort_Ändern.setWidth("330px");	
		UI.getCurrent().addWindow(Passwort_Ändern);
		
		Passwort_Ändern.addAction(new ClickShortcut(btn_save, KeyCode.ENTER));
		txt_pass1.focus();
		
	}
	
	
	private void VAL_Map_Fill()
	{
		Val_Map = new HashMap<>(); 
		Val_Map.put(txt_pass1,"Passwort");
		Val_Map.put(txt_pass2,"Passwort2");
		
		txt_pass1.addValidator(new Custom_Benutzerform_psw_ändern(txt_pass1, txt_pass2));
		txt_pass2.addValidator(new Custom_Benutzerform_psw_ändern(txt_pass1, txt_pass2));
		
		
	//	Isconet_Validators_1_Test isv = new Isconet_Validators_1_Test( "2", Val_Map);
	}
	
	
	
	private void Event_Forms()
	{
		
    btn_save.addClickListener(new ClickListener() {
			
			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Automatisch generierter Methodenstub
				
				val_checker val = new val_checker(Val_Map);
				
				if(val.Is_Valid() == false)
				{
					
					I18nManager.global(I18nGlobalNotifiers.fields_empty);
					
					return;
				}
				
				PSW_ändern();
				
				
				UI.getCurrent().getUI().removeWindow(Passwort_Ändern);
				
				
			//	Constructor con = new Constructor();
				
				
				
			}
		});
		
	}
	
	
	private void PSW_ändern()
	{
		String tmp = null;
		String Username = (String) UI.getCurrent().getUI().getSession().getSession().getAttribute("Username");
		

		try
	    {
			tmp = Crypt_SHA1.SHA512(Username+txt_pass1.getValue()+"6545465258552455554424");
	   
	     
	    }
	    catch (NoSuchAlgorithmException ex)
	    {
	        System.out.println(ex.getMessage());
	    }
	    catch (UnsupportedEncodingException ex)
	    {
	        System.out.println(ex.getMessage());
	    }	
		
		String UID = UI.getCurrent().getUI().getSession().getSession().getAttribute("Userid").toString();
		
		CMS_Config_Std std = CMS_Config_Std.getInstance();
		DBClass db = new DBClass();
		db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_stammdaten_user");
		db.DB_Data_Update.DB_Daten.DB_Data("cms_auth_stammdaten_user", "AUL_PASSWORT", tmp);
		db.DB_Data_Update.DB_Daten.DB_Data("cms_auth_stammdaten_user", "AUL_PASS_RESET", "0");
		db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_ID", "=", UID, "");
		db.DB_Data_Update.DB_Update();
		
	}
	

}
