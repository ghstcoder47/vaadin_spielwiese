package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Locale;
import java.util.concurrent.TimeUnit;

import archenoah.config.MapsConfig;
import archenoah.lib.custom.AddressHolder;
import archenoah.lib.custom.AddressHolder.AddressEntry;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.tool.comunication.dbclass.GeoPoolSingleton;
import archenoah.lib.tool.comunication.dbclass.RefreshableConnectionPool;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.UserInfo.UserData;

import com.google.maps.DistanceMatrixApiRequest;
import com.google.maps.GeoApiContext;
import com.google.maps.PendingResult;
import com.google.maps.PendingResult.Callback;
import com.google.maps.model.Distance;
import com.google.maps.model.DistanceMatrix;
import com.google.maps.model.DistanceMatrixElement;
import com.google.maps.model.DistanceMatrixRow;
import com.google.maps.model.Duration;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.data.util.converter.Converter;
import com.vaadin.event.FieldEvents.FocusEvent;
import com.vaadin.event.FieldEvents.FocusListener;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.tapio.googlemaps.GoogleMap;
import com.vaadin.tapio.googlemaps.client.LatLon;
import com.vaadin.tapio.googlemaps.client.events.MarkerClickListener;
import com.vaadin.tapio.googlemaps.client.overlays.GoogleMapInfoWindow;
import com.vaadin.tapio.googlemaps.client.overlays.GoogleMapMarker;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class form_zuweisung_analyse extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout vtl_map;
    @AutoGenerated
    private Table tbl_analyse;
    @AutoGenerated
    private VerticalLayout verticalLayout_2;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private Button btn_uebernehmen;
    @AutoGenerated
    private Button btn_refresh;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_2;
    @AutoGenerated
    private IntStepper range;
    @AutoGenerated
    private TextField city;
    @AutoGenerated
    private TextField plz;
    @AutoGenerated
    private ComboBox patient;
    @AutoGenerated
    private ComboBox project;
    /**************** --> Allgemein <--- ********************/
    private static org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(form_zuweisung_analyse.class);
    
    // Allgemein
    private MapsConfig mpc;

    // Datenbank
    private Integer patientId = null;
    private Integer projectId = null;

    // Berrechtigung

    private String caption = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    final String imgPat = "VAADIN/themes/" + UI.getCurrent().getTheme() + "/image-res/mapmarkers/mapmarker-patient.png";
    final String imgNrs = "VAADIN/themes/" + UI.getCurrent().getTheme() + "/image-res/mapmarkers/mapmarker-nurse.png";
    
    private GoogleMap googleMap;
    private GeoApiContext geoApi;
    private DistanceMatrixApiRequest distMatrix;
    private String proximList = "";
    
    private AddressEntry patAddress;
    private AddressEntry custAddress;
    private GoogleMapMarker patMarker;
    private final GoogleMapInfoWindow markerInfoWindow = new GoogleMapInfoWindow();
    private final HashMap<GoogleMapMarker, String> markerInfoMap = new HashMap<GoogleMapMarker, String>();
    private AddressHolder nurseAddresses;
    private final HashSet<GoogleMapMarker> nurseMarkers = new HashSet<GoogleMapMarker>();

    private RefreshableConnectionPool geoPool = GeoPoolSingleton.INSTANCE.getPool();

    /************ ----->Einstellungen<-- ********************/
    // private final String LNG_FRM_ID = "22";

    private final String Windows_Height = "640px";
    private final String Windows_Width = "720px";
    /******************************************************/

    private ComboBox nurseCombo;

    private I18nManager i18n;

    public form_zuweisung_analyse(Button btn) {
        if(btn != null) {
            caption = btn.getCaption();
        }
    }
    
    public form_zuweisung_analyse(MenuItem item) {
        if(item != null) {
            caption = item.getText();
        }
    }

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        if (caption != null) {

            Build_Window_Button bwb = new Build_Window_Button(caption, mainLayout, Windows_Height, Windows_Width, null);
            win = bwb.ReturnWindow();
        }

    }
    
    
    
    public void setNurseCombo(ComboBox nurseCombo) {
        this.nurseCombo = nurseCombo;
        btn_uebernehmen.setVisible((nurseCombo != null));
    }

    public void setPatientId(Integer patientId) {
        this.patientId = patientId;
    }

    public void setProjectId(Integer projectId) {
        this.projectId = projectId;
    }

    public void fill(Integer projectId, Integer patientId) {
        setProjectId(projectId);
        setPatientId(patientId);
        
        project.setVisible(false);
        patient.setVisible(false);
        plz.setVisible(false);
        city.setVisible(false);
        
        setPatMarker();
        refreshNurses();
    }
    
    public void unset() {
        setProjectId(null);
        setPatientId(null);
        
        project.setVisible(canSeePatients());
        patient.setVisible(canSeePatients());
        plz.setVisible(true);
        city.setVisible(true);
    }
    
    /********* Init-Standard ************/
    private void Standard_Init() {

        buildMainLayout();
        i18n = new I18nManager(this);
        
        mpc = new MapsConfig();

        configureComponents();
        configureTable();

        i18n.refresh();

    }

    private void refreshNurses() {

        if(patAddress == null && custAddress == null) {
            proximList = "";
            return;
        }
        
        AddressEntry address = patAddress != null ? patAddress : custAddress;
        if(address == null) {
            return;
        }
        
        getProximFromList(address.getPostalCode(), Integer.valueOf(range.getValue()), 100);
        Datenholen();

        if (tbl_analyse.size() == 0) {
            return;
        }
        configureTable();
        buildNurseAdresses();
        setNurseMarkers();
        requestDistanceInfo();

    }
    
    private void configureComponents() {
        
        initMap();
        initGeo();
        initInfoWindow();
        
        range.setMinValue(1);
        range.setValue(100);
        
        btn_uebernehmen.setVisible(false);
        
        project.setVisible(canSeePatients());
        project.setItemCaptionPropertyId("PSLV_NAME");
        project.setImmediate(true);
        project.setContainerDataSource(dbGetProjects());
        project.setFilteringMode(FilteringMode.CONTAINS);
        project.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                log.info("project: {}", project.getValue());
                patient.setContainerDataSource(dbGetPatients());
            }
        });
        
        patient.setVisible(canSeePatients());
        patient.setItemCaptionPropertyId("patient");
        patient.setImmediate(true);
        patient.setFilteringMode(FilteringMode.CONTAINS);
        patient.addFocusListener(new FocusListener() {

            @Override
            public void focus(FocusEvent event) {
                if(patient.getContainerDataSource() == null || patient.getContainerDataSource().size() == 0) {
                    patient.setContainerDataSource(dbGetPatients());
                }
            }
        });
        patient.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                log.info("patient: {}", patient.getValue());
                setPatMarker();
                nurseAddresses = null; // needs some restructuring
                setNurseMarkers();
                tbl_analyse.setContainerDataSource(null);
                
                if(patAddress != null) {
                    plz.setValue(patAddress.getPostalCode());
                    city.setValue(patAddress.getCity());
                }else {
                    plz.setValue(null);
                    city.setValue(null);
                }
                
                
            }
        });
        
        ValueChangeListener customListener = new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                if(patAddress != null) {
                    return;
                }
                
                setPatMarker();
                nurseAddresses = null; // needs some restructuring
                setNurseMarkers();
                tbl_analyse.setContainerDataSource(null);
                
            }
        };
        
        FocusListener focusListener = new FocusListener() {
            
            @Override
            public void focus(FocusEvent event) {
                
                patient.setValue(null);
                
            }
        };
        
        plz.addValueChangeListener(customListener);
        city.addValueChangeListener(customListener);
        
        plz.addFocusListener(focusListener);
        city.addFocusListener(focusListener);
        
        plz.setImmediate(true);
        plz.setNullRepresentation("");
        city.setImmediate(true);
        city.setNullRepresentation("");
        
        btn_uebernehmen.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                Object rowId = tbl_analyse.getValue(); // get the selected rows
                // id

                if (rowId == null) {

                    I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                    return;
                }
                final int ID = (int) tbl_analyse.getContainerProperty(rowId, "KSK_ID").getValue();
                if (!nurseCombo.isReadOnly()) {
                    nurseCombo.setValue(ID);
                }
                UI.getCurrent().removeWindow(win);
            }
        });

        btn_refresh.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                if (range.isValid()) {
                    refreshNurses();
                } else {
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                }
            }
        });
        
    }
    
    private void configureTable() {
        tbl_analyse.setSelectable(true);
        tbl_analyse.setImmediate(true);

        tbl_analyse.setColumnCollapsingAllowed(false);

        Converter<String, Long> StringLongConverterKM = new Converter<String, Long>() {

            @Override
            public Long convertToModel(String value, Class<? extends Long> targetType, Locale locale)
                throws com.vaadin.data.util.converter.Converter.ConversionException {
                return Long.parseLong(value);
            }

            @Override
            public String convertToPresentation(Long value, Class<? extends String> targetType, Locale locale)
                throws com.vaadin.data.util.converter.Converter.ConversionException {

                String displayValue = "";

                if (value != 0) {
                    Double km = value.doubleValue();
                    km = km / 1000;

                    displayValue = String.format("%1$,.0f", km);
                }

                return displayValue;
            }

            @Override
            public Class<Long> getModelType() {
                return Long.class;
            }

            @Override
            public Class<String> getPresentationType() {
                return String.class;
            }

        };

        Converter<String, Long> StringLongConverterHRS = new Converter<String, Long>() {

            @Override
            public Long convertToModel(String value, Class<? extends Long> targetType, Locale locale)
                throws com.vaadin.data.util.converter.Converter.ConversionException {
                return Long.parseLong(value);
            }

            @Override
            public String convertToPresentation(Long value, Class<? extends String> targetType, Locale locale)
                throws com.vaadin.data.util.converter.Converter.ConversionException {

                String displayValue = "";

                if (value != 0) {

                    long t = value / 60;
                    long hours = t / 60;
                    long minutes = t % 60;
                    String formattedDate = String.format("%d:%02d", hours, minutes);

                    displayValue = formattedDate;
                }

                return displayValue;
            }

            @Override
            public Class<Long> getModelType() {
                return Long.class;
            }

            @Override
            public Class<String> getPresentationType() {
                return String.class;
            }

        };

        if (!tbl_analyse.getContainerPropertyIds().isEmpty()) {
            tbl_analyse.setConverter("Fahrtweg", StringLongConverterKM);
            tbl_analyse.setConverter("Fahrtzeit", StringLongConverterHRS);
        }

    }

    /************************************************/

    private void initMap() {

        googleMap = new GoogleMap(mpc.getEntry("ApiKey", "apiKey"), null, null);
        googleMap.setCenter(new LatLon(51.1633, 10.4475));

        // googleMap.setCenter(new LatLon(49.488889, 8.469167));
        googleMap.setZoom(4);
        googleMap.setSizeFull();

        // googleMap.addMarker("NOT DRAGGABLE: Mannheim", new LatLon(49.488889,
        // 8.469167), false, null);

        googleMap.setMinZoom(4);
        googleMap.setMaxZoom(16);

        vtl_map.addComponent(googleMap);
        vtl_map.setExpandRatio(googleMap, 1.0f);
    }

    private void initGeo() {
        geoApi = new GeoApiContext();

        if (mpc.useEntry("ApiKey")) {
            geoApi.setApiKey(mpc.getEntry("ApiKey", "apiKey"));
        }

        if (mpc.useEntry("EnterpriseCredentials")) {
            geoApi.setEnterpriseCredentials(mpc.getEntry("EnterpriseCredentials", "clientId"), mpc.getEntry("EnterpriseCredentials", "cryptographicSecret"));
        }

        if (mpc.useEntry("QueryRateLimit")) {
            geoApi.setQueryRateLimit(Integer.parseInt(mpc.getEntry("QueryRateLimit", "maxQps")),
                Integer.parseInt(mpc.getEntry("QueryRateLimit", "minimumInterval")));
        }

        if (mpc.useEntry("ConnectTimeout")) {
            geoApi.setConnectTimeout(Long.parseLong(mpc.getEntry("ConnectTimeout", "timeout")), TimeUnit.SECONDS);
        }

        if (mpc.useEntry("ReadTimeout")) {
            geoApi.setReadTimeout(Long.parseLong(mpc.getEntry("ReadTimeout", "timeout")), TimeUnit.SECONDS);
        }

        if (mpc.useEntry("RetryTimeout")) {
            geoApi.setRetryTimeout(Long.parseLong(mpc.getEntry("RetryTimeout", "timeout")), TimeUnit.SECONDS);
        }

        if (mpc.useEntry("WriteTimeout")) {
            geoApi.setWriteTimeout(Long.parseLong(mpc.getEntry("WriteTimeout", "timeout")), TimeUnit.SECONDS);
        }

    }

    private void buildNurseAdresses() {
        Container fnc = tbl_analyse.getContainerDataSource();
        AddressHolder adh = new AddressHolder();

        for (Object itemId : fnc.getItemIds()) {
            // System.out.println(fnc.getItem(itemId));

            AddressEntry nurse = adh.newAddress((String) fnc.getItem(itemId).getItemProperty("Krankenschwesternname").getValue());
            nurse.setCountryCode((String) fnc.getItem(itemId).getItemProperty("KSK_COUNTRYCODE").getValue());
            nurse.setStreet((String) fnc.getItem(itemId).getItemProperty("Strasse").getValue());
            nurse.setPostalCode((String) fnc.getItem(itemId).getItemProperty("PLZ").getValue());
            nurse.setCity((String) fnc.getItem(itemId).getItemProperty("Ort").getValue());

            // HashMap<String, Double> nursePoint =
            // getLatLonSingle(nurse.getPostalCode());

            // System.out.println(nurse.getCountryCode() + " " +
            // nurse.getPostalCode() + " " + nursePoint.get("lat"));

            // nurse.setLatLon(nursePoint);

            adh.add(nurse);

        }

        HashMap<String, Double[]> postalcodes = getLatLonList(adh);

        for (int i = 0; i < adh.getLength(); i++) {
            AddressEntry ae = adh.get(i);
            try {
                ae.setLatLon(postalcodes.get(ae.getPostalCode())[0], postalcodes.get(ae.getPostalCode())[1]);
                nurseAddresses = adh;
            } catch (Exception e) {

            }

        }

    }

    private void initInfoWindow() {
        MarkerClickListener click = new MarkerClickListener() {
            @Override
            public void markerClicked(GoogleMapMarker clickedMarker) {

                if (markerInfoMap.get(clickedMarker) != null) {
                    markerInfoWindow.setAnchorMarker(clickedMarker);
                    markerInfoWindow.setContent(markerInfoMap.get(clickedMarker));
                    googleMap.openInfoWindow(markerInfoWindow);
                }
            }
        };
        googleMap.addMarkerClickListener(click);
    }
    
    private boolean canSeePatients() {
        
        return UserData.get().hasGroup(1)
            || UserData.get().getNurse().isNurse()
            || UserData.get().getCS().isCS();

    }
    
    private void setPatMarker() {
        
        patAddress = null;
        custAddress = null;
        
        if(patMarker != null) {
            googleMap.removeMarker(patMarker); 
        }
        
        
        if(!dbGetPatientAddress() && !getCustomAddress()) {
            return;
        }
        
        AddressEntry address = patAddress != null ? patAddress : custAddress;
        if(address == null) {
            return;
        }

        googleMap.setCenter(new LatLon(address.getLat(), address.getLon()));
        googleMap.setZoom(10);

        
        patMarker = new GoogleMapMarker("Ziel", new LatLon(address.getLat(), address.getLon()), false, imgPat);

        markerInfoMap.put(patMarker, address.generateCaption());

        googleMap.addMarker(patMarker);

    }

    private void setNurseMarkers() {


        for (GoogleMapMarker marker : nurseMarkers) {
            googleMap.removeMarker(marker);
        }
        
        if (nurseAddresses == null) {
            return;
        }

        for (int i = 0; i < nurseAddresses.getLength(); i++) {
            AddressEntry entry = nurseAddresses.get(i);

            GoogleMapMarker nurseMarker = new GoogleMapMarker("Nurse", new LatLon(entry.getLat(), entry.getLon()), false, imgNrs);

            markerInfoMap.put(nurseMarker, entry.generateCaption());

            googleMap.addMarker(nurseMarker);
            nurseMarkers.add(nurseMarker);

        }

    }

    /********** -> Datenholen <- ******************/

    private IndexedContainer dbGetProjects() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSLV_ID, PSLV_NAME from cust_projekte_stammdaten_liste where PSLV_CODE IS NOT NULL";
        q.setSqlString(sql);
        
        return MyUtils.convertIndex(q.query(), "PSLV_ID");
    }

    
    private IndexedContainer dbGetPatients() {
        
        String where = "";
        if(project.getValue() != null) {
            where = "where VH_PROJEKT_ID = " + project.getValue();
        }
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select PSL_ID, CONCAT_WS('', ASA_NAME, ' ', PSL_VORNAME, ' ', PSL_NAME, ' (', PSL_PLZ, ' ', PSL_ORT, ')') as patient"
             + "\n " + "from cust_verk_haupt"
             + "\n " + "inner join view_patient_stammdaten_liste on PSL_ID = VH_PATIENT_ID"
             + "\n " + "left join cms_auth_stammdaten_anrede on PSL_ANREDE = ASA_ID"
             + "\n " + where
             + "\n " + "group by PSL_ID"
             + "\n " + "order by PSL_NAME, PSL_VORNAME";
        q.setSqlString(sql);
        
        return MyUtils.convertIndex(q.query(), "PSL_ID");
    }
    
    private void Datenholen() {

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(KSK_TITEL,' ',KSA_NAME,' ',AUL_NAME,' ',AUL_VORNAME)", "Krankenschwesternname");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_STRASSE", "Strasse");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_ORT", "Ort");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_PLZ", "PLZ");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSA_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AUL_VORNAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_COUNTRYCODE");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CC_TEXT", "Land");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_krankenschwester_stammdaten_anrede",
            "AUL_ANREDE_ID", "KSA_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_krankenschwester_stammdaten_ks", "INNER JOIN", "cms_auth_stammdaten_user", "KSK_U_ID",
            "AUL_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_krankenschwester_stammdaten_ks", "INNER JOIN", "cust_countrycodes", "KSK_COUNTRYCODE",
            "CC_CODE");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cms_auth_liste_gu", "AUL_ID", "AL_U_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_liste_gu", "INNER JOIN", "cust_projekte_stammdaten_liste", "AL_G_ID", "PSLV_GROUP");

        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_user", "AUL_AKTIV", "=", "1", "AND");

        // if (!proximList.equals("")) {
        db.DB_Data_Get.DB_Filter.DB_WHERE_CUSTOM("WHERE FIND_IN_SET(KSK_PLZ, '" + proximList + "') > 0", "AND");
        // }
        if (projectId != null) {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_projekte_stammdaten_liste", "PSLV_ID", "=", projectId.toString(), "AND");
        }else if (project.getValue() != null) {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_projekte_stammdaten_liste", "PSLV_ID", "=", project.getValue().toString(), "AND");
        }
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_countrycodes", "CC_LNG", "=", "1", "");
        
        db.DB_Data_Get.DB_Gruppieren.DB_Gruppieren("KSK_ID");
        
//        db.debugNextQuery(true);

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        con.addContainerProperty("Status", String.class, "unbekannt");
        con.addContainerProperty("Fahrtzeit", Long.class, new Long(0));
        con.addContainerProperty("Fahrtweg", Long.class, new Long(0));

        // for (Object id : con.getItemIds()) {
        // String r = "";
        // for (Object pid : con.getItem(id).getItemPropertyIds()) {
        // r += con.getItem(id).getItemProperty(pid).getValue();
        // }
        // System.out.println(r);
        // }

        if (con.size() > 0) {
            tbl_analyse.removeAllItems();

            tbl_analyse.setContainerDataSource(con);
            tbl_analyse.setVisibleColumns(new Object[] { "Krankenschwesternname", "Ort", "PLZ", "Fahrtweg", "Fahrtzeit", "Status" });
            tbl_analyse.sort(new String[] { "Fahrtweg", "Fahrtzeit" }, new boolean[] { true, true });

        } else {
            tbl_analyse.removeAllItems();

        }

    }

    private boolean getCustomAddress() {
        
        if(plz.getValue() == null || city.getValue() == null ||
            "".equals(plz.getValue().trim()) || "".equals(city.getValue().trim())) {
            return false;
        }
        
        custAddress = AddressHolder.newAddress(
            "",
            "",
            plz.getValue(),
            city.getValue(),
            "",
            getLatLonSingle(plz.getValue()));

        return true;
    }
    
    private boolean dbGetPatientAddress() {

        patAddress = null;
        
        if(patientId == null && patient.getValue() == null) {
            return false;
        }
        
        DBClass db = new DBClass();

        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_STRASSE");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_ORT");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_VORNAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSA_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_PLZ");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_patient_stammdaten_liste", "INNER JOIN", "cust_patient_stammdaten_anrede", "PSL_ANREDE",
            "PSA_ID");
        if(patientId != null) {
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_patient_stammdaten_liste", "PSL_ID", "=", patientId.toString(), "");
        }else if (patient.getValue() != null){
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_patient_stammdaten_liste", "PSL_ID", "=", patient.getValue().toString(), "");
        }
        

        Item item = MyUtils.getFirstItemFromContainer(db.DB_Data_Get.DB_SEND_AND_GET_Container());
        
        patAddress = AddressHolder.newAddress(
            MyUtils.getValueFromItem(item, "PSA_NAME", String.class) + " "
                + MyUtils.getValueFromItem(item, "PSL_VORNAME", String.class) + " "
                + MyUtils.getValueFromItem(item, "PSL_NAME", String.class),
            MyUtils.getValueFromItem(item, "PSL_NAME", String.class),
            MyUtils.getValueFromItem(item, "PSL_PLZ", String.class),
            MyUtils.getValueFromItem(item, "PSL_ORT", String.class),
            MyUtils.getValueFromItem(item, "PSL_STRASSE", String.class),
            getLatLonSingle(MyUtils.getValueFromItem(item, "PSL_PLZ", String.class)));

        return true;
    }

    private void getProximFromList(String postalCode, Integer radius, Integer max) {

        proximList = "";

        DBClass db = new DBClass();
        DBClass dbg = new DBClass(geoPool);

        db.CustomQuery.setSqlString("SELECT GROUP_CONCAT(KSK_PLZ) as postal_code_list FROM cust_krankenschwester_stammdaten_ks");
        Container con = db.CustomQuery.query();

        String postalCodeList = "";

        for (Object itemId : con.getItemIds()) {
            postalCodeList = (String) con.getItem(itemId).getItemProperty("postal_code_list").getValue();
        }

        // System.out.println(postalCodeList);

        dbg.CustomQuery.setSqlString("CALL getProximResultFromList('" + postalCode + "', " + radius + ", '" + postalCodeList + "', " + max + ")");
        Container cong = dbg.CustomQuery.query();

        // System.out.println("CALL getProximResultFromList('" + postalCode +
        // "', " + radius + ", '" + postalCodeList + "', " + max + ")");

        dbg.debugNextQuery(true);
        
        String comma = "";
        for (Object itemId : cong.getItemIds()) {

            String f = (String) cong.getItem(itemId).getItemProperty("postal_code").getValue();
            proximList = proximList.concat(comma + f);
            comma = ",";
        }

    }

    private HashMap<String, Double[]> getLatLonList(AddressHolder adh) {

        HashMap<String, Double[]> postalcodes = new HashMap<String, Double[]>();

        DBClass db = new DBClass(geoPool);

        db.CustomQuery.setSqlString("CALL getLatLonList('" + adh.toPostalCodeString() + "')");
        IndexedContainer con = (IndexedContainer) db.CustomQuery.query();
        
        for (AddressEntry address : adh) {
            postalcodes.put(address.getPostalCode(), findLocation(con, address.getPostalCode(), address.getCountryCode()));
        }

        return postalcodes;

    }
    
    private Double[] findLocation(IndexedContainer con, String plz, String country) {
        Double[] coords = new Double[2];
        
        for (Object iid : con.getItemIds()) {
            if(plz.equals(MyUtils.getValueFromItem(con.getItem(iid), "postal_code", String.class))
                && country.equals(MyUtils.getValueFromItem(con.getItem(iid), "country_code", String.class)) ) {
              coords[0] = ((Float) con.getItem(iid).getItemProperty("latitude").getValue()).doubleValue();
              coords[1] = ((Float) con.getItem(iid).getItemProperty("longitude").getValue()).doubleValue();
              break;
            }
        }
        
        return coords;
    }

    private HashMap<String, Double> getLatLonSingle(String postalCode) {

        HashMap<String, Double> result = new HashMap<String, Double>();

        DBClass db = new DBClass(geoPool);

        db.CustomQuery.setSqlString("CALL getLatLonSingle('" + postalCode + "')");
        Container con = db.CustomQuery.query();

        if (con.size() > 0) {
            for (Object itemId : con.getItemIds()) {

                Double lat = ((Float) con.getItem(itemId).getItemProperty("latitude").getValue()).doubleValue();
                Double lon = ((Float) con.getItem(itemId).getItemProperty("longitude").getValue()).doubleValue();

                result.put("lat", lat);
                result.put("lon", lon);
                break;
            }
        }

        return result;

    }

    private void requestDistanceInfo() {

        if (nurseAddresses == null) {
            return;
        }

        String[] origins = nurseAddresses.toAddressArray();

        distMatrix = new DistanceMatrixApiRequest(geoApi);

        distMatrix.origins(origins);
        String destination = null;
        
        if(patAddress != null) {
            destination = patAddress.getPostalCode() + " " + patAddress.getCity();
        }else {
            destination = plz.getValue() + " " + city.getValue();
        }
        
        if ("".equals(destination.trim())) {
            return;
        }
        
        distMatrix.destinations(destination);

        // System.out.println(Arrays.toString(origins));
        
        btn_refresh.setEnabled(false);
        
        Callback<DistanceMatrix> cb = new PendingResult.Callback<DistanceMatrix>() {

            @Override
            public void onResult(DistanceMatrix result) {

                Container con = tbl_analyse.getContainerDataSource();

                for (int i = 0; i < result.rows.length; i++) {

                    DistanceMatrixRow row = result.rows[i];

                    for (Integer j = 0; j < row.elements.length; j++) {

                        DistanceMatrixElement element = row.elements[j];
                        Distance dist = element.distance;
                        Duration dur = element.duration;

                        Item item = con.getItem(i + 1);
                        item.getItemProperty("Fahrtweg").setValue(dist.inMeters);
                        item.getItemProperty("Fahrtzeit").setValue(dur.inSeconds);
                        item.getItemProperty("Status").setValue("OK");

                    }

                }

                tbl_analyse.sort(new String[] { "Fahrtweg", "Fahrtzeit" }, new boolean[] { true, true });
                btn_refresh.setEnabled(true);

            }

            @Override
            public void onFailure(Throwable e) {
                System.out.println(e);
                btn_refresh.setEnabled(true);
            }
        };

        distMatrix.setCallback(cb);
    }


    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        mainLayout.addComponent(verticalLayout_2);
        mainLayout.setExpandRatio(verticalLayout_2, 1.0f);
        
        // tbl_analyse
        tbl_analyse = new Table();
        tbl_analyse.setImmediate(false);
        tbl_analyse.setWidth("100.0%");
        tbl_analyse.setHeight("100.0%");
        mainLayout.addComponent(tbl_analyse);
        mainLayout.setExpandRatio(tbl_analyse, 4.0f);
        mainLayout.setComponentAlignment(tbl_analyse, new Alignment(48));
        
        // vtl_map
        vtl_map = new VerticalLayout();
        vtl_map.setImmediate(false);
        vtl_map.setWidth("100.0%");
        vtl_map.setHeight("100.0%");
        vtl_map.setMargin(false);
        mainLayout.addComponent(vtl_map);
        mainLayout.setExpandRatio(vtl_map, 6.0f);
        mainLayout.setComponentAlignment(vtl_map, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);
        verticalLayout_2.setSpacing(true);
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        verticalLayout_2.addComponent(horizontalLayout_1);
        
        return verticalLayout_2;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(false);
        horizontalLayout_1.setSpacing(true);
        
        // horizontalLayout_2
        horizontalLayout_2 = buildHorizontalLayout_2();
        horizontalLayout_1.addComponent(horizontalLayout_2);
        horizontalLayout_1.setExpandRatio(horizontalLayout_2, 1.0f);
        
        // btn_refresh
        btn_refresh = new Button();
        btn_refresh.setCaption("Aktualisieren");
        btn_refresh.setImmediate(true);
        btn_refresh.setWidth("-1px");
        btn_refresh.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_refresh);
        horizontalLayout_1.setComponentAlignment(btn_refresh, new Alignment(24));
        
        // btn_uebernehmen
        btn_uebernehmen = new Button();
        btn_uebernehmen.setCaption("Übernehmen");
        btn_uebernehmen.setImmediate(true);
        btn_uebernehmen.setWidth("-1px");
        btn_uebernehmen.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_uebernehmen);
        horizontalLayout_1.setComponentAlignment(btn_uebernehmen, new Alignment(24));
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_2() {
        // common part: create layout
        horizontalLayout_2 = new HorizontalLayout();
        horizontalLayout_2.setImmediate(false);
        horizontalLayout_2.setWidth("-1px");
        horizontalLayout_2.setHeight("-1px");
        horizontalLayout_2.setMargin(false);
        horizontalLayout_2.setSpacing(true);
        
        // project
        project = new ComboBox();
        project.setCaption("Projekt");
        project.setImmediate(false);
        project.setWidth("160px");
        project.setHeight("-1px");
        horizontalLayout_2.addComponent(project);
        
        // patient
        patient = new ComboBox();
        patient.setCaption("Patient");
        patient.setImmediate(false);
        patient.setWidth("160px");
        patient.setHeight("-1px");
        horizontalLayout_2.addComponent(patient);
        
        // plz
        plz = new TextField();
        plz.setCaption("PLZ");
        plz.setImmediate(false);
        plz.setWidth("60px");
        plz.setHeight("-1px");
        horizontalLayout_2.addComponent(plz);
        
        // city
        city = new TextField();
        city.setCaption("Ort");
        city.setImmediate(false);
        city.setWidth("120px");
        city.setHeight("-1px");
        horizontalLayout_2.addComponent(city);
        
        // range
        range = new IntStepper();
        range.setCaption("Umkreis");
        range.setImmediate(false);
        range.setWidth("50px");
        range.setHeight("-1px");
        horizontalLayout_2.addComponent(range);
        
        return horizontalLayout_2;
    }

}
