package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.pop.classes;

import java.sql.Time;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map.Entry;

import org.slf4j.Logger;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Fields.CustomTimePicker;
import archenoah.lib.vaadin.Components.Steppers.FloatStepper;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.CustomConverterFactorys.BooleanToTextConverter;
import archenoah.lib.vaadin.CustomConverterFactorys.FloatConverter;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

public class PanelVitals extends CustomComponent{
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout layoutTable;
    @AutoGenerated
    private Table table;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private VerticalLayout layoutFields2;
    @AutoGenerated
    private HorizontalLayout fieldsBot;
    @AutoGenerated
    private Button vitalsRemove;
    @AutoGenerated
    private Button vitalsAdd;
    @AutoGenerated
    private TextField vitalsComment;
    @AutoGenerated
    private CheckBox vitalsIsMax;
    @AutoGenerated
    private HorizontalLayout fieldsTop;
    @AutoGenerated
    private FloatStepper vitalsTemp;
    @AutoGenerated
    private IntStepper vitalsPulse;
    @AutoGenerated
    private FloatStepper vitalsOxi;
    @AutoGenerated
    private TextField vitalsPressure;
    @AutoGenerated
    private CustomTimePicker vitalsTime;
    // {section fields}
    // ****************
    
    private HashMap<Object, String> componentMap;
    private Integer dataId;

    private ArrayList<Integer> dataOriginal;
    private Logger log;
    
    private Object[] columns  = new Object[] {"TIME", "PRESSURE", "OXI", "PULSE", "TEMP", "COMMENT", "FLAG_IS_MAX_REACT"};
    private I18nManager i18n;
    
    // {end fields}
    

    

    // {section constructors}
    // **********************
    public PanelVitals() {
        
        log = org.slf4j.LoggerFactory.getLogger(this.getClass());
        
        
        setCompositionRoot(buildMainLayout());
        i18n = new I18nManager(this);
        registerComponents();
        
        fillFields();
        configureComponents();
        configureListeners();
        
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    public void getEntries(Integer dataId) {
        this.dataId = dataId;
        dbGetEntries();
    }
    
    public void save(Integer dataId) {
        this.dataId = dataId;
        checkIncompleteInput();
        dbSaveEntries();
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    
    private void checkIncompleteInput() {
        boolean hasUnsaved = false;
        
        if( vitalsTime.isValid()
            && vitalsPressure.isValid()
            && vitalsOxi.isValid()
            && vitalsPulse.isValid()
            && vitalsTemp.isValid()) {
            hasUnsaved = true;
        }
        
        if(hasUnsaved && table.size() == 0) {
            I18nManager.global(I18nGlobalNotifiers.incomplete_save);
        }
    }
    
    private void registerComponents(){
        componentMap = new HashMap<Object, String>();
        new ComponentIterator(mainLayout).createMap(componentMap);
    }
    
    private void configureComponents() {
        
        for (Entry<Object, String> entry : componentMap.entrySet()) {
            AbstractComponent field = (AbstractComponent) entry.getKey();

                    
            if(field instanceof AbstractField){
                field.setImmediate(true);
            }
            
            if(field instanceof ComboBox){
                ((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
            }
            
        }
        
        vitalsRemove.setEnabled(false);
        
        
        vitalsTime.setRequired(true);
        
        vitalsPressure.setRequired(true);
        
        vitalsOxi.setRequired(true);
        vitalsOxi.setMinValue(0F);
        vitalsOxi.setNumberOfDecimals(2);
        
        vitalsPulse.setRequired(true);
        vitalsPulse.setMinValue(0);
        
        vitalsTemp.setRequired(true);
        vitalsTemp.setMinValue(0F);
        vitalsTemp.setNumberOfDecimals(1);
        
    }
    
    private void configureListeners() {

        
        table.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
               toggleFields((table.getValue() == null)); // edit mode if null
                
            }
        });
        
        vitalsAdd.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if( vitalsTime.isValid()
                        && vitalsPressure.isValid()
                        && vitalsOxi.isValid()
                        && vitalsPulse.isValid()
                        && vitalsTemp.isValid()) {
                    addEntry();
                }
                
            }
        });
        
        vitalsRemove.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                removeEntry();
                
            }
        });
        
    }
    
    private void configureTable() {
        table.setImmediate(true);
        table.setSelectable(true);
        
        table.setVisibleColumns(columns);
        
        StringSqlTimestampConverter time = new StringSqlTimestampConverter();
        time.setDateFormat(0);
        time.setTimeFormat(DateFormat.SHORT);
        
        table.setConverter("TIME", time);
        table.setConverter("FLAG_IS_MAX_REACT", new BooleanToTextConverter());
        
        FloatConverter flt = new FloatConverter();
        flt.setPrecision(1);
        table.setConverter("TEMP", flt);
        
        table.setColumnExpandRatio("COMMENT", 1);
        
        i18n.refresh();
    }
    
    private void fillFields() {

    }
    
    
    private void toggleFields(Boolean editMode) {
        vitalsTime.setEnabled(editMode);
        vitalsPressure.setEnabled(editMode);
        vitalsOxi.setEnabled(editMode);
        vitalsPulse.setEnabled(editMode);
        vitalsTemp.setEnabled(editMode);
        vitalsIsMax.setEnabled(editMode);
        vitalsComment.setEnabled(editMode);
        
        vitalsAdd.setEnabled(editMode);
        vitalsRemove.setEnabled(!editMode);
    }
    
    
    private void addEntry() {
        
        Container con = table.getContainerDataSource();
        
//        String name = medName.getItemCaption(medName.getValue());
//        Time time = new Time(medTime.getTime().toDateTimeToday().getMillis());
//        Integer applied = (Integer) medApplied.getValue();
        
        Time time = new Time(vitalsTime.getTime().toDateTimeToday().getMillis());
        String pressure = vitalsPressure.getValue();
        Float oxi = vitalsOxi.getValue();
        Integer pulse = vitalsPulse.getValue();
        Float temp = vitalsTemp.getValue();
        String comment = vitalsComment.getValue();
        Boolean max = vitalsIsMax.getValue();
        
        
        Object iid = con.addItem();
        
        Collection propIds = con.getContainerPropertyIds();
        
        if(!propIds.contains("TIME")) {
            con.addContainerProperty("TIME", java.sql.Time.class, null);
            con.addContainerProperty("PRESSURE", String.class, null);
            con.addContainerProperty("OXI", Float.class, null);
            con.addContainerProperty("PULSE", Integer.class, null);
            con.addContainerProperty("TEMP", Float.class, null);
            con.addContainerProperty("COMMENT", String.class, null);
            con.addContainerProperty("FLAG_IS_MAX_REACT", Boolean.class, null);
        }
        
        if(dataId == null) {
            configureTable();
        }
        
        con.getItem(iid).getItemProperty("TIME").setValue(time);
        con.getItem(iid).getItemProperty("PRESSURE").setValue(pressure);
        con.getItem(iid).getItemProperty("OXI").setValue(oxi);
        con.getItem(iid).getItemProperty("PULSE").setValue(pulse);
        con.getItem(iid).getItemProperty("TEMP").setValue(temp);
        con.getItem(iid).getItemProperty("COMMENT").setValue(comment);
        con.getItem(iid).getItemProperty("FLAG_IS_MAX_REACT").setValue(max);
        
        table.setValue(null);
    }
    
    private void removeEntry() {
        
        if(table.getValue() != null) {
            table.getContainerDataSource().removeItem(table.getValue());
        }
     
        table.setValue(null);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    
    private void dbGetEntries() {
        
        DBClass db = new DBClass();
        
        String sql = "SELECT ID, TIME, PRESSURE, OXI, PULSE, TEMP, COMMENT, FLAG_IS_MAX_REACT"
             + "\n " + "FROM cust_protokoll_pop_multi_vitals"
             + "\n " + "WHERE ID_DATA = "+dataId
             + "\n " + "ORDER BY ID ASC";
        
        db.CustomQuery.setSqlString(sql);
//        db.debugNextQuery(true);
        Container con  = MyUtils.convertIndex(db.CustomQuery.query(), "ID");
        
        dataOriginal = new ArrayList<Integer>();
        dataOriginal.addAll((Collection<Integer>) con.getItemIds());
        
        table.setContainerDataSource(con);
        
        configureTable();
    }
    
    private ArrayList<Integer> getInsertEntries() {
        
        ArrayList<Integer> insert = new ArrayList<Integer>();
        insert.addAll((Collection<Integer>) table.getContainerDataSource().getItemIds());
        if(dataOriginal != null) {
            insert.removeAll(dataOriginal);
        }
        
        return insert;
    }
    
    private ArrayList<Integer> getDeleteEntries() {
        
        ArrayList<Integer> delete = new ArrayList<Integer>();
        if(dataOriginal != null) {
            delete.addAll(dataOriginal);
        }
        delete.removeAll(table.getContainerDataSource().getItemIds());
        
        return delete;
    }
    
    private void dbSaveEntries() {

        DBClass db = new DBClass();
        
        ArrayList<Integer> insertEntries = getInsertEntries();
        ArrayList<Integer> deleteEntries = getDeleteEntries();
        
        if(deleteEntries.size() > 0 ) {
            String deleteString = "DELETE FROM cust_protokoll_pop_multi_vitals WHERE ID_DATA = " + dataId + " AND ID IN("+Joiner.on(",").join(getDeleteEntries())+")";
            db.CustomQuery.setSqlString(deleteString);
            db.CustomQuery.update();
        }
        
        if(insertEntries.size() > 0 ) {
            
            ArrayList<String> insertList = new ArrayList<String>();
            
            for (Integer id : getInsertEntries()) {
                Item item = table.getContainerDataSource().getItem(id);
                
                Integer reactInt = (Boolean) item.getItemProperty("FLAG_IS_MAX_REACT").getValue() ? 1 : 0;
                
                insertList.add("("+dataId+
                        ", '"+item.getItemProperty("TIME").getValue()+
                        "', '"+item.getItemProperty("PRESSURE").getValue()+
                        "', '"+item.getItemProperty("OXI").getValue()+
                        "', '"+item.getItemProperty("PULSE").getValue()+
                        "', '"+item.getItemProperty("TEMP").getValue()+
                        "', '"+item.getItemProperty("COMMENT").getValue()+
                        "', "+ reactInt +")");
            }
            
            String insertString = "INSERT INTO `cust_protokoll_pop_multi_vitals` (`ID_DATA`, `TIME`, `PRESSURE`, `OXI`, `PULSE`, `TEMP`, `COMMENT`, `FLAG_IS_MAX_REACT`)"
                    + "\n " + "VALUES " + Joiner.on(",\n").join(insertList) + ";";

            db.CustomQuery.setSqlString(insertString);
            db.CustomQuery.update();
        }

        
    }
    
    
    // {end database}

    // {section layout}
    // ****************
    // {end layout}
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_half_full_none_full");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // layoutTable
        layoutTable = buildLayoutTable();
        mainLayout.addComponent(layoutTable);
        mainLayout.setExpandRatio(layoutTable, 1.0f);
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutTable() {
        // common part: create layout
        layoutTable = new VerticalLayout();
        layoutTable.setImmediate(false);
        layoutTable.setWidth("100.0%");
        layoutTable.setHeight("100.0%");
        layoutTable.setMargin(false);
        layoutTable.setSpacing(true);
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        layoutTable.addComponent(horizontalLayout_1);
        
        // table
        table = new Table();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        layoutTable.addComponent(table);
        layoutTable.setExpandRatio(table, 1.0f);
        
        return layoutTable;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("-1px");
        horizontalLayout_1.setMargin(false);
        horizontalLayout_1.setSpacing(true);
        
        // layoutFields2
        layoutFields2 = buildLayoutFields2();
        horizontalLayout_1.addComponent(layoutFields2);
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private VerticalLayout buildLayoutFields2() {
        // common part: create layout
        layoutFields2 = new VerticalLayout();
        layoutFields2.setImmediate(false);
        layoutFields2.setWidth("100.0%");
        layoutFields2.setHeight("-1px");
        layoutFields2.setMargin(false);
        layoutFields2.setSpacing(true);
        
        // fieldsTop
        fieldsTop = buildFieldsTop();
        layoutFields2.addComponent(fieldsTop);
        
        // fieldsBot
        fieldsBot = buildFieldsBot();
        layoutFields2.addComponent(fieldsBot);
        
        return layoutFields2;
    }

    @AutoGenerated
    private HorizontalLayout buildFieldsTop() {
        // common part: create layout
        fieldsTop = new HorizontalLayout();
        fieldsTop.setImmediate(false);
        fieldsTop.setWidth("100.0%");
        fieldsTop.setHeight("-1px");
        fieldsTop.setMargin(false);
        fieldsTop.setSpacing(true);
        
        // vitalsTime
        vitalsTime = new CustomTimePicker();
        vitalsTime.setCaption("Uhrzeit");
        vitalsTime.setImmediate(false);
        vitalsTime.setWidth("80px");
        vitalsTime.setHeight("-1px");
        fieldsTop.addComponent(vitalsTime);
        fieldsTop.setExpandRatio(vitalsTime, 1.0f);
        fieldsTop.setComponentAlignment(vitalsTime, new Alignment(24));
        
        // vitalsPressure
        vitalsPressure = new TextField();
        vitalsPressure.setCaption("Blutdruck (mm Hg)");
        vitalsPressure.setImmediate(false);
        vitalsPressure.setWidth("80px");
        vitalsPressure.setHeight("-1px");
        fieldsTop.addComponent(vitalsPressure);
        fieldsTop.setExpandRatio(vitalsPressure, 1.0f);
        fieldsTop.setComponentAlignment(vitalsPressure, new Alignment(24));
        
        // vitalsOxi
        vitalsOxi = new FloatStepper();
        vitalsOxi.setCaption("Pulsoximeter SpO2");
        vitalsOxi.setImmediate(false);
        vitalsOxi.setWidth("80px");
        vitalsOxi.setHeight("-1px");
        fieldsTop.addComponent(vitalsOxi);
        fieldsTop.setExpandRatio(vitalsOxi, 1.0f);
        fieldsTop.setComponentAlignment(vitalsOxi, new Alignment(24));
        
        // vitalsPulse
        vitalsPulse = new IntStepper();
        vitalsPulse.setCaption("Puls / min");
        vitalsPulse.setImmediate(false);
        vitalsPulse.setWidth("80px");
        vitalsPulse.setHeight("-1px");
        fieldsTop.addComponent(vitalsPulse);
        fieldsTop.setExpandRatio(vitalsPulse, 1.0f);
        fieldsTop.setComponentAlignment(vitalsPulse, new Alignment(24));
        
        // vitalsTemp
        vitalsTemp = new FloatStepper();
        vitalsTemp.setCaption("Temperatur");
        vitalsTemp.setImmediate(false);
        vitalsTemp.setWidth("80px");
        vitalsTemp.setHeight("-1px");
        fieldsTop.addComponent(vitalsTemp);
        fieldsTop.setExpandRatio(vitalsTemp, 1.0f);
        fieldsTop.setComponentAlignment(vitalsTemp, new Alignment(24));
        
        return fieldsTop;
    }

    @AutoGenerated
    private HorizontalLayout buildFieldsBot() {
        // common part: create layout
        fieldsBot = new HorizontalLayout();
        fieldsBot.setImmediate(false);
        fieldsBot.setWidth("100.0%");
        fieldsBot.setHeight("-1px");
        fieldsBot.setMargin(false);
        fieldsBot.setSpacing(true);
        
        // vitalsIsMax
        vitalsIsMax = new CheckBox();
        vitalsIsMax.setCaption("Max. bei Inf.Reakt.");
        vitalsIsMax.setImmediate(false);
        vitalsIsMax.setWidth("-1px");
        vitalsIsMax.setHeight("-1px");
        fieldsBot.addComponent(vitalsIsMax);
        fieldsBot.setExpandRatio(vitalsIsMax, 1.0f);
        fieldsBot.setComponentAlignment(vitalsIsMax, new Alignment(48));
        
        // vitalsComment
        vitalsComment = new TextField();
        vitalsComment.setCaption("Kommentar / Befinden");
        vitalsComment.setImmediate(false);
        vitalsComment.setWidth("100.0%");
        vitalsComment.setHeight("-1px");
        fieldsBot.addComponent(vitalsComment);
        fieldsBot.setExpandRatio(vitalsComment, 3.0f);
        fieldsBot.setComponentAlignment(vitalsComment, new Alignment(48));
        
        // vitalsAdd
        vitalsAdd = new Button();
        vitalsAdd.setCaption("Hinzuf√ºgen");
        vitalsAdd.setImmediate(true);
        vitalsAdd.setWidth("-1px");
        vitalsAdd.setHeight("-1px");
        fieldsBot.addComponent(vitalsAdd);
        fieldsBot.setExpandRatio(vitalsAdd, 1.0f);
        fieldsBot.setComponentAlignment(vitalsAdd, new Alignment(24));
        
        // vitalsRemove
        vitalsRemove = new Button();
        vitalsRemove.setCaption("Entfernen");
        vitalsRemove.setEnabled(false);
        vitalsRemove.setImmediate(true);
        vitalsRemove.setWidth("-1px");
        vitalsRemove.setHeight("-1px");
        fieldsBot.addComponent(vitalsRemove);
        fieldsBot.setExpandRatio(vitalsRemove, 1.0f);
        fieldsBot.setComponentAlignment(vitalsRemove, new Alignment(24));
        
        return fieldsBot;
    }
}
