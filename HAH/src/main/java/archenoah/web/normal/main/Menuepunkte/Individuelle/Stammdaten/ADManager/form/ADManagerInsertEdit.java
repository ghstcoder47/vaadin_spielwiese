package archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.ADManager.form;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Combo.nativecombo;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.valchecker.val_checker4;
import archenoah.web.normal.main.Menuepunkte.Standard.Administration.Benutzerverwaltung.Validatoren.Custom_Benutzerform_tel;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.NativeSelect;
import com.vaadin.ui.Panel;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class ADManagerInsertEdit extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;

    @AutoGenerated
    private Button btn_save;

    @AutoGenerated
    private Panel pan_verwaltung;

    @AutoGenerated
    private VerticalLayout verticalLayout_24;

    @AutoGenerated
    private ComboBox cbx_project;

    @AutoGenerated
    private Panel pan_stammdaten;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private VerticalLayout verticalLayout_3;

    @AutoGenerated
    private TextField txt_gebiet;

    @AutoGenerated
    private TextField txt_tel;

    @AutoGenerated
    private TextField txt_firma;

    @AutoGenerated
    private VerticalLayout verticalLayout_2;

    @AutoGenerated
    private TextField txt_vorname;

    @AutoGenerated
    private TextField txt_name;

    @AutoGenerated
    private NativeSelect ns_anrede;

    

    

    

    

    

    

    

    

    

    

    

    

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /*******************************************/
    private MenuItem Temp_Menü = null;
    private Button Temp_Btn = null;
    private TabSheet tab = null;
    private Window win = null;
    /*******************************************/
    /*******************************************/
    // Allgemein
    private CMS_Config_Std std;
    // Datenbank
    private Map<Object, String> DBMap;
    private Map<Object, String> ValidateMap;
    private String Form_ID = "";
    // Berrechtigung
    private int ACC_ID;
    private int permCreate;
    private int permRead;
    private int permUpdate;
    private int permDelete;
    
    /*******************************************/
//    private final String LNG_FRM_ID = "42";
    private final String BER_MEN_ID = "";
    private final String Windows_Height = "400px";
    private final String Windows_Width = "440px";

    private ArrayList<AbstractField> fieldList;

    private I18nManager i18n;
    /*******************************************/

    public ADManagerInsertEdit(MenuItem Arg_Menü, String Arg_Form_ID) {
        Temp_Menü = Arg_Menü;
        Form_ID = Arg_Form_ID;
    }

    public ADManagerInsertEdit(Button Arg_btn, String Arg_Form_ID) {
        Temp_Btn = Arg_btn;
        Form_ID = Arg_Form_ID;
    }

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        String fid = Form_ID;
        if (fid != "") {
            fid = " - #" + fid;
        }

        if (Temp_Menü != null) {
            String Recourcename = Temp_Menü.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(Temp_Menü.getText() + fid, mainLayout, Windows_Height, Windows_Width,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (Temp_Btn != null) {
            Build_Window_Button bwb = new Build_Window_Button(Temp_Btn.getCaption() + fid, mainLayout, Windows_Height, Windows_Width,
                    Temp_Btn.getIcon());
            win = bwb.ReturnWindow();
        }

    }
    /********* INIT-Tray ************/
    public void Init_Class_Tab(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (Temp_Menü != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Menü.getText(), mainLayout, Temp_Menü.getIcon());
        }
        if (Temp_Btn != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Btn.getCaption(), mainLayout, Temp_Btn.getIcon());
        }

    }

    public Window getWindow(){
        return win;
    }
    
    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        
        buildFieldList();

        fillFields();
        
        fillDBMap();

        fillValidateMap();


        if (Form_ID != "") {
            dbGet();
        } else {

        }
        
        
        setPopupPermissions();
        setListeners();
        configFields();
        
        i18n.refresh();

    }
    
    
    private void fillFields(){
        dbFillAnrede();
        dbFillProject();
    }
    
    private void buildFieldList(){
        fieldList = new ArrayList<AbstractField>();
        
        fieldList.add(ns_anrede);
        fieldList.add(txt_name);
        fieldList.add(txt_vorname);
        
        fieldList.add(txt_firma);
        fieldList.add(txt_tel);
        fieldList.add(txt_gebiet);
        
        fieldList.add(cbx_project);

       
    }
    
    private void setListeners(){
        btn_save.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(!validate()){
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                    return;
                }
                
                if(Form_ID != ""){
                    dbUpdate();
                }else{
                    dbInsert();
                }
                UI.getCurrent().getUI().removeWindow(win);
            }
        });
    }
    
    private void configFields(){
        for (AbstractField field : fieldList) {
            field.setImmediate(true);
        }
        cbx_project.setFilteringMode(FilteringMode.CONTAINS);
        
        // migrated from database
        txt_name.setRequired(true);
        // migration end
    }
    
    /************************ --> Berrechtigung <-- **************************/

    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (BER_MEN_ID == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(BER_MEN_ID) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setPopupPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);
        
        Boolean readonly = (r && !(c || u));
        
        for (AbstractField field : fieldList) {
            field.setReadOnly(readonly);
        }
        
        btn_save.setEnabled(!readonly);
        
    }
    
    /*********************** -->Validierung<-- ********************/
    private void fillValidateMap() {
        ValidateMap = new HashMap<>();
        
        for (AbstractField field : fieldList) {
            ValidateMap.put(field, "field");
        }
        
        txt_tel.addValidator(new Custom_Benutzerform_tel());

    }



    private boolean validate() {
        val_checker4 val = new val_checker4(ValidateMap);
        if (val.Is_Valid() == false) {
            return false;
        } else {
            return true;
        }

    }
    
    
    /******************** Database *****************/
    private void fillDBMap() {
        DBMap = new HashMap<>();
        DBMap.put(ns_anrede, "cust_stammdaten_aussendienst:SAD_ID_ANREDE");
        DBMap.put(txt_name, "cust_stammdaten_aussendienst:SAD_NAME");
        DBMap.put(txt_vorname, "cust_stammdaten_aussendienst:SAD_VORNAME");
        DBMap.put(txt_firma, "cust_stammdaten_aussendienst:SAD_FIRMA");
        DBMap.put(txt_tel, "cust_stammdaten_aussendienst:SAD_TEL");
        DBMap.put(txt_gebiet, "cust_stammdaten_aussendienst:SAD_GEBIET");
        DBMap.put(cbx_project, "cust_stammdaten_aussendienst:SAD_ID_PROJEKT");
        
    }

    private void dbGet() {
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_stammdaten_aussendienst");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_stammdaten_aussendienst", "SAD_ID", "=", Form_ID, "");
        

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        Form_Bind fb = new Form_Bind();

        fb.Get_and_Fill(con, DBMap);

    }



    private int dbInsert() {
        DBClass db = new DBClass();
        Form_Bind fb = new Form_Bind();

        fb.Insert(db, DBMap);
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_stammdaten_aussendienst");
        
        // dba.DB_Data_Insert.DB_DEBUG_SQL_STRING();
        return db.DB_Data_Insert.DB_Insert();
    }

    private void dbUpdate() {
        DBClass db = new DBClass();
        Form_Bind fb = new Form_Bind();
        fb.Update(db, DBMap);

        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_stammdaten_aussendienst");
        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein("cust_stammdaten_aussendienst", "SAD_ID", "=", Form_ID, "");
        db.DB_Data_Update.DB_Update();

    }

    private void dbFillAnrede(){
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_stammdaten_anrede");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_anrede", "ASA_ID", "=", "1", "OR");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_anrede", "ASA_ID", "=", "2", "");
        
        try {
            nativecombo nc = new nativecombo(db.DB_Data_Get.DB_SEND_AND_GET(), ns_anrede, "ASA_ID", "ASA_NAME");
        } catch (Exception e) {
            ns_anrede.removeAllItems();
        }
    }

    private void dbFillProject(){
        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_projekte_stammdaten_liste");
        
        try {
            combo nc = new combo(db.DB_Data_Get.DB_SEND_AND_GET_Container(), cbx_project, "PSLV_ID", "PSLV_NAME");
        } catch (Exception e) {
            cbx_project.removeAllItems();
        }
    }



   

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // panel_1
        pan_stammdaten = buildPanel_1();
        mainLayout.addComponent(pan_stammdaten);
        mainLayout.setExpandRatio(pan_stammdaten, 3.0f);
        
        // pan_verwaltung
        pan_verwaltung = buildPan_verwaltung();
        mainLayout.addComponent(pan_verwaltung);
        mainLayout.setExpandRatio(pan_verwaltung, 1.2f);
        mainLayout.setComponentAlignment(pan_verwaltung, new Alignment(48));
        
        // btn_save
        btn_save = new Button();
        btn_save.setCaption("Speichern");
        btn_save.setImmediate(true);
        btn_save.setWidth("-1px");
        btn_save.setHeight("-1px");
        mainLayout.addComponent(btn_save);
        mainLayout.setExpandRatio(btn_save, 0.5f);
        mainLayout.setComponentAlignment(btn_save, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private Panel buildPanel_1() {
        // common part: create layout
        pan_stammdaten = new Panel();
        pan_stammdaten.setCaption("Stammdaten");
        pan_stammdaten.setImmediate(false);
        pan_stammdaten.setWidth("100.0%");
        pan_stammdaten.setHeight("100.0%");
        
        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        pan_stammdaten.setContent(horizontalLayout_1);
        
        return pan_stammdaten;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("100.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(true);
        
        // verticalLayout_2
        verticalLayout_2 = buildVerticalLayout_2();
        horizontalLayout_1.addComponent(verticalLayout_2);
        
        // verticalLayout_3
        verticalLayout_3 = buildVerticalLayout_3();
        horizontalLayout_1.addComponent(verticalLayout_3);
        
        return horizontalLayout_1;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_2() {
        // common part: create layout
        verticalLayout_2 = new VerticalLayout();
        verticalLayout_2.setImmediate(false);
        verticalLayout_2.setWidth("100.0%");
        verticalLayout_2.setHeight("100.0%");
        verticalLayout_2.setMargin(false);
        
        // ns_anrede
        ns_anrede = new NativeSelect();
        ns_anrede.setCaption("Anrede");
        ns_anrede.setImmediate(false);
        ns_anrede.setWidth("150px");
        ns_anrede.setHeight("-1px");
        verticalLayout_2.addComponent(ns_anrede);
        verticalLayout_2.setComponentAlignment(ns_anrede, new Alignment(48));
        
        // txt_name
        txt_name = new TextField();
        txt_name.setCaption("Name");
        txt_name.setImmediate(false);
        txt_name.setWidth("150px");
        txt_name.setHeight("-1px");
        verticalLayout_2.addComponent(txt_name);
        verticalLayout_2.setComponentAlignment(txt_name, new Alignment(48));
        
        // txt_vorname
        txt_vorname = new TextField();
        txt_vorname.setCaption("Vorname");
        txt_vorname.setImmediate(false);
        txt_vorname.setWidth("150px");
        txt_vorname.setHeight("-1px");
        verticalLayout_2.addComponent(txt_vorname);
        verticalLayout_2.setComponentAlignment(txt_vorname, new Alignment(48));
        
        return verticalLayout_2;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_3() {
        // common part: create layout
        verticalLayout_3 = new VerticalLayout();
        verticalLayout_3.setImmediate(false);
        verticalLayout_3.setWidth("100.0%");
        verticalLayout_3.setHeight("100.0%");
        verticalLayout_3.setMargin(false);
        
        // txt_firma
        txt_firma = new TextField();
        txt_firma.setCaption("Firma");
        txt_firma.setImmediate(false);
        txt_firma.setWidth("150px");
        txt_firma.setHeight("-1px");
        verticalLayout_3.addComponent(txt_firma);
        verticalLayout_3.setComponentAlignment(txt_firma, new Alignment(48));
        
        // txt_tel
        txt_tel = new TextField();
        txt_tel.setCaption("Telefon");
        txt_tel.setImmediate(false);
        txt_tel.setWidth("150px");
        txt_tel.setHeight("-1px");
        verticalLayout_3.addComponent(txt_tel);
        verticalLayout_3.setComponentAlignment(txt_tel, new Alignment(48));
        
        // txt_gebiet
        txt_gebiet = new TextField();
        txt_gebiet.setCaption("Gebiet");
        txt_gebiet.setImmediate(false);
        txt_gebiet.setWidth("150px");
        txt_gebiet.setHeight("-1px");
        verticalLayout_3.addComponent(txt_gebiet);
        verticalLayout_3.setComponentAlignment(txt_gebiet, new Alignment(48));
        
        return verticalLayout_3;
    }

    @AutoGenerated
    private Panel buildPan_verwaltung() {
        // common part: create layout
        pan_verwaltung = new Panel();
        pan_verwaltung.setCaption("Verwaltungsdaten");
        pan_verwaltung.setImmediate(false);
        pan_verwaltung.setWidth("100.0%");
        pan_verwaltung.setHeight("100.0%");
        
        // verticalLayout_24
        verticalLayout_24 = buildVerticalLayout_24();
        pan_verwaltung.setContent(verticalLayout_24);
        
        return pan_verwaltung;
    }

    @AutoGenerated
    private VerticalLayout buildVerticalLayout_24() {
        // common part: create layout
        verticalLayout_24 = new VerticalLayout();
        verticalLayout_24.setImmediate(false);
        verticalLayout_24.setWidth("100.0%");
        verticalLayout_24.setHeight("100.0%");
        verticalLayout_24.setMargin(false);
        verticalLayout_24.setSpacing(true);
        
        // cbx_project
        cbx_project = new ComboBox();
        cbx_project.setCaption("Projekt");
        cbx_project.setImmediate(false);
        cbx_project.setWidth("150px");
        cbx_project.setHeight("-1px");
        verticalLayout_24.addComponent(cbx_project);
        verticalLayout_24.setComponentAlignment(cbx_project, new Alignment(48));
        
        return verticalLayout_24;
    }

}
