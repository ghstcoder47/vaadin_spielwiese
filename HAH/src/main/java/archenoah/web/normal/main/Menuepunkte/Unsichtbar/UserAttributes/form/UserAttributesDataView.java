package archenoah.web.normal.main.Menuepunkte.Unsichtbar.UserAttributes.form;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;

import org.tepi.filtertable.FilterTable;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.custom.TableFilterGenerator;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.ClickMenuBar.ClickCommand;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.DataviewGenerator;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.CustomConverterFactorys.DataviewConverter;
import archenoah.lib.vaadin.CustomConverterFactorys.TableFilterConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.resources.Icons;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.AbstractSelect;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.Command;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.MessageBoxListener;


@SuppressWarnings({"serial", "rawtypes", "unchecked"})
public class UserAttributesDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private VerticalLayout mainContainer;

    @AutoGenerated
    private FilterTable tbl_data;

    @AutoGenerated
    private HorizontalLayout globalFilterContainer;

    @AutoGenerated
    private VerticalLayout menuSpacer;

    @AutoGenerated
    private MenuBar men_frm;

    

    

    

    

    

	

	

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Datenbank
    private Map<Object, String> componentMap;
    private FilteringTableUpdater tableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Men端punkte <- ********************/
    private MenuBar.MenuItem btn_create;
//    private MenuBar.MenuItem btn_update;
//    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_filter;
    
    private boolean deferTableUpdates;
    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PollListener pollListener = null;
    
    enum Status {}
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdPerm = "711";
    private final String winHeight = "600px";
    private final String winWidth = "900px";


    /******************************************************/
    
    //TASK cols
    private final Object[] tableColsAll = new Object[] {"UA_ID_USER", "UA_KEY", "UA_VALUE",};
    //use custom Cols when needed
    private Object[] tableColsDefault = tableColsAll;
    //use custom Cols when needed
    private final Object[] tableColsFilter = tableColsDefault;
    private Object[] tableColsActive = tableColsDefault;
    
    private I18nManager i18n;
    
    private UserConverter userConverter;

    /******************************************************/

    public UserAttributesDataView(MenuItem Arg_Men端) {
        tmpMenu = Arg_Men端;
    }

    public UserAttributesDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {
        
        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        win.addDetachListener(onDetach);

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        tab.getSelectedTab().addDetachListener(onDetach);
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        
        registerComponents();
        
        generateMenu();

//        setMenuPermissions();

        updateTable();
        tbl_data.setSortContainerPropertyId("UA_ID_USER");
        tbl_data.setSortAscending(true);
        tbl_data.sort();
        configureTable();
        configureComponents();
        
        updateTable();
        
        setupListenersAndDetachEvent();
        
        i18n.refresh();
    }
    
    // register components for lng and validation tools
    private void registerComponents(){
    	componentMap = new HashMap<Object, String>();
    	new ComponentIterator(mainContainer).createMap(componentMap);
    }

    
    private void setupListenersAndDetachEvent() {
        pollListener = new PollListener() {

            @Override
            public void poll(PollEvent event) {
                if(tab.isRendered(mainLayout)){
                    updateTable();
                }
            }
        };

        UI.getCurrent().getUI().addPollListener(pollListener);

        onDetach = new DetachListener() {

            @Override
            public void detach(DetachEvent event) {
                UI.getCurrent().getUI().removePollListener(pollListener);
            }
        };
    }
    
//    @SuppressWarnings("unused")
//    public void setPermissionsFromDatabase() {
//        if (formIdPerm == "") {
//            System.out.println("Form Einstellung Fehlt: Berechtigung");
//            return;
//        }
//
//        Rechteholen r = new Rechteholen(UserData.get().getUserId() + "");
//        String[][] perms = r.Datenholen();
//
//        for (int i = 0; i < perms.length; i++) {
//            if (perms[i][0].equals(formIdPerm) == true) {
//
//                permRead = Integer.valueOf(perms[i][3]);
//                permUpdate = Integer.valueOf(perms[i][4]);
//                permCreate = Integer.valueOf(perms[i][6]);
//                permDelete = Integer.valueOf(perms[i][5]);
//                
//            }
//        }
//    }
//
//    public void setPermissions(int create, int read, int update, int delete) {
//
//        permCreate = create;
//        permRead = read;
//        permUpdate = update;
//        permDelete = delete;
//
//    }
//
//    private void setMenuPermissions() {
//        Boolean c = (permCreate == 1);
//        Boolean r = (permRead == 1);
//        Boolean u = (permUpdate == 1);
//        Boolean d = (permDelete == 1);
//
//        btn_create.setEnabled(c);
//        btn_create.setVisible(c);
//
//        btn_read.setEnabled(r);
//        btn_read.setVisible(r);
//
//        btn_update.setEnabled(u);
//        btn_update.setVisible(u);
//
//        btn_delete.setEnabled(d);
//        btn_delete.setVisible(d);
//    }

    /************ -><- ******************/

    /***************** Comands *********************/
    
    CloseListener closeListener = new CloseListener() {
		
		@Override
		public void windowClose(CloseEvent e) {
			updateTable(true);
		}
	};
    
    //TASK Commands are here
    public Command cmd_btn_add = new ClickCommand() {
        
        final ClickCommand cc = this;
        
        @Override
        public void menuClicked(MenuItem selectedItem) {
            
            UserAttributesInsertEdit pie = new UserAttributesInsertEdit(btn_create, null);
//            pie.setPermissions(permCreate, permRead, permUpdate, permDelete);
            pie.setUsers(userConverter);
            pie.init();
            pie.getWindow().addCloseListener(closeListener);

            cc.setWindow(pie.getWindow());
            cc.setParent(men_frm);
 

        }
    };
    
    public Command cmd_btn_del = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            deleteData(tbl_data.getItem(tbl_data.getValue()));

        }
    };

    public Command cmd_btn_filter = new Command() {
        @Override
        public void menuSelected(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_data.setFilterBarVisible(true);
                tbl_data.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_data.setFilterBarVisible(!tbl_data.isFilterBarVisible());
            
            if(!tbl_data.isFilterBarVisible()){
                tbl_data.clearFilters();
            }
            
            tableColsActive = tbl_data.isFilterBarVisible() ? tableColsFilter : tableColsDefault;
            if(tableColsActive.length > 0){
            	tbl_data.setVisibleColumns(tableColsActive);
            }

        }
    };


    

    

    
    

    /*********** Gen Men端s *************/
    private void generateMenu() {

        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
//        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
//        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);
        
    }
    
    private void configureComponents(){
       
    	for (Entry<Object, String> entry : componentMap.entrySet()) {
    		AbstractComponent field = (AbstractComponent) entry.getKey();
    		
			field.setImmediate(true);
			
			
			if(field instanceof ComboBox){
				((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
			}
			
		}
        
        toggleMenuItems();
    }
    
    private void deferTableUpdates(boolean defer) {
        this.deferTableUpdates = defer;
    }
    
    private ArrayList<AbstractField> getActiveGlobalFilters(){
        ArrayList<AbstractField> al = new ArrayList<AbstractField>();
        
        return al;
    }
    
    private Boolean hasGlobalFilters(ArrayList a){
        
        return (a.size() > 0);
        
    }
    
    private Boolean hasGlobalFilters(){
        
        return hasGlobalFilters(getActiveGlobalFilters());
        
    }
    
    /*************************** Config TBL ********************/

    private void configureTable() {
        tbl_data.setSelectable(true);
        tbl_data.setFilterOnDemand(false);
        tbl_data.setImmediate(true);
        tbl_data.setColumnCollapsingAllowed(false);
        tbl_data.setFooterVisible(true);
        tbl_data.setPageLength(1);
        try {
        	if(tableColsDefault.length > 0){
        		tbl_data.setVisibleColumns(tableColsDefault);
        	}
		} catch (Exception e) {

		}
        
        if(tbl_data.size() > 0){
            
//            StringSqlTimestampConverter date = new StringSqlTimestampConverter();
//            date.setDateFormat(DateFormat.SHORT);
//            
//            StringSqlTimestampConverter time = new StringSqlTimestampConverter();
//            time.setDateFormat(DateFormat.SHORT);
//            time.setTimeFormat(DateFormat.SHORT);
//            
//            tbl_data.setConverter("ST_CREATED", time);
//            tbl_data.setConverter("ST_UPDATED", time);
//            tbl_data.setConverter("ST_DATE", date);
//            
//            I18nConverter typeConverter = new I18nConverter("cust_protokoll_servicetasking_master_types", "STXT_ID", "STXT_KEY");
//            tbl_data.setConverter("ST_ID_TYPE", typeConverter);
//            
//            tbl_data.addGeneratedColumn("rx", new HtmlLabelColumnGenerator("rx", "rx_raw"));
            
        }
        
        userConverter = new UserConverter();
        
        DataviewGenerator gen = new DataviewGenerator();
        gen.addConverter("UA_ID_USER", userConverter);
        gen.attach(tbl_data);
        
        tbl_data.setFilterGenerator(new TableFilterGenerator(tbl_data));
        
        tableUpdater = new FilteringTableUpdater(tbl_data);
        tableUpdater.showSum();

        
        tbl_data.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                toggleMenuItems();
                
            }
        });
        toggleMenuItems();
        
        for (Object col : tableColsAll) {
        	
        	try {
        		tbl_data.setColumnExpandRatio(col, 1);
			} catch (Exception e) {
				
			}
        		
		}
        
//        tbl_data.setColumnExpandRatio("ST_ID", 0);
        
        
        
    }

    private void toggleMenuItems(){
        
        boolean crud = tbl_data.getValue() != null;
        
//        btn_create.setEnabled(crud);
//        btn_update.setEnabled(crud);
//        btn_read.setEnabled(crud);
        btn_delete.setEnabled(crud);
        
        
    }

    /*************************** Database ********************/
    
    /********************************/
    
    
    private void updateTable(){
        updateTable(false);
    }
    
    private void updateTable(Boolean ignoreFilter) {
        
        if(deferTableUpdates) {
            return;
        }
        
        if (ignoreFilter || !tbl_data.isFilterBarVisible()) {
            dbGetContainer();
            try{
            	if(tableColsDefault.length > 0){
            		tbl_data.setVisibleColumns(tableColsActive);
            	}
            }catch(Exception e){
                
            }
        }
        
        
    }
    
    private void deleteData(final Item item){
        
        I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
            
            @Override
            public void buttonClicked(ButtonId arg0) {
                if(ButtonId.YES == arg0) {
                    dbDeleteData(item);
                }
            }
        });
    }
    
    //TASK dbget
	private void dbGetContainer() {

	    CustomQuery q = new DBClass().CustomQuery;
        String sql = "select * from cms_user_attributes";
        q.setSqlString(sql);
        
        try {
        	Container container = q.query();
            
        	if (tableUpdater != null) {
                tableUpdater.updateTable(container);
            } else {
                tbl_data.setContainerDataSource(container);
            }
        	
		} catch (Exception e) {
			System.out.println("exception!");
			UI.getCurrent().getUI().removePollListener(pollListener);
		}
        
    }
    
    private void dbDeleteData(Item item){
    
        String val = MyUtils.getValueFromItem(item, "UA_VALUE", String.class);
        
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "delete from cms_user_attributes"
             + "\n " + "where UA_ID_USER = " + MyUtils.getValueFromItem(item, "UA_ID_USER", Integer.class)
             + "\n " + "    and UA_KEY = " + MyUtils.formatSqlValue(MyUtils.getValueFromItem(item, "UA_KEY", String.class))
             + "\n " + "    and UA_VALUE " + (val == null ? "IS NULL" : ("= " + MyUtils.formatSqlValue(val))); 
        q.setSqlString(sql);
        
        q.update();
        
        I18nManager.global(I18nGlobalNotifiers.entry_deleted);
        
        updateTable(true);

        
    }
    
    public static class UserConverter implements DataviewConverter<Integer>, TableFilterConverter{

        static final String caption = "user";
        IndexedContainer con;
        final HashMap<Integer, String> modelToPresentationMap = new HashMap<Integer, String>();
        
        public UserConverter() {
            
            CustomQuery q = new DBClass().CustomQuery;
            String sql = "select AUL_ID, CONCAT_WS(' ',"
                 + "\n " + "     IF(ASA_NAME = '', NULL, ASA_NAME),"
                 + "\n " + "     IF(AUL_VORNAME = '', NULL, AUL_VORNAME),"
                 + "\n " + "     AUL_NAME) as `user`"
                 + "\n " + "from cms_auth_stammdaten_user"
                 + "\n " + "left join cms_auth_stammdaten_anrede on AUL_ANREDE_ID = ASA_ID"
                 + "\n " + "where AUL_PASSWORT IS NOT NULL"
                 + "\n " + "order by AUL_NAME ASC";

            q.setSqlString(sql);
            
            con = MyUtils.convertIndex(q.query(), "AUL_ID");
            
            for (Object iid : con.getItemIds()) {
                modelToPresentationMap.put((Integer) iid
                    , MyUtils.getValueFromItem(con.getItem(iid), caption, String.class));
            }
        };
        
        @Override
        public Integer convertToModel(String value, Class<? extends Integer> targetType, Locale locale)
            throws com.vaadin.data.util.converter.Converter.ConversionException {
            return null;
        }

        @Override
        public String convertToPresentation(Integer value, Class<? extends String> targetType, Locale locale)
            throws com.vaadin.data.util.converter.Converter.ConversionException {
            return modelToPresentationMap.get(value) != null ? modelToPresentationMap.get(value) : value + "";
        }

        @Override
        public Class<Integer> getModelType() {
            return null;
        }

        @Override
        public Class<String> getPresentationType() {
            return null;
        }

        @Override
        public void attachDatasource(AbstractSelect select) {
        }

        @Override
        public IndexedContainer getContainer() {
            return con;
        }

        @Override
        public Object getItemCaptionProperty() {
            return caption;
        }
        
    }
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // mainContainer
        mainContainer = buildMainContainer();
        mainLayout.addComponent(mainContainer);
        mainLayout.setExpandRatio(mainContainer, 1.0f);
        mainLayout.setComponentAlignment(mainContainer, new Alignment(20));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildMainContainer() {
        // common part: create layout
        mainContainer = new VerticalLayout();
        mainContainer.setImmediate(false);
        mainContainer.setWidth("100.0%");
        mainContainer.setHeight("100.0%");
        mainContainer.setMargin(true);
        
        // menuSpacer
        menuSpacer = buildMenuSpacer();
        mainContainer.addComponent(menuSpacer);
        
        // globalFilterContainer
        globalFilterContainer = new HorizontalLayout();
        globalFilterContainer.setEnabled(false);
        globalFilterContainer.setImmediate(false);
        globalFilterContainer.setVisible(false);
        globalFilterContainer.setWidth("100.0%");
        globalFilterContainer.setHeight("80px");
        globalFilterContainer.setMargin(false);
        mainContainer.addComponent(globalFilterContainer);
        mainContainer.setComponentAlignment(globalFilterContainer, new Alignment(48));
        
        // tbl_data
        tbl_data = new FilterTable();
        tbl_data.setImmediate(true);
        tbl_data.setWidth("100.0%");
        tbl_data.setHeight("100.0%");
        mainContainer.addComponent(tbl_data);
        mainContainer.setExpandRatio(tbl_data, 1.0f);
        mainContainer.setComponentAlignment(tbl_data, new Alignment(20));
        
        return mainContainer;
    }

    @AutoGenerated
    private VerticalLayout buildMenuSpacer() {
        // common part: create layout
        menuSpacer = new VerticalLayout();
        menuSpacer.setImmediate(false);
        menuSpacer.setWidth("100.0%");
        menuSpacer.setHeight("40px");
        menuSpacer.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        menuSpacer.addComponent(men_frm);
        menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
        
        return menuSpacer;
    }
}
