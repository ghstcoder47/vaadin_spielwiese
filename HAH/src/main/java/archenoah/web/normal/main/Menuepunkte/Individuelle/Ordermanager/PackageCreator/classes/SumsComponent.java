package archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes;

import java.util.HashMap;
import java.util.Map.Entry;

import org.apache.commons.lang3.tuple.Pair;
import org.tepi.filtertable.FilterTable;

import archenoah.lib.vaadin.Components.table.DataViewSorter;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.form.PackageCreatorDataView.Packs;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.classes.ProductConverter;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.VerticalLayout;

public class SumsComponent extends CustomComponent {

    // {section fields}
    // ****************
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private TabSheet tabSheet_1;
    @AutoGenerated
    private FilterTable sizeSums;
    @AutoGenerated
    private FilterTable totalSums;
    
    
    private static String product = "product";
    private static String sum = "sum";
    
    private static String country = "country";
    private static String sizeName = "sizeId";
    private static String size = "size";
    
    
    private ProductConverter productConverter;
    private AutoPackager packager;
    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB product = set();
        static final I18nCB sum = set();
        static final I18nCB country = set();
        static final I18nCB sizeName = set();
        static final I18nCB size = set();
    }
    
    // {end fields}

    // {section constructors}
    // **********************
    public SumsComponent() {
        
        i18n = new I18nManager(this);
        
        setCompositionRoot(buildMainLayout());
        
        configureComponents();
        
        i18n.refresh();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public void setPackager(AutoPackager packager) {
        this.packager = packager;
    }
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    @SuppressWarnings("unchecked")
    public void setSums(HashMap<Integer, Integer> sums) {
        
        IndexedContainer con = new IndexedContainer();
        
        con.addContainerProperty(product, Integer.class, null);
        con.addContainerProperty(sum, Integer.class, null);
        
        for (Entry<Integer, Integer> entry : sums.entrySet()) {
            Item item = con.addItem(entry.getKey());
            item.getItemProperty(product).setValue(entry.getKey());
            item.getItemProperty(sum).setValue(entry.getValue());
        }
        
        totalSums.setContainerDataSource(con);
        
        configureSumsTable(con);
    }
    
    @SuppressWarnings("unchecked")
    public void setSizes(Packs packs) {
        
        IndexedContainer con = new IndexedContainer();
        
        con.addContainerProperty(country, String.class, null);
        con.addContainerProperty(product, Integer.class, null);
        con.addContainerProperty(sizeName, Integer.class, null);
        con.addContainerProperty(size, Integer.class, null);
        con.addContainerProperty(sum, Integer.class, null);
        
        for (Entry<String, HashMap<Pair<Integer, Integer>, Integer>> entry : packs.entrySet()) {
            
            for (Entry<Pair<Integer, Integer>, Integer> sentry : entry.getValue().entrySet()) {
                Item item = con.getItem(con.addItem());
                item.getItemProperty(country).setValue(entry.getKey());
                item.getItemProperty(product).setValue(sentry.getKey().getLeft());
                item.getItemProperty(sizeName).setValue(sentry.getKey().getRight());
                item.getItemProperty(size).setValue(sentry.getKey().getRight());
                item.getItemProperty(sum).setValue(sentry.getValue());
            }
            
        }
        
        sizeSums.setContainerDataSource(con);
        configureSizesTable(con);
        
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    private void configureComponents() {
        productConverter = new ProductConverter();
    }
    
    private void configureSumsTable(IndexedContainer con) {
        totalSums.setConverter(product, productConverter);
        
        totalSums.setColumnHeader(product, i18n.get(caption.product));
        totalSums.setColumnHeader(sum, i18n.get(caption.sum));
        
        con.setItemSorter(new DataViewSorter(totalSums));
        totalSums.sort(new Object[] {product}, new boolean[] {true});
        
        totalSums.setSortEnabled(false);
        totalSums.setSelectable(true);
    }
    
    private void configureSizesTable(IndexedContainer con) {
        
        sizeSums.setConverter(product, productConverter);
        
        if(packager != null) {
            sizeSums.setConverter(sizeName, packager.getNameConverter());
            sizeSums.setConverter(size, packager.getSizeConverter());
        }
        
        sizeSums.setColumnHeader(country, i18n.get(caption.country));
        sizeSums.setColumnHeader(product, i18n.get(caption.product));
        sizeSums.setColumnHeader(sizeName, i18n.get(caption.sizeName));
        sizeSums.setColumnHeader(size, i18n.get(caption.size));
        sizeSums.setColumnHeader(sum, i18n.get(caption.sum));
        
        sizeSums.setColumnExpandRatio(country, 0f);
        sizeSums.setColumnExpandRatio(product, 1f);
        sizeSums.setColumnExpandRatio(sizeName, 1f);
        sizeSums.setColumnExpandRatio(size, 0f);
        sizeSums.setColumnExpandRatio(sum, 0f);
        
        con.setItemSorter(new DataViewSorter(sizeSums));
        sizeSums.sort(new Object[] {country, product, sizeName, size}, new boolean[] {true});
        
        sizeSums.setSortEnabled(false);
        sizeSums.setSelectable(true);
    }
    // {end privatemethods}

    // {section database}
    // ******************
    // {end database}

    // {section layout}
    // ****************
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // tabSheet_1
        tabSheet_1 = buildTabSheet_1();
        mainLayout.addComponent(tabSheet_1);
        
        return mainLayout;
    }

    @AutoGenerated
    private TabSheet buildTabSheet_1() {
        // common part: create layout
        tabSheet_1 = new TabSheet();
        tabSheet_1.setImmediate(true);
        tabSheet_1.setWidth("100.0%");
        tabSheet_1.setHeight("100.0%");
        
        // totalSums
        totalSums = new FilterTable();
        totalSums.setImmediate(false);
        totalSums.setWidth("100.0%");
        totalSums.setHeight("100.0%");
        tabSheet_1.addTab(totalSums, "Gesamtsummen", null);
        
        // sizeSums
        sizeSums = new FilterTable();
        sizeSums.setImmediate(false);
        sizeSums.setWidth("100.0%");
        sizeSums.setHeight("100.0%");
        tabSheet_1.addTab(sizeSums, "Packungsgrößen", null);
        
        return tabSheet_1;
    }
    
    // {end layout}
}
