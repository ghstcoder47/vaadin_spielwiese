package archenoah.web.normal.main.Menuepunkte.Individuelle.Ordermanager.PackageCreator.classes;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map.Entry;

import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.web.normal.UserInfo.UserData;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.classes.ProjectNurseCombos;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.VerticalLayout;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.Icon;
import de.steinwedel.messagebox.MessageBox;
import de.steinwedel.messagebox.MessageBoxListener;

public class TicketContentsMover extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private ComboBox selectTicket;
    @AutoGenerated
    private ComboBox selectNurse;
    @AutoGenerated
    private ComboBox selectPatient;
    @AutoGenerated
    private ComboBox selectActions;
    // {section fields}
    // ****************
    private org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    private MessageBox messageBox;
    
    public enum Action {
        
        add,
        move,
        new_nurse,
        new_generic,
        new_patient,
        delete

    }
    
    private List<Item> selectedItems;
    private TicketDbActions dba;
    private Boolean usePopup;
    private HashMap<Object, String> componentMap;
//    private String formIdLng = "1081"; 
    private I18nManager i18n;
    
    // {end fields}

    private final static class caption extends I18nCB {
        static final I18nCB title = set();
        static final I18nCB action_add = set();
        static final I18nCB action_move = set();
        static final I18nCB action_new_nurse = set();
        static final I18nCB action_new_patient = set();
        static final I18nCB action_new_generic = set();
        static final I18nCB action_delete = set();
    }
    
    // {section constructors}
    // **********************
    
    public TicketContentsMover(Boolean usePopup) {
        this.dba = new TicketDbActions();
        this.usePopup = usePopup;
        init();
    }
    
    private void init() {

        buildMainLayout();
        i18n = new I18nManager(this);
        
        registerComponents();
        
        configureComponents();
        
    }

    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    
    public TicketDbActions getDbActions() {
        return this.dba;
    }
    
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    public void showMessageBox() {
        showMessageBox(null);
    }
    
    public void showMessageBox(final CloseAction closeAction) {
        
        fillOptions();
        
        MessageBoxListener mbl = new MessageBoxListener() {

            @Override
            public void buttonClicked(ButtonId buttonId) {

                Action action = null;
                Integer tid = null;
                Boolean close = false;
                
                if (buttonId.equals(ButtonId.OK)) {
                    
                    if(selectActions != null) {
                        action = (Action) selectActions.getValue();
                    }
                    
                    tid = processAction(action);
                    
                    close = (tid != null);
                    
                }else {
                    close = true;
                }
                
                if(close) {
                    messageBox.close();
                    if(closeAction != null) {
                        closeAction.onClose(action, tid);
                    }
                }
                
                
                
            }
        };

        messageBox = MessageBox.showCustomized(Icon.NONE, i18n.get("title"), mainLayout, mbl, ButtonId.CANCEL, ButtonId.OK);
        messageBox.getButton(ButtonId.OK).setEnabled(false);
        messageBox.setAutoClose(false);

        
    }

    // {end publicmethods}

    // {section privatemethods}
    // ************************

    private void registerComponents(){
        componentMap = new HashMap<Object, String>();
        new ComponentIterator(mainLayout).createMap(componentMap);
    }
    
    private void configureComponents() {
        
        for (Entry<Object, String> entry : componentMap.entrySet()) {
            AbstractField field = (AbstractField) entry.getKey();
            
            field.setImmediate(true);
            
            if(field instanceof ComboBox){
                ((ComboBox)field).setFilteringMode(FilteringMode.CONTAINS);
            }

        }
        
        ValueChangeListener vcl = new ValueChangeListener() {

            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Action action = (Action) selectActions.getValue();
                
                selectTicket.setVisible((action == Action.move || action == Action.add));
                selectTicket.setRequired((action == Action.move || action == Action.add));
                
                selectNurse.setVisible((action == Action.new_nurse));
                selectNurse.setRequired((action == Action.new_nurse));
                
                selectPatient.setVisible((action == Action.new_patient));
                selectPatient.setRequired((action == Action.new_patient));
                
                Boolean valid = (
                            selectActions.isValid()
                            && selectTicket.isValid()
                            && selectNurse.isValid()
                            && selectPatient.isValid()
                        );
                
                messageBox.getButton(ButtonId.OK).setEnabled(valid);

            }
        };
        
        ValueChangeListener ncl = new ValueChangeListener() {

            @Override
            public void valueChange(ValueChangeEvent event) {
                
                Action action = (Action) selectActions.getValue();
                
                if((action == Action.new_nurse)) {
                    selectNurse.setValue(dba.getUserId().toString());
                }
                if((action == Action.new_patient)) {
                    log.debug("should something happen here? (selected new_patient)");
                }

            }
        };
        
        selectActions.setRequired(true);
        selectActions.setItemCaptionPropertyId("caption");
        selectActions.setContainerDataSource(setupContainer());
        selectActions.addValueChangeListener(vcl);
        selectActions.addValueChangeListener(ncl);
        
        selectNurse.setVisible(false);
        selectNurse.setItemCaptionPropertyId("nurse");
        selectNurse.setContainerDataSource(setupContainer());
        selectNurse.addValueChangeListener(vcl);

        selectPatient.setVisible(false);
        selectPatient.setItemCaptionPropertyId("patient");
        selectPatient.setContainerDataSource(setupContainer());
        selectPatient.addValueChangeListener(vcl);
        
        selectTicket.setVisible(false);
        selectTicket.setItemCaptionPropertyId("caption");
        selectTicket.setContainerDataSource(setupContainer());
        selectTicket.addValueChangeListener(vcl);
    }

//    private HashMap<String, String> getDefaultActions() {
//
//        HashMap<String, String> actions = new LinkedHashMap<String, String>();
//
//        actions.put("action_delete", "entfernen");
//        actions.put("action_add", "in bestehendes Ticket einfügen");
//        actions.put("action_new_nurse", "neues Nurse-Ticket erstellen");
//        actions.put("action_new_generic", "neues generisches Ticket erstellen");
//
//        return actions;
//    }

    private IndexedContainer setupContainer() {

        IndexedContainer con = new IndexedContainer();
        con.addContainerProperty("caption", String.class, "");

        return con;
    }
    
    @SuppressWarnings("unchecked")
    private void fillOptions() {
        
        boolean isNurse = UserData.get().getNurse().isNurse();
        
        Container conActions = selectActions.getContainerDataSource();
        Container conTicket = selectTicket.getContainerDataSource();
        
        HashMap<Integer, String> availableTickets = dba.getAvailableTickets();
        ArrayList<Integer> contentIds = dba.getContentIds();
        
        if(availableTickets != null && contentIds == null) { // from Calendar
            conActions.addItem(Action.add).getItemProperty("caption").setValue(i18n.get("action_"+Action.add));
        }
        
        log.info("avail {}", availableTickets); //TASK is null when it should not be
        log.info("contentIds {}", contentIds);
        
        if(availableTickets != null && contentIds != null) { // from TicketContents
            conActions.addItem(Action.move).getItemProperty("caption").setValue(i18n.get("action_"+Action.move));
        }
        
        if(dba.getUserId() != null && dba.getUserId() != -1) {
            conActions.addItem(Action.new_nurse).getItemProperty("caption").setValue(i18n.get("action_"+Action.new_nurse));
        }
        if(!isNurse) {
            conActions.addItem(Action.new_patient).getItemProperty("caption").setValue(i18n.get("action_"+Action.new_patient));
        }
        if(!isNurse) {
            conActions.addItem(Action.new_generic).getItemProperty("caption").setValue(i18n.get("action_"+Action.new_generic));
        }
        
        if(dba.getContentIds() != null) {
            conActions.addItem(Action.delete).getItemProperty("caption").setValue(i18n.get("action_"+Action.delete));
        }
        
        // Tickets
        if(availableTickets != null) {
            
            for (Entry<Integer, String> entry : availableTickets.entrySet()) {
                
                conTicket.addItem(entry.getKey()).getItemProperty("caption").setValue(entry.getValue());
                
            }
            
        }
        
        ProjectNurseCombos nc = new ProjectNurseCombos();
        nc.setGetAllFields(true);
        
        Container con = null;
        if(isNurse) {
            con = nc.getNurseComboSingle(UserData.get().getNurse().getNurseId());
        }else {
            con = nc.getNurseComboAll();
        }
        
        selectNurse.setContainerDataSource(MyUtils.convertIndex(con, "KSK_U_ID"));
        
        selectPatient.setContainerDataSource(dbGetPatients());
    }
    
    private Container dbGetPatients() {
        
        CustomQuery q = new DBClass().CustomQuery;
        q.setSqlString("select PSL_ID, CONCAT(PSA_NAME, ' ', PSL_VORNAME, ' ', PSL_NAME) as patient"
             + "\n " + "from cust_patient_stammdaten_liste"
             + "\n " + "left join cust_patient_stammdaten_anrede on PSL_ANREDE = PSA_ID");
//        q.db.debugNextQuery(true);
        
        return MyUtils.convertIndex(q.query(), "PSL_ID");
    }
    
    public Integer processAction(Action action) {
        
        if(action == null) {
            return null;
        }
        
        Integer tid = null;
        
        switch (action) {
        
        case delete:
            
            dba.contentsDelete();
            tid = 0;
            break;
            
        case new_nurse:
            
            if(dba.getVirtualIds() != null) { // create ticket as from calendar
                dba.contentsCreate(tid = dba.ticketCreate());
            }
            
            if(dba.getContentIds() != null) { // create ticket and move contents
                if(selectNurse.getValue() != null) {
                    
                    Integer userId = dba.getUserId();
                    
                    dba.setUserId(Integer.parseInt((String) selectNurse.getValue()));
                    
                    dba.contentsMove(tid = dba.ticketCreate());
                    
                    dba.setUserId(userId);
                }
                
            }
            
            break;
            
        case new_patient:
            
            log.info("new patient, container {}", dba.getStandaloneContainer());
            
            if(dba.getStandaloneContainer() != null) { // create ticket as from calendar
                // patient id is set in fillContents()
                dba.contentsCreate(tid = dba.ticketCreate());
            }
            
            
            if(dba.getContentIds() != null) { // create ticket and move contents
                
                if(selectPatient.getValue() != null) {
                    dba.setPatientId((Integer) selectPatient.getValue());
                    dba.contentsMove(tid = dba.ticketCreate());
                }
                
            }else {
                
                
            }
            
            break;
            
        case new_generic:
            
            if(dba.getVirtualIds() != null) { // create ticket as from calendar
                dba.contentsCreate(tid = dba.ticketCreateBlank());
            }
            
            if(dba.getContentIds() != null) { // create ticket and move contents 
                dba.contentsMove(tid = dba.ticketCreateBlank());
            }
            
            break;
            
        case move:
            
            dba.contentsMove(tid = (Integer) selectTicket.getValue());
            
            break;
            
        case add:
            
            dba.contentsCreate(tid = (Integer) selectTicket.getValue());
            
            break;
            
        default:
            break;
        }
        
        return tid;
        
    }
    

    // {end privatemethods}

    
    // {section classes}
    // ******************
    
    public abstract class CloseAction {
        
        public abstract void onClose(Action action, Integer tid);
        
    }
    
    // {end database}
    
    // {section database}
    // ******************
    // {end database}

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // selectActions
        selectActions = new ComboBox();
        selectActions.setCaption("Aktion wählen");
        selectActions.setImmediate(false);
        selectActions.setWidth("100.0%");
        selectActions.setHeight("-1px");
        mainLayout.addComponent(selectActions);
        mainLayout.setComponentAlignment(selectActions, new Alignment(48));
        
        // selectNurse
        selectNurse = new ComboBox();
        selectNurse.setCaption("Nurse");
        selectNurse.setImmediate(false);
        selectNurse.setWidth("100.0%");
        selectNurse.setHeight("-1px");
        mainLayout.addComponent(selectNurse);
        mainLayout.setComponentAlignment(selectNurse, new Alignment(48));
        
        // selectPatient
        selectPatient = new ComboBox();
        selectPatient.setCaption("Patient");
        selectPatient.setImmediate(false);
        selectPatient.setWidth("100.0%");
        selectPatient.setHeight("-1px");
        mainLayout.addComponent(selectPatient);
        mainLayout.setComponentAlignment(selectPatient, new Alignment(48));
        
        // selectTicket
        selectTicket = new ComboBox();
        selectTicket.setCaption("Ticket");
        selectTicket.setImmediate(false);
        selectTicket.setWidth("100.0%");
        selectTicket.setHeight("-1px");
        mainLayout.addComponent(selectTicket);
        mainLayout.setComponentAlignment(selectTicket, new Alignment(48));
        
        return mainLayout;
    }
}
