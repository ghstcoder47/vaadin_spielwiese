package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.expenses.form;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.joda.time.LocalDateTime;
import org.joda.time.Period;
import org.joda.time.PeriodType;
import org.joda.time.format.PeriodFormatter;
import org.joda.time.format.PeriodFormatterBuilder;
import org.jsoup.Jsoup;
import org.jsoup.safety.Whitelist;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.ComponentIterator;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.tool.comunication.email.Mailer;
import archenoah.lib.tool.comunication.email.Mailer.MAIL_TYPE;
import archenoah.lib.tool.comunication.email.MailerGroup;
import archenoah.lib.tool.templating.TemplatingRenderer;
import archenoah.lib.vaadin.Components.Fields.BooleanComboBox;
import archenoah.lib.vaadin.Components.Fields.CustomDurationPicker;
import archenoah.lib.vaadin.Components.Fields.CustomTimePicker;
import archenoah.lib.vaadin.Components.Steppers.FloatStepper;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.valchecker.val_checker4;
import archenoah.web.normal.UserInfo.UserData;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektuebersicht.servicetasking.modules.ModuleComponent;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.Panel;
import com.vaadin.ui.PopupDateField;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

@SuppressWarnings({ "serial", "rawtypes", "unchecked" })
public class ExpensesInsertEdit extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private VerticalLayout mainLayout;

	@AutoGenerated
	private HorizontalLayout buttons;

	@AutoGenerated
	private Button btn_save_new;

	@AutoGenerated
	private Button btn_save;

	@AutoGenerated
	private Button reset;

	@AutoGenerated
	private VerticalLayout main;

	@AutoGenerated
	private Panel panel_1;

	@AutoGenerated
	private VerticalLayout verticalLayout_4;

	@AutoGenerated
	private VerticalLayout verticalLayout_2;

	@AutoGenerated
	private TextArea CED_DECLINE_COMMENT;

	@AutoGenerated
	private TextArea CED_COMMENT;

	@AutoGenerated
	private Label infoMessage;

	@AutoGenerated
	private HorizontalLayout horizontalLayout_2;

	@AutoGenerated
	private IntStepper CED_DAYS;

	@AutoGenerated
	private FloatStepper CED_EXPENSES;

	@AutoGenerated
	private IntStepper CED_KM;

	@AutoGenerated
	private CustomTimePicker CED_FAHRZEIT;

	@AutoGenerated
	private CustomDurationPicker CED_SERVICEZEIT;

	@AutoGenerated
	private CustomTimePicker CED_END;

	@AutoGenerated
	private CustomTimePicker CED_START;

	@AutoGenerated
	private HorizontalLayout horizontalLayout_1;

	@AutoGenerated
	private BooleanComboBox CED_BILLABLE;

	@AutoGenerated
	private ComboBox CED_COORDINATORS;

	@AutoGenerated
	private HorizontalLayout horizontalLayout_4;

	@AutoGenerated
	private ComboBox CED_ACTIVITY;

	@AutoGenerated
	private ComboBox CED_PROJECT;

	@AutoGenerated
	private PopupDateField CED_DATE;

	@AutoGenerated
	private HorizontalLayout horizontalLayout_3;

	@AutoGenerated
	private ComboBox CED_STATUS;

	@AutoGenerated
	private ComboBox CED_CONTRACT;

	@AutoGenerated
	private TextField CED_USER;

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	/**
	 * The constructor should first build the main layout, set the composition
	 * root and then do any custom initialization.
	 * 
	 * The constructor will not be automatically regenerated by the visual
	 * editor.
	 */

	/**************** --> Allgemein <--- ********************/
	// Allgemein
	org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());

	// Datenbank
	private Map<Object, String> componentMap;
	// private Map<Object, String> dbMap;
	private Map<Object, String> validateMap;
	private Form_Bind fb;
	private String dataSetId = "";

	// Berrechtigung
	private Integer permRead;
	private Integer permUpdate;
	private Integer permCreate;
	private Integer permDelete;

	private MenuItem tmpMenu = null;
	private Button tmpButton = null;
	/******************************************************/
	/**************** --> Tabsheetvars <--- *****************/
	private TabSheet tab = null;
	/******************************************************/
	/**************** --> Windowvars <--- *******************/
	private Window win = null;
	/******************************************************/
	/******************* --> Custom <--- ********************/
	/******************************************************/

	/************ ----->Einstellungen<-- ********************/
	// private final String formIdLng = "6011";
	private final String formIdPerm = "715";
	private final String Windows_Height = "700px";
	private final String Windows_Width = "570px";

	private final String dataTableName = "cust_expenses_data";

	private HashMap<Object, String> dbMap;

	private final String dataIdCol = "CED_ID";
	private Item dataSetItem;

	private boolean regionalManager = false;
	private Integer ticketId = null;

	private ModuleComponent moduleComponent;

	private I18nManager i18n;
	
	private static List<Integer> notifyOnStatus = Arrays.asList(5,6);
	
	private final static class caption extends I18nCB {
	    static final I18nCB unknown = set();
        static final I18nCB mail_subject = set();
	}
	
	PeriodFormatter formatter = new PeriodFormatterBuilder().printZeroAlways().minimumPrintedDigits(2)
			.appendHours().appendLiteral(":").appendMinutes().toFormatter();
	
	/******************************************************/

	public ExpensesInsertEdit(MenuItem Arg_Menü, String Arg_Form_ID) {
		tmpMenu = Arg_Menü;
		dataSetId = Arg_Form_ID;
	}

	public ExpensesInsertEdit(Button Arg_btn, String Arg_Form_ID) {
		tmpButton = Arg_btn;
		dataSetId = Arg_Form_ID;
	}

	/********* INIT-Window ************/
	public void init() {
		if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
			System.out.println("Form Einstellung Fehlt: !!!");
			return;
		}

		Standard_Init();

		String fid = dataSetId;
		if (fid != "") {
			fid = " - #" + fid;
		}

		if (tmpMenu != null) {

			String Recourcename = null;
			ThemeResource resource = null;
			if (tmpMenu.getIcon() != null) {
				Recourcename = tmpMenu.getIcon().toString();
				Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";
				resource = new ThemeResource(Recourcename);
			}

			Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText() + fid, mainLayout, Windows_Height,
					Windows_Width, resource);
			win = bwb.ReturnWindow();
		}
		if (tmpButton != null) {
			Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption() + fid, mainLayout, Windows_Height,
					Windows_Width, tmpButton.getIcon());
			win = bwb.ReturnWindow();
		}

	}

	/********* INIT-Tray ************/
	public void init(TabSheet Arg_tab) {

		Standard_Init();
		tab = Arg_tab;
		if (tmpMenu != null) {
			new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
		}
		if (tmpButton != null) {
			new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
		}

	}

	public Window getWindow() {
		return win;
	}

	public TabSheet getTabSheet() {
		return tab;
	}

	/********* Init-Standard ************/
	private void Standard_Init() {
		buildMainLayout();
		i18n = new I18nManager(this);

		// System.out.println(UserData.get().getUserId());

		fb = new Form_Bind();

		registerComponents();

		fillFields();
		fillDbMap();

		setCustomValidators();
		fillValidateMap();

		/***************/

		configureComponents();

		if (dataSetId != "") {

			dbFillForm();
			if (isBasicUser() && ((int) CED_STATUS.getValue() >= 2 && (int) CED_STATUS.getValue() != 5)) {

				setPermissions(0, 1, 0, 0);

			}

		} else {
			CED_USER.setValue(UserData.get().getUserName());
			existExpense();
			// TASK "create init"

		}

		limitStatusPicker();
		limitActivityPicker();
		
		setMenuPermissions();
		setEventListeners();

	}

	private boolean isBasicUser() {

		return (!UserData.get().getExpenseChecking().isExpenseChecking() && !UserData.get().getCS().isCS()
				&& !UserData.get().hasGroup(1));
	}
	
	private void existExpense(){
		
		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
			+ "\n " + "	CED_CONTRACT"
			+ "\n " + "FROM" 
			+ "\n " + "	cust_expenses_data"
			+ "\n " + "WHERE" 
			+ "\n "	+ "	cust_expenses_data.CED_ID_USER = " + UserData.get().getUserId()
			+ "\n " + "ORDER BY" 
			+ "\n " + "	CED_DATE DESC" 
			+ "\n " + "LIMIT 1";

		q.setSqlString(sql);

		Container con = q.query();

		if (con.size() > 0) {
			
			CED_CONTRACT.setValue(MyUtils.getFirstValueFromContainer(con, "CED_CONTRACT", Integer.class));
			
		}

		
	}

	// register components for lng and validation tools
	private void registerComponents() {
		componentMap = new HashMap<Object, String>();
		new ComponentIterator(main).createMap(componentMap);
	}

	private void configureComponents() {

		for (Entry<Object, String> entry : componentMap.entrySet()) {

			AbstractComponent field = (AbstractComponent) entry.getKey();

			field.setImmediate(true);

			if (field instanceof ComboBox) {
				((ComboBox) field).setFilteringMode(FilteringMode.CONTAINS);
			}

		}

		
		CED_USER.setEnabled(false);
		CED_USER.setStyleName("nogrey");

		CED_STATUS.setItemCaptionPropertyId("SS_NAME");
		CED_STATUS.setNullSelectionAllowed(false);
		CED_STATUS.select(1);

		CED_BILLABLE.setRequired(true);
		CED_BILLABLE.setNullSelectionItemId(null);
		CED_BILLABLE.setItemCaption(-1, i18n.get(caption.unknown));
		
//		CED_DATE.setRangeEnd(new LocalDate().toDate());
		
		CED_ACTIVITY.setItemCaptionPropertyId("CEA_ACTIVITY");
		CED_ACTIVITY.setNullSelectionAllowed(false);

		CED_CONTRACT.setItemCaptionPropertyId("UES_TYP");
		CED_CONTRACT.setNullSelectionAllowed(true);
		
		CED_DAYS.setVisible(false);
		CED_DAYS.setEnabled(false);
		CED_DAYS.setMaxValue(60);
		
		CED_COORDINATORS.setItemCaptionPropertyId("CEC_ROLE");
		
		CED_PROJECT.setItemCaptionPropertyId("PSLV_NAME");

		CED_EXPENSES.setEnabled(false);
		CED_EXPENSES.setVisible(false);
		CED_EXPENSES.setMinValue(0f);
		CED_EXPENSES.setStepAmount(0.01f);
		CED_EXPENSES.setNumberOfDecimals(2);
		CED_EXPENSES.setNullValueAllowed(true);
		
		CED_KM.setEnabled(false);
		CED_KM.setVisible(false);
		CED_KM.setMinValue(0);
		CED_KM.setNullValueAllowed(true);
		
		CED_FAHRZEIT.setEnabled(false);
		CED_FAHRZEIT.setVisible(false);

		CED_SERVICEZEIT.setEnabled(false);
		CED_SERVICEZEIT.setVisible(false);

		CED_START.setEnabled(false);
		CED_START.setVisible(false);
		CED_START.setUpperBound(CED_END);
		
		CED_END.setEnabled(false);
		CED_END.setVisible(false);
		CED_END.setLowerBound(CED_START);
		
		CED_DECLINE_COMMENT.setEnabled(false);
		CED_DECLINE_COMMENT.setVisible(true);
		
		showInfoMessage(null);
		
	}

	private void limitStatusPicker(){
		((IndexedContainer) CED_STATUS.getContainerDataSource()).addContainerFilter(new Filter() {
			
			boolean isBasic = isBasicUser();
			
			@Override
			public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
			
				int selectedStatus = (Integer) CED_STATUS.getValue();
				int itemStatus = MyUtils.getValueFromItem(item, "id", Integer.class);
				
				if(isBasic){
					
					if(selectedStatus <= 2){
						return itemStatus <= 2;
					}
					
					if(selectedStatus == 5){
						return itemStatus == 2 || itemStatus == 5;
					}
				}

				return true;

			}
			
			@Override
			public boolean appliesToProperty(Object propertyId) {
				return false;
			}
		});
	}
	
	
	private void limitActivityPicker(){
		IndexedContainer con = (IndexedContainer) CED_ACTIVITY.getContainerDataSource();
		con.removeAllContainerFilters();
		
		con.addContainerFilter(new Filter() {
			
			@Override
			public boolean passesFilter(Object itemId, Item item) throws UnsupportedOperationException {
				// FIXME Auto-generated method stub
				
				Integer selectedContract = (Integer) CED_CONTRACT.getValue();
				
				return MyUtils.getValueFromItem(item, "id", Integer.class) != 12 || MyUtils.equalsWithNulls(selectedContract, 1);
				
			}
			
			@Override
			public boolean appliesToProperty(Object propertyId) {
				// FIXME Auto-generated method stub
				return false;
			}
		});
	}
	

	/*************************** Events *******************************/

	private void setEventListeners() {

		CED_CONTRACT.addValueChangeListener(new ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				// FIXME Auto-generated method stub

				if(!MyUtils.equalsWithNulls(event.getProperty().getValue(), 1) && MyUtils.equalsWithNulls(CED_ACTIVITY.getValue(), 12))
					CED_ACTIVITY.setValue(null);
				
				limitActivityPicker();
				
			}
		});
		
		CED_STATUS.addValueChangeListener(new ComboBox.ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				// FIXME Auto-generated method stub
								
				if((Integer) event.getProperty().getValue() == 5 || (Integer) event.getProperty().getValue() == 6){
					
					CED_DECLINE_COMMENT.setEnabled(true);
					CED_DECLINE_COMMENT.setRequired(true);
					
				}else{
					CED_DECLINE_COMMENT.setEnabled(false);
					CED_DECLINE_COMMENT.setRequired(false);
				}
				
			}
		});
		
		CED_ACTIVITY.addValueChangeListener(new ComboBox.ValueChangeListener() {

			@Override
			public void valueChange(ValueChangeEvent event) {
				// TODO Auto-generated method stub

				Integer value = (Integer) event.getProperty().getValue();
				showFields(value == null ? 0 : (Integer) CED_ACTIVITY.getItem(value).getItemProperty("CEA_COST").getValue());
				
				boolean powerAllowance = checkExistingPowerAllowance();

				btn_save.setEnabled(powerAllowance);
				btn_save_new.setEnabled(powerAllowance);

				if(MyUtils.equalsWithNulls(value, 12)){
					showInfoMessage("Angabe des Zeitraums in Beschreibung erforderlich!");
				}else{
					showInfoMessage(null);
				}
			}
		});

		CED_DATE.addValueChangeListener(new ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				// FIXME Auto-generated method stub

				Integer value = (Integer) CED_ACTIVITY.getValue();
				showFields(value == null ? 0 : (Integer) CED_ACTIVITY.getItem(value).getItemProperty("CEA_COST").getValue());
				
				boolean powerAllowance = checkExistingPowerAllowance();

				btn_save.setEnabled(powerAllowance);
				btn_save_new.setEnabled(powerAllowance);
				
			}
		});
		
		CED_START.addValueChangeListener(new ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				// FIXME Auto-generated method stub
				
				CED_SERVICEZEIT.setValue(calcTimeDiff((String) event.getProperty().getValue(), CED_END.getValue()));
				
			}
		});
		
		CED_END.addValueChangeListener(new ValueChangeListener() {
			
			@Override
			public void valueChange(ValueChangeEvent event) {
				// FIXME Auto-generated method stub
				
				CED_SERVICEZEIT.setValue(calcTimeDiff(CED_START.getValue(), (String) event.getProperty().getValue()));
				
			}
		});
		
		btn_save.addClickListener(new ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub

				if (!validate()) {
					I18nManager.global(I18nGlobalNotifiers.fields_empty);
					return;
				}
				if (dataSetId.equals("") == true) {

					dataSetId = Integer.toString(dbInsert());

				} else {

					dbUpdate();
					handleMailNotifcation();

				}

				UI.getCurrent().getUI().removeWindow(win);

			}
		});

		btn_save_new.addClickListener(new ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub

				if (!validate()) {
					I18nManager.global(I18nGlobalNotifiers.fields_empty);
					return;
				}
				if (dataSetId.equals("") == true) {

					dataSetId = Integer.toString(dbInsert());

				} else {

					dbUpdate();

				}

				final Collection<CloseListener> cls = (Collection<CloseListener>) win.getListeners(CloseEvent.class);

				win.addCloseListener(new CloseListener() {

					@Override
					public void windowClose(CloseEvent e) {

						ExpensesInsertEdit pie = new ExpensesInsertEdit(tmpMenu, "");
						pie.setPermissions(permCreate, permRead, permUpdate, permDelete);
						pie.init();
						for (CloseListener tcl : cls) {
							pie.getWindow().addCloseListener(tcl);
						}

					}

				});
				UI.getCurrent().getUI().removeWindow(win);

			}
		});

		reset.addClickListener(new ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub

				UI.getCurrent().getUI().removeWindow(win);

			}
		});
		
	}

	
	private boolean checkExistingPowerAllowance(){
				
		if(CED_ACTIVITY.getValue() != null){
			if((Integer) CED_ACTIVITY.getValue() == 15 || (Integer) CED_ACTIVITY.getValue() == 16){
				CustomQuery q = new DBClass().CustomQuery;
				
				String sql = "SELECT"
				 + "\n " + "	CED_ID_CEA"
				 + "\n " + "FROM"
				 + "\n " + "	cust_expenses_data"
				 + "\n " + "WHERE"
				 + "\n " + "	CED_ID_USER = " + UserData.get().getUserId()
				 + "\n " + "	AND (CED_ID_CEA = 15 OR CED_ID_CEA = 16)"
				 + "\n " + "	AND (YEAR(CED_DATE) = YEAR('" + MyUtils.formatSqlDate(CED_DATE.getValue()) + "') AND MONTH(CED_DATE) = MONTH('" + MyUtils.formatSqlDate(CED_DATE.getValue()) + "'))";
				
				q.setSqlString(sql);
		
//				q.db.debugNextQuery(true);
				
				Container con = q.query();
				
				if (con.size() != 1) {
					
					return true;
		
				}else{
					
					return false;
		
				}	
			}else{
				return true;
			}
		}
			
		return false;
		
		

	}
	
	/******************************************************************/
	/************************ --> Berrechtigung <-- **************************/

	@SuppressWarnings("unused")
	public void setPermissionsFromDatabase() {
		if (formIdPerm == "") {
			System.out.println("Form Einstellung Fehlt: Berechtigung");
			return;
		}

		Rechteholen r = new Rechteholen(UserData.get().getUserId() + "");
		String[][] perms = r.Datenholen();

		for (int i = 0; i < perms.length; i++) {
			if (perms[i][0].equals(formIdPerm) == true) {

				permRead = Integer.valueOf(perms[i][3]);
				permUpdate = Integer.valueOf(perms[i][4]);
				permCreate = Integer.valueOf(perms[i][6]);
				permDelete = Integer.valueOf(perms[i][5]);

			}
		}
	}

	public void setPermissions(int create, int read, int update, int delete) {

		permCreate = create;
		permRead = read;
		permUpdate = update;
		permDelete = delete;

	}

	private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);
        
        btn_save.setEnabled(c||u);
        btn_save_new.setEnabled(c||u);
                
        if(!(c||u)){
        	setFieldsDisabled();
        }

        if(UserData.get().getExpenseChecking().isExpenseChecking() && u && !UserData.get().getNurse().isNurse()){
			
			setFieldsDisabled();
			CED_STATUS.setEnabled(true);
			CED_STATUS.setStyleName("");
			
			btn_save_new.setVisible(false);
			
		}

	}

	public void setFieldsDisabled(){
		for (Object component : componentMap.keySet()) {
			if(component == reset 
				|| component == btn_save
				|| component == btn_save_new){
				continue;
			}
		
			if (component instanceof AbstractComponent) {
				
				((AbstractComponent) component).setEnabled(false);
				((AbstractComponent) component).setStyleName("nogrey");
				
			}
        }

	}
	
	public void setRegionalManagerEnabled(Boolean enabled) {
		regionalManager = enabled;
	}

	public void setResetEnabled(boolean enabled) {
		reset.setEnabled(enabled);
		reset.setVisible(enabled);
	}

	/***********************************************/

	private void configureTable() {

	}

	private void fillFields() {
		dbFillContract();
		dbFillStatus();
		dbFillActivity();
		dbFillCoordinator();
		dbFillProject();
	}
	
	private String dbGetUserMail() {
	    CustomQuery q = new DBClass().CustomQuery;
        String sql = "select AUL_EMAIL from cms_auth_stammdaten_user where AUL_ID = "
            + MyUtils.getValueFromItem(dataSetItem, "CED_ID_USER", Integer.class);
        q.setSqlString(sql);
//        q.db.debugNextQuery(true);
        
        Container con = q.query();
        
        return MyUtils.getValueFromItem(MyUtils.getFirstItemFromContainer(con), "AUL_EMAIL", String.class);
        
	}
	
	private void dbFillForm() {

		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
		    + "\n " + "	CED_ID" 
			+ "\n " + "	, CED_ID_USER" 
			+ "\n " + "	, CED_CREATED" // used for table
			+ "\n " + "	, CONCAT(AUL_VORNAME, ' ', AUL_NAME) AS CED_USER" 
			+ "\n " + "	, CED_STATUS" 
			+ "\n "	+ "	, CED_DATE" 
			+ "\n " + "	, CED_ID_CEA" 
			+ "\n "	+ "	, CED_START" 
			+ "\n " + "	, CED_END" 
			+ "\n " + "	, CED_SERVICEZEIT" 
			+ "\n " + "	, CED_FAHRZEIT"
			+ "\n " + "	, CED_KM" 
			+ "\n " + "	, CED_AMOUNT" 
			+ "\n " + "	, CED_ID_CEC" 
			+ "\n "	+ "	, CED_ID_PROJECT" 
			+ "\n " + "	, CED_COMMENT" 
			+ "\n " + "	, CEA_COST" 
			+ "\n "	+ "	, CED_STATUS_BILLABLE" 
			+ "\n "	+ "	, CED_DECLINE_COMMENT" 
			+ "\n " + " , CED_DAYS"
			+ "\n " + " , CED_CONTRACT"
			+ "\n " + "FROM" 
			+ "\n " + "	cust_expenses_data" 
			+ "\n "	+ "LEFT JOIN cust_expenses_activity ON CED_ID_CEA = CEA_ID" 
			+ "\n "	+ "LEFT JOIN cms_auth_stammdaten_user ON CED_ID_USER = AUL_ID" 
			+ "\n " + "WHERE" 
			+ "\n "	+ "	cust_expenses_data.CED_ID = " + dataSetId;

		q.setSqlString(sql);

		Container con = q.query();

		if (con.size() > 0) {

			fb = new Form_Bind();
			fb.Get_and_Fill(con, dbMap);

			dataSetItem = MyUtils.getItemFromContainer(con, "CED_ID", Integer.parseInt(dataSetId));

			CED_USER.setValue(MyUtils.getValueFromItem(dataSetItem, "CED_USER", String.class));
			
			showFields(MyUtils.getValueFromItem(dataSetItem, "CEA_COST", Integer.class));

		}

	}

	private void dbFillContract(){
		
		CustomQuery q = new DBClass().CustomQuery;
		
		String sql = "SELECT "
			 + "\n " + "	cust_user_employments.UES_ID AS id,"
			 + "\n " + "	cust_user_employments.UES_TYP "
			 + "\n " + "FROM "
			 + "\n " + "	cust_user_employments";

		q.setSqlString(sql);
		
		CED_CONTRACT.setContainerDataSource(MyUtils.convertIndex(q.query(), "id"));
		
	}
	
	private void dbFillStatus() {

		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
			+ "\n " + "    cust_schulung_status.SS_PROZESS AS id," 
			+ "\n "	+ "    cust_schulung_status.SS_NAME" 
			+ "\n " + "FROM" 
			+ "\n " + "    cust_schulung_status" 
			+ "\n "	+ "WHERE" 
			+ "\n " + "    SS_CODE = 'EXP'"
			+ "\n " + "AND"
			+ "\n " + "    SS_PROZESS != 4"; // ignore closed for now

		q.setSqlString(sql);

		CED_STATUS.setContainerDataSource(MyUtils.convertIndex(q.query(), "id"));

	}

	private void dbFillActivity() {

		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
			+ "\n "	+ "    cust_expenses_activity.CEA_ID AS id," 
			+ "\n "	+ "    cust_expenses_activity.CEA_ACTIVITY," 
			+ "\n " + "    cust_expenses_activity.CEA_COST" 
			+ "\n "	+ "FROM" 
			+ "\n " + "    cust_expenses_activity";

		q.setSqlString(sql);

		CED_ACTIVITY.setContainerDataSource(MyUtils.convertIndex(q.query(), "id"));

	}

	private void dbFillCoordinator() {

		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
			+ "\n " + "    cust_expenses_coordinators.CEC_ID AS id," 
			+ "\n "	+ "    cust_expenses_coordinators.CEC_ROLE" 
			+ "\n " + "FROM" 
			+ "\n " + "    cust_expenses_coordinators";

		q.setSqlString(sql);

		CED_COORDINATORS.setContainerDataSource(MyUtils.convertIndex(q.query(), "id"));

	}

	private void dbFillProject() {

		CustomQuery q = new DBClass().CustomQuery;

		String sql = "SELECT" 
			+ "\n " + "    cust_projekte_stammdaten_liste.PSLV_ID AS id," 
			+ "\n "	+ "    cust_projekte_stammdaten_liste.PSLV_NAME" 
			+ "\n " + "FROM" 
			+ "\n "	+ "    cust_projekte_stammdaten_liste" 
			+ "\n " + "WHERE" 
			+ "\n "	+ "    PSLV_CODE = 'FOR'" 
			+ "\n "	+ "    OR PSLV_CODE = 'POP'" 
			+ "\n "	+ "    OR PSLV_CODE = 'SA'" 
			+ "\n "	+ "    OR PSLV_CODE = 'INT'" 
			+ "\n "	+ "    OR PSLV_CODE = 'EXP'" 
			+ "\n "	+ "order by if(PSLV_CODE = 'INT', 0, PSLV_NAME) ASC" 
			;

		q.setSqlString(sql);

		CED_PROJECT.setContainerDataSource(MyUtils.convertIndex(q.query(), "id"));

	}

	private void fillDbMap() {

		String table = dataTableName + ":";

		dbMap = new HashMap<>();
		dbMap.put(CED_STATUS, table + "CED_STATUS");
		dbMap.put(CED_DATE, table + "CED_DATE");
		dbMap.put(CED_PROJECT, table + "CED_ID_PROJECT");
		dbMap.put(CED_ACTIVITY, table + "CED_ID_CEA");
		dbMap.put(CED_COORDINATORS, table + "CED_ID_CEC");
		dbMap.put(CED_BILLABLE, table + "CED_STATUS_BILLABLE");
		dbMap.put(CED_FAHRZEIT, table + "CED_FAHRZEIT");
		dbMap.put(CED_START, table + "CED_START");
		dbMap.put(CED_END, table + "CED_END");
		dbMap.put(CED_SERVICEZEIT, table + "CED_SERVICEZEIT");
		dbMap.put(CED_KM, table + "CED_KM");
		dbMap.put(CED_EXPENSES, table + "CED_AMOUNT");
		dbMap.put(CED_COMMENT, table + "CED_COMMENT");
		dbMap.put(CED_DECLINE_COMMENT, table + "CED_DECLINE_COMMENT");
		dbMap.put(CED_DAYS, table + "CED_DAYS");
		dbMap.put(CED_CONTRACT, table + "CED_CONTRACT");

	}

	private int dbInsert(){

		if((Integer) CED_ACTIVITY.getValue() == 12){
			dbMap.remove(CED_SERVICEZEIT, dataTableName + ":" + "CED_SERVICEZEIT");
		}
		
		DBClass db = new DBClass();
		
		fb = new Form_Bind();
		fb.Insert(db, dbMap);

		db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
		
		db.DB_Data_Insert.DB_Daten.DB_Data(dataTableName, "CED_ID_USER", UserData.get().getUserId().toString());
		
		if((Integer) CED_ACTIVITY.getValue() == 12){
			db.DB_Data_Insert.DB_Daten.DB_Data(dataTableName, "CED_SERVICEZEIT", calcTime());
		}

//		db.DB_Data_Insert.DB_DEBUG_SQL_STRING();
		return db.DB_Data_Insert.DB_Insert();
	}

	private void dbUpdate() {
		DBClass db = new DBClass();
		fb = new Form_Bind();
		fb.Update(db, dbMap);

		db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln(dataTableName);
		
		if((Integer) CED_STATUS.getValue() == 3 && checkChanges()){	
			db.DB_Data_Update.DB_Daten.DB_Data(dataTableName, "CED_STATUS_CHECKED_DATE", MyUtils.formatSqlDate(new LocalDateTime()));
			db.DB_Data_Update.DB_Daten.DB_Data(dataTableName, "CED_STATUS_CHECKED_ID_USER", UserData.get().getUserId().toString());	
		}
		
		if((Integer) CED_ACTIVITY.getValue() == 12){
			db.DB_Data_Update.DB_Daten.DB_Data(dataTableName, "CED_SERVICEZEIT", calcTime());
		}
		
		db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein(dataTableName, dataIdCol, "=", dataSetId, "");
		
		
//		 db.DB_Data_Update.DB_DEBUG_SQL_STRING();
		db.DB_Data_Update.DB_Update();

	}
	
	private String calcTimeDiff(String start, String end){
		
		if(start == null || end == null){
			start = "00:00";
			end = "00:00";
		}
		
    	PeriodFormatter parser = new PeriodFormatterBuilder().appendHours().appendLiteral(":").appendMinutes().appendLiteral(":").appendSeconds().toFormatter();
    	Period period = Period.ZERO;
    	
    	period = period.plus(parser.parsePeriod(end + ":00"));
		period = period.minus(parser.parsePeriod(start + ":00"));
    	
    	PeriodFormatter printer = new PeriodFormatterBuilder().printZeroAlways().minimumPrintedDigits(2).appendHours().appendLiteral(":").appendMinutes().toFormatter();
    	
		return printer.print(period.normalizedStandard(PeriodType.time()));
	}

	private String calcTime(){
    	PeriodFormatter parser = new PeriodFormatterBuilder().appendHours().appendLiteral(":").appendMinutes().appendLiteral(":").appendSeconds().toFormatter();
    	Period period = Period.ZERO;
    	
    	for(int x = 0; x < CED_DAYS.getValue(); x++){
    		
    		period = period.plus(parser.parsePeriod("01:12:00"));

    	}
    	
    	PeriodFormatter printer = new PeriodFormatterBuilder().printZeroAlways().minimumPrintedDigits(2).appendHours().appendLiteral(":").appendMinutes().toFormatter();

    	return printer.print(period.normalizedStandard(PeriodType.time()));
	}
	
	private boolean checkChanges(){

		int tempHadChanges = 0;
		
		for (Map.Entry<Object, String> entry : dbMap.entrySet()) {
			
			AbstractField tempComp = (AbstractField) entry.getKey();
			String tempVal = entry.getValue();

//			log.info("FIELD: {}, DataSetItem Value: {}, Field Value: {}", tempVal.split(":")[1], dataSetItem.getItemProperty(tempVal.split(":")[1]).getValue(), tempComp.getValue());
			
			if(tempComp.isVisible() && tempComp.isEnabled()){
				if(!(tempComp.getValue() == dataSetItem.getItemProperty(tempVal.split(":")[1]).getValue())){
					tempHadChanges++;
				}
			}
			
		}
		
		return tempHadChanges > 0;
	}
	
	private void handleMailNotifcation() {
	    
	    
	    if(dataSetItem == null
	        || MyUtils.equalsWithNulls(
	                MyUtils.getValueFromItem(dataSetItem, "CED_ID_USER", Integer.class),
	                UserData.get().getUserId()) ) {
	        log.info("no mail needed, returning");
	        return;
	    }
	    
	    
	    Integer previousStatus = MyUtils.getValueFromItem(dataSetItem, "CED_STATUS", Integer.class);
	    Integer currentStatus = (Integer) CED_STATUS.getValue();
	    
	    if(MyUtils.equalsWithNulls(previousStatus, currentStatus)
	        || !notifyOnStatus.contains(currentStatus)) {
	        log.info("no status change detected");
	        return;
	    }
	    
	    
	    
	    String rec = dbGetUserMail();
	    if(rec == null) {
	        log.error("no recipient found for userId: {}", UserData.get().getUserId());
	        return;
	    }
	        
	    
        Mailer mail = new Mailer(CMS_Config_Std.getInstance());
        mail.setSender(new MailerGroup("_noreply").getFirstEntry());
        mail.setSubject(i18n.get(caption.mail_subject));
        mail.setType(MAIL_TYPE.HTML);
        mail.addRecipient(rec);
        
        TemplatingRenderer render = new TemplatingRenderer();
        render.loadTemplate("tpl_expenses_notifier");
        render.with("id", dataSetId);
        render.with("user", UserData.get().getUserName());
        render.with("status", CED_STATUS.getItemCaption(CED_STATUS.getValue()));
        render.with("comment", Jsoup.clean(CED_DECLINE_COMMENT.getValue(), Whitelist.none()));
        
        mail.setContent(render.render());
        try {
            mail.send();
        } catch (IllegalStateException e) {
            log.warn("mail could not be sent");
        }
        
	}
	
	private boolean activityHasCost(){
		return (Integer) CED_ACTIVITY.getItem(CED_ACTIVITY.getValue()).getItemProperty("CEA_COST").getValue() == 1;
	}
	
	/*********************** -->Validierung<-- ********************/
	private void fillValidateMap() {
		validateMap = new HashMap<>();
		validateMap.putAll(componentMap);

		// ValidateMap.put(component, "component"); // should not be needed

	}

	private void setCustomValidators() {

		// psw_pass_1.addValidator(new
		// Custom_Benutzerform_psw_ändern(psw_pass_1, psw_pass_2));

		/******* manual actions *******/

	}

	private boolean validate() {
		val_checker4 val = new val_checker4(validateMap);
		if (val.Is_Valid() == false) {
			return false;
		} else {
			return true;
		}

	}

	private void showInfoMessage(String msg){

		infoMessage.setVisible(msg != null);
		infoMessage.setValue(msg);
		
	}
	
	private void showFields(Integer cost) {

		if((Integer) CED_STATUS.getValue() >= 5){
			CED_DECLINE_COMMENT.setVisible(true);
			
			if(isBasicUser()){
				CED_DECLINE_COMMENT.setStyleName("nogrey");
			}
			
		}
		
		CED_COORDINATORS.setEnabled(true);
		CED_COORDINATORS.removeStyleName("nogrey");
		
		CED_PROJECT.setEnabled(true);
		CED_PROJECT.setRequired(true);
		
		CED_EXPENSES.setVisible(false);
		CED_EXPENSES.setEnabled(false);
		CED_EXPENSES.setRequired(false);
		CED_EXPENSES.removeStyleName("nogrey");
		
		CED_KM.setVisible(false);
		CED_KM.setEnabled(false);
		CED_KM.setRequired(false);

		CED_START.setVisible(false);
		CED_START.setEnabled(false);
		CED_START.setRequired(false);
		
		CED_END.setVisible(false);
		CED_END.setEnabled(false);
		CED_END.setRequired(false);
		
		CED_SERVICEZEIT.setVisible(false);
		CED_SERVICEZEIT.setEnabled(false);
		CED_SERVICEZEIT.setRequired(false);

		CED_FAHRZEIT.setVisible(false);
		CED_FAHRZEIT.setEnabled(false);
		CED_FAHRZEIT.setRequired(false);

		CED_DAYS.setVisible(false);
		CED_DAYS.setEnabled(false);
		CED_DAYS.setRequired(false);		
		
		CED_COMMENT.setRequired(true);
		CED_COMMENT.setEnabled(true);
		CED_COMMENT.removeStyleName("nogrey");
		
		if(MyUtils.equalsWithNulls(CED_ACTIVITY.getValue(), 12)){
			
			CED_PROJECT.setEnabled(false);
			CED_PROJECT.setRequired(false);
			CED_PROJECT.setValue(null);
			CED_PROJECT.setStyleName("nogrey");
			
			CED_COORDINATORS.setEnabled(false);
			CED_COORDINATORS.setStyleName("nogrey");
			
			CED_KM.setValue(null);
			CED_SERVICEZEIT.setValue("");
			CED_FAHRZEIT.setValue("");
			CED_START.setValue("");
			CED_END.setValue("");
			CED_EXPENSES.setValue(0f);
			
			CED_DAYS.setVisible(true);
			CED_DAYS.setEnabled(true);
			CED_DAYS.setRequired(true);
		
		}else if(!MyUtils.equalsWithNulls(CED_ACTIVITY.getValue(), 15) && !MyUtils.equalsWithNulls(CED_ACTIVITY.getValue(), 16)){
			
			switch (cost) {
			case 0:
				
				CED_KM.setVisible(true);
				CED_KM.setEnabled(true);
				CED_KM.setRequired(true);

				CED_SERVICEZEIT.setVisible(true);
				CED_SERVICEZEIT.setRequired(true);
				CED_SERVICEZEIT.setEnabled(true);

				CED_FAHRZEIT.setVisible(true);
				CED_FAHRZEIT.setEnabled(true);
				CED_FAHRZEIT.setRequired(true);
				
				CED_EXPENSES.setValue(0f);
				
				SimpleDateFormat dateformat = new SimpleDateFormat("yyyy-MM-dd");
				Date date1 = new Date();
				
				try {
					date1 = dateformat.parse("2018-10-01");
					
				} catch (ParseException e) {
					// FIXME Auto-generated catch block
					e.printStackTrace();
				}
								
				if(CED_DATE.getValue() != null){
				
					if(!CED_DATE.getValue().before(date1) && CED_DATE.getValue() != null){
						
						CED_START.setVisible(true);
						CED_START.setEnabled(true);
						CED_START.setRequired(true);
						
						CED_END.setVisible(true);
						CED_END.setEnabled(true);
						CED_END.setRequired(true);
						
						CED_SERVICEZEIT.setEnabled(false);
//						CED_SERVICEZEIT.setStyleName("nogrey");
						
					}else{
						CED_START.setVisible(false);
						CED_START.setEnabled(false);
						CED_START.setRequired(false);
						
						CED_END.setVisible(false);
						CED_END.setEnabled(false);
						CED_END.setRequired(false);
						
						CED_SERVICEZEIT.setEnabled(true);
//						CED_SERVICEZEIT.removeStyleName("nogrey");
						
					}
					
				}
				
				break;
			case 1:
				
				CED_EXPENSES.setVisible(true);
				CED_EXPENSES.setEnabled(true);
				CED_EXPENSES.setRequired(true);
				
				CED_KM.setValue(null);
				
				CED_SERVICEZEIT.setValue("");
				CED_FAHRZEIT.setValue("");
				CED_START.setValue("");
				CED_END.setValue("");
				
				break;

			default:
				System.out.println("error");
				break;
			}
			
		}else{
			
			CED_EXPENSES.setVisible(true);
			CED_EXPENSES.setEnabled(false);
			CED_EXPENSES.setValue((Integer) CED_ACTIVITY.getValue() == 15 ? 6.39f : 4.87f  );
			CED_EXPENSES.setStyleName("nogrey");

			CED_KM.setVisible(false);
			CED_KM.setEnabled(false);
			CED_KM.setRequired(false);
			CED_KM.setValue(null);

			CED_START.setVisible(false);
			CED_START.setEnabled(false);
			CED_START.setRequired(false);
			
			CED_END.setVisible(false);
			CED_END.setEnabled(false);
			CED_END.setRequired(false);
			
			CED_SERVICEZEIT.setVisible(false);
			CED_SERVICEZEIT.setEnabled(false);
			CED_SERVICEZEIT.setRequired(false);

			CED_FAHRZEIT.setVisible(false);
			CED_FAHRZEIT.setEnabled(false);
			CED_FAHRZEIT.setRequired(false);
			
			CED_COMMENT.setRequired(false);
			CED_COMMENT.setEnabled(false);
			CED_COMMENT.setValue("");
			CED_COMMENT.setStyleName("nogrey");
			
			CED_COORDINATORS.setEnabled(false);
			CED_COORDINATORS.select(14);
			CED_COORDINATORS.setStyleName("nogrey");
			
			CED_PROJECT.select(null);
			CED_PROJECT.setRequired(false);
			CED_PROJECT.setEnabled(false);
			
			
		}
		
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setStyleName("cust_margin_half_full_none_full");
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// main
		main = buildMain();
		mainLayout.addComponent(main);
		mainLayout.setExpandRatio(main, 9.0f);
		mainLayout.setComponentAlignment(main, new Alignment(48));
		
		// buttons
		buttons = buildButtons();
		mainLayout.addComponent(buttons);
		mainLayout.setComponentAlignment(buttons, new Alignment(48));
		
		return mainLayout;
	}

	@AutoGenerated
	private VerticalLayout buildMain() {
		// common part: create layout
		main = new VerticalLayout();
		main.setImmediate(false);
		main.setWidth("100.0%");
		main.setHeight("100.0%");
		main.setMargin(false);
		main.setSpacing(true);
		
		// panel_1
		panel_1 = buildPanel_1();
		main.addComponent(panel_1);
		main.setComponentAlignment(panel_1, new Alignment(48));
		
		return main;
	}

	@AutoGenerated
	private Panel buildPanel_1() {
		// common part: create layout
		panel_1 = new Panel();
		panel_1.setImmediate(false);
		panel_1.setWidth("100.0%");
		panel_1.setHeight("100.0%");
		
		// verticalLayout_4
		verticalLayout_4 = buildVerticalLayout_4();
		panel_1.setContent(verticalLayout_4);
		
		return panel_1;
	}

	@AutoGenerated
	private VerticalLayout buildVerticalLayout_4() {
		// common part: create layout
		verticalLayout_4 = new VerticalLayout();
		verticalLayout_4.setImmediate(false);
		verticalLayout_4.setWidth("100.0%");
		verticalLayout_4.setHeight("100.0%");
		verticalLayout_4.setMargin(true);
		verticalLayout_4.setSpacing(true);
		
		// verticalLayout_2
		verticalLayout_2 = buildVerticalLayout_2();
		verticalLayout_4.addComponent(verticalLayout_2);
		verticalLayout_4.setComponentAlignment(verticalLayout_2, new Alignment(48));
		
		return verticalLayout_4;
	}

	@AutoGenerated
	private VerticalLayout buildVerticalLayout_2() {
		// common part: create layout
		verticalLayout_2 = new VerticalLayout();
		verticalLayout_2.setImmediate(false);
		verticalLayout_2.setWidth("100.0%");
		verticalLayout_2.setHeight("100.0%");
		verticalLayout_2.setMargin(true);
		verticalLayout_2.setSpacing(true);
		
		// horizontalLayout_3
		horizontalLayout_3 = buildHorizontalLayout_3();
		verticalLayout_2.addComponent(horizontalLayout_3);
		verticalLayout_2.setExpandRatio(horizontalLayout_3, 1.0f);
		
		// horizontalLayout_4
		horizontalLayout_4 = buildHorizontalLayout_4();
		verticalLayout_2.addComponent(horizontalLayout_4);
		verticalLayout_2.setExpandRatio(horizontalLayout_4, 1.0f);
		
		// horizontalLayout_1
		horizontalLayout_1 = buildHorizontalLayout_1();
		verticalLayout_2.addComponent(horizontalLayout_1);
		verticalLayout_2.setExpandRatio(horizontalLayout_1, 1.0f);
		
		// horizontalLayout_2
		horizontalLayout_2 = buildHorizontalLayout_2();
		verticalLayout_2.addComponent(horizontalLayout_2);
		verticalLayout_2.setExpandRatio(horizontalLayout_2, 1.0f);
		
		// infoMessage
		infoMessage = new Label();
		infoMessage.setImmediate(false);
		infoMessage.setWidth("100.0%");
		infoMessage.setHeight("-1px");
		infoMessage.setValue("Label");
		verticalLayout_2.addComponent(infoMessage);
		
		// CED_COMMENT
		CED_COMMENT = new TextArea();
		CED_COMMENT.setCaption("Beschreibung");
		CED_COMMENT.setImmediate(false);
		CED_COMMENT.setWidth("100.0%");
		CED_COMMENT.setHeight("100.0%");
		CED_COMMENT.setRequired(true);
		verticalLayout_2.addComponent(CED_COMMENT);
		verticalLayout_2.setExpandRatio(CED_COMMENT, 2.0f);
		
		// CED_DECLINE_COMMENT
		CED_DECLINE_COMMENT = new TextArea();
		CED_DECLINE_COMMENT.setCaption("Kommentar des Prüfers");
		CED_DECLINE_COMMENT.setImmediate(false);
		CED_DECLINE_COMMENT.setWidth("100.0%");
		CED_DECLINE_COMMENT.setHeight("100.0%");
		verticalLayout_2.addComponent(CED_DECLINE_COMMENT);
		verticalLayout_2.setExpandRatio(CED_DECLINE_COMMENT, 2.0f);
		
		return verticalLayout_2;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_3() {
		// common part: create layout
		horizontalLayout_3 = new HorizontalLayout();
		horizontalLayout_3.setImmediate(false);
		horizontalLayout_3.setWidth("100.0%");
		horizontalLayout_3.setHeight("-1px");
		horizontalLayout_3.setMargin(false);
		horizontalLayout_3.setSpacing(true);
		
		// CED_USER
		CED_USER = new TextField();
		CED_USER.setCaption("User");
		CED_USER.setImmediate(false);
		CED_USER.setWidth("100.0%");
		CED_USER.setHeight("-1px");
		horizontalLayout_3.addComponent(CED_USER);
		horizontalLayout_3.setExpandRatio(CED_USER, 1.0f);
		
		// CED_CONTRACT
		CED_CONTRACT = new ComboBox();
		CED_CONTRACT.setCaption("Vertragsart");
		CED_CONTRACT.setImmediate(false);
		CED_CONTRACT.setWidth("100.0%");
		CED_CONTRACT.setHeight("-1px");
		horizontalLayout_3.addComponent(CED_CONTRACT);
		horizontalLayout_3.setExpandRatio(CED_CONTRACT, 1.0f);
		
		// CED_STATUS
		CED_STATUS = new ComboBox();
		CED_STATUS.setCaption("Status");
		CED_STATUS.setImmediate(false);
		CED_STATUS.setWidth("100.0%");
		CED_STATUS.setHeight("-1px");
		horizontalLayout_3.addComponent(CED_STATUS);
		horizontalLayout_3.setExpandRatio(CED_STATUS, 1.0f);
		
		return horizontalLayout_3;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_4() {
		// common part: create layout
		horizontalLayout_4 = new HorizontalLayout();
		horizontalLayout_4.setImmediate(false);
		horizontalLayout_4.setWidth("100.0%");
		horizontalLayout_4.setHeight("-1px");
		horizontalLayout_4.setMargin(false);
		horizontalLayout_4.setSpacing(true);
		
		// CED_DATE
		CED_DATE = new PopupDateField();
		CED_DATE.setCaption("Datum");
		CED_DATE.setImmediate(true);
		CED_DATE.setWidth("100.0%");
		CED_DATE.setHeight("-1px");
		CED_DATE.setRequired(true);
		horizontalLayout_4.addComponent(CED_DATE);
		horizontalLayout_4.setExpandRatio(CED_DATE, 1.0f);
		
		// CED_PROJECT
		CED_PROJECT = new ComboBox();
		CED_PROJECT.setCaption("Projekt");
		CED_PROJECT.setImmediate(false);
		CED_PROJECT.setWidth("100.0%");
		CED_PROJECT.setHeight("-1px");
		CED_PROJECT.setRequired(true);
		horizontalLayout_4.addComponent(CED_PROJECT);
		horizontalLayout_4.setExpandRatio(CED_PROJECT, 1.0f);
		
		// CED_ACTIVITY
		CED_ACTIVITY = new ComboBox();
		CED_ACTIVITY.setCaption("Tätigkeit");
		CED_ACTIVITY.setImmediate(true);
		CED_ACTIVITY.setWidth("100.0%");
		CED_ACTIVITY.setHeight("-1px");
		CED_ACTIVITY.setRequired(true);
		horizontalLayout_4.addComponent(CED_ACTIVITY);
		horizontalLayout_4.setExpandRatio(CED_ACTIVITY, 2.0f);
		
		return horizontalLayout_4;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_1() {
		// common part: create layout
		horizontalLayout_1 = new HorizontalLayout();
		horizontalLayout_1.setImmediate(false);
		horizontalLayout_1.setWidth("100.0%");
		horizontalLayout_1.setHeight("-1px");
		horizontalLayout_1.setMargin(false);
		horizontalLayout_1.setSpacing(true);
		
		// CED_COORDINATORS
		CED_COORDINATORS = new ComboBox();
		CED_COORDINATORS.setCaption("beauftragt durch");
		CED_COORDINATORS.setImmediate(false);
		CED_COORDINATORS.setWidth("100.0%");
		CED_COORDINATORS.setHeight("-1px");
		horizontalLayout_1.addComponent(CED_COORDINATORS);
		horizontalLayout_1.setExpandRatio(CED_COORDINATORS, 2.0f);
		
		// CED_BILLABLE
		CED_BILLABLE = new BooleanComboBox();
		CED_BILLABLE.setCaption("Weiter verrechenbar");
		CED_BILLABLE.setImmediate(false);
		CED_BILLABLE.setWidth("100.0%");
		CED_BILLABLE.setHeight("-1px");
		horizontalLayout_1.addComponent(CED_BILLABLE);
		horizontalLayout_1.setExpandRatio(CED_BILLABLE, 1.0f);
		
		return horizontalLayout_1;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_2() {
		// common part: create layout
		horizontalLayout_2 = new HorizontalLayout();
		horizontalLayout_2.setImmediate(false);
		horizontalLayout_2.setWidth("100.0%");
		horizontalLayout_2.setHeight("-1px");
		horizontalLayout_2.setMargin(false);
		horizontalLayout_2.setSpacing(true);
		
		// CED_START
		CED_START = new CustomTimePicker();
		CED_START.setCaption("Von");
		CED_START.setImmediate(false);
		CED_START.setDescription("In folgenden Format eintragen \"00:05\"");
		CED_START.setWidth("100.0%");
		CED_START.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_START);
		horizontalLayout_2.setExpandRatio(CED_START, 1.0f);
		
		// CED_END
		CED_END = new CustomTimePicker();
		CED_END.setCaption("Bis");
		CED_END.setImmediate(false);
		CED_END.setDescription("In folgenden Format eintragen \"00:05\"");
		CED_END.setWidth("100.0%");
		CED_END.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_END);
		horizontalLayout_2.setExpandRatio(CED_END, 1.0f);
		
		// CED_SERVICEZEIT
		CED_SERVICEZEIT = new CustomDurationPicker();
		CED_SERVICEZEIT.setCaption("Dauer");
		CED_SERVICEZEIT.setImmediate(false);
//		CED_SERVICEZEIT.setDescription("In folgenden Format eintragen \"00:05\"");
		CED_SERVICEZEIT.setWidth("100.0%");
		CED_SERVICEZEIT.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_SERVICEZEIT);
		horizontalLayout_2.setExpandRatio(CED_SERVICEZEIT, 1.0f);
		
		// CED_FAHRZEIT
		CED_FAHRZEIT = new CustomTimePicker();
		CED_FAHRZEIT.setCaption("Fahrzeit");
		CED_FAHRZEIT.setImmediate(false);
		CED_FAHRZEIT.setDescription("In folgenden Format eintragen \"00:05\"");
		CED_FAHRZEIT.setWidth("100.0%");
		CED_FAHRZEIT.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_FAHRZEIT);
		horizontalLayout_2.setExpandRatio(CED_FAHRZEIT, 1.0f);
		
		// CED_KM
		CED_KM = new IntStepper();
		CED_KM.setCaption("KM");
		CED_KM.setImmediate(false);
		CED_KM.setWidth("100.0%");
		CED_KM.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_KM);
		horizontalLayout_2.setExpandRatio(CED_KM, 1.0f);
		
		// CED_EXPENSES
		CED_EXPENSES = new FloatStepper();
		CED_EXPENSES.setCaption("Spesen");
		CED_EXPENSES.setImmediate(true);
		CED_EXPENSES.setWidth("-1px");
		CED_EXPENSES.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_EXPENSES);
		
		// CED_DAYS
		CED_DAYS = new IntStepper();
		CED_DAYS.setCaption("Tage");
		CED_DAYS.setImmediate(false);
		CED_DAYS.setWidth("-1px");
		CED_DAYS.setHeight("-1px");
		horizontalLayout_2.addComponent(CED_DAYS);
		
		return horizontalLayout_2;
	}

	@AutoGenerated
	private HorizontalLayout buildButtons() {
		// common part: create layout
		buttons = new HorizontalLayout();
		buttons.setImmediate(false);
		buttons.setWidth("100.0%");
		buttons.setHeight("-1px");
		buttons.setMargin(true);
		
		// reset
		reset = new Button();
		reset.setCaption("cancel");
		reset.setImmediate(true);
		reset.setWidth("-1px");
		reset.setHeight("-1px");
		buttons.addComponent(reset);
		buttons.setComponentAlignment(reset, new Alignment(48));
		
		// btn_save
		btn_save = new Button();
		btn_save.setCaption("save");
		btn_save.setImmediate(true);
		btn_save.setWidth("-1px");
		btn_save.setHeight("-1px");
		buttons.addComponent(btn_save);
		buttons.setComponentAlignment(btn_save, new Alignment(48));
		
		// btn_save_new
		btn_save_new = new Button();
		btn_save_new.setCaption("continue");
		btn_save_new.setImmediate(true);
		btn_save_new.setWidth("-1px");
		btn_save_new.setHeight("-1px");
		buttons.addComponent(btn_save_new);
		buttons.setComponentAlignment(btn_save_new, new Alignment(48));
		
		return buttons;
	}

}
