package archenoah.web.normal.main.Menuepunkte.Individuelle.Projekte.Projektzuweisung.Form;

import java.math.BigDecimal;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.HashMap;

import org.tepi.filtertable.FilterTable;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.custom.MyUtils;
import archenoah.lib.custom.PauseablePollListener;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.ClickMenuBar.ClickCommand;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Components.table.FilteringTableUpdater;
import archenoah.lib.vaadin.CustomConverterFactorys.StringSqlTimestampConverter;
import archenoah.lib.vaadin.Language.i18n.I18nCB;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.web.normal.UserInfo.UserData;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.event.UIEvents.PollEvent;
import com.vaadin.event.UIEvents.PollListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractField;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.MessageBoxListener;


public class ProjektzuweisungDataView extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private HorizontalLayout mainLayout;

    @AutoGenerated
    private VerticalLayout vl_main;

    @AutoGenerated
    private FilterTable tbl_data;

    @AutoGenerated
    private HorizontalLayout layoutFilter;

    @AutoGenerated
    private ComboBox filterNurseSubs;

    @AutoGenerated
    private VerticalLayout vl_menuSpacer;

    @AutoGenerated
    private MenuBar men_frm;

    

	

	

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Datenbank
    private FilteringTableUpdater tableUpdater = null;

    // Berrechtigung
    private int ACC_ID;

    private int permRead;
    private int permCreate;
    private int permUpdate;
    private int permDelete;

    private MenuItem tmpMenu = null;

    private Button tmpButton = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/

    private DetachListener onDetach = null;

    /******************* -> Menüpunkte <- ********************/
    private MenuBar.MenuItem btn_create;
    private MenuBar.MenuItem btn_update;
    private MenuBar.MenuItem btn_read;
    private MenuBar.MenuItem btn_delete;
    private MenuBar.MenuItem btn_duplicate;
    private MenuBar.MenuItem btn_filter;

    
    /*******************************************************/
    /******************* --> Custom <--- ********************/
    /******************************************************/

    private Boolean firstFilter = true;
    private PauseablePollListener pollListener = null;
    
    enum Status {}
    enum Count {}
    enum Project {}
    enum Patient {}
    enum Nurse {}
    
    /************ ----->Einstellungen<-- ********************/
//    private final String formIdLng = "20";
    private final String formIdPerm = "33";
    private final String winHeight = "600px";
    private final String winWidth = "900px";

    /************************ Filtered Init ******************/

    private HashMap<String, String> filteredInitVars;
    /******************************************************/

    private final String tableIdCol = "VH_ID";
    
    private final Object[] tableColsAll = new Object[] { "VH_ID", "VH_CREATED", "PSLV_NAME", "PATIENT", "PSL_COUNTYCODE", "NURSE", "rlead", "pdf_type", "pdf_freq", "COUNT", "COUNT_CUR", "VH_AKTIV" };
    //use custom Cols when needed
    private final Object[] tableColsDefault = tableColsAll;
    //use custom Cols when needed
    private final Object[] tableColsFilter = tableColsDefault;
    private Object[] tableColsActive = tableColsDefault;

    private I18nConverter pdfTypeConverter;
    private I18nConverter pdfFreqConverter;

    private I18nManager i18n;
    
    private final static class caption extends I18nCB {
        static final I18nCB bool_true = set();
        static final I18nCB bool_false = set();
    }
    
    /******************************************************/

    public ProjektzuweisungDataView(MenuItem Arg_Menü) {
        tmpMenu = Arg_Menü;
    }

    public ProjektzuweisungDataView(Button Arg_btn) {
        tmpButton = Arg_btn;
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void init() {

        Standard_Init();

        if (tmpMenu != null) {
            String Recourcename = tmpMenu.getIcon().toString();
            Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";

            Build_Window_Button bwb = new Build_Window_Button(tmpMenu.getText(), mainLayout, winHeight, winWidth,
                    new ThemeResource(Recourcename));
            win = bwb.ReturnWindow();
        }
        if (tmpButton != null) {
            Build_Window_Button bwb = new Build_Window_Button(tmpButton.getCaption(), mainLayout, winHeight, winWidth,
                    tmpButton.getIcon());
            win = bwb.ReturnWindow();
        }

        pollListener = new PauseablePollListener() {}; // dummy;

        if(onDetach != null) {
            win.addDetachListener(onDetach);
        }

    }
    
    public Window getWindow(){
    	return win;
    }
    
    public TabSheet getTabSheet(){
    	return tab;
    }
    
    public void init(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (tmpMenu != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpMenu.getText(), mainLayout, tmpMenu.getIcon());
        }
        if (tmpButton != null) {
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, tmpButton.getCaption(), mainLayout, tmpButton.getIcon());
        }

        setupListenersAndDetachEvent();
    }

    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);

        generateMenu();

        setMenuPermissions();

        dbGetNurses();
        
        updateTable();
        tbl_data.setSortContainerPropertyId(tableIdCol);
        tbl_data.setSortAscending(true);
        tbl_data.sort();
        configureTable();
        configueComponents();
        
        i18n.refresh();
    }

    private void setupListenersAndDetachEvent() {
        pollListener = PauseablePollListener.getListener(tab, mainLayout, new PollListener() {
            @Override
            public void poll(PollEvent event) {
                updateTable();
            }
        });
    }
    
    
    @SuppressWarnings("unused")
    public void setPermissionsFromDatabase() {
        if (formIdPerm == "") {
            System.out.println("Form Einstellung Fehlt: Berechtigung");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] perms = r.Datenholen();

        for (int i = 0; i < perms.length; i++) {
            if (perms[i][0].equals(formIdPerm) == true) {

                permRead = Integer.valueOf(perms[i][3]);
                permUpdate = Integer.valueOf(perms[i][4]);
                permCreate = Integer.valueOf(perms[i][6]);
                permDelete = Integer.valueOf(perms[i][5]);
                
            }
        }
    }

    public void setPermissions(int create, int read, int update, int delete) {

        permCreate = create;
        permRead = read;
        permUpdate = update;
        permDelete = delete;

    }

    private void setMenuPermissions() {
        Boolean c = (permCreate == 1);
        Boolean r = (permRead == 1);
        Boolean u = (permUpdate == 1);
        Boolean d = (permDelete == 1);

        btn_create.setEnabled(c);
        btn_create.setVisible(c);

        btn_duplicate.setEnabled(c);
        btn_duplicate.setVisible(c);
        
        btn_read.setEnabled(r);
        btn_read.setVisible(r);

        btn_update.setEnabled(u);
        btn_update.setVisible(u);

        btn_delete.setEnabled(d);
        btn_delete.setVisible(d);
    }

    /************ -><- ******************/
    
    public void setFilteredInit(String projekt, String patient) {
        filteredInitVars = new HashMap<String, String>();
        filteredInitVars.put("projekt", projekt);
        filteredInitVars.put("patient", patient);
    }

    public void setFilteredInit(String projekt, String patient, String arzt) {
        setFilteredInit(projekt, patient);
        filteredInitVars.put("arzt", arzt);
    }
    
    /***************** Comands *********************/
    CloseListener closeListener = new CloseListener() {
        
        @Override
        public void windowClose(CloseEvent e) {
            
            pollListener.resume();
            updateTable(true);
            
        }
    };
   
    //TASK Commands are here
    public ClickCommand cmd_btn_add = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {

        	form_projektzuweisung_insert_edit pie = new form_projektzuweisung_insert_edit(selectedItem, "");
            if (filteredInitVars != null && filteredInitVars.size() > 0) {
                pie.setPrefilledInit(filteredInitVars.get("projekt"), filteredInitVars.get("patient"));
            }
            pie.Init_Class_Window();
            pie.getWindow().addCloseListener(closeListener);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());
            pollListener.pause();
            
        }
    };
    
    public ClickCommand cmd_btn_read = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {

            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            final int ID = (int) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue();

            form_projektzuweisung_insert_edit pie = new form_projektzuweisung_insert_edit(selectedItem, ID + "");
            pie.Init_Class_Window();
            pie.Set_Berrechtigung_Custom(1, 0, 0, 0);
            pie.getWindow().addCloseListener(closeListener);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());
            pollListener.pause();

        }
    };
    
    public ClickCommand cmd_btn_edit = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            final int ID = (int) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue();

            form_projektzuweisung_insert_edit pie = new form_projektzuweisung_insert_edit(selectedItem, ID + "");
            pie.Init_Class_Window();
            pie.getWindow().addCloseListener(closeListener);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());
            pollListener.pause();
            
        }
    };

    public ClickCommand cmd_btn_duplicate = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            final int ID = (int) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue();

            form_projektzuweisung_insert_edit pie = new form_projektzuweisung_insert_edit(selectedItem, ID + "");
            pie.Init_Class_Window();
            pie.setForceInsert(true);
            pie.getWindow().addCloseListener(closeListener);
            this.setParent(men_frm);
            this.setWindow(pie.getWindow());
            pollListener.pause();
            
        }
    };
    
    public ClickCommand cmd_btn_del = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {
            
            if(tbl_data.getValue() == null){
                I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                return;
            }
            
            try {
                BigDecimal count = (BigDecimal) tbl_data.getContainerDataSource().getContainerProperty(tbl_data.getValue(), "COUNT").getValue();
                if(count.compareTo(BigDecimal.ZERO) > 0) {
                    I18nManager.global(I18nGlobalNotifiers.assignment_blocking_delete);
                    return;
                }
            } catch (Exception e) {
                I18nManager.global(I18nGlobalNotifiers.assignment_blocking_delete); //TASK proper notifier
                return;
            }
            
            
            String id = Integer.toString((Integer) tbl_data.getContainerProperty(tbl_data.getValue(), tableIdCol).getValue());
            deleteData(id);

        }
    };

    public ClickCommand cmd_btn_filter = new ClickCommand() {
        @Override
        public void menuClicked(MenuItem selectedItem) {

            if (firstFilter) {
                tbl_data.setFilterBarVisible(true);
                tbl_data.setFilterBarVisible(false);
                firstFilter = false;
            }
            tbl_data.setFilterBarVisible(!tbl_data.isFilterBarVisible());
            layoutFilter.setVisible(tbl_data.isFilterBarVisible());
            
            if(!tbl_data.isFilterBarVisible()){
                tbl_data.clearFilters();
                filterNurseSubs.setValue(null);
            }
            
            tableColsActive = tbl_data.isFilterBarVisible() ? tableColsFilter : tableColsDefault;
            if(tbl_data.size() > 0) {
                tbl_data.setVisibleColumns(tableColsActive);
            }

        }
    };
    

    /******************************************/

    
    

    /*********** Gen Menüs *************/
    private void generateMenu() {

        btn_create = men_frm.addItem("FRM_ADD", Icons.White.add_16, cmd_btn_add);
        btn_update = men_frm.addItem("FRM_EDIT", Icons.White.edit_16, cmd_btn_edit);
        btn_read = men_frm.addItem("FRM_READ", Icons.White.perm_lesen_16, cmd_btn_read);
        btn_delete = men_frm.addItem("FRM_DEL", Icons.White.delete_16, cmd_btn_del);
        btn_duplicate = men_frm.addItem("FRM_DUPLICATE", Icons.White.projekte_16, cmd_btn_duplicate);
        
        
        btn_filter = men_frm.addItem("FRM_FILTER", Icons.White.filter_16, cmd_btn_filter);

    }
    
    private void configueComponents(){
       
        layoutFilter.setVisible(false);
        
        filterNurseSubs.setFilteringMode(FilteringMode.CONTAINS);
        filterNurseSubs.setImmediate(true);
        filterNurseSubs.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                updateTable(true);
                
            }
        });
        
    }
    
    
    private ArrayList<AbstractField> getActiveGlobalFilters(){
        ArrayList<AbstractField> al = new ArrayList<AbstractField>();
        
//        if(pop_month.getValue() != null){
//            al.add(pop_month);
//        }
//        
//        if(cb_filterStatus.getValue()){
//            al.add(tcol_filterStatus);
//        }
        
        return al;
    }
    
    private Boolean hasGlobalFilters(ArrayList a){
        
        return (a.size() > 0);
        
    }
    
    private Boolean hasGlobalFilters(){
        
        return hasGlobalFilters(getActiveGlobalFilters());
        
    }
    
    /*************************** Config TBL ********************/

    private void configureTable() {
        tbl_data.setSelectable(true);
        tbl_data.setFilterOnDemand(false);
        tbl_data.setImmediate(true);
        tbl_data.setColumnCollapsingAllowed(false);
        tbl_data.setFooterVisible(true);
        tbl_data.setPageLength(1);
        
        tbl_data.setColumnCollapsingAllowed(true);
        
        if(tbl_data.size() > 0){
            
            StringSqlTimestampConverter time = new StringSqlTimestampConverter();
            time.setDateFormat(DateFormat.SHORT);
            time.setTimeFormat(DateFormat.SHORT);
            
            try {
            	tbl_data.setConverter("VH_CREATED", time);
            	
                if(pdfTypeConverter == null) {
                    pdfTypeConverter = new I18nConverter("cust_protokoll_pdf_type", "PPT_KEY", "PPT_KEY");
                    tbl_data.setConverter("pdf_type", pdfTypeConverter);
                }
                
                if(pdfFreqConverter == null){
                    pdfFreqConverter = new I18nConverter("cust_protokoll_pdf_freq", "PPF_KEY", "PPF_KEY");
                    tbl_data.setConverter("pdf_freq", pdfFreqConverter);
                }
            	
			} catch (Exception e) {
				System.out.println("Error setting converters");
			}
            
        }
        
        tbl_data.setColumnWidth("PSL_COUNTYCODE", 30);
        tbl_data.setColumnExpandRatio("VH_ID", 0);
        tbl_data.setColumnExpandRatio("VH_CREATED", 0);
        tbl_data.setColumnExpandRatio("VH_PROJEKT", 0);
        tbl_data.setColumnExpandRatio("COUNT", 0);
        tbl_data.setColumnExpandRatio("COUNT_CUR", 0);
        tbl_data.setColumnExpandRatio("VH_AKTIV", 0);
        
        tbl_data.setColumnExpandRatio("PATIENT", 1);
        tbl_data.setColumnExpandRatio("NURSE", 1);
        tbl_data.setColumnExpandRatio("rlead", 1);
        
        tbl_data.setColumnCollapsed("pdf_type", true);
        tbl_data.setColumnCollapsed("pdf_freq", true);
        
        btn_duplicate.setVisible(false);
        tbl_data.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                boolean visible = false;
                String code = MyUtils.getValueFromItem(tbl_data.getItem(tbl_data.getValue()), "PSLV_CODE", String.class);
                
                if("POP".equals(code)){
                    visible = true;
                }
                
                // temporarily disabled until rework
//                btn_duplicate.setVisible(btn_duplicate.isEnabled() && visible);
                
            }
        });
        
        tableUpdater = new FilteringTableUpdater(tbl_data);

    }

    /*************************** Database ********************/
    
    /********************************/
    
    
    private void updateTable(){
        updateTable(false);
    }
    
    private void updateTable(Boolean ignoreFilter) {

        if (ignoreFilter || !tbl_data.isFilterBarVisible()) {
            dbGetContainer();
            try{
                tbl_data.setVisibleColumns(tableColsActive);
            }catch(Exception e){
                
            }
        }
        
        tbl_data.setColumnFooter("VH_AKTIV", "Σ " + tbl_data.size());
        
    }
    
    private void deleteData(final String id){
        
        I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
            
            @Override
            public void buttonClicked(ButtonId arg0) {
                if(ButtonId.YES == arg0) {
                    dbDeleteData(id);
                }
            }
        });
    }
    
    private void dbGetNurses() {
        
        DBClass db = new DBClass();
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("KSK_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(AUL_VORNAME,' ',AUL_NAME)", "nurse");

        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_krankenschwester_stammdaten_ks", "INNER JOIN", "cms_auth_stammdaten_user", "KSK_U_ID", "AUL_ID");

        try {
            combo nc = new combo(db.DB_Data_Get.DB_SEND_AND_GET(), filterNurseSubs, "KSK_ID", "nurse");
        } catch (Exception e) {
            filterNurseSubs.removeAllItems();
            return;
        }
    }
    
    private void dbGetContainer() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();

        /************ Set Spalten *************/
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("cust_verk_haupt.VH_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("VH_CREATED");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSLV_NAME");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSLV_CODE"); //used by duplicate tool
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(PSL_NAME,', ',PSL_VORNAME, ', ', PSA_NAME)", "PATIENT");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("PSL_COUNTYCODE");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(KSK_TITEL,' ',KSA_NAME,' ',Krankenschwester.AUL_NAME,' ',Krankenschwester.AUL_VORNAME)", "NURSE");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(ASA_NAME,' ',rlead.AUL_NAME,' ',rlead.AUL_VORNAME)", "rlead");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("pdf_type");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("pdf_freq");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("COALESCE(SUM(p1.total), SUM(p2.total), 0)", "COUNT");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("COALESCE(SUM(p1.adv), SUM(p2.adv), 0)", "COUNT_CUR");
        
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("IF(VH_AKTIV = 1, '"+i18n.get(caption.bool_true)+"', '"+i18n.get(caption.bool_false)+"')", "VH_AKTIV");
        // db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(ASA_TITEL,' ',ASAN_NAME,' ',Arzt.AUL_NAME,' ',Arzt.AUL_VORNAME)","Arztname");
        /**************************************/
        /************ Set Tabelle *************/
        
        db.DB_Data_Get.DB_Tabellen.DB_CustomSQL(""
		    + "\n cust_projekte_stammdaten_liste inner join cust_verk_haupt on cust_projekte_stammdaten_liste.PSLV_ID = cust_verk_haupt.VH_PROJEKT_ID"
//			Patient
		    + "\n left join view_patient_stammdaten_liste on  cust_verk_haupt.VH_PATIENT_ID = view_patient_stammdaten_liste.PSL_ID"
			+ "\n left join cust_patient_stammdaten_anrede on view_patient_stammdaten_liste.PSL_ANREDE = cust_patient_stammdaten_anrede.PSA_ID"
//			Nurse
			+ "\n left join cust_krankenschwester_stammdaten_ks on cust_verk_haupt.VH_NURSE_ID = cust_krankenschwester_stammdaten_ks.KSK_ID"
			+ "\n left join cms_auth_stammdaten_user as Krankenschwester on cust_krankenschwester_stammdaten_ks.KSK_U_ID = Krankenschwester.AUL_ID"
			+ "\n left join cust_krankenschwester_stammdaten_anrede on Krankenschwester.AUL_ANREDE_ID = cust_krankenschwester_stammdaten_anrede.KSA_ID"
//			Status
			+ "\n inner join cust_verk_haupt_status on cust_verk_haupt.VH_STATUS_ID = cust_verk_haupt_status.VKS_ID"
//          Mailing			
			+ "\n left join view_project_meta_combined on cust_verk_haupt.VH_ID = view_project_meta_combined.vh_id"
//          RegLead			
			+ "\n left join cust_stammdaten_regionalleiter on rlead_id = SRL_ID"
			+ "\n left join cms_auth_stammdaten_user as rlead on SRL_ID_USER = rlead.AUL_ID"
	        + "\n left join cms_auth_stammdaten_anrede on rlead.AUL_ANREDE_ID = cms_auth_stammdaten_anrede.ASA_ID"
//			Count
            + "\n left join view_protokoll_count_sums as p1 on VH_PROJEKT_ID != 1 and VH_PROJEKT_ID = p1.project and p1.vh = cust_verk_haupt.VH_ID"
            + "\n left join view_protokoll_count_sums as p2 on VH_PROJEKT_ID = 1 and p2.project = 1 and VH_PATIENT_ID = p2.patient and p2.nurse = VH_NURSE_ID"
//          subs	
            + ((filterNurseSubs.getValue() != null || UserData.get().getNurse().isNurse()) ?
			"\n left join cust_verk_subs on CVS_PROJECT_ID = p1.project and cust_verk_subs.CVS_PATIENT_ID = view_patient_stammdaten_liste.PSL_ID" : "") 
		);

        /**************************************/
        /************ Set Group *************/
        
        db.DB_Data_Get.DB_Gruppieren.DB_Gruppieren("cust_verk_haupt.VH_ID");
        
        /**************************************/
        /************ Set Filter *************/
        
        String glue1 = ((filteredInitVars != null && filteredInitVars.size() > 0) || filterNurseSubs.getValue() != null || UserData.get().getNurse().isNurse()) ? "AND" : "";
        db.DB_Data_Get.DB_Filter.DB_WHERE_CUSTOM(" WHERE NOT ( VH_PROJEKT_ID = 1 and PSL_ID IS NULL )", glue1);
        
        
        if(UserData.get().getNurse().isNurse()) {
            String glue = filterNurseSubs.getValue() != null ? "AND" : "";
            
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("(cust_verk_subs", "CVS_NURSE_ID", "=", UserData.get().getNurse().getNurseId().toString(), "OR");
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_haupt", "VH_NURSE_ID", "=", UserData.get().getNurse().getNurseId().toString(), " ) " + glue);
            
        }
        
        if(filterNurseSubs.getValue() != null){
            
            String glue = (filteredInitVars != null && filteredInitVars.size() > 0) ? "AND" : "";
            
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_subs", "CVS_NURSE_ID", "=", filterNurseSubs.getValue().toString(), glue);
            
        }

        if (filteredInitVars != null && filteredInitVars.size() > 0) {

            // System.out.println(filteredInitVars.get("patient") + "," + filteredInitVars.get("patient").getClass());

            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("view_patient_stammdaten_liste", "PSL_ID", "=", filteredInitVars.get("patient"), "AND");
            db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_haupt", "VH_PROJEKT_ID", "=", filteredInitVars.get("projekt"), "");

        }
        
//        String glue = "";
//        
//        
//        ArrayList<AbstractField> filterList = getActiveGlobalFilters(); 
//        
//        if(pop_month.getValue() != null){
//            
//           filterList.remove(pop_month);
//            glue = hasGlobalFilters(filterList) ? "AND" : "";
//            
//            db.DB_Data_Get.DB_Filter.DB_WHERE_BETWEEN(.., glue);
//        }
        
        
        /**************************************/
        /************ Set Custom *************/
        /**************************************/

        db.DB_Data_Get.Set_Type("PSLV_NAME", Project.class);
//        db.DB_Data_Get.Set_Type("PATIENT", Patient.class);
//        db.DB_Data_Get.Set_Type("NURSE", Nurse.class);
        // problem, da enum combobox nicht auf Filteringmode.CONTAINS steht!
        db.DB_Data_Get.Set_Type("VH_AKTIV", Status.class);
//        db.DB_Data_Get.Set_Type("COUNT", Count.class);
        
        /* **************************/
        
//        db.debugNextQuery(true);
        
        Container container = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        if (tableUpdater != null) {
            tableUpdater.updateTable(container);
        } else {
            tbl_data.setContainerDataSource(container);
        }

    }
    
    private void dbDeleteData(String id){
    
        CMS_Config_Std std = CMS_Config_Std.getInstance();
    
        DBClass db = new DBClass();
        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_verk_haupt");
        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein("cust_verk_haupt", tableIdCol, "=", id, "");
        db.DB_Data_Delete.DB_Delete();
    
        I18nManager.global(I18nGlobalNotifiers.entry_deleted);
        
        updateTable(true);

        
    }
    
    @AutoGenerated
    private HorizontalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new HorizontalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // vl_main
        vl_main = buildVl_main();
        mainLayout.addComponent(vl_main);
        mainLayout.setExpandRatio(vl_main, 1.0f);
        mainLayout.setComponentAlignment(vl_main, new Alignment(20));
        
        return mainLayout;
    }

    @AutoGenerated
    private VerticalLayout buildVl_main() {
        // common part: create layout
        vl_main = new VerticalLayout();
        vl_main.setImmediate(false);
        vl_main.setWidth("100.0%");
        vl_main.setHeight("100.0%");
        vl_main.setMargin(true);
        
        // vl_menuSpacer
        vl_menuSpacer = buildVl_menuSpacer();
        vl_main.addComponent(vl_menuSpacer);
        
        // layoutFilter
        layoutFilter = buildLayoutFilter();
        vl_main.addComponent(layoutFilter);
        
        // tbl_data
        tbl_data = new FilterTable();
        tbl_data.setImmediate(true);
        tbl_data.setWidth("100.0%");
        tbl_data.setHeight("100.0%");
        vl_main.addComponent(tbl_data);
        vl_main.setExpandRatio(tbl_data, 1.0f);
        vl_main.setComponentAlignment(tbl_data, new Alignment(20));
        
        return vl_main;
    }

    @AutoGenerated
    private VerticalLayout buildVl_menuSpacer() {
        // common part: create layout
        vl_menuSpacer = new VerticalLayout();
        vl_menuSpacer.setImmediate(false);
        vl_menuSpacer.setWidth("100.0%");
        vl_menuSpacer.setHeight("40px");
        vl_menuSpacer.setMargin(false);
        
        // men_frm
        men_frm = new MenuBar();
        men_frm.setImmediate(false);
        men_frm.setWidth("100.0%");
        men_frm.setHeight("-1px");
        vl_menuSpacer.addComponent(men_frm);
        vl_menuSpacer.setComponentAlignment(men_frm, new Alignment(20));
        
        return vl_menuSpacer;
    }

    @AutoGenerated
    private HorizontalLayout buildLayoutFilter() {
        // common part: create layout
        layoutFilter = new HorizontalLayout();
        layoutFilter.setImmediate(false);
        layoutFilter.setWidth("100.0%");
        layoutFilter.setHeight("-1px");
        layoutFilter.setMargin(true);
        
        // filterNurseSubs
        filterNurseSubs = new ComboBox();
        filterNurseSubs.setCaption("Vertretungsnurse");
        filterNurseSubs.setImmediate(false);
        filterNurseSubs.setWidth("-1px");
        filterNurseSubs.setHeight("-1px");
        layoutFilter.addComponent(filterNurseSubs);
        layoutFilter.setComponentAlignment(filterNurseSubs, new Alignment(48));
        
        return layoutFilter;
    }
}
