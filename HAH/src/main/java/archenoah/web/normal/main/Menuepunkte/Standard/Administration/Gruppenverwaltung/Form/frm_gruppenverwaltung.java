package archenoah.web.normal.main.Menuepunkte.Standard.Administration.Gruppenverwaltung.Form;

import archenoah.UIS.UI_Functions;
import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalMessages;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.github.wolfie.refresher.Refresher;
import com.github.wolfie.refresher.Refresher.RefreshListener;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.Table;
import com.vaadin.ui.VerticalLayout;

import de.steinwedel.messagebox.ButtonId;
import de.steinwedel.messagebox.MessageBoxListener;

public class frm_gruppenverwaltung extends CustomComponent {

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Table tbl_grp;
    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;
    @AutoGenerated
    private Button btn_del;
    @AutoGenerated
    private Button btn_edit;
    @AutoGenerated
    private Button btn_add;
    /**
     * The constructor should first build the main layout, set the composition root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual editor.
     */

    private MenuItem Menü;

    private UI_Functions me;
    private Refresher refresher;
    private TabSheet tab;
    private I18nManager i18n;

    public frm_gruppenverwaltung(MenuItem Arg_Menü) {

        buildMainLayout();
        i18n = new I18nManager(this);
        me = new UI_Functions();

        Menü = Arg_Menü;
        Datenholen();
 
        events();
        // Get_Tabitem(Menü.getText());

        i18n.refresh();
    }

    private void set_refresher() {
        refresher = new Refresher();

        refresher.setRefreshInterval(10000);

        refresher.addListener(new Datenholenlistener());

        me.addEx(refresher);
    }

    public class Datenholenlistener implements RefreshListener {

        @Override
        public void refresh(Refresher source) {
            // TODO Automatisch generierter Methodenstub

            Object rowId = tbl_grp.getValue(); // get the selected rows id

            Integer originalIndex = tbl_grp.getCurrentPageFirstItemIndex();
            Datenholen();
            tbl_grp.setCurrentPageFirstItemIndex(originalIndex);

            if (rowId != null) {
                tbl_grp.setValue(rowId);
            }

            if (Prüfungtab(Menü.getText()) == false) {
                me.remEx(source);
            }

        }

        private boolean Prüfungtab(String Name) {
            int Count = tab.getComponentCount();

            for (int i = 0; i < Count; i++) {
                if (tab.getTab(i).getCaption() == Name) {

                    // tab.setSelectedTab(i);

                    return true;
                }

            }

            return false;
        }

    }

    public void Gen_Tab(TabSheet Arg_tab) {
        tab = Arg_tab;

        Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Menü.getText(), mainLayout, Menü.getIcon());
        Config_TBL();
        set_refresher();
    }

    // events

    private void events() {
        btn_add.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                pop_gruppen_insert_edit pg = new pop_gruppen_insert_edit(event.getButton(), "");

            }
        });

        btn_edit.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                Object rowId = tbl_grp.getValue(); // get the selected rows id

                if (rowId == null) {

                    I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                    return;
                }
                final int ID = (int) tbl_grp.getContainerProperty(rowId, "Gruppen ID").getValue();

                pop_gruppen_insert_edit pg = new pop_gruppen_insert_edit(event.getButton(), ID + "");

            }
        });

        btn_del.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                Object rowId = tbl_grp.getValue(); // get the selected rows id

                if (rowId == null) {

                    I18nManager.global(I18nGlobalNotifiers.no_entry_selected);
                    return;
                }
                final int ID = (int) tbl_grp.getContainerProperty(rowId, "Gruppen ID").getValue();

                Datenlöschen(ID);

            }
        });

    }

    // Datenbank

    private void Config_TBL() {
        tbl_grp.setSelectable(true);
        tbl_grp.setImmediate(true);
    }

    public void Datenholen() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass dbH = new DBClass();
        dbH.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AGL_ID", "'Gruppen ID'");
        dbH.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("AGL_NAME", "'Gruppen Name'");
        dbH.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_stammdaten_group");
        tbl_grp.setContainerDataSource(dbH.DB_Data_Get.DB_SEND_AND_GET_Container());
    }

    private void Datenlöschen(final int ID) {

        if (ID == 1) {

            I18nManager.global(I18nGlobalNotifiers.admin_group_not_deletable);

            return;

        } else {
            
            I18nManager.global(I18nGlobalMessages.confirm_delete, new MessageBoxListener() {
                
                @Override
                public void buttonClicked(ButtonId arg0) {
                    if(ButtonId.YES == arg0) {
                        DBClass db = new DBClass();
                        db.DB_Data_Delete.DB_Tabellen.DB_set_Tabelle_Einzeln("cms_auth_stammdaten_group");
                        db.DB_Data_Delete.DB_Filter.DB_WHERE_Allgemein("cms_auth_stammdaten_group", "AGL_ID", "=", ID + "", "");
                        db.DB_Data_Delete.DB_Delete();

                        I18nManager.global(I18nGlobalNotifiers.entry_deleted);
                    }
                }
            });
 
        }
    }

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);

        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");

        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 1.0f);
        mainLayout.setComponentAlignment(horizontalLayout_1, new Alignment(20));

        // tbl_grp
        tbl_grp = new Table();
        tbl_grp.setImmediate(false);
        tbl_grp.setWidth("80.0%");
        tbl_grp.setHeight("80.0%");
        mainLayout.addComponent(tbl_grp);
        mainLayout.setExpandRatio(tbl_grp, 5.0f);
        mainLayout.setComponentAlignment(tbl_grp, new Alignment(20));

        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("80.0%");
        horizontalLayout_1.setHeight("50px");
        horizontalLayout_1.setMargin(false);

        // btn_add
        btn_add = new Button();
        btn_add.setCaption("Add");
        btn_add.setImmediate(true);
        btn_add.setWidth("60.0%");
        btn_add.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_add);
        horizontalLayout_1.setComponentAlignment(btn_add, new Alignment(48));

        // btn_edit
        btn_edit = new Button();
        btn_edit.setCaption("Edit");
        btn_edit.setImmediate(true);
        btn_edit.setWidth("60.0%");
        btn_edit.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_edit);
        horizontalLayout_1.setComponentAlignment(btn_edit, new Alignment(48));

        // btn_del
        btn_del = new Button();
        btn_del.setCaption("Delete");
        btn_del.setImmediate(true);
        btn_del.setWidth("60.0%");
        btn_del.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_del);
        horizontalLayout_1.setComponentAlignment(btn_del, new Alignment(48));

        return horizontalLayout_1;
    }
}
