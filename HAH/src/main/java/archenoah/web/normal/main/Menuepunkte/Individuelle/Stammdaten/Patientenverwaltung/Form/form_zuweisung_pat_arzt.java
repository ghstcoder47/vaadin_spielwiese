package archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.Patientenverwaltung.Form;

import java.util.HashMap;
import java.util.Map;

import archenoah.config.CMS_Config_Std;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.Combo.combo;
import archenoah.lib.vaadin.Components.Combo.nativecombo;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Tab_Menue_Item;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Forms_Builder.Form_Bind;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;
import archenoah.lib.vaadin.MenuBerechtigung.Rechteholen;
import archenoah.lib.vaadin.resources.Icons;
import archenoah.lib.vaadin.valchecker.val_checker4;
import archenoah.web.normal.main.Menuepunkte.Individuelle.Stammdaten.Ärztverwaltung.Form.form_arzt_insert_edit;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.event.FieldEvents.FocusEvent;
import com.vaadin.event.FieldEvents.FocusListener;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.MenuBar.MenuItem;
import com.vaadin.ui.NativeSelect;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

public class form_zuweisung_pat_arzt extends CustomComponent {

    @AutoGenerated
    private VerticalLayout mainLayout;

    @AutoGenerated
    private Button btn_save;

    @AutoGenerated
    private TextArea txta_bemerkung;

    @AutoGenerated
    private NativeSelect ns_art;

    @AutoGenerated
    private HorizontalLayout horizontalLayout_1;

    @AutoGenerated
    private Button btn_new;

    @AutoGenerated
    private Button btn_info;

    @AutoGenerated
    private ComboBox cb_arzt;

    /**
     * The constructor should first build the main layout, set the composition root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual editor.
     */

    /**************** --> Allgemein <--- ********************/
    // Allgemein
    private CMS_Config_Std std;
    private String Exportname;
    // Datenbank
    private Map<Object, String> DBMap;
    private Map<Object, String> ValidateMap;
    private DBClass db;
    private Form_Bind fb;
    private String Form_ID = "";
    // Berrechtigung
    private int ACC_ID;
    private int Lesen;
    private int Schreiben;
    private int Erstellen;
    private int Edit;
    private int Löschen;

    private MenuItem Temp_Menü = null;

    private Button Temp_Btn = null;
    /******************************************************/
    /**************** --> Tabsheetvars <--- *****************/
    private TabSheet tab = null;

    /******************************************************/
    /**************** --> Windowvars <--- *******************/
    private Window win = null;
    /******************************************************/
    /******************* --> Custom <--- ********************/
    public String PatientenID = "";
    public String ArztID = "";
    /******************************************************/

    /************ ----->Einstellungen<-- ********************/
//    private String LNG_FRM_ID = "17";
    private String BER_MEN_ID = "";
    private String Windows_Height = "400px";
    private String Windows_Width = "330px";

    private I18nManager i18n;

    /******************************************************/

    public form_zuweisung_pat_arzt(MenuItem Arg_Menü, String Arg_Form_ID) {
        Temp_Menü = Arg_Menü;
        Form_ID = Arg_Form_ID;

        // TODO add user code here
    }

    public form_zuweisung_pat_arzt(Button Arg_btn, String Arg_Form_ID) {

        Temp_Btn = Arg_btn;
        Form_ID = Arg_Form_ID;

        // TODO add user code here
    }

    /***************************** ---> Feste Funtionen<--- **************************************/

    /********* INIT-Window ************/
    public void Init_Class_Window() {
        if (Windows_Height.equals("") == true || Windows_Width.equals("") == true) {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        Standard_Init();

        if (Temp_Menü != null) {

            if (Temp_Menü.getIcon() != null) {
                String Recourcename = Temp_Menü.getIcon().toString();
                Recourcename = Recourcename.substring(0, Recourcename.length() - 12) + "white-16.png";
                Exportname = Temp_Menü.getText();
                Build_Window_Button bwb = new Build_Window_Button(Temp_Menü.getText(), mainLayout, Windows_Height, Windows_Width, new ThemeResource(Recourcename));
                win = bwb.ReturnWindow();
            } else {
                Exportname = Temp_Menü.getText();
                Build_Window_Button bwb = new Build_Window_Button(Temp_Menü.getText(), mainLayout, Windows_Height, Windows_Width, null);
                win = bwb.ReturnWindow();
            }

        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Window_Button bwb = new Build_Window_Button(Temp_Btn.getCaption(), mainLayout, Windows_Height, Windows_Width, Temp_Btn.getIcon());
            win = bwb.ReturnWindow();
        }

    }

    /********* INIT-Tray ************/
    public void Init_Class_Tab(TabSheet Arg_tab) {

        Standard_Init();
        tab = Arg_tab;
        if (Temp_Menü != null) {
            Exportname = Temp_Menü.getText();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Menü.getText(), mainLayout, Temp_Menü.getIcon());
        }
        if (Temp_Btn != null) {
            Exportname = Temp_Btn.getCaption();
            Build_Tab_Menue_Item bt = new Build_Tab_Menue_Item(Arg_tab, Temp_Btn.getCaption(), mainLayout, Temp_Btn.getIcon());
        }

    }
    
    public Window getWindow() {
        return win;
    }
    
    /********* Init-Standard ************/
    private void Standard_Init() {
        buildMainLayout();
        i18n = new I18nManager(this);
        std = CMS_Config_Std.getInstance();
        fb = new Form_Bind();

        Set_DB_Map();

        Set_Validierer();
        Set_Validate_Map();

        /********** Custom Fill Function *******************/
        Arzt_Holen();
        Art_Holen();

        /***************************************************/

        if (Form_ID != "") {

            Forms_Fill();
            ArztID = cb_arzt.getValue().toString();
        }

        event();
        
        // migrated from database
        btn_info.setIcon(Icons.White.info_16);
        btn_save.setIcon(Icons.White.save_16);
        btn_new.setIcon(Icons.White.add_16);
        ns_art.setRequired(true);
        cb_arzt.setRequired(true);
        // migration end
        
        // win.addAction(new ClickShortcut(btn_save, KeyCode.ENTER));

    }

    /*********************************/

    /*************************** Events *******************************/

    private void event() {

        btn_save.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                if (Validate_Test() == false) {
                    I18nManager.global(I18nGlobalNotifiers.fields_empty);
                    return;
                }

                if (ArztID.equals(cb_arzt.getValue().toString()) != true) {
                    if (Prüfung_Vorhanden() == true) {
//                        System.out.println("ters");
                        I18nManager.global(I18nGlobalNotifiers.entry_exists);
                        return;

                    }
                }

                if (Form_ID.equals("") == true) {
                    Forms_Insert();

                } else {
                    Forms_Update();
                }

                UI.getCurrent().getUI().removeWindow(win);
            }

        });

        btn_info.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {
                // TODO Automatisch generierter Methodenstub

                if (cb_arzt.getValue() == null) {
                    I18nManager.global(I18nGlobalNotifiers.no_entry_selected);

                    return;
                }

                form_arzt_insert_edit pie = new form_arzt_insert_edit(event.getButton(), "" + cb_arzt.getValue());
                pie.Init_Class_Window();
                pie.Set_Berrechtigung_Custom(1, 0, 0, 0);

            }
        });

        btn_new.addClickListener(new ClickListener() {

            @Override
            public void buttonClick(ClickEvent event) {

                form_arzt_insert_edit aie = new form_arzt_insert_edit(event.getButton(), "");

                aie.Init_Class_Window(new CloseListener() {

                    @Override
                    public void windowClose(CloseEvent e) {

                        Arzt_Holen();
                        cb_arzt.select(((AbstractComponent) e.getComponent()).getData());

                    }
                });
                aie.Set_Berrechtigung_Custom(1, 1, 1, 0);
                aie.setAutoCreateUser(true, true);
            }
        });

        cb_arzt.addFocusListener(new FocusListener() {

            @Override
            public void focus(FocusEvent event) {
                // TODO Auto-generated method stub
                Arzt_Holen();
            }
        });

    }

    /******************************************************************/

    /************************ --> Berrechtigung <-- **************************/

    public void Set_Berrechtigung_Database() {
        if (BER_MEN_ID == "") {
            System.out.println("Form Einstellung Fehlt: !!!");
            return;
        }

        ACC_ID = (int) UI.getCurrent().getSession().getSession().getAttribute("Userid");
        Rechteholen r = new Rechteholen(ACC_ID + "");
        String[][] Asan = r.Datenholen();

        for (int i = 0; i < Asan.length; i++) {
            if (Asan[i][0].equals(BER_MEN_ID) == true) {

                Lesen = Integer.valueOf(Asan[i][3]);

                Schreiben = Integer.valueOf(Asan[i][4]);
                Erstellen = Integer.valueOf(Asan[i][6]);
                Löschen = Integer.valueOf(Asan[i][5]);
            }
        }
    }

    public void Set_Berrechtigung_Custom(int Arg_Lesen, int Arg_Erstellen, int Arg_Bearbeiten, int Arg_Loeschen) {
        Lesen = Arg_Lesen;
        Schreiben = Arg_Erstellen;
        Erstellen = Arg_Erstellen;
        Edit = Arg_Bearbeiten;
        Löschen = Arg_Loeschen;
    }

    /**********************************************************************/

    /************************** Einstellen **************************************/

    /******************** Database *****************/
    private void Set_DB_Map() {
        DBMap = new HashMap<>();
        DBMap.put(cb_arzt, "cust_verk_arzt_patient:VAP_A_ID");
        DBMap.put(ns_art, "cust_verk_arzt_patient:VAP_B_ID");
        DBMap.put(txta_bemerkung, "cust_verk_arzt_patient:VAP_BEMERKUNGEN");

    }

    private void Forms_Fill() {
        db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();

        /******************************** Table ****************************************/
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_verk_arzt_patient");
        /******************************************************************************/
        /******************************** Filter ****************************************/
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_arzt_patient", "VAP_ID", "=", Form_ID, "");
        /******************************************************************************/

        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();
        fb = new Form_Bind();

        for (Object ItemIda : con.getItemIds()) {
            fb.Get_and_Fill(con, DBMap);
        }
    }

    private void Forms_Insert() {
        db = new DBClass();
        fb = new Form_Bind();
        fb.Insert(db, DBMap);
        /******************************** Table ****************************************/
        db.DB_Data_Insert.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_verk_arzt_patient");
        /******************************************************************************/
        db.DB_Data_Insert.DB_Daten.DB_Data("cust_verk_arzt_patient", "VAP_P_ID", PatientenID + "");
        
        db.DB_Data_Insert.DB_Insert();
    }

    private void Forms_Update() {
        db = new DBClass();
        fb = new Form_Bind();
        fb.Update(db, DBMap);

        /******************************** Table ****************************************/
        db.DB_Data_Update.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_verk_arzt_patient");
        /******************************************************************************/
        /******************************** Filter ****************************************/
        db.DB_Data_Update.DB_Filter.DB_WHERE_Allgemein("cust_verk_arzt_patient", "VAP_ID", "=", Form_ID, "");
        /******************************************************************************/
        db.DB_Data_Update.DB_Update();
    }

    /***********************************************/

    /*********************** -->Validierung<-- ********************/
    private void Set_Validate_Map() {
        ValidateMap = new HashMap<>();
        ValidateMap.put(ns_art, "ns_art");
        ValidateMap.put(cb_arzt, "cb_arzt");

    }

    private void Set_Validierer() {

        // psw_pass_1.addValidator(new Custom_Benutzerform_psw_ändern(psw_pass_1, psw_pass_2));

    }

    private boolean Validate_Test() {
        val_checker4 val = new val_checker4(ValidateMap);
        if (val.Is_Valid() == false) {
            return false;
        } else {
            return true;
        }

    }

    /*************** -> Füllen ns <- *****************************/
    private void Arzt_Holen() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("ASA_ID");
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_Einzeln("CONCAT(ASA_TITEL,' ',AUL_NAME,' ',AUL_VORNAME, ' ', IF(ASA_ORT != '', CONCAT(' (', trim(ASA_ORT), ')'), ''))", "Arztname");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cms_auth_stammdaten_user", "INNER JOIN", "cust_arzt_stammdaten_anrede", "AUL_ANREDE_ID", "ASAN_ID");
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Verknüpfung("cust_arzt_stammdaten_arzt", "INNER JOIN", "cms_auth_stammdaten_user", "ASA_U_ID", "AUL_ID");

        combo nc = new combo(db.DB_Data_Get.DB_SEND_AND_GET(), cb_arzt, "ASA_ID", "Arztname");
        cb_arzt.setInvalidAllowed(false);
        cb_arzt.setFilteringMode(FilteringMode.CONTAINS);
        db.DB_Data_Get.connclose();

    }

    private void Art_Holen() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_azt_art_stammdaten");

        nativecombo nc = new nativecombo(db.DB_Data_Get.DB_SEND_AND_GET(), ns_art, "AAS_ID", "AAS_NAME");
        ns_art.setInvalidAllowed(false);
        db.DB_Data_Get.connclose();

    }

    private boolean Prüfung_Vorhanden() {
        CMS_Config_Std std = CMS_Config_Std.getInstance();

        DBClass db = new DBClass();
        db.DB_Data_Get.DB_Spalten.Standard.DB_set_Spalten_All();
        db.DB_Data_Get.DB_Tabellen.DB_set_Tabelle_Einzeln("cust_verk_arzt_patient");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_arzt_patient", "VAP_P_ID", "=", PatientenID, "AND");
        db.DB_Data_Get.DB_Filter.DB_WHERE_Allgemein("cust_verk_arzt_patient", "VAP_A_ID", "=", cb_arzt.getValue().toString(), "");
        // System.out.println(cb_arzt.getValue().toString());
        Container con = db.DB_Data_Get.DB_SEND_AND_GET_Container();

        // System.out.println(con.size());
        if (con.size() > 0) {
            return true;
        } else {
            return false;
        }

    }

    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);

        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");

        // cb_arzt
        cb_arzt = new ComboBox();
        cb_arzt.setCaption("Arzt");
        cb_arzt.setImmediate(false);
        cb_arzt.setWidth("80.0%");
        cb_arzt.setHeight("-1px");
        mainLayout.addComponent(cb_arzt);
        mainLayout.setExpandRatio(cb_arzt, 1.0f);
        mainLayout.setComponentAlignment(cb_arzt, new Alignment(48));

        // horizontalLayout_1
        horizontalLayout_1 = buildHorizontalLayout_1();
        mainLayout.addComponent(horizontalLayout_1);
        mainLayout.setExpandRatio(horizontalLayout_1, 0.5f);
        mainLayout.setComponentAlignment(horizontalLayout_1, new Alignment(48));

        // ns_art
        ns_art = new NativeSelect();
        ns_art.setCaption("Art");
        ns_art.setImmediate(false);
        ns_art.setWidth("80.0%");
        ns_art.setHeight("-1px");
        mainLayout.addComponent(ns_art);
        mainLayout.setExpandRatio(ns_art, 1.0f);
        mainLayout.setComponentAlignment(ns_art, new Alignment(48));

        // txta_bemerkung
        txta_bemerkung = new TextArea();
        txta_bemerkung.setCaption("Bemerkung");
        txta_bemerkung.setImmediate(false);
        txta_bemerkung.setWidth("80.0%");
        txta_bemerkung.setHeight("100.0%");
        mainLayout.addComponent(txta_bemerkung);
        mainLayout.setExpandRatio(txta_bemerkung, 1.0f);
        mainLayout.setComponentAlignment(txta_bemerkung, new Alignment(48));

        // btn_save
        btn_save = new Button();
        btn_save.setCaption("Speichern");
        btn_save.setImmediate(true);
        btn_save.setWidth("-1px");
        btn_save.setHeight("-1px");
        mainLayout.addComponent(btn_save);
        mainLayout.setExpandRatio(btn_save, 1.0f);
        mainLayout.setComponentAlignment(btn_save, new Alignment(48));

        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildHorizontalLayout_1() {
        // common part: create layout
        horizontalLayout_1 = new HorizontalLayout();
        horizontalLayout_1.setImmediate(false);
        horizontalLayout_1.setWidth("80.0%");
        horizontalLayout_1.setHeight("100.0%");
        horizontalLayout_1.setMargin(false);

        // btn_info
        btn_info = new Button();
        btn_info.setImmediate(true);
        btn_info.setWidth("-1px");
        btn_info.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_info);
        horizontalLayout_1.setExpandRatio(btn_info, 1.0f);
        horizontalLayout_1.setComponentAlignment(btn_info, new Alignment(48));

        // btn_new
        btn_new = new Button();
        btn_new.setImmediate(true);
        btn_new.setWidth("-1px");
        btn_new.setHeight("-1px");
        horizontalLayout_1.addComponent(btn_new);
        horizontalLayout_1.setExpandRatio(btn_new, 1.0f);
        horizontalLayout_1.setComponentAlignment(btn_new, new Alignment(48));

        return horizontalLayout_1;
    }

}
