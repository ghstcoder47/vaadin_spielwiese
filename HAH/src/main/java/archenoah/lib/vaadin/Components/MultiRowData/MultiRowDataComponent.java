package archenoah.lib.vaadin.Components.MultiRowData;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map.Entry;

import org.apache.commons.lang3.tuple.Pair;
import org.tepi.filtertable.FilterTable;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowPopupInput.SaveAction;
import archenoah.lib.vaadin.Language.i18n.I18nGlobalNotifiers;
import archenoah.lib.vaadin.Language.i18n.I18nManager;

import com.google.common.base.Joiner;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Container.Filterable;
import com.vaadin.data.Container.ItemSetChangeListener;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.data.util.ObjectProperty;
import com.vaadin.data.util.PropertysetItem;
import com.vaadin.data.util.converter.Converter;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.combobox.FilteringMode;
import com.vaadin.ui.AbstractComponent;
import com.vaadin.ui.AbstractSelect;
import com.vaadin.ui.AbstractSelect.Filtering;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.CustomTable;
import com.vaadin.ui.CustomTable.ColumnGenerator;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.VerticalLayout;

public class MultiRowDataComponent extends CustomComponent {
    
//    public static void main(String[] args) {
//        System.out.println("test");
//    }
    
    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private VerticalLayout tableLayout;
    @AutoGenerated
    private FilterTable table;
    @AutoGenerated
    private HorizontalLayout topLayout;
    @AutoGenerated
    private VerticalLayout buttonLayout;
    @AutoGenerated
    private Button buttonRemove;
    @AutoGenerated
    private Button buttonRead;
    @AutoGenerated
    private Button buttonAdd;
    @AutoGenerated
    private VerticalLayout fieldLayoutContainer;
    // {section fields}
    // ****************
    org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    private String tableName;
    private String idColumn;
    private String parentColumn;
    private MultiRowDataFieldRows fieldRows;
    
    private ArrayList<MultiRowDataField> fieldList;
    
    private Integer parentId;
    
    private String tableSql;
    private ArrayList<Integer> dataOriginal;
    private ArrayList<PropertysetItem> removedItems;
    private ArrayList<Item> insertedItems;
    
    private ArrayList<Object> visibleColumns = new ArrayList<>();
    private ArrayList<Object> generatedColumns = new ArrayList<>();
    private MultiRowPopupInput popup;
    
    private HashMap<Object, FooterGenerator> footerGenerators;
    private MultiRowSaveListener saveListener;
    private MultiRowInsertListener insertListener;
    private boolean prepenedNewItems = false;
    
    private HashMap<Object, ColumnGenerator> columnGenerators;
    private HashMap<Object, String> columnCaptions;
    
    private ArrayList<Container.Filter> containerFilters;
    private Pair<Object[], boolean[]> containerSort;
    
    private boolean create = true;
    private boolean read = true;
    private boolean update = false; // tdb
    private boolean delete = true;
    
    // {end fields}
    
    

    // {section constructors}
    // **********************
    
    public MultiRowDataComponent() {};
    
    public MultiRowDataComponent(String table, String idColumn, String parentColumn, MultiRowDataFieldRows rows) {
        setup(table, idColumn, parentColumn, rows);
    }
    
    public MultiRowDataComponent(String table, String idColumn, String parentColumn, MultiRowPopupInput popup) {
        setup(table, idColumn, parentColumn, popup);
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public Integer getParentId() {
        return parentId;
    }
    
    public void setParentIdOnly(Integer parentId) {
        this.parentId = parentId;
        tableSql = null;
    }
    
    public void setParentId(Integer parentId) {
        setParentIdOnly(parentId);
        tableSql = null;
        dbGetData();
    }
    
    public void setSaveListener(MultiRowSaveListener saveListener) {
        this.saveListener = saveListener;
    }
    
    public void setInsertListener(MultiRowInsertListener insertListener) {
        this.insertListener = insertListener;
    }
    
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    public void setup(String table, String idColumn, String parentColumn, MultiRowDataFieldRows rows) {
        this.tableName = table;
        this.idColumn = idColumn;
        this.parentColumn = parentColumn;
        this.fieldRows = rows;
        setCompositionRoot(buildMainLayout());
        init();
    }
    
    public void setup(String table, String idColumn, String parentColumn, MultiRowPopupInput popup) {
        this.tableName = table;
        this.idColumn = idColumn;
        this.parentColumn = parentColumn;
        this.popup = popup;
        this.fieldList = popup.getFields();
        setCompositionRoot(buildMainLayout());
        init();
    }
    
    public void save() {
        
        checkIncompleteInput();

        getContainer().removeAllContainerFilters();
        try {
            dbDelete();
            dbInsert();
            
            if(saveListener != null) {
                saveListener.onSave(insertedItems, removedItems);
            }
        } catch (Exception e) {}
        
        if(containerFilters != null) {
            for (Filter filter : containerFilters) {
                getContainer().addContainerFilter(filter);
            }
        }
        
        
    }
    
    public void save(Integer id) {
        this.parentId = id;
        save();
    }
    
    public void saveAndUpdate() {
        
        save();
        dbGetData();
        
    }
    
    public void setVisibleColumns(Object[] columns) {
        visibleColumns = new ArrayList<Object>(Arrays.asList(columns));
    }
    
    public IndexedContainer getContainer() {
        return (IndexedContainer) table.getContainerDataSource();
    }
    
    @Override
    public void setEnabled(boolean enabled) {
        
        buttonLayout.setEnabled(enabled);
        topLayout.setEnabled(enabled);
        
        buttonLayout.setVisible(enabled);
        topLayout.setVisible(enabled);
    }
    
    @Override
    public boolean isEnabled() {
        return buttonLayout.isEnabled();
    }
    
    public Object getValue() {
        return table.getValue();
    }
    
    public Item getSelectedItem() {
        if(table.getValue() == null || getContainer() == null) {
            return null;
        }
        return getContainer().getItem(table.getValue());
    }
    
    public void addValueChangeListener(ValueChangeListener vcl) {
        table.addValueChangeListener(vcl);
    }
    
    public void addItemSetChangeListener(ItemSetChangeListener isc) {
        table.addItemSetChangeListener(isc);
    }
    
    public void setFooterGenerator(MultiRowDataField field, FooterGenerator footerGenerator) {
        setFooterGenerator(field.getColumn(), footerGenerator);
    }
    
    public void setFooterGenerator(String columnId, FooterGenerator footerGenerator) {
        if(footerGenerators == null) {
            footerGenerators = new HashMap<Object, FooterGenerator>();
        }
        footerGenerators.put(columnId, footerGenerator);
    }
    
    public void addGeneratedColumn(Object id, String caption, ColumnGenerator generatedColumn) {
        
        if(table != null) {
            table.addGeneratedColumn(id, generatedColumn);
        }else {
            if(columnGenerators == null) {
                columnGenerators = new HashMap<Object, CustomTable.ColumnGenerator>();
            }
            columnGenerators.put(id, generatedColumn);
        }
        
        if(columnCaptions == null) {
            columnCaptions = new HashMap<Object, String>();
        }
        columnCaptions.put(id, caption);
    }
    
    public Boolean isModified() {
        return getInsertEntries().size() > 0 || getDeleteEntries().size() > 0;
    }
    
    public ArrayList<AbstractComponent> getFields() {
        ArrayList<AbstractComponent> list = new ArrayList<AbstractComponent>();
        for (MultiRowDataField field : fieldList) {
            list.add(field.getField());
        }
        return list;
    }
    
    protected void addContainerFilter(Container.Filter filter) {
        
        if(containerFilters == null) {
            containerFilters = new ArrayList<Container.Filter>();
        }
        
        containerFilters.add(filter);
        getContainer().addContainerFilter(filter);
        sortContainer();
    }
    
    protected void removeContainerFilter(Container.Filter filter) {
        if(filter != null) {
            containerFilters.remove(filter);
            getContainer().removeContainerFilter(filter);
            sortContainer();
        }
    }
    
    protected void clearContainerSort() {
        this.containerSort = null; 
    }
    
    protected void setContainerSort(Object[] propertyId, boolean[] ascending) {
        this.containerSort = Pair.of(propertyId, ascending); 
    }
    
    protected void prependNewItems(boolean prepend) {
        this.prepenedNewItems = prepend;
    }
    
    protected void allowAdd(boolean allowed) {
        create = allowed;
        toggleButtons();
    }
    protected void allowRead(boolean allowed) {
        read = allowed;
        toggleButtons();
    }
    protected void allowDelete(boolean allowed) {
        delete = allowed;
        toggleButtons();
    }
    protected void addTopComponent(AbstractComponent component) {
        fieldLayoutContainer.addComponent(component);
    }
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    private void checkIncompleteInput() {
        boolean hasUnsaved = false;
        
        if(isPopupMode()) {
            return;
        }
        
        for (MultiRowDataField field : fieldList) {
            if(field.getField() != null && field.getField().getValue() != null) {
                hasUnsaved = true;
                break;
            }
        }
        
        if(hasUnsaved && table.size() == 0) {
            I18nManager.global(I18nGlobalNotifiers.incomplete_save);
        }
    }
    
    @SuppressWarnings("unchecked")
    private void init() {
        
        removedItems = new ArrayList<PropertysetItem>();
        insertedItems = new ArrayList<Item>();
        
        if(fieldList == null) {
        
            fieldList = new ArrayList<MultiRowDataField>();
            
            for (ArrayList<MultiRowDataField> row : fieldRows.getRows()) {
                
                HorizontalLayout hl = new HorizontalLayout();
                hl.setWidth("100%");
                hl.setHeight("-1px");
                hl.setSpacing(true);
                fieldLayoutContainer.addComponent(hl);
                
                for (MultiRowDataField field : row) {
                    
                    fieldList.add(field);
                    
                    field.getField().setImmediate(true);
                    hl.addComponent(field.getField());
                    hl.setComponentAlignment(field.getField(), Alignment.MIDDLE_CENTER);
                    if(field.getFieldRatio() != null) {
                        hl.setExpandRatio(field.getField(), field.getFieldRatio());
                    }
                    if(field.getField() instanceof Filtering) {
                        ((ComboBox) field.getField()).setFilteringMode(FilteringMode.CONTAINS);
                    }
                    try {
                        field.getField().setValue(field.getDefaultValue());
                    } catch (Exception e) {
                    }
                                    
                    
                }
            }
            fieldLayoutContainer.setHeight("-1px");

        }
//        dbGetData();
        
        configureComponents();
        localize();
        configureTable();
        
    }
    
    private Boolean isPopupMode() {
        return popup != null;
    }
    
    private void configureComponents() {
        
        buttonLayout.setMargin(true);
        buttonLayout.setStyleName("cust_margin_half_full_none_full");
        buttonLayout.setWidth("60px");
        buttonLayout.setComponentAlignment(buttonAdd, Alignment.MIDDLE_CENTER);
        buttonLayout.setComponentAlignment(buttonRemove, Alignment.MIDDLE_CENTER);
        
        if(isPopupMode()) {
            topLayout.addComponent(buttonAdd);
            topLayout.setComponentAlignment(buttonAdd, Alignment.MIDDLE_CENTER);
            topLayout.addComponent(buttonRead);
            topLayout.setComponentAlignment(buttonRead, Alignment.MIDDLE_CENTER);
            topLayout.addComponent(buttonRemove);
            topLayout.setComponentAlignment(buttonRemove, Alignment.MIDDLE_CENTER);
            
            topLayout.removeComponent(buttonLayout);
   
        }
        
        toggleButtons();
        
        buttonAdd.setEnabled(isPopupMode());
        buttonAdd.setIcon(new ThemeResource("image-res/icons/add-white-16.png"), "hinzuf√ºgen");
        buttonAdd.setStyleName("button-image-only");
        buttonAdd.setWidth("35px");
        buttonAdd.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                if(!isPopupMode()) {
                    addEntry();
                }else {
                    popup.show();
                }
                
            }
        });
        
        if(isPopupMode()) {
            popup.setSaveAction(new SaveAction() {
                
                @Override
                public void onSave(ArrayList<MultiRowDataField> fields) {
                    
                    if(fields == null) {
                        return;
                    }
                    
                    fieldList = fields;
                    addEntry();
                    
                }
            });
        }
        
        buttonRead.setEnabled(false);
        buttonRead.setVisible(read && isPopupMode());
        buttonRead.setIcon(new ThemeResource("image-res/icons/perm-lesen-white-16.png"), "betrachten");
        buttonRead.setStyleName("button-image-only");
        buttonRead.setWidth("35px");
        buttonRead.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                popup.setValue(table.getItem(table.getValue()));
                popup.show();
                
            }
        });
        
        buttonRemove.setEnabled(false);
        buttonRemove.setIcon(new ThemeResource("image-res/icons/delete-white-16.png"), "entfernen");
        buttonRemove.setStyleName("button-image-only");
        buttonRemove.setWidth("35px");
        buttonRemove.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                removeEntry();
                
            }
        });
        
        ValueChangeListener vcl = new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                buttonAdd.setEnabled(isInsertable());
                
            }
        };
        
        if(!isPopupMode()) {
            for (MultiRowDataField field : fieldList) {
                field.getField().addValueChangeListener(vcl);
            }
        }
        
        table.addValueChangeListener(new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                
                buttonRemove.setEnabled(isDeletable());
                buttonRead.setEnabled(isPopupMode() && isDeletable());
                
            }
        });
        
        final ValueChangeListener parentChangeListener = new ValueChangeListener() {
            
            @Override
            public void valueChange(ValueChangeEvent event) {
                tableSql = null;
                dbGetData();
            }
        };
        for (MultiRowDataField field : fieldList) {
            if(field.isParent()) {
                field.getField().addValueChangeListener(parentChangeListener);
            }
            
        }
        
    }
    
    private void configureTable() {
        
        table.setSelectable(true);
        table.setImmediate(true);
        
//        table.setContainerDataSource(tableContainer);
        
        for (final MultiRowDataField field : fieldList) {
            
            table.addContainerProperty(field.getColumn(), field.type, null);
            
            visibleColumns.add(field.getColumn());
            table.setColumnHeader(field.getColumn(), field.getField().getCaption());
            if(field.getRatio() != null) {
                table.setColumnExpandRatio(field.getColumn(), field.getRatio());
                //truncate header to allow narrow columns
                if(field.getRatio() == 0) {
                    if(field.getField().getCaption() != null){
                        String hdr = field.getField().getCaption().replaceAll("[aeiou]", "").substring(0, 3);
                        table.setColumnHeader(field.getColumn(), hdr);
                    }
                }
            }
            
            try {
                if (field.getConverter() != null) {
                    table.setConverter(field.getColumn(), field.getConverter());
                } else if (field.getField().getConverter() != null) {
                    table.setConverter(field.getColumn(), field.getField().getConverter());
                } else if(field.getDataSource() != null) {
                    table.setConverter(field.getColumn(), getConverter(field, String.class));
                }
            } catch (Exception e) {
                log.error("exception while attaching converter: {}", e);
            }
            
            // add generated columns inf the field datasource provides values
            try {

                if (field.getAdditionalColumns() != null && field.getAdditionalColumns().size() > 0) {

                    for (Object c : field.getAdditionalColumns()) {
                        
                        //visibleColumns.add(c); // set visible columns manually if needed
                        generatedColumns.add(c);
                        
                        table.addGeneratedColumn(c, new ColumnGenerator() {

                            @Override
                            public Object generateCell(CustomTable source, Object itemId, Object columnId) {
                                //           get by specific id           from dropdown con      with id prop
                                Item fitem = MyUtils.getItemFromContainer(field.getDataSource(), field.getIdProperty().toString(),
                                    //                      current table item       with field col as id value for above
                                    MyUtils.getValueFromItem(source.getItem(itemId), field.getColumn(), Object.class));
                                // and get the value from dropdown for the table autogen column 
                                return MyUtils.getValueFromItem(fitem, columnId, Object.class);
                                

                            }
                        });

                    }

                }

            } catch (Exception e) {
                log.error("error adding generated columns, {}", e);
            }
            
        }
        
        if(columnGenerators != null) {
            for (Entry<Object, ColumnGenerator> entry : columnGenerators.entrySet()) {
                visibleColumns.add(entry.getKey());
                table.addGeneratedColumn(entry.getKey(), entry.getValue());
                table.setColumnHeader(entry.getKey(), columnCaptions.get(entry.getKey()));
                table.setColumnExpandRatio(entry.getKey(), 1);
            }
        }
        
    }
    
    private void sortContainer() {
        if(containerSort != null) {
            getContainer().sort(containerSort.getKey(), containerSort.getValue());
        }
    }
    
    private void toggleButtons() {
        
        if(mainLayout == null) {
            return;
        }
        
        table.setSelectable(!(!read && !update && !delete));
        
        buttonAdd.setVisible(create);
        buttonRead.setVisible(read);
        buttonRemove.setVisible(delete);
    }
    
    private Boolean isInsertable() {
        
        Boolean insertable = true;
        
        for (MultiRowDataField field : fieldList) {
            if(!field.getField().isValid()) {
                insertable = false;
                break;
            }
        }
        
        return insertable;
        
    }
    
    private Boolean isDeletable() {
        return (table.getValue() != null);
    }
    
    @SuppressWarnings("unchecked")
    private <T> Converter<String, T> getConverter(final MultiRowDataField field, final Class<T> type){
        
        if(!(field.getField() instanceof AbstractSelect)) {
            return null;
        }
        
        final Container con = ((AbstractSelect) field.getField()).getContainerDataSource();
        
        Collection<Filter> filters = new ArrayList<Container.Filter>();
        if(con instanceof Filterable) {
            filters = new ArrayList<Filter>(((Filterable) con).getContainerFilters());
            ((Filterable) con).removeAllContainerFilters();
        }
        
        HashMap<String, T> tempMapModel = new HashMap<String, T>();
        HashMap<T, String> tempMapPresentation = new HashMap<T, String>();
        
        for (Object iid: con.getItemIds()) {
            
            tempMapModel.put( MyUtils.getValueFromItem(con.getItem(iid), field.getCaptionProperty(), String.class), (T) iid);
            tempMapPresentation.put((T) iid, MyUtils.getValueFromItem(con.getItem(iid), field.getCaptionProperty(), String.class));
        }
        
        if(filters.size() > 0) {
            for (Filter filter : filters) {
                ((Filterable) con).addContainerFilter(filter);
            }
        }
        
        final HashMap<String, T> modelMap = tempMapModel;
        final HashMap<T, String> presentationMap = tempMapPresentation;
        
        return new Converter<String, T>(){

            
            @Override
            public T convertToModel(String value, Class<? extends T> targetType, Locale locale)
                    throws com.vaadin.data.util.converter.Converter.ConversionException {
                return modelMap.get(value);
            }

            @Override
            public String convertToPresentation(T value, Class<? extends String> targetType, Locale locale)
                    throws com.vaadin.data.util.converter.Converter.ConversionException {
                return presentationMap.get(value);
            }

            @Override
            public Class<T> getModelType() {
                return type;
            }

            @Override
            public Class<String> getPresentationType() {
                return String.class;
            }
            
        };
        
    }
    
    
    
    private void updateFooter() {

        if(footerGenerators == null) {
            return;
        }
        
        table.setFooterVisible(footerGenerators != null);
        
        //reset Footer Texts
        for (FooterGenerator gen : footerGenerators.values()) {
            gen.reset();
        }
        
        // iterate all table entries and update each FooterGenerator
        for (Object iid : getContainer().getItemIds()) {
            
            Item item = getContainer().getItem(iid);
            HashMap<Object, Object> generated = new HashMap<Object, Object>();
            
            for (Object cid : generatedColumns) {
                ColumnGenerator gen = table.getColumnGenerator(cid);
                if(gen != null) {
                    generated.put(cid, gen.generateCell(table, iid, cid));
                }
            }
            
            for (Entry<Object, FooterGenerator> set : footerGenerators.entrySet()) {
                set.getValue().modify(set.getKey(), item, generated);
            }
            
        }
        
        //set Footer Values;
        for (Entry<Object, FooterGenerator> set : footerGenerators.entrySet()) {
            table.setColumnFooter(set.getKey(), set.getValue().getFooterText());
        }
        
    }
    
    
    private void addEntry() {
        
        log.info("adding");
        
        Object iid = new Date().hashCode() + "i" + table.size(); //make sure temp ids are unique and don't collide with existing
        
        log.info("iid is {}", iid);
        
        Item item;
        
        if(prepenedNewItems) {
            item = ((IndexedContainer) table.getContainerDataSource()).addItemAt(0, iid);
        }else {
            item = table.addItem(iid);
        }
        
        Object value = null;
        
        for (MultiRowDataField field : fieldList) {
            
            if(field.getField() == null || field.getField().getValue() == null) {
                continue;
            }
            
            if(field.getFieldConverter() != null)  {
                value = field.getFieldConverter().convertForTable(field);
            }else {
                value = field.getField().getValue();
            }
            
            if(item.getItemProperty(field.getColumn()) != null) {
                item.getItemProperty(field.getColumn()).setValue(value);
            }
        }
        
        
        if(insertListener != null) {
            insertListener.onInsert(item);
        }
        table.setCurrentPageFirstItemId(iid);
        updateFooter();
    }
    
    protected void scrollToBottom() {
        Object[] ids = table.getItemIds().toArray();
        table.setCurrentPageFirstItemId(ids[ids.length -1]);
    }
    
    private void removeEntry() {
        
        removeEntry(table.getValue());
                
    }
    
    protected void removeEntry(Object value) {
        
        log.info("removing: {}", value);
        
        logRemovedItem(value);

        table.removeItem(value);
        updateFooter();

    }
    
    private void logRemovedItem(Object id) {
        
        if(!dataOriginal.contains(id)) {
            return;
        }
        
        try {
            
            Item tableItem = table.getItem(id);
            PropertysetItem logItem = new PropertysetItem();

            for (Object pid : tableItem.getItemPropertyIds()) {

                Object type = tableItem.getItemProperty(pid).getType();
                    
                logItem.addItemProperty(pid, new ObjectProperty(tableItem.getItemProperty(pid).getValue(), type.getClass()));
                logItem.getItemProperty(pid).setValue(tableItem.getItemProperty(pid).getValue());

            }
            removedItems.add(logItem);
            
        } catch (Exception e) {
            
            log.error("error marking item as removed");
            
        }
        

    }
    
    private HashMap<String, String> getMultiParents() {
        HashMap<String, String> map = new HashMap<String, String>();
        
        for (MultiRowDataField field : fieldList) {
            if(field.isParent()) {
                map.put(field.getColumn(), "'" + field.getField().getValue() + "'");
            }
        }
        
        return map;
    }
    
    private void localize() {

        ArrayList<String> list = new ArrayList<String>();
        for (MultiRowDataField field : fieldList) {
            list.add(field.getField().getCaption());
        }
        
        I18nManager i18n = new I18nManager(this.getClass().getCanonicalName(), list);
        
        for (MultiRowDataField field : fieldList) {
            field.getField().setCaption(i18n.get(field.getField().getCaption()));
        }
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    
    private void dbGetData() {
        
        DBClass db = new DBClass();
        
        if(tableSql == null) {
            tableSql = "SELECT " + idColumn + ", " + parentColumn + ", " + Joiner.on(", ").join(fieldList)
                    + "\n " + "FROM " + tableName
                    + "\n " + "WHERE " +
                    ((parentId != null) ? (parentColumn + " = " + parentId) : ("1=0"));// hack to get columns
            
            HashMap<String, String> parents = getMultiParents();
            if(parents.size() > 0) {
                for (Entry<String, String> entry : parents.entrySet()) {
                    tableSql += "\n and " + entry.getKey() + " = " + entry.getValue(); 
                }
            }
        }
        
        db.CustomQuery.setSqlString(tableSql);
//        db.debugNextQuery(true);
        IndexedContainer con = MyUtils.convertIndex(db.CustomQuery.query(), idColumn);
        
        dataOriginal = new ArrayList<Integer>();
        dataOriginal.addAll((Collection<Integer>) con.getItemIds());
        
        if (containerFilters != null) {
            for (Filter filter : containerFilters) {
                con.addContainerFilter(filter);
            }
        }
        
        table.setContainerDataSource(con);
        table.setVisibleColumns(visibleColumns.toArray());
        
        sortContainer();
        
        updateFooter();
    }
    
    private ArrayList<Object> getInsertEntries() {
        
        ArrayList<Object> insert = new ArrayList<Object>();
        insert.addAll(table.getContainerDataSource().getItemIds());
        if(dataOriginal != null) {
            insert.removeAll(dataOriginal);
        }
        
        return insert;
    }
    
    private ArrayList<Object> getDeleteEntries() {
        
        ArrayList<Object> delete = new ArrayList<Object>();
        if(dataOriginal != null) {
            delete.addAll(dataOriginal);
        }
        delete.removeAll(table.getContainerDataSource().getItemIds());
        
        return delete;
    }
    
    private void dbInsert() {
        
        ArrayList<Object> entries = getInsertEntries();
        
        insertedItems = new ArrayList<Item>();
        
        if(entries.size() == 0) {
            return;
        }
        
        ArrayList<HashMap<Object, Object>> insertValues = new ArrayList<HashMap<Object, Object>>();
        
        for (Object entry : entries) {
            
            HashMap<Object, Object> entryMap = new HashMap<Object, Object>();
            
            Item item = table.getItem(entry);
            insertedItems.add(item);
            
            for (Object pid : item.getItemPropertyIds()) {
                
                entryMap.put(pid, item.getItemProperty(pid) != null ? item.getItemProperty(pid).getValue() : null);
                
            } 
            
            entryMap.remove(idColumn);
            
            insertValues.add(entryMap);
            
        }
        
        log.info("insertValues: {}", insertValues);
        
        DBClass db = new DBClass();
        String sql = "INSERT INTO " + tableName 
                + "\n " + "(" + parentColumn + ", " + Joiner.on(", ").join(fieldList) + ") VALUES "
                + "\n ";
        
        ArrayList<String> rows = new ArrayList<String>(); 
        
        for (HashMap<Object, Object> entryMap : insertValues) {
            
            ArrayList<String> values = new ArrayList<String>();
            
            for (MultiRowDataField field : fieldList) {
                Object value = entryMap.get(field.getColumn());
                
                String result = "";
                
                if(value == null) {
                    result = "NULL";
                }else if (value instanceof String
                        || value instanceof java.sql.Date) { //TASK extend as needed
                    result = "'" + value + "'";
                } else {
                    result = value.toString();
                }
                values.add(result);
                
            }
            
            rows.add("(" + "'" + parentId + "', " + Joiner.on(", ").join(values) + ")");
            
        }
        
        sql += Joiner.on(",\n ").join(rows) + ";";
        
        log.info("insert sql: {}" + sql);
        
        db.CustomQuery.setSqlString(sql);
        db.CustomQuery.update();
        
    }
    
    private void dbDelete() {
        

        ArrayList<Object> entries = getDeleteEntries();
        
        if(entries.size() == 0) {
            return;
        }
        
        DBClass db = new DBClass();
        String sql = "DELETE FROM " + tableName
                + "\n " + " WHERE " + idColumn + " IN('" + Joiner.on("', '").join(entries) + "')"; 

        log.info("delete sql: {}" + sql);
        
        db.CustomQuery.setSqlString(sql);
        db.CustomQuery.update();
        
    }
    
    // {end database}

    // {section layout}
    // ****************


    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setStyleName("cust_margin_none");
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(false);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100.0%");
        
        // topLayout
        topLayout = buildTopLayout();
        mainLayout.addComponent(topLayout);
        
        // tableLayout
        tableLayout = buildTableLayout();
        mainLayout.addComponent(tableLayout);
        mainLayout.setExpandRatio(tableLayout, 1.0f);
        mainLayout.setComponentAlignment(tableLayout, new Alignment(48));
        
        return mainLayout;
    }

    @AutoGenerated
    private HorizontalLayout buildTopLayout() {
        // common part: create layout
        topLayout = new HorizontalLayout();
        topLayout.setImmediate(false);
        topLayout.setWidth("100.0%");
        topLayout.setHeight("-1px");
        topLayout.setMargin(false);
        topLayout.setSpacing(true);
        
        // fieldLayoutContainer
        fieldLayoutContainer = new VerticalLayout();
        fieldLayoutContainer.setImmediate(false);
        fieldLayoutContainer.setWidth("100.0%");
        fieldLayoutContainer.setHeight("100.0%");
        fieldLayoutContainer.setMargin(false);
        fieldLayoutContainer.setSpacing(true);
        topLayout.addComponent(fieldLayoutContainer);
        topLayout.setExpandRatio(fieldLayoutContainer, 1.0f);
        topLayout.setComponentAlignment(fieldLayoutContainer, new Alignment(48));
        
        // buttonLayout
        buttonLayout = buildButtonLayout();
        topLayout.addComponent(buttonLayout);
        topLayout.setComponentAlignment(buttonLayout, new Alignment(48));
        
        return topLayout;
    }

    @AutoGenerated
    private VerticalLayout buildButtonLayout() {
        // common part: create layout
        buttonLayout = new VerticalLayout();
        buttonLayout.setImmediate(false);
        buttonLayout.setWidth("-1px");
        buttonLayout.setHeight("-1px");
        buttonLayout.setMargin(false);
        buttonLayout.setSpacing(true);
        
        // buttonAdd
        buttonAdd = new Button();
        buttonAdd.setCaption(" ");
        buttonAdd.setImmediate(true);
        buttonAdd.setWidth("-1px");
        buttonAdd.setHeight("-1px");
        buttonLayout.addComponent(buttonAdd);
        
        // buttonRead
        buttonRead = new Button();
        buttonRead.setCaption(" ");
        buttonRead.setImmediate(false);
        buttonRead.setWidth("-1px");
        buttonRead.setHeight("-1px");
        buttonLayout.addComponent(buttonRead);
        
        // buttonRemove
        buttonRemove = new Button();
        buttonRemove.setCaption(" ");
        buttonRemove.setImmediate(true);
        buttonRemove.setWidth("-1px");
        buttonRemove.setHeight("-1px");
        buttonLayout.addComponent(buttonRemove);
        
        return buttonLayout;
    }

    @AutoGenerated
    private VerticalLayout buildTableLayout() {
        // common part: create layout
        tableLayout = new VerticalLayout();
        tableLayout.setImmediate(false);
        tableLayout.setWidth("100.0%");
        tableLayout.setHeight("100.0%");
        tableLayout.setMargin(false);
        
        // table
        table = new FilterTable();
        table.setImmediate(false);
        table.setWidth("100.0%");
        table.setHeight("100.0%");
        tableLayout.addComponent(table);
        
        return tableLayout;
    }
    
    // {end layout}
}
