package archenoah.lib.custom.comments;

import java.sql.Timestamp;
import java.util.ArrayList;

import archenoah.lib.custom.MyUtils;
import archenoah.lib.tool.comunication.dbclass.DBClass;
import archenoah.lib.tool.comunication.dbclass.DBClass.CustomQuery;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowDataField;
import archenoah.lib.vaadin.Components.MultiRowData.MultiRowPopupInput;
import archenoah.lib.vaadin.Components.Steppers.IntStepper;
import archenoah.lib.vaadin.Components.Window_Tab_Generierer.Build_Window_Button;
import archenoah.lib.vaadin.Language.i18n.I18nConverter;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Container;
import com.vaadin.data.Container.Filter;
import com.vaadin.data.Item;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.DateField;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.CloseEvent;
import com.vaadin.ui.Window.CloseListener;

public class CommentInput extends CustomComponent implements MultiRowPopupInput{

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    @AutoGenerated
    private VerticalLayout mainLayout;
    @AutoGenerated
    private Button save;
    @AutoGenerated
    private TextArea comment;
    // {section fields}
    // ****************
    
    org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(this.getClass());
    
    private DateField created;
    private DateField updated;
    private ComboBox author;
    private ComboBox origin;
    private ComboBox type;
    private IntStepper data;
    
    private Filter typeFilter;
    private I18nConverter typeConverter;
    private I18nConverter originConverter;
    
    private ArrayList<MultiRowDataField> fields;
    
    private Window win;
    private SaveAction saveAction; 
    // {end fields}

    // {section constructors}
    // **********************
    public CommentInput() {
        buildMainLayout();
        configureConverters();
        configureComponents();
        getFields();
    }
    // {end constructors}

    // {section gettersandsetters}
    // ***************************
    public void setTypeConverter(I18nConverter typeConverter) {
        this.typeConverter = typeConverter;
        this.typeConverter.attachDatasource(type);
    }
    
    public I18nConverter getTypeConverter() {
        return typeConverter;
    }
    
    public void setOriginConverter(I18nConverter originConverter) {
        this.originConverter = originConverter;
        this.originConverter.attachDatasource(origin);
    }
    
    public I18nConverter getOriginConverter() {
        return originConverter;
    }
    // {end gettersandsetters}

    // {section publicmethods}
    // ***********************
    
    @SuppressWarnings("unchecked")
    public void setOrigin(String originString) {
        
        if(originString == null) {
            throw new IllegalArgumentException("originString must be provided!");
        }
        
        if(!origin.getContainerDataSource().getItemIds().contains(originConverter.convertToModel(originString, Integer.class))) {
            dbSaveOrigin(originString);
            //origin.getContainerDataSource().addItem().getItemProperty("CO_KEY").setValue(originString);
            setOriginConverter(new OriginConverter());
        }
        for (Object iid : origin.getItemIds()) {
            if(originString.equals(MyUtils.getValueFromItem(origin.getItem(iid), "CO_KEY", String.class))) {
                origin.setValue(iid);
                return;
            }
        }
    }
    
    @SuppressWarnings("unchecked")
    public void setType(String typeString) {
        
        if(typeString == null) {
            throw new IllegalArgumentException("typeString must be provided!");
        }
        
        if(!type.getContainerDataSource().getItemIds().contains(typeConverter.convertToModel(typeString, Integer.class))) {
            dbSaveType(typeString);
            //type.getContainerDataSource().addItem(dbSaveType(typeString)).getItemProperty("CT_KEY").setValue(typeString);
            setTypeConverter(new TypeConverter());
        }
        for (Object iid : type.getItemIds()) {
            if(typeString.equals(MyUtils.getValueFromItem(type.getItem(iid), "CT_KEY", String.class))) {
                type.setValue(iid);
                return;
            }
        }
    }
    
    public void setData(Integer dataId) {
        data.setValue(dataId);
    }

    public void setAuthor(Integer userId) {
        author.setValue(userId);
    }
    
    @Override
    public ArrayList<MultiRowDataField> getFields() {
        
        if(fields != null) {
            return fields;
        }
        
        fields = new ArrayList<MultiRowDataField>();
        
        MultiRowDataField commentField = new MultiRowDataField(comment, "C_COMMENT", TextArea.class);
        commentField.setDefaultValue("");
        fields.add(commentField);
        

        MultiRowDataField createdField = new MultiRowDataField(created, "C_CREATED", Timestamp.class);
        fields.add(createdField);
        

        MultiRowDataField updatedField = new MultiRowDataField(updated, "C_UPDATED", Timestamp.class);
        fields.add(updatedField);
        

        MultiRowDataField authorField = new MultiRowDataField(author, "C_ID_AUTHOR", Integer.class);
        authorField.setDataSource(dbGetAuthors(), "AUL_ID", "author");
        fields.add(authorField);
        
        MultiRowDataField originField = new MultiRowDataField(origin, "C_ID_ORIGIN", Integer.class);
//        originField.setDataSource(dbOrigins(), "CO_ID", "CO_KEY");
        originField.setConverter(originConverter);
        fields.add(originField);
        
        MultiRowDataField typeField = new MultiRowDataField(type, "C_ID_TYPE", Integer.class);
//        typeField.setDataSource(dbGetTypes(), "CT_ID", "CT_KEY");
        typeField.setConverter(typeConverter);
        typeField.isParent(true);
        fields.add(typeField);
        
        MultiRowDataField dataField = new MultiRowDataField(data, "C_DATA", Integer.class);
        fields.add(dataField);

        return fields;
    }

    @Override
    public void show() {
        if(win == null) {
            Build_Window_Button bwb = new Build_Window_Button("Kommentar schreiben", mainLayout, "250", "500", null);
            win = bwb.ReturnWindow();
            win.setStyleName("scrollfix");
            
            win.addCloseListener(new CloseListener() {
                
                @Override
                public void windowClose(CloseEvent e) {
                    
                    //clear fields since reopening does not create a new instance
                    comment.setValue("");
                    toggleEnabled(true);
                    
                }
            });
            
        }else {
            UI.getCurrent().getUI().addWindow(win);
        }
    }
    
    @Override
    public void setValue(Item item) {
        comment.setValue(MyUtils.getValueFromItem(item, "C_COMMENT", String.class));
        toggleEnabled(false);
    }
    
    @Override
    public void setSaveAction(SaveAction saveAction) {
        
        this.saveAction = saveAction;
        
    }
    
    // {end publicmethods}

    // {section privatemethods}
    // ************************
    
    private void configureConverters() {
        originConverter = new OriginConverter();
        typeConverter = new TypeConverter();
    }
    
    private void configureComponents() {
        
        created = new DateField();
        updated = new DateField();
        author = new ComboBox();
        origin = new ComboBox();
        type = new ComboBox();
        data = new IntStepper();
        
        comment.setRequired(true);
        
        typeConverter.attachDatasource(type);
        originConverter.attachDatasource(origin);
        
        data.setValue(null);
        
        save.addClickListener(new ClickListener() {
            
            @Override
            public void buttonClick(ClickEvent event) {
                
                log.info("author value {}", author.getValue());
                
                if(saveAction != null) {
                    saveAction.onSave(getFields());
                }
                
                win.close();
                
            }
        });
    }
    
    private void toggleEnabled(Boolean enabled) {
        comment.setEnabled(enabled);
        comment.setStyleName(enabled ? "" : "nogrey"); 
        save.setVisible(enabled);
        save.setEnabled(enabled);
    }
    
    // {end privatemethods}

    // {section database}
    // ******************
    private Container dbGetAuthors() {
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "select AUL_ID, CONCAT_WS('', AUL_VORNAME, ' ', AUL_NAME) as author"
                    + "\n " + "from cms_auth_stammdaten_user where AUL_USERNAME != ''";
        q.setSqlString(sql);
        return q.query();
    }
    
    private Integer dbSaveOrigin(String origin) {
        ArrayList<Integer> keys = new ArrayList<Integer>();
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "INSERT INTO cust_comments_origins (`CO_KEY`) VALUES ('"+origin+"');";
        q.setSqlString(sql);
        q.update(false, keys);
        
        return keys.iterator().next();
    }
    
    private Integer dbSaveType(String type) {
        ArrayList<Integer> keys = new ArrayList<Integer>();
        CustomQuery q = new DBClass().CustomQuery;
        String sql = "INSERT INTO cust_comments_types (`CT_KEY`) VALUES ('"+type+"');";
        q.setSqlString(sql);
        q.update(false, keys);
        
        return keys.iterator().next();
    }
    // {end database}

    private class OriginConverter extends I18nConverter{
        public OriginConverter() {
            super("cust_comments_origins", "CO_ID", "CO_KEY");
        }
    }
    
    private class TypeConverter extends I18nConverter{
        public TypeConverter() {
            super("cust_comments_types", "CT_ID", "CT_KEY");
        }
    }
    
    @AutoGenerated
    private VerticalLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new VerticalLayout();
        mainLayout.setImmediate(false);
        mainLayout.setWidth("100%");
        mainLayout.setHeight("100%");
        mainLayout.setMargin(true);
        mainLayout.setSpacing(true);
        
        // top-level component properties
        setWidth("100.0%");
        setHeight("100%");
        
        // comment
        comment = new TextArea();
        comment.setCaption("Kommentar");
        comment.setImmediate(false);
        comment.setWidth("100.0%");
        comment.setHeight("100.0%");
        mainLayout.addComponent(comment);
        mainLayout.setExpandRatio(comment, 1);
        
        // save
        save = new Button();
        save.setCaption("Speichern");
        save.setImmediate(true);
        save.setWidth("-1px");
        save.setHeight("-1px");
        mainLayout.addComponent(save);
        mainLayout.setComponentAlignment(save, new Alignment(48));
        
        return mainLayout;
    }
}
